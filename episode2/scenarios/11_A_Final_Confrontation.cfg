#textdomain wesnoth-After_the_Storm

[scenario]
    id=11_A_Final_Confrontation
    name= _ "A Final Confrontation"
    {MAP 11_A_Final_Confrontation.map}
    {TURNS 36 34 32}
    next_scenario=12_Fate
    victory_when_enemies_defeated=no

    {E_DEATHS}

    {SCENARIO_MUSIC       "suspense.ogg"} {CONTINUE_PLAYING_STORY_MUSIC_FIRST}
    {EXTRA_SCENARIO_MUSIC "the_deep_path.ogg"}

    {STORYTXT_A_FINAL_CONFRONTATION}

    {INDOORS_HIVE}

#define I_NO_ECONOMY
    gold,village_gold=0,0
    {NO_INCOME}
#enddef

    {SPAWN_CONTROLLER}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        save_id=player
        team_name=good
        user_team_name= _ "team_name^Elynia"

        {GOLD 250 225 200}
        {INCOME 4 3 2}

        shroud=yes

        # wmllint: recognize Elynia
        {CHARACTER_STATS_ELYNIA}
    [/side]
    # wmllint: validate-on

    #
    # Boss controller
    #
    [side]
        side=2
        team_name=evil
        user_team_name= _ "team_name^Mal Hekuba"
        color=yellow
        {CHAOS_FLAG}

        hidden=yes
        no_leader=yes

        {I_NO_ECONOMY}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression          5.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution             0.00}
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth        ({DIFF 2 3 3})}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "scout,mixed fighter,scout,scout"}
        [/ai]

        [unit]
#ifdef EASY
            type=Necrophage
#else
            type=Ghast
#endif
            ai_special=guardian
            upkeep=free
            x,y=43,38
            facing=se
            [modifications]
                {TRAIT_UNDEAD}
            [/modifications]
        [/unit]

        [unit]
#ifdef EASY
            type=Necrophage
#else
            type=Ghast
#endif
            ai_special=guardian
            upkeep=free
            x,y=39,38
            facing=ne
            [modifications]
                {TRAIT_UNDEAD}
            [/modifications]
        [/unit]
    [/side]

    [side]
        side=3
        team_name=evil
        user_team_name= _ "team_name^Mal Hekuba"
        color=blue
        {CHAOS_FLAG}
        controller=null

        hidden=yes
        no_leader=yes

        {I_NO_ECONOMY}
    [/side]

    #
    # Guards
    #
    [side]
        side=4
        team_name=evil
        user_team_name= _ "team_name^Chamber Guards"
        {CHAOS_FLAG}

        no_leader=yes
        hidden=yes

        {I_NO_ECONOMY}
        recruit=Demon,Imp,Chaos Headhunter

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression          1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution             0.00}
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth        ({DIFF 3 4 4})}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "mixed fighter,fighter,mixed fighter,scout,fighter"}
        [/ai]

        [unit]
            type=Demon Zephyr
            gender=female
            id=Azalia
            name= _ "Azalia"
            ai_special=guardian
            upkeep=free
            x,y=36,40
            facing=ne
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]
        [unit]
            type=Demon Zephyr
            gender=male
            id=Rhadiarch
            name= _ "Rhadiarch"
            ai_special=guardian
            upkeep=free
            x,y=44,33
            facing=s
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]
#ifndef EASY
        [unit]
            type=Demon Zephyr
            gender=female
            id=Galaviel
            name= _ "Galaviel"
            ai_special=guardian
            upkeep=free
            x,y=47,37
            facing=sw
            [modifications]
                {TRAIT_QUICK}
                {TRAIT_DEXTROUS}
            [/modifications]
        [/unit]
#endif
    [/side]

    [side]
        side=5
        team_name=evil
        user_team_name= _ "team_name^Chamber Guards"
        {CHAOS_FLAG}

        no_leader=yes
        hidden=yes

        {I_NO_ECONOMY}
        recruit=Automaton,Shaxthal Drone,Chaos Invoker

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression          1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution             0.00}
            {AI_SIMPLE_ALWAYS_ASPECT attack_depth        ({DIFF 2 3 4})}
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "fighter,mixed fighter,fighter,archer"}
        [/ai]

        [unit]
            type=Shaxthal Sentry Drone
            ai_special=guardian
            upkeep=free
            x,y=37,32
            facing=sw
            [modifications]
                {TRAIT_BIOMECHANICAL}
                {TRAIT_RESILIENT}
                {UNIT_PALETTE_SWITCH () shaxthal_drone_base shaxthal_drone_purple}
            [/modifications]
        [/unit]

        [unit]
            type=Shaxthal Sentry Drone
            ai_special=guardian
            upkeep=free
            x,y=33,34
            facing=se
            [modifications]
                {TRAIT_BIOMECHANICAL}
                {TRAIT_ARMORED}
                {UNIT_PALETTE_SWITCH () shaxthal_drone_base shaxthal_drone_purple}
            [/modifications]
        [/unit]
    [/side]

    #
    # Hive spawns
    #
    [side]
        side=6
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        no_leader=yes
        hidden=yes
        {I_NO_ECONOMY}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression 5.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution    0.00}
            {AI_SIMPLE_ALWAYS_ASPECT grouping     no}
        [/ai]
    [/side]

#define I_DOOR _X _Y
    {GENERIC_UNIT () Door ({_X}) ({_Y})} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
#enddef

    #
    # Door controller
    #
    [side]
        side=7
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}
        color=black

        no_leader=yes
        hidden=yes
        {I_NO_ECONOMY}

        {I_DOOR 35 36}
        {I_DOOR 36 35}
        {I_DOOR 37 35}
    [/side]

    #
    # Dummy stand-in for side 1
    #
    [side]
        side=8
        team_name=good,evil
        user_team_name= _ "team_name^Elynia"
        color=red
        controller=null

        no_leader=yes
        hidden=yes
        {I_NO_ECONOMY}
    [/side]

#undef I_NO_ECONOMY
#undef I_DOOR

#define I_DRONE _RESPAWN_TURNS _TYPES _X _Y
    {TIMED_DRONE_SPAWNER ({_RESPAWN_TURNS}) (type={_TYPES}) 6 ({_X}) ({_Y})}
#enddef

    {I_DRONE 4 (Shaxthal Drone) 35 45}
    {I_DRONE 8 (Shaxthal Drone) 33 42}
#ifndef EASY
    {I_DRONE 8 (Shaxthal Drone) 33 43}
#endif

    {I_DRONE 1 (Shaxthal Drone) 51 37}
    {I_DRONE 1 (Shaxthal Drone) 53 35}

#undef I_DRONE

    {STARTING_VILLAGES 1 6}

    [event]
        name=prestart
        {VARIABLE boss_stage_3_in_progress no}

        # wmllint: recognize Anya
        {RECALL_ANYA_AT_LOCATION   47 49}
        # wmllint: recognize Durvan
        {RECALL_DURVAN_AT_LOCATION 49 48}

        {MODIFY_UNIT (side=1) facing nw}

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Proceed further underground with Elynia to find Mal Hekuba")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}

            {TURNS_RUN_OUT}
        )}
    [/event]

    [event]
        name=start
        [message]
            speaker=Durvan
            message= _ "This goes deeper and deeper—"
        [/message]

        {QUAKE "rumble.ogg"}

        {QUAKE "cave-in.ogg"}

        [message]
            speaker=Elynia
            message=  _ "... I fear we don’t have much more time. Just where in this accursed place are you, Hekuba?"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            type=Door
        [/filter]

#define I_CAPTURE_STARTING_VILLAGES _SIDE _RADIUS
    [store_starting_location]
        side={_SIDE}
        variable=temp_I_CAPTURE_STARTING_VILLAGES
    [/store_starting_location]

    {CAPTURE_VILLAGES_OF_TYPE (*^V*) {_SIDE} $temp_I_CAPTURE_STARTING_VILLAGES.x $temp_I_CAPTURE_STARTING_VILLAGES.y {_RADIUS}}

    {CLEAR_VARIABLE temp_I_CAPTURE_STARTING_VILLAGES}
#enddef

        [modify_side]
            side=4
            hidden=no
            income=0
            {GOLD 100 120 140}
            village_gold=1
        [/modify_side]

        [unit]
            canrecruit=yes
            type=Chaos Lorekeeper
            id=Jarlean
            name= _ "Jarlean"
            side=4
            x,y=46,25
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_QUICK}
            [/modifications]
        [/unit]

        {I_CAPTURE_STARTING_VILLAGES 4 8}

        [modify_side]
            side=5
            hidden=no
            income=0
            {GOLD 100 120 140}
            village_gold=1
        [/modify_side]

        [unit]
            canrecruit=yes
            type=Chaos Advanced Crossbowman
            id=Terryl
            name= _ "Terryl"
            side=5
            x,y=49,18
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        {I_CAPTURE_STARTING_VILLAGES 5 4}

#undef I_CAPTURE_STARTING_VILLAGES
    [/event]

    [event]
        name=die
        [filter]
            side=4
            canrecruit=yes
        [/filter]
        [filter_condition]
            [have_unit]
                side=5
                canrecruit=yes
            [/have_unit]
        [/filter_condition]

        [gold]
            side=5
            {QUANTITY amount 110 120 140}
        [/gold]
    [/event]

    [event]
        name=die
        [filter]
            side=5
            canrecruit=yes
        [/filter]
        [filter_condition]
            [have_unit]
                side=4
                canrecruit=yes
            [/have_unit]
        [/filter_condition]

        [gold]
            side=4
            {QUANTITY amount 110 120 140}
        [/gold]
    [/event]

    [event]
        name=lift central barriers

        [unit]
            side=2
            x,y=22,13
            facing=se
            type=Goliath
            upkeep=free
            ai_special=guardian
        [/unit]

        [unit]
            side=2
            x,y=36,20
            facing=se
            type=Goliath
            upkeep=free
            ai_special=guardian
        [/unit]

        [unit]
            side=2
            x,y=35,26
            facing=s
            type=Goliath
            upkeep=free
            ai_special=guardian
        [/unit]

        [unit]
            side=2
            x,y=17,26
            facing=ne
            type=Goliath
            upkeep=free
            ai_special=guardian
        [/unit]

        {QUAKE "rumble.ogg"}

#define I_BARRIER_LOCS_NORTH
    x=40,40,40,40,40,40,41,41,41,41,41,41
    y=18,19,20,21,22,23,18,19,20,21,22,23
#enddef
#define I_BARRIER_LOCS_SOUTH
    x=28,29,29,30,30,31,31,32,32,33,33,34,34,35,35,36,36,37
    y=31,31,32,30,31,30,31,29,30,29,30,28,29,28,29,27,28,28
#enddef
        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "The earth shakes."
        [/message]

        [terrain]
            terrain="Ur^Es"
            {I_BARRIER_LOCS_NORTH}
            [or]
                {I_BARRIER_LOCS_SOUTH}
            [/or]
        [/terrain]

        [remove_shroud]
            side=1
            {I_BARRIER_LOCS_NORTH}
            [or]
                {I_BARRIER_LOCS_SOUTH}
            [/or]
        [/remove_shroud]

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=41,21
        [/scroll_to]

        {HIGHLIGHT_GOAL ({I_BARRIER_LOCS_NORTH})}

        [scroll_to]
            x,y=33,30
        [/scroll_to]

        {HIGHLIGHT_GOAL ({I_BARRIER_LOCS_SOUTH})}

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]

#undef I_BARRIER_LOCS_NORTH
#undef I_BARRIER_LOCS_SOUTH

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Move Elynia to the central chamber")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}

            {TURNS_RUN_OUT}
        )}
    [/event]

    {ITEM_CRYSTAL_GLYPH_GATE 53 17}

    [event]
        name=moveto
        [filter]
            side=1
            x,y=53,17
        [/filter]

        [redraw][/redraw]

        [message]
            speaker=narrator
            image="items/crystal-glyph.png"
            sound="magic-3.ogg"
            message= _ "Access granted."
        [/message]

        [remove_item]
            x,y=$x1,$y1
        [/remove_item]

        [fire_event]
            name=lift central barriers
            [primary_unit]
                x,y=$x1,$y1
            [/primary_unit]
        [/fire_event]
    [/event]

#define I_BOSS_LOC
    x=24
    y=19
#enddef

#define I_CORE_LOCS
    x=24,28,20,20,28,24
    y=15,17,17,21,21,23
#enddef

#define I_ANIMATE_SINGLE_SPIRE _X _Y
    [animate_unit]
        [filter]
            x={_X}
            y={_Y}
        [/filter]
        flag="portal beam"
        with_bars=yes
        [facing]
            [filter_adjacent_location]
                x={_X}
                y={_Y}
                adjacent=-n
            [/filter_adjacent_location]
        [/facing]
    [/animate_unit]
#enddef

    [event]
        name=side 2 turn refresh
        first_time_only=no

        [store_unit]
            [filter]
                type=Verlissh Control Spire
            [/filter]
            kill=no
            variable=spires_store
        [/store_unit]

        {FOREACH spires_store k}
            {I_ANIMATE_SINGLE_SPIRE $spires_store[$k].x $spires_store[$k].y}
        {NEXT k}

        {CLEAR_VARIABLE spires_store}

        # wmllint: recognize Mal Hekuba
        [if]
            [have_unit]
                id=Mal Hekuba
            [/have_unit]
            [then]
                # We are in the boss sequence.
                {QUAKE ({SOUND_LIST:COLLAPSING_FACILITY})}
            [/then]
        [/if]
    [/event]

    #
    # Boss sequence trigger.
    #

    [event]
        name=moveto
        [filter]
            id=Elynia
            x=13-32
            y=12-25
        [/filter]

        [allow_undo][/allow_undo]

        [event]
            delayed_variable_substitution=no
            name="turn $($turn_number + 1)"
            [fire_event]
                name=boss stage 1
            [/fire_event]
        [/event]

        [message]
            speaker=Elynia
            message= _ "Be careful. I’m sure he is in this chamber, somewhere..."
        [/message]

        [remove_shroud]
            side=1
            {I_BOSS_LOC}
            radius=7
            # The central block is Xu, can't use this without an exception!
            #[filter_radius]
            #    [not]
            #        terrain=X*,X*^*,*^X*
            #    [/not]
            #[/filter_radius]
        [/remove_shroud]

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            {I_BOSS_LOC}
        [/scroll_to]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elynia
            message= _ "Most likely on that tall platform at the center. We need to get up there somehow."
        [/message]

        {QUAKE "rumble.ogg"}

        [message]
            speaker=Anya
            message= _ "What’s that noise?"
        [/message]

        {QUAKE "cave-in.ogg"}
        {QUAKE "rumble.ogg"}

        [store_locations]
            {I_CORE_LOCS}
            variable=core_locs
        [/store_locations]

        {FOREACH core_locs k}
            [terrain]
                x,y=$core_locs[$k].x,$core_locs[$k].y
                terrain=Cud^Xo
            [/terrain]

            [redraw][/redraw]

            [unit]
                type=Verlissh Control Spire
                side=2
                x,y=$core_locs[$k].x,$core_locs[$k].y
                upkeep=free
                ai_special=guardian
            [/unit]
        {NEXT k}

        [redraw][/redraw]

        [delay]
            time=250
        [/delay]

        {FOREACH core_locs k}
            [scroll_to]
                x,y=$core_locs[$k].x,$core_locs[$k].y
            [/scroll_to]

            [delay]
                time=250
            [/delay]

            {I_ANIMATE_SINGLE_SPIRE $core_locs[$k].x $core_locs[$k].y}

            [delay]
                time=250
            [/delay]
        {NEXT k}

        {CLEAR_VARIABLE core_locs}

        [message]
            speaker=Elynia
            message= _ "... That energy... It’s the same..."
        [/message]

        [message]
            speaker=Durvan
            message= _ "Elynia? What’s happening?"
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Elynia
            message= _ "... A dark energy emanates from those spires... It’s the same energy that was released in Wesmere when we destroyed the creature within the hive. "
        [/message]

        [message]
            speaker=Anya
            message= _ "How should we destroy them?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Search the chamber — there must be some mechanism controlling them."
        [/message]

        # Increase turn limit.

        [modify_turns]
            {QUANTITY add 24 22 20}
        [/modify_turns]

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Explore the central chamber")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}

            {TURNS_RUN_OUT}
        )}
    [/event]

    ############################################################################
    #
    # BOSS FIGHT STAGE 1
    #
    ############################################################################

    [event]
        name=boss stage 1
        first_time_only=yes

        {QUAKE "rumble.ogg"}

        [terrain]
            {I_BOSS_LOC}
            radius=1
            terrain=Cud
        [/terrain]

        [terrain]
            {I_BOSS_LOC}
            terrain=Kud
        [/terrain]

        [item]
            {I_BOSS_LOC}
            image="items/ball-magenta.png"
            halo="halo/heart-aura.png"
        [/item]

        [modify_side]
            side=2
            hidden=no
            recruit=Demon Zephyr,Shaxthal Sentry Drone
            gold=50
            income=25
        [/modify_side]

        [store_direction]
            [from]
                {I_BOSS_LOC}
            [/from]
            [to]
                [filter]
                    id=Elynia
                [/filter]
            [/to]
        [/store_direction]

#define I_EFFECT_CANNOT_MOVE
    [effect]
        apply_to="movement"
        set=1
    [/effect]
    [effect]
        apply_to="movement_costs"
        replace=yes
        [movement_costs]
            shallow_water={UNREACHABLE}
            reef={UNREACHABLE}
            swamp_water={UNREACHABLE}
            flat={UNREACHABLE}
            sand={UNREACHABLE}
            forest={UNREACHABLE}
            hills={UNREACHABLE}
            mountains={UNREACHABLE}
            village={UNREACHABLE}
            castle={UNREACHABLE}
            cave={UNREACHABLE}
            frozen={UNREACHABLE}
            fungus={UNREACHABLE}
        [/movement_costs]
    [/effect]
#enddef

        [unit]
            {CHARACTER_STATS_MAL_HEKUBA}
            canrecruit=yes
            {IS_BOSS}
            side=2
            {I_BOSS_LOC}
            facing=$direction
            #
            # TODO: new baseframe and new unit type
            # instead of this crap
            #
            level=5
            max_experience=250
            [+modifications]
                [object]
                    silent=yes
                    [effect]
                        apply_to="attack"
                        name=shadow wave
                        # set_name=darkness storm
                        set_description= _ "darkness storm"
                        increase_damage=1
                    [/effect]
                    [effect]
                        apply_to="attack"
                        name=chill tempest
                        increase_damage=14
                    [/effect]
                    [effect]
                        apply_to="hitpoints"
                        heal_full=yes
                        increase_total=100%
                    [/effect]
                    {I_EFFECT_CANNOT_MOVE}
                    [effect]
                        apply_to="new_ability"
                        [abilities]
                            {ABILITY_REGENERATES}
                        [/abilities]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        {CLEAR_VARIABLE direction}

        [redraw]
            side=1
        [/redraw]

        [scroll_to_unit]
            id=Mal Hekuba
        [/scroll_to_unit]

        {REPLACE_SCENARIO_MUSIC "the_city_falls.ogg"}
        {APPEND_MUSIC           "casualties_of_war.ogg"}

        {INCIDENTAL_MUSIC       "ambuscade.ogg"}

        {BOSS_POPUP}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Mal Hekuba
            message= _ "Welcome to your end, heathens!"
        [/message]

        {QUAKE (cave-in.ogg)}

        {FLASH_RED (
            [store_unit]
                [filter]
                    type=Verlissh Control Spire
                [/filter]
                variable=spires_store
            [/store_unit]

            {FOREACH spires_store k}
                [object]
                    silent=yes
                    [filter]
                        x,y=$spires_store[$k].x,$spires_store[$k].y
                    [/filter]
                    [effect]
                        apply_to="image_mod"
                        add="R(128)"
                    [/effect]
                [/object]
            {NEXT k}

            [redraw][/redraw]

            [delay]
                time=750
            [/delay]

            [sound]
                name=explosion-big.ogg
            [/sound]

            [sound]
                name=rumble.ogg
            [/sound]

            [terrain]
                x=19-30
                y=16-24
                [and]
                    terrain=Q*
                [/and]
                terrain=Qxua
            [/terrain]

            [redraw][/redraw]

            {FOREACH spires_store k}
                [unstore_unit]
                    find_vacant=no
                    variable="spires_store[$k]"
                [/unstore_unit]
            {NEXT k}

            {CLEAR_VARIABLE spires_store}
        )}

        [redraw][/redraw]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Durvan
            message= _ "What kind of evil magic is this?"
        [/message]

        [message]
            speaker=Anya
            message= _ "Is he... fused with one of the spires?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "What do you expect to achieve by creating a new portal to Inferno with your new-found powers? Your troops are falling one by one under the might of the northern peoples’ alliance, and you decided to start a riot against your own leader in this dead land?"
        [/message]

        [message]
            speaker=Mal Hekuba
            # po: "her" refers to Elyssa, again
            message= _ "Ha, ha, ha, ha! Don’t forget that your shortsightedness is the chief cause of your friends’ demise, foolish creature. The power I control now is too great, even for her."
        [/message]

        [message]
            speaker=Anya
            message= _ "What if you don’t truly control it? You said you cannot speak to Uria directly — what if her will is <i>your</i> destruction?"
        [/message]

        [message]
            speaker=Mal Hekuba
            message= _ "Insolent girl! You shall all die!"
        [/message]

        {QUAKE (rumble.ogg)}
        {QUAKE (cave-in.ogg)}

        [message]
            speaker=Mal Hekuba
            message= _ "YOU SHALL ALL DIE NOW!"
        [/message]

        {QUAKE (explosion-big.ogg)}
        {QUAKE (rumble.ogg)}

#define I_RECRUIT_DEMON _X _Y
    [animate_unit]
        [filter]
            id=Mal Hekuba
        [/filter]
        flag=recruiting
        with_bars=yes
        [facing]
            x={_X}
            y={_Y}
        [/facing]
    [/animate_unit]

    [unit]
        animate=yes
        type=Demon Zephyr
        side=2
        x={_X}
        y={_Y}
        random_traits=yes
        random_gender=yes
        generate_name=yes
        upkeep=loyal
    [/unit]
#enddef
        [store_locations]
            [filter_adjacent_location]
                {I_BOSS_LOC}
            [/filter_adjacent_location]
            variable=recruit_locs
        [/store_locations]

        {FOREACH recruit_locs k}
            {I_RECRUIT_DEMON $recruit_locs[$k].x $recruit_locs[$k].y}
        {NEXT k}

        {CLEAR_VARIABLE recruit_locs}

#undef I_RECRUIT_DEMON

        [message]
            speaker=Durvan
            message= _ "What are we going to do now?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Everyone, stay away from the spires and the portal! I must think of something..."
        [/message]

        #[message]
        #    speaker=Mal Hekuba
        #    message= _ "IT’S TOO LATE FOR THAT!"
        #[/message]

#define I_PORTAL_NOTES
    {OBJECTIVE_NOTE ( _ "The portal increases in size every turn, taking adjacent ground hexes with it")}
    {OBJECTIVE_NOTE ( _ "Unless they are adjacent to a spire, road hexes cannot disappear")}
    {OBJECTIVE_NOTE ( _ "Units incapable of flight over chasms will die should the ground below them disappear")}
#enddef

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Survive until the end of turns")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}

            {I_PORTAL_NOTES}
        )}

        #
        # On subsquent turns, increase the portal opening's size.
        # (FIXME: is it really necessary to check the turn number so it
        # doesn't fire immediately at the end of the current new turn event?)
        #

        [event]
            delayed_variable_substitution=no
            name=new turn
            first_time_only=no
            # Only fire on subsequent turns
            [filter_condition]
                {VARIABLE_NUMERICAL_GREATER_THAN turn_number "$($turn_number + 1)"}
            [/filter_condition]
            [fire_event]
                name=portal crack step
            [/fire_event]
        [/event]

        #
        # Two turns later, stage 2.
        #

        [event]
            delayed_variable_substitution=no
            name="turn $($turn_number + 2)"
            [fire_event]
                name=boss stage 2
            [/fire_event]
        [/event]
    [/event]

#define I_EXTEND_PORTAL_TO _X _Y
    [sound]
        name="rumble.ogg"
    [/sound]

    [terrain]
        x={_X}
        y={_Y}
        terrain=Qxua
    [/terrain]

    [redraw][/redraw]

    #
    # Kill present unit if it cannot normally move/fly
    # on Unwalkable hexes.
    #

    [if]
        [have_unit]
            x={_X}
            y={_Y}
        [/have_unit]
        [then]
            [store_unit_can_move_on_current_terrain]
                x={_X}
                y={_Y}
                variable=result
            [/store_unit_can_move_on_current_terrain]

            [if]
                {VARIABLE_BOOLEAN_EQUALS result no}
                [then]
                    [kill]
                        x={_X}
                        y={_Y}
                        animate=yes
                        fire_event=yes
                    [/kill]

                    [redraw][/redraw]
                [/then]
            [/if]

            {CLEAR_VARIABLE result}
        [/then]
    [/if]
#enddef

    #
    # Portal logic!
    #
    [event]
        name=portal crack step
        first_time_only=no

        # Each destroyed hex will cause the death of the unit on it if it's
        # not capable of flight on unwalkable hexes.

        # First, destroy one adjacent non-portal hex for each core unit.

        [store_locations]
            {I_CORE_LOCS}
            variable=core_locs
        [/store_locations]

        {FOREACH core_locs k}
            [store_locations]
                [filter_adjacent_location]
                    x,y=$core_locs[$k].x,$core_locs[$k].y
                [/filter_adjacent_location]
                terrain=!,Qxua
                variable=core_adjacent_locs
            [/store_locations]

            [if]
                {VARIABLE_NUMERICAL_GREATER_THAN core_adjacent_locs.length 0}
                [then]
                    # Randomize choice if there are more than 1 remaining locations
                    {VARIABLE_RANDOM r "0..$($core_adjacent_locs.length - 1)"}
                    {I_EXTEND_PORTAL_TO $core_adjacent_locs[$r].x $core_adjacent_locs[$r].y}
                    {CLEAR_VARIABLE r}
                [/then]
            [/if]

            {CLEAR_VARIABLE core_adjacent_locs}
        {NEXT k}

        {CLEAR_VARIABLE core_locs}

        # Then, destroy one non-portal/castle/keep/road/wall hex that is adjacent
        # to a portal hex that is *not* adjacent to a core unit nor is a core
        # unit's location.

        [store_locations]
            [filter_adjacent_location]
                terrain=Qxua
                [not]
                    {I_CORE_LOCS}
                [/not]
            [/filter_adjacent_location]
            terrain=!,Qxua,C*,C*^*,K*,K*^*,Ur*,Ur*^*,X*,X*^*
            [not]
                {I_CORE_LOCS}
            [/not]
            variable=portal_adjacent_locs
        [/store_locations]

        [if]
            {VARIABLE_NUMERICAL_GREATER_THAN portal_adjacent_locs.length 0}
            [then]
                # Randomize choice if there are more than 1 remaining locations
                {VARIABLE_RANDOM r "0..$($portal_adjacent_locs.length - 1)"}
                {I_EXTEND_PORTAL_TO $portal_adjacent_locs[$r].x $portal_adjacent_locs[$r].y}
                {CLEAR_VARIABLE r}
            [/then]
        [/if]

        {CLEAR_VARIABLE portal_adjacent_locs}
    [/event]

#undef I_EXTEND_PORTAL_TO

    #
    # Damage absorption logic for control spires.
    #

    [event]
        name=attacker hits
        first_time_only=no
        [filter]
            side=1
        [/filter]
        [filter_second]
            type=Verlissh Control Spire
        [/filter_second]

        {BOSS_ABSORB_FULL_DAMAGE (x,y=$x2,$y2)}

        [fire_event]
            name=spire warning
        [/fire_event]
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter_second]
            side=1
        [/filter_second]
        [filter]
            type=Verlissh Control Spire
        [/filter]

        {BOSS_ABSORB_FULL_DAMAGE (x,y=$x1,$y1)}

        [fire_event]
            name=spire warning
        [/fire_event]
    [/event]

    [event]
        name=spire warning
        first_time_only=yes
        [message]
            speaker=Elynia
            message= _ "There’s no use in attacking those structures, and the energy they release in retaliation could kill us all!"
        [/message]
    [/event]

    #
    # Damage absorption logic for Mal Hekuba.
    #

    [event]
        name=attacker hits
        first_time_only=no
        [filter]
            side=1
        [/filter]
        [filter_second]
            id=Mal Hekuba
        [/filter_second]

        {BOSS_ABSORB_FULL_DAMAGE (id=Mal Hekuba)}

        [fire_event]
            name=invincibility taunt
        [/fire_event]
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter_second]
            side=1
        [/filter_second]
        [filter]
            id=Mal Hekuba
        [/filter]

        {BOSS_ABSORB_FULL_DAMAGE (id=Mal Hekuba)}

        [fire_event]
            name=invincibility taunt
        [/fire_event]
    [/event]

    [event]
        name=invincibility taunt
        first_time_only=yes
        [message]
            speaker=Mal Hekuba
            message= _ "Attacking me is futile!"
        [/message]
    [/event]

    ############################################################################
    #
    # BOSS FIGHT STAGE 2
    #
    ############################################################################

#define I_EFFECT_CAN_FLY_OVER_CHASMS
    [effect]
        apply_to=movement_costs
        replace=true
        [movement_costs]
            unwalkable=1
        [/movement_costs]
    [/effect]
#enddef

    [event]
        name=boss stage 2
        first_time_only=yes
        [message]
            speaker=Elynia
            message= _ "The more time passes, the more energy fills the place and binds our worlds together. I must go and try to destroy that lich by myself."
        [/message]

        [message]
            speaker=Anya
            message= _ "Elynia? No! If you go he will—"
        [/message]

        [message]
            speaker=Elynia
            message= _ "I am well aware, but I’m also the only one who can wield this staff and not become corrupted by the power of the Ruby. Using it to vanquish this evil... if my own sacrifice is necessary, I will gladly accept my fate. There’s nothing left in Irdya for me now, and there will certainly be nothing if this fiend succeeds."
        [/message]

        [message]
            speaker=Anya
            message= _ "I— I—"
        [/message]

        [message]
            speaker=Elynia
            message= _ "You cannot go with me, for someone must survive the ordeal to pass the news on to our allies. You are a very smart girl, and I’m sure you all will be able to escape together with your power."
        [/message]

        [message]
            speaker=Elynia
            message= _ "I must go now."
        [/message]

        [message]
            speaker=Durvan
            message= _ "Elynia, my lady... Good luck!"
        [/message]

        [object]
            name= _ "Darkness Flight"
            description= _ "Elynia is now able to fly over chasms."
            image="icons/jewelry_butterfly_pin.png"
            [filter]
                id=Elynia
            [/filter]
            {I_EFFECT_CAN_FLY_OVER_CHASMS}
        [/object]

        # Switch leaders

        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            variable=elynia_store
        [/store_unit]
        [store_unit]
            [filter]
                id=Anya
            [/filter]
            variable=anya_store
        [/store_unit]

        [set_variables]
            name=elynia_store
            mode=merge
            [literal]
                canrecruit=no
                {IS_HERO}
            [/literal]
        [/set_variables]

        {VARIABLE anya_store.canrecruit yes}
        {CLEAR_VARIABLE anya_store.overlays}

        [unstore_unit]
            variable=elynia_store
            find_vacant=no
        [/unstore_unit]
        [unstore_unit]
            variable=anya_store
            find_vacant=no
        [/unstore_unit]

        {CLEAR_VARIABLE anya_store,elynia_store}

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Attack Mal Hekuba with Elynia")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}

            {TURNS_RUN_OUT}

            {I_PORTAL_NOTES}
        )}

        [event]
            name=moveto
            [filter]
                id=Elynia
                [filter_adjacent]
                    id=Mal Hekuba
                [/filter_adjacent]
            [/filter]

            [store_direction]
                [from]
                    [filter]
                        id=Mal Hekuba
                    [/filter]
                [/from]
                [to]
                    [filter]
                        id=Elynia
                    [/filter]
                [/to]
            [/store_direction]

            {MODIFY_UNIT (id=Mal Hekuba) facing $direction}

            [store_direction]
                [from]
                    [filter]
                        id=Elynia
                    [/filter]
                [/from]
                [to]
                    [filter]
                        id=Mal Hekuba
                    [/filter]
                [/to]
            [/store_direction]

            {MODIFY_UNIT (id=Elynia) facing $direction}

            {CLEAR_VARIABLE direction}

            [message]
                speaker=Mal Hekuba
                message= _ "And just what are you doing now?"
            [/message]

            [message]
                speaker=Elynia
                message= _ "I’m going to destroy you!"
            [/message]

            #
            # Needed so Elynia can't be hit and killed before the next sequence.
            #

            {FORCE_CHANCE_TO_HIT () (id=Elynia) 0 (
                {VARIABLE_BOOLEAN_EQUALS boss_stage_3_in_progress no}
            )}

            [event]
                name=attack end
                [filter]
                    id=Elynia
                [/filter]
                [filter_second]
                    id=Mal Hekuba
                [/filter_second]

                [fire_event]
                    name=boss stage 3
                [/fire_event]
            [/event]

            [event]
                name=attack end
                [filter_second]
                    id=Elynia
                [/filter_second]
                [filter]
                    id=Mal Hekuba
                [/filter]

                [fire_event]
                    name=boss stage 3
                [/fire_event]
            [/event]
        [/event]
    [/event]

    ############################################################################
    #
    # BOSS FIGHT STAGE 3
    #
    ############################################################################

    [event]
        name=boss stage 3
        first_time_only=yes

        [message]
            speaker=Mal Hekuba
            message= _ "How pathetic."
        [/message]

        [animate_attack]
            [filter]
                id=Elynia
            [/filter]
            [filter_second]
                id=Mal Hekuba
            [/filter_second]
            [filter_attack]
                range=ranged
            [/filter_attack]
            kill=no
            amount="$($this_unit.hitpoints * 0.75)"
            animate,fire_event=yes,no
            #experience=no
        [/animate_attack]

        [message]
            speaker=Mal Hekuba
            message= _ "Have you not learned anything after your friends’ vain sacrifices, Elynia? Have you not learned to GIVE UP?"
        [/message]

        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            kill=no
            variable=elynia_store
        [/store_unit]

        {COLOR_ADJUST 63 0 0}
        {COLOR_ADJUST 127 0 0}
        {COLOR_ADJUST 255 0 0}

#define I_HEKUBA_MUST_FACE_ELYNIA
    [store_unit]
        [filter]
            id=Mal Hekuba
        [/filter]
        variable=hekuba_store
        kill=no
    [/store_unit]

    [store_direction]
        [from]
            [filter]
                id=Mal Hekuba
            [/filter]
        [/from]
        [to]
            [filter]
                id=Elynia
            [/filter]
        [/to]
        variable=hekuba_store.facing
    [/store_direction]

    [unstore_unit]
        variable=hekuba_store
        find_vacant=no
    [/unstore_unit]

    {CLEAR_VARIABLE hekuba_store}
#enddef

#define I_ATTACK_ELYNIA
    {I_HEKUBA_MUST_FACE_ELYNIA}

    [animate_attack]
        [filter]
            id=Elynia
        [/filter]
        [filter_second]
            id=Mal Hekuba
        [/filter_second]
        [filter_attack]
            range=ranged
        [/filter_attack]
        kill=no
        amount=$this_unit.hitpoints
        animate,fire_event=yes,no
        #experience=no
    [/animate_attack]
#enddef

        {I_ATTACK_ELYNIA}

        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            kill=no
            variable=elynia_original_store
        [/store_unit]

        [object]
            silent=yes
            [filter]
                id=Elynia
            [/filter]
            {I_EFFECT_CANNOT_MOVE}
        [/object]

        {COLOR_ADJUST 127 0 0}
        {COLOR_ADJUST 63 0 0}
        {COLOR_ADJUST 0 0 0}

        #
        # TODO: baseframe for Elynia lying on the floor
        #

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Anya
            message= _ "ELYNIA!"
        [/message]

        [message]
            speaker=Mal Hekuba
            message= _ "Why won’t you just accept your fate and <b>DIE</b>?!"
        [/message]

        {REPEAT 3 ({I_ATTACK_ELYNIA})}

        [message]
            speaker=Anya
            message= _ "We must do something!"
        [/message]

        [message]
            speaker=Durvan
            message= _ "If Elynia herself doesn’t have the power to destroy that lich, I don’t think there’s anything we can do about it..."
        [/message]

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Survive until the opportunity to destroy Mal Hekuba presents itself")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}

            {I_PORTAL_NOTES}
        )}

        {VARIABLE boss_stage_3_in_progress yes}

        [event]
            delayed_variable_substitution=no
            name="side 2 turn $($turn_number + 1)"
            {I_HEKUBA_MUST_FACE_ELYNIA}
            [message]
                speaker=Mal Hekuba
                message= _ "It’s too late to stop me!"
            [/message]
        [/event]

        [event]
            delayed_variable_substitution=no
            name="side 2 turn $($turn_number + 2)"
            {I_HEKUBA_MUST_FACE_ELYNIA}
            [message]
                speaker=Mal Hekuba
                message= _ "There’s absolutely <i>nothing</i> you can do!"
            [/message]
        [/event]

        [event]
            delayed_variable_substitution=no
            name="turn $($turn_number + 3)"
            {I_HEKUBA_MUST_FACE_ELYNIA}
            [fire_event]
                name=boss stage 4
            [/fire_event]
        [/event]

        # Continue torturing Elynia every turn.
        #
        # It's not currently possible to stop unit deaths in "attacker/defender
        # hits" event handlers by any obvious means (FIXME: bug?), so we change
        # her side for the duration of side 2 turns to a dual ally side (8) in
        # order for the AI to not attack her; then Mal Hekuba's attacks are
        # animated every time in WML. Her unit is switched back to side 1's
        # control in player turns.
        #
        # This mechanism is rather unelegant, but at least permits safely
        # forcing all AI sides to ignore her for target evaluation.
        #

        [event]
            name=side 2 turn
            first_time_only=no
            [filter_condition]
                {VARIABLE_BOOLEAN_EQUALS boss_stage_3_in_progress yes}
            [/filter_condition]

            {MODIFY_UNIT (id=Elynia) side 8}

            {I_ATTACK_ELYNIA}
        [/event]

        [event]
            name=side 1 turn refresh
            first_time_only=no
            [filter_condition]
                {VARIABLE_BOOLEAN_EQUALS boss_stage_3_in_progress yes}
            [/filter_condition]

            [store_unit]
                [filter]
                    id=Elynia
                [/filter]
                variable=elynia_store
            [/store_unit]

            [set_variables]
                name=elynia_store
                mode=merge
                [literal]
                    resting=no
                    side=1
                [/literal]
            [/set_variables]

            [unstore_unit]
                variable=elynia_store
                find_vacant=no
            [/unstore_unit]

            {CLEAR_VARIABLE elynia_store}
        [/event]

        [event]
            name=side 1 turn
            first_time_only=no
            [filter_condition]
                {VARIABLE_BOOLEAN_EQUALS boss_stage_3_in_progress yes}
            [/filter_condition]

            [store_unit]
                [filter]
                    id=Elynia
                [/filter]
                variable=elynia_store
            [/store_unit]

            [set_variables]
                name=elynia_store
                mode=merge
                [literal]
                    attacks_left=0
                    moves=0
                [/literal]
            [/set_variables]

            [unstore_unit]
                variable=elynia_store
                find_vacant=no
            [/unstore_unit]

            {CLEAR_VARIABLE elynia_store}
        [/event]
    [/event]

    ############################################################################
    #
    # BOSS FIGHT STAGE 4
    #
    ############################################################################

    [event]
        name=boss stage 4
        first_time_only=no

        [store_locations]
            [filter]
                id=Elynia
            [/filter]
            variable=elynia_current_loc
        [/store_locations]

        {VARIABLE boss_stage_3_in_progress no}

        {FORCE_CHANCE_TO_HIT (
            [not]
                id=Mal Hekuba
            [/not]
        ) (id=Elynia) 20 ()}

        {FORCE_CHANCE_TO_HIT (id=Mal Hekuba) (id=Elynia) 0 ()}

        [message]
            speaker=Mal Hekuba
            message= _ "Have you had enough already?"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Mal Hekuba
            message= _ "No?"
        [/message]

        {REPLACE_SCENARIO_MUSIC "the_high_kings_march.ogg"}

        [message]
            speaker=narrator
            image="misc/blank-hex.png"
            message= _ "<i>... Don’t forget that you are here fighting for a greater cause...</i>"
        [/message]

        [message]
            speaker=Elynia
            message= _ "... I..."
        [/message]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Mal Hekuba
            message= _ "Stupid little vermin..."
        [/message]

        [remove_shroud]
            side=1
            x= 8-20, 9-11
            y=21-27,28
            terrain=!,X*,X*^*,*^X*
        [/remove_shroud]

        [redraw]
            side=1
        [/redraw]

        [modify_side]
            side=3
            controller=ai
            hidden=no
        [/modify_side]

        [unit]
            side=3
            #canrecruit=yes
            type=Shaxthal Infiltrator
            id=Ivyel
            name= _ "Ivyel"
            facing=ne
            x,y=9,28
            [modifications]
                {TRAIT_BIOMECHANICAL}
                {TRAIT_RESILIENT}
                {TRAIT_DEXTROUS}
            [/modifications]
        [/unit]

        [store_locations]
            [filter_adjacent_location]
                {I_BOSS_LOC}
            [/filter_adjacent_location]
            [not]
                [filter][/filter]
            [/not]
            variable=vacant_locs
        [/store_locations]

        [if]
            {VARIABLE_NUMERICAL_GREATER_THAN vacant_locs.length 0}
            [then]
                {VARIABLE_RANDOM r "0..$($vacant_locs.length - 1)"}
                {MOVE_UNIT (id=Ivyel) "10,12,17,23,$vacant_locs[$r].x" "27,26,24,21,$vacant_locs[$r].y"}
                {CLEAR_VARIABLE r}
            [/then]
            [else]
                {MOVE_UNIT (id=Ivyel) "10,12,17,23" "27,26,24,21"}
            [/else]
        [/if]

        {CLEAR_VARIABLE vacant_locs}

        [store_direction]
            [from]
                [filter]
                    id=Mal Hekuba
                [/filter]
            [/from]
            [to]
                [filter]
                    id=Ivyel
                [/filter]
            [/to]
        [/store_direction]

        {MODIFY_UNIT (id=Mal Hekuba) facing $direction}

        {CLEAR_VARIABLE direction}

        [message]
            speaker=Mal Hekuba
            message= _ "Ah, Ivyel! It’s good to see you again... This pitiful creature is hindering me. Could you sweep her away for me?"
        [/message]

        {VARIABLE elynia_original_store.x $elynia_current_loc.x}
        {VARIABLE elynia_original_store.y $elynia_current_loc.y}

        [unstore_unit]
            # Not removed now, we still need to restore her stats
            # before the end of the scenario!
            variable=elynia_original_store
            find_vacant=no
        [/unstore_unit]

        {CLEAR_VARIABLE elynia_current_loc}

        [heal_unit]
            [filter]
                id=Elynia
            [/filter]
            amount="full"
            animate=yes
            restore_statuses=yes
        [/heal_unit]

        [modify_unit]
            [filter]
                id=Elynia
            [/filter]
            attacks_left=$this_unit.max_attacks
            moves=$this_unit.max_moves
            level="$($this_unit.level + 1)"
        [/modify_unit]

        {I_HEKUBA_MUST_FACE_ELYNIA}

        [message]
            speaker=Mal Hekuba
            message= _ "Uh... What’s this?"
        [/message]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "... I cannot be defeated by the likes of you..."
        [/message]

        [object]
            silent=yes
            [filter]
                id=Elynia
            [/filter]
            [effect]
                apply_to="attack"
                name=faerie fire
                increase_damage=1
                increase_attacks=1
            [/effect]
            [effect]
                apply_to="hitpoints"
                heal_full=yes
                increase_total=20%
            [/effect]
            [effect]
                apply_to="image_mod"
                add="CS(32,32,32)"
            [/effect]
        [/object]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Elynia
            message= _ "... I am the Lady of Light..."
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Elynia
            message= _ "... even without my former power, I shall destroy you..."
        [/message]

        [message]
            speaker=Mal Hekuba
            message= _ "Of course not. TAKE HER DOWN!"
        [/message]

        [store_direction]
            [from]
                [filter]
                    id=Elynia
                [/filter]
            [/from]
            [to]
                [filter]
                    id=Ivyel
                [/filter]
            [/to]
        [/store_direction]

        {MODIFY_UNIT (id=Elynia) facing $direction}

        [store_direction]
            [from]
                [filter]
                    id=Ivyel
                [/filter]
            [/from]
            [to]
                [filter]
                    id=Elynia
                [/filter]
            [/to]
        [/store_direction]

        {MODIFY_UNIT (id=Ivyel) facing $direction}

        {CLEAR_VARIABLE direction}

        [message]
            speaker=Durvan
            message= _ "What’s she going to do? Does she have a plan?"
        [/message]

        [message]
            speaker=Anya
            message= _ "I am not sure. It appears she wants to attack the infiltrator creature..."
        [/message]

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Destroy Ivyel")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}

            {TURNS_RUN_OUT}

            {I_PORTAL_NOTES}
        )}

        [event]
            name=last breath
            [filter]
                id=Ivyel
            [/filter]

            [message]
                speaker=Elynia
                message= _ "This is <i>your</i> end, Mal Hekuba..."
            [/message]

            {REPLACE_SCENARIO_MUSIC "silence.ogg"}

            #
            # TODO: ensure Elynia and Ivyel are in adjacent hexes (?)
            #

            [if]
                [have_unit]
                    id=Elynia
                    [filter_adjacent]
                        id=Ivyel
                    [/filter_adjacent]
                [/have_unit]
                [then]
                    [animate_attack]
                        [filter]
                            id=Ivyel
                        [/filter]
                        [filter_second]
                            id=Elynia
                        [/filter_second]
                        [filter_attack]
                            range=melee
                        [/filter_attack]
                        kill=yes
                        animate=yes
                        fire_event=no
                        amount=1
                        #experience=no
                    [/animate_attack]
                [/then]
                [else]
                    [kill]
                        id=Ivyel
                        animate=yes
                        fire_event=no
                    [/kill]
                [/else]
            [/if]

            [message]
                speaker=Elynia
                message= _ "... Irdya is not yours to destroy!"
            [/message]

            {QUAKE ({SOUND_LIST:COLLAPSING_FACILITY})}

            {FLASH_RED (
                [harm_unit]
                    [filter]
                        id=Mal Hekuba
                    [/filter]
                    kill=no
                    amount=$this_unit.hitpoints
                    animate,fire_event=yes,no
                [/harm_unit]
            )}

            [message]
                speaker=Mal Hekuba
                message= _ "AAAAAAAARRGH!"
            [/message]

            [store_unit]
                [filter]
                    type=Verlissh Control Spire
                [/filter]
                kill=no
                variable=spires_store
            [/store_unit]

            {QUAKE ({SOUND_LIST:COLLAPSING_FACILITY})}

            {QUAKE ({SOUND_LIST:COLLAPSING_FACILITY})}

            {FOREACH spires_store k}
                {FLASH_RED (
                    {VARIABLE spires_store[$k].hitpoints 1}

                    [unstore_unit]
                        variable="spires_store[$k]"
                        find_vacant=no
                        text="$spires_store[$k].max_hitpoints" # wmllint: ignore
                        {COLOR_HARM}
                    [/unstore_unit]

                    [object]
                        [filter]
                            x,y=$spires_store[$k].x,$spires_store[$k].y
                        [/filter]
                        [effect]
                            apply_to=variation
                            name=low
                        [/effect]
                        silent=yes
                    [/object]
                )}
            {NEXT k}

            {FLASH_RED ({QUAKE ({SOUND_LIST:COLLAPSING_FACILITY})})}

            [message]
                speaker=Mal Hekuba
                message= _ "WHAT HAVE YOU DONE?"
            [/message]

            {FLASH_RED ()}

            {QUAKE ({SOUND_LIST:COLLAPSING_FACILITY})}

            {QUAKE ({SOUND_LIST:COLLAPSING_FACILITY})}

            [store_unit]
                [filter]
                    id=Anya
                [/filter]
                variable=anya_store
                kill=yes
            [/store_unit]

            [set_variables]
                name=anya_store
                mode=merge
                [literal]
                    canrecruit=no
                    {IS_HERO}
                    x,y=recall,recall
                [/literal]
            [/set_variables]

            {CLEAR_VARIABLE elynia_original_store.overlays}

            [set_variables]
                name=elynia_original_store
                mode=merge
                [literal]
                    canrecruit=yes
                    x,y=recall,recall
                [/literal]
            [/set_variables]

            [unstore_unit]
                variable=anya_store
                find_vacant=no
            [/unstore_unit]

            [kill]
                id=Elynia
            [/kill]

            [unstore_unit]
                variable=elynia_original_store
                find_vacant=no
            [/unstore_unit]

            {CLEAR_VARIABLE elynia_original_store,anya_store}

            {PUT_TO_RECALL_LIST (side=1)}

            [scroll_to_unit]
                id=Mal Hekuba
            [/scroll_to_unit]

            {QUAKE ({SOUND_LIST:COLLAPSING_FACILITY})}

            {REPEAT 3 ({FLASH_RED (
                [harm_unit]
                    [filter]
                        id=Mal Hekuba
                    [/filter]
                    kill=no
                    amount=$this_unit.hitpoints
                    animate,fire_event=yes,no
                [/harm_unit]
            )})}

            [harm_unit]
                [filter]
                    id=Mal Hekuba
                [/filter]
                kill=yes
                amount=$this_unit.hitpoints
                animate,fire_event=yes,no
            [/harm_unit]

            [remove_item]
                {I_BOSS_LOC}
            [/remove_item]

            [item]
                {I_BOSS_LOC}
                image="items/ball-magenta.png~CS(25,25,25)"
                halo="halo/heart-aura.png"
            [/item]

            {COLOR_ADJUST 67 0 0}

            [redraw][/redraw]

            [delay]
                time=250
            [/delay]

            [remove_item]
                {I_BOSS_LOC}
            [/remove_item]

            [item]
                {I_BOSS_LOC}
                image="items/ball-magenta.png~CS(50,50,50)"
                halo="halo/heart-aura.png"
            [/item]

            {COLOR_ADJUST 100 0 0}

            [redraw][/redraw]

            [delay]
                time=250
            [/delay]

            [remove_item]
                {I_BOSS_LOC}
            [/remove_item]

            [item]
                {I_BOSS_LOC}
                image="items/ball-magenta.png~CS(120,120,120)"
                halo="halo/lighthouse-aura.png"
            [/item]

            [redraw][/redraw]

            [delay]
                time=750
            [/delay]

            {COLOR_ADJUST 200 0 0}

            [delay]
                time=500
            [/delay]

            [sound]
                name={SOUND_LIST:EXPLOSION}
            [/sound]

            [remove_item]
                {I_BOSS_LOC}
            [/remove_item]

            [kill]
                {NOT_ON_RECALL_LIST}
                fire_event=no
                animate=no
            [/kill]

            [terrain]
                {I_BOSS_LOC}
                radius=1
                [or]
                    terrain=Qxua
                [/or]
                terrain=Qxu
            [/terrain]

            [sound]
                name={SOUND_LIST:EXPLOSION}
            [/sound]

            {COLOR_ADJUST 0 0 0}

            [redraw][/redraw]

            [sound]
                name={SOUND_LIST:COLLAPSING_FACILITY}
            [/sound]

            [delay]
                time=250
            [/delay]

            #
            # Fade to black
            #

#define I_NOISY_FADE_STEP _VALUE _DELAY
    {FADE_STEP ({_VALUE}) ({_DELAY})}

    [sound]
        name={SOUND_LIST:COLLAPSING_FACILITY}
    [/sound]
#enddef

            {I_NOISY_FADE_STEP -32 250}

            {I_NOISY_FADE_STEP -64 250}
            {I_NOISY_FADE_STEP -96 250}
            {I_NOISY_FADE_STEP -128 250}
            {I_NOISY_FADE_STEP -160 250}
            {I_NOISY_FADE_STEP -192 250}
            {I_NOISY_FADE_STEP -224 250}

            [store_map_dimensions][/store_map_dimensions]

            [remove_item]
                x="1-$map_size.width"
                y="1-$map_size.height"
            [/remove_item]

            [replace_schedule]
                {NEUTRAL_TOD} {SCHEDULE_LIGHTING 0 -20 -20}
            [/replace_schedule]

            [terrain]
                x="0-$($map_size.width + 1)"
                y="0-$($map_size.height + 1)"
                terrain=Xv
            [/terrain]

            [modify_side]
                side=1
                shroud=no
            [/modify_side]

            [redraw][/redraw]

            {I_NOISY_FADE_STEP -500 750}

            {CLEAR_VARIABLE map_size}

            {ENDLEVEL_QUIET}
        [/event]
    [/event]

#undef I_BOSS_LOC

    # Side 2 recruits become loyal every time.

    [event]
        name=prerecruit
        [filter]
            side=2
        [/filter]

        {VARIABLE unit.upkeep free}

        [unstore_unit]
            variable=unit
            find_vacant=no
        [/unstore_unit]
    [/event]

    [event]
        name=victory
        {CLEAR_VARIABLE boss_stage_3_in_progress,elynia_original_store}
    [/event]

#undef I_ATTACK_ELYNIA
#undef I_CORE_LOCS
#undef I_PORTAL_NOTES
#undef I_NOISY_FADE_STEP
#undef I_EFFECT_CAN_FLY_OVER_CHASMS
#undef I_HEKUBA_MUST_FACE_ELYNIA
#undef I_ANIMATE_SINGLE_SPIRE
#undef I_EFFECT_CANNOT_MOVE
[/scenario]

# kate: indent-mode normal; encoding utf-8; space-indent on;
