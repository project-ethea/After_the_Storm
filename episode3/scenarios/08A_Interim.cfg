#textdomain wesnoth-After_the_Storm

[scenario]
    id=08A_Interim
    name= _ "Interim"
    {SEGMENTED_SCENARIO}
    turns=-1
    next_scenario=08B_Destiny_part_1
    victory_when_enemies_defeated=no

    {ADD_SEGMENT "{LE /maps/08A_Interim_01.map}"
    ({INDOORS_HIVE}) ()}

    {ADD_SEGMENT "{LE /maps/08A_Interim_02.map}"
    ({INDOORS_HIVE} {SCHEDULE_LIGHTING -60 -80 0}) ()}

    {SCENARIO_MUSIC "data/core/sounds/ambient/wardrums.ogg"} {CONTINUE_PLAYING_STORY_MUSIC_FIRST}

    {STORYTXT_INTERIM}

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        save_id=Elyssa
        persistent=no
        team_name=elyssa,neutral,enemies
        user_team_name= _ "team_name^Elyssa"
        {RAGGED_FLAG}
        color=yellow

        shroud=yes

        {NO_ECONOMY}

        # wmllint: recognize Elyssa
        {CHARACTER_STATS_ELYSSA}
        canrecruit=yes
        type=Guardian of Darkness Elyssa
        variation=sword
    [/side]
    # wmllint: validate-on

    [side]
        side=2
        team_name=enemies
        user_team_name= _ "team_name^Uria"
        {CHAOS_FLAG}

        hidden=yes
        no_leader=yes

        {NO_ECONOMY}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT aggression        1.00}
            {AI_SIMPLE_ALWAYS_ASPECT leader_aggression 1.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution           0.00}
            {AI_SIMPLE_ALWAYS_ASPECT grouping            no}
        [/ai]
    [/side]

    [side]
        side=3
        team_name=neutral
        user_team_name= _ "team_name^Neutral"
        {CHAOS_FLAG}
        color=black

        controller=null
        hidden=yes
        no_leader=yes

        {NO_ECONOMY}
    [/side]

    [side]
        side=4
        team_name=doors # So they can be killed by the player.
        user_team_name= _ "team_name^Neutral"
        {CHAOS_FLAG}
        color=black

        controller=null
        hidden=yes
        no_leader=yes

        {NO_ECONOMY}
    [/side]

    [side]
        side=5
        team_name=gatekeeper
        user_team_name= _ "team_name^Gatekeeper"
        {RAGGED_FLAG}
        color=brown

        controller=null
        hidden=yes
        no_leader=yes

        {NO_ECONOMY}
    [/side]

    # Goals:
    #
    #   com1        Communication room (1)
    #   trans1      Transporter before meeting Gatekeeper
    #   com2        Communication room (2)
    #   mem1        Memories cave entrance at 33,29
    #   mem2        Memories cave entrance around 22,22
    #   mem3        Room at 24,16
    #   mem4        Room at 13,30
    #   final       End-of-scenario following touchplate at 14,12

    [event]
        name=prestart

        {VARIABLE have_argans_missing_pages no}

        {VARIABLE current_goal com1}

        {SWITCH_FLOOR 1}

        [store_starting_location]
            side=1
        [/store_starting_location]

        [teleport]
            [filter]
                id=Elyssa
            [/filter]
            x,y=$location.x,$location.y
        [/teleport]

        [hide_unit][/hide_unit]

        {CLEAR_CAVE_SHROUD (
            x,y=41,30
            radius=5
        )}

        {BLACK_SCREEN}

        {DISALLOW_END_TURN}
    [/event]

    {UNLIMITED_PLAYER_MOVES}

#define INT_GUARDIAN _SIDE _TYPE _X _Y
    {GENERIC_UNIT ({_SIDE}) ({_TYPE}) ({_X}) ({_Y})} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
#enddef

    [event]
        name=setup floor 1
        first_time_only=yes

        {INT_GUARDIAN 3 (Abomination) 54 40} {FACING nw}

        {INT_GUARDIAN 3 (Shaxthal Worm) 14 21} {FACING se} {PALETTE shaxthal_drone_base shaxthal_drone_purple}
        {INT_GUARDIAN 3 (Shaxthal Worm) 18 25} {FACING nw} {PALETTE shaxthal_drone_base shaxthal_drone_purple}
        {INT_GUARDIAN 3 (Shaxthal Worm) 10 16} {FACING se} {PALETTE shaxthal_drone_base shaxthal_drone_purple}
        {INT_GUARDIAN 3 (Shaxthal Worm) 10 15} {FACING sw} {PALETTE shaxthal_drone_base shaxthal_drone_purple}

        {INT_GUARDIAN 3 (Shaxthal Drone) 61 34} {FACING nw} {PALETTE shaxthal_drone_base shaxthal_drone_purple}

        {INT_GUARDIAN 3 (Shaxthal Drone) 25 21} {FACING sw} {PALETTE shaxthal_drone_base shaxthal_drone_purple}

        {INT_GUARDIAN 3 (Shaxthal Sentry Drone) 15 24} {FACING ne} {PALETTE shaxthal_drone_base shaxthal_drone_purple}

        {INT_GUARDIAN 3 (Shaxthal Assault Drone) 54 33} {FACING ne} {PALETTE shaxthal_drone_surface shaxthal_drone_purple}

        {INT_GUARDIAN 3 (Leech) 25 36}
        {INT_GUARDIAN 3 (Leech) 22 37}

        {INT_GUARDIAN 3 (Leech)  7 29}
        {INT_GUARDIAN 3 (Leech)  5 31}
        {INT_GUARDIAN 3 (Leech)  7 35}
        {INT_GUARDIAN 3 (Leech) 15 33}
        {INT_GUARDIAN 3 (Leech) 13 35}

        {INT_GUARDIAN 3 (Fungoid)  6 20}
        {INT_GUARDIAN 3 (Fungoid) 17 14}
    [/event]

#undef INT_GUARDIAN

    #
    # This setup floor 1 event handler deals with [item]s and other stuff
    # that cannot be stored during transitions, therefore it needs to run
    # multiple times.
    #

    [event]
        name=setup floor 1
        first_time_only=no

        {PLACE_IMAGE items/book1.png  3 32}

        {PLACE_IMAGE items/bones.png 10 35}

        {PLACE_IMAGE scenery/banner-yechnagoth-standing.png 25 25}

        {ITEM_TOUCHPLATE 38 35}

        {ITEM_CRYSTAL_GLYPH 28-30,29 39,40}

        #{ITEM_CRYSTAL_GLYPH 31 36}
        #{ITEM_CRYSTAL_GLYPH 33 40}
        #{ITEM_CRYSTAL_GLYPH 32 41}
        #{ITEM_CRYSTAL_GLYPH 22 41}

        {PLACE_IMAGE items/crystal-communicator.png 56 22}
        {ITEM_CRYSTAL_GLYPH 56 22}

        {ITEM_CRYSTAL_GLYPH_POWERUP 66 34}

        {PLACE_IMAGE items/altar-evil.png      27 15}

        {PLACE_IMAGE scenery/blood-trail-1.png 14  6}

        {PLACE_IMAGE items/coffin-closed.png 13  7}
        {PLACE_IMAGE items/coffin-closed.png 15  7}
        {PLACE_IMAGE items/coffin-closed.png 13  8}
        {PLACE_IMAGE items/coffin-closed.png 15  8}
        #{PLACE_IMAGE items/coffin-closed.png 13  9}
        #{PLACE_IMAGE items/coffin-closed.png 15  9}

        {PLACE_IMAGE items/chest-plain-closed.png 10  5}
        {PLACE_IMAGE items/chest-plain-closed.png 16  3}
        {PLACE_IMAGE items/chest-plain-open.png   11  8}

        {PLACE_IMAGE items/box.png 16 13}
        {PLACE_IMAGE items/box.png 58 39}

        {PLACE_IMAGE items/barrel.png 23 15}

        {PLACE_IMAGE items/bones.png 18 24}

        {PLACE_IMAGE items/ring-brown.png 57 30}

        {PLACE_IMAGE scenery/slab1.png 12 16}

        {PLACE_IMAGE items/burial.png 13 16}

        {PLACE_IMAGE scenery/trapdoor-closed.png 27 13}

        {PLACE_IMAGE scenery/trash.png      10 32}
        {PLACE_IMAGE items/ball-magenta.png 10 32}

        {PLACE_IMAGE items/bonestack.png 42 40}

        {PLACE_IMAGE items/potion-blue.png 12  8}
    [/event]

    [event]
        name=start

        {LOCK_VIEW}

        # NOTE: fake empty objectives screen. For some reason [show_objectives]
        # does nothing when there aren't any objectives set.

        [transient_message]
            caption= _ "Interim"
            message={TSTR_NO_OBJECTIVES_AVAILABLE}
        [/transient_message]

        [delay]
            time=2000
        [/delay]

        {REPLACE_SCENARIO_MUSIC "underground.ogg"}

        {FADE_IN}

        [unhide_unit][/unhide_unit]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            # po: The narrator refers to Elyssa in second person throughout
            # po: this scenario.
            message= _ "That is not entirely accurate. Of course you do have more specific goals in mind tonight, the longest of nights on Irdya.

Ever since you were brought back to life by the man who once was Uria’s first, you have done nothing but comply with the wishes of those responsible for your prolonged lifespan.

Such is the price of cheating death, you think to yourself."
        [/message]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            # po: The 'Seer' is female, and no, she is not Valen.
            message= _ "But the Seer told you about things to come. Things that did not make much sense to you at the time; things you promptly disregarded as long-winded prophetic nonsense, the kind that necessitates a very specific mindset to digest and interpret. You have lived for nearly two hundred years and you have not yet managed to understand half of the Seer’s ramblings; in the meantime, you have forgotten most of the other half."
        [/message]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Yet she sometimes provides you with clear instructions for you to execute as the Guardian of Darkness you unwillingly became. As the descendant of Delethia she claims to be, the Seer is well versed in the domains of the Ten she was created to serve. She knows about Darkness and its association with the matters of mind, and she willingly allows you to exploit that aspect and gnaw at her thick mental barrier when the situation calls for it. But instructions are all you ever find in the vast void of her thoughts.

Executing instructions as the machine you are is all you ever do. But you were promised a change. You have a couple of contracts to fulfill first, though.

What will you do?"
        [/message]

        [scroll_to]
            x,y=45,29
        [/scroll_to]

        {HIGHLIGHT_GOAL x,y=45,29}

        [scroll_to_unit]
            id=Elyssa
        [/scroll_to_unit]

        {OBJECTIVES (
            side=1
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Proceed to the meeting chamber")}

            {UNLIMITED_LEADER_MOVES_NOTE}
            {OBJECTIVE_NOTE {NO_GOLD_CARRYOVER_NOTE} }
        )}

        {UNLOCK_VIEW}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Elyssa
            [filter_location]
                [filter_adjacent_location]
                    terrain=*^Zok
                [/filter_adjacent_location]
            [/filter_location]
        [/filter]

        [allow_undo][/allow_undo]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "There is nothing of interest whence you came, really. You should really get moving now."
        [/message]
    [/event]

    [event]
        name=prestart

        # wmllint: markcheck off

        [set_variables]
            name=reprimands
            mode=replace
            [literal]
                msg= _ "You have a very specific objective in mind at this particular time, and you are not really the type that gets distracted this easily. What were you thinking?

You purposefully turn around and go back to business."
            [/literal]
            [literal]
                msg= _ "This is not where you should be heading right now, and you know it. Still, you cannot resist the urge to take a glance at this striking scenery. Who ever knew that ancient ruins could look this good? Truly, nature itself is the best architect that there is."
            [/literal]
            [literal]
                msg= _ "You take a glance at the wondrous handicraft on the enchanted gate. It is largely rusted and you can barely make out the details, and yet, your eyes are affixed.

Perhaps you should get back to whatever you were doing."
            [/literal]
            [literal]
                msg= _ "It is an old enchanted gate, of course. You are not completely sure why you bothered to put these spells on most of the gates in this level, actually, but you are prone to wasting your time on frivolous activities like that on occasion, while nobody is around. Then again, the faint glow on it is unusually mesmerizing.

Time to go back to doing something productive."
            [/literal]
            [literal]
                msg= _ "As much as you wish you had the ability, you cannot stop time, and the events foretold to happen on this night need some help to happen. Your mission here is to provide that necessary assistance to fate, so you really ought to stop staring at the enchanted gate now and get back to work."
            [/literal]
        [/set_variables]

        # wmllint: markcheck on
    [/event]

    [event]
        name=reprimand player
        first_time_only=no

        {RANDOM "0..$($reprimands.length - 1)"}

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=$reprimands[$random].msg
        [/message]

        {CLEAR_VARIABLE random}
    [/event]

#define INT_MAY_NOT_PASS _CURRENT_GOAL _LOCATION
    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Elyssa
            [filter_location]
                {_LOCATION}
            [/filter_location]
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal {_CURRENT_GOAL} }
        [/filter_condition]

        [fire_event]
            name=reprimand player
        [/fire_event]

        [allow_undo][/allow_undo]
    [/event]
#enddef

    {INT_MAY_NOT_PASS com1 (
        [filter_adjacent_location]
            x,y=33,29
            [or]
                x=45,46,47
                y=36,35,34
            [/or]
        [/filter_adjacent_location]
    )}

#define INT_SLF_BRAZIERS_ENTRANCE
    x=50,52
    y=25,26
#enddef

#define INT_SLF_BRAZIERS_CHAMBER
    x=52,56,60,60,56,52
    y=20,18,20,24,26,24
#enddef

#define INT_LIT_BRAZIERS _SLF
    [terrain]
        {_SLF}
        layer=overlay
        terrain=^Bz
    [/terrain]
#enddef

#define INT_UNLIT_BRAZIERS _SLF
    [terrain]
        {_SLF}
        layer=overlay
        terrain=^Bzu
    [/terrain]
#enddef

#define INT_COM_CHAMBER_SLF
    x=52-60,53-60
    y=18-24,25-26
#enddef

#define INT_COM_TRIGGER_SLF
    x,y=56,22
#enddef

    [event]
        name=moveto
        [filter]
            id=Elyssa
            {INT_COM_CHAMBER_SLF}
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal com1}
        [/filter_condition]

        # Block the chamber exit.

        [terrain]
            x,y=50,26
            layer=overlay
            terrain=^Xo
        [/terrain]

        # Lit the entrance braziers

        {INT_LIT_BRAZIERS ({INT_SLF_BRAZIERS_ENTRANCE})}

        [redraw][/redraw]

        [scroll_to]
            x,y=56,22
        [/scroll_to]

        {HIGHLIGHT_GOAL x,y=56,22}

        [scroll_to_unit]
            id=Elyssa
        [/scroll_to_unit]

        {OBJECTIVES (
            side=1
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Activate the communicator")}

            {UNLIMITED_LEADER_MOVES_NOTE}
            {OBJECTIVE_NOTE {NO_GOLD_CARRYOVER_NOTE} }
        )}
    [/event]

#define INT_UNLIT_BRAZIERS_ON_CHAMBER_EXIT
    [event]
        name=moveto
        [filter]
            id=Elyssa
            x=37-50
            y=26-34
        [/filter]

        # Exit chamber

        {INT_UNLIT_BRAZIERS ({INT_SLF_BRAZIERS_ENTRANCE})}

        [redraw][/redraw]

        [allow_undo][/allow_undo]
    [/event]
#enddef

#define INT_CC _VARIATION _ID _NAME _X _Y
    [unit]
        side=3
        type=Communicator Controller

        variation={_VARIATION}

        id={_ID}
        name={_NAME}

        x={_X}
        y={_Y}

        animate=yes
    [/unit]
#enddef

#define INT_CC_ACTIVATE_VISUALS
    # Lit the chamber braziers

    {INT_LIT_BRAZIERS ({INT_SLF_BRAZIERS_CHAMBER})}

    [redraw][/redraw]

    # Lighten up the communicator thing

    [store_items]
        x,y=$x1,$y1
    [/store_items]

    [remove_item]
        x,y=$x1,$y1
    [/remove_item]

    {FOREACH items k}
        [set_variables]
            name=lit_item
            mode=replace
            to_variable="items[$k]"
        [/set_variables]

        {VARIABLE lit_item.image "$lit_item.image|~CS(64,64,64)"}

        # 1.10 and earlier always redraw after each [item] action.
#ifver WESNOTH_VERSION >= 1.11.0
        {VARIABLE lit_item.redraw no}
#endif

        [insert_tag]
            name=item
            variable=lit_item
        [/insert_tag]
    {NEXT k}

    {CLEAR_VARIABLE lit_item}

    [redraw]
        side=1
    [/redraw]
#enddef

    [event]
        name=moveto
        [filter]
            id=Elyssa
            {INT_COM_TRIGGER_SLF}
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal com1}
        [/filter_condition]

        {LOCK_VIEW}

        {INT_CC_ACTIVATE_VISUALS}

        [terrain]
            x=56,58
            y=20,23
            layer=overlay
            terrain=^Ii
        [/terrain]

        [redraw][/redraw]

        [terrain]
            x=58
            y=21
            layer=overlay
            terrain=^Ii
        [/terrain]

        [redraw][/redraw]

        [terrain]
            x=54
            y=21
            layer=overlay
            terrain=^Ii
        [/terrain]

        [redraw][/redraw]

        #
        # Some cheap flickering effect.
        #

        [remove_terrain_overlays]
            x,y=56,20
        [/remove_terrain_overlays]

        [redraw][/redraw]

        [delay]
            time=250
        [/delay]

        [terrain]
            x,y=56,20
            layer=overlay
            terrain=^Ii
        [/terrain]

        [redraw][/redraw]

        [delay]
            time=750
        [/delay]

        [remove_terrain_overlays]
            x,y=56,20
        [/remove_terrain_overlays]

        [redraw][/redraw]

        #[delay]
        #    time=100
        #[/delay]

        [terrain]
            x,y=56,20
            layer=overlay
            terrain=^Ii
        [/terrain]

        [redraw][/redraw]

        #
        # End flickering.
        #

        {MOVE_UNIT id=Elyssa 56 21}

        {MODIFY_UNIT id=Elyssa facing nw}

        [delay]
            time=1000
        [/delay]

        {INT_CC uria Uria _"Uria" 56 20} {FACING se}

        #{REPLACE_SCENARIO_MUSIC "end.ogg"}

        [delay]
            time=1000
        [/delay]

        #
        # Talk.
        #

        [message]
            speaker=Uria
            message= _ "Ah, it is you."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "I believe you wanted to see me, my lady."
        [/message]

        [message]
            speaker=Uria
            message= _ "That is correct. Have the preparations for my arrival on Ethea been completed yet? I believe there is a certain nuisance remaining to be eliminated."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "I have been awaiting your order to destroy the Gatekeeper, my lady."
        [/message]

        [message]
            speaker=Uria
            message= _ "Hm, hm, I appreciate your obedience, but in this case I would have preferred if you did it as soon as the breach was opened."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "I assumed you would wait until you gathered further information on Valdir’s movements, my lady. Does he not..."
        [/message]

        [message]
            speaker=Uria
            message= _ "Yes. He is already there."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Uria
            # Make sure French-hating linguists have another reason to hate Uria.
            message= _ "But he is not cognizant of our schemes, is he? His people never noticed the supplies and equipment we stole from their world, so I am free to advance my plans while they are distracted. Do not forget that I need to find the missing piece of that damned puzzle."
        [/message]

        [message]
            speaker=Elyssa
            # po: The Body of the Union
            message= _ "... the Body..."
        [/message]

        [message]
            speaker=Uria
            message= _ "Will you please stop wasting everyone’s time and destroy that hideous thing at once? And... once you are done, come back to me."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Yes. As you command, my lady."
        [/message]

        #
        # End talk.
        #

        [kill]
            animate=yes
            id=Uria
        [/kill]

        [remove_item]
            x,y=$x1,$y1
        [/remove_item]

        {FOREACH items k}
            # 1.10 and earlier always redraw after each [item] action.
#ifver WESNOTH_VERSION >= 1.11.0
            {VARIABLE lit_item.redraw no}
#endif

            [insert_tag]
                name=item
                variable="items[$k]"
            [/insert_tag]
        {NEXT k}

        {CLEAR_VARIABLE items}

        [remove_terrain_overlays]
            x=54,56,58,58
            y=21,20,21,23
        [/remove_terrain_overlays]

        {INT_UNLIT_BRAZIERS ({INT_SLF_BRAZIERS_CHAMBER})}

        [redraw]
            side=1
        [/redraw]

        [unit]
            side=2
            canrecruit=yes
            type=Lumeril Guard
            id=Halbadrel
            name= _ "Halbadrel"
            x,y=46,34
            facing=nw
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [unit]
            side=2
            x,y=47,34
            type=Demon Zephyr
            gender=female
            id=Sheelevrea
            name= _ "Sheelevrea"
            upkeep=free
            facing=nw
            [modifications]
                {TRAIT_DEXTROUS}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [unit]
            side=2
            x,y=45,35
            type=Gutwrencher Imp
            id=Kraador
            name= _ "Kraador"
            upkeep=free
            facing=ne
            [modifications]
                {TRAIT_SLOW}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]

        #{REPLACE_SCENARIO_MUSIC "underground.ogg"}

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "You guess it cannot be helped. Things are going to get more complicated than you wanted. As usual."
        [/message]

        # Unblock the chamber exit.

        [remove_terrain_overlays]
            x,y=50,26
        [/remove_terrain_overlays]

        {CLEAR_CAVE_SHROUD (
            x,y=66,34
            radius=2
        )}

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=66,34
        [/scroll_to]

        {HIGHLIGHT_GOAL x,y=66,34}

        [scroll_to_unit]
            id=Elyssa
        [/scroll_to_unit]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "These security measures are inconvenient at times. If that stupid faerie and her accomplices did not have access to teleport spells you would be able to instantly go to the breach site and deal with your target. But it cannot be helped. The transport glyph awaits. You really hope to not stumble upon any undesirable vermin along the way."
        [/message]

        {MOVE_UNIT id=Elyssa 54 24}

        [delay]
            time=750
        [/delay]

        #
        # Remove the 'sword' variation. This is not exactly trivial and
        # it should be easier to just replace Elyssa's unit. However, we
        # want to avoid a [kill] + [unit] sequence that could cause her
        # to blink for a moment right after the [kill] action.
        #

        [unit]
            side=1
            {CHARACTER_STATS_ELYSSA}
            canrecruit=yes
            type=Guardian of Darkness Elyssa
            x,y=54,24
            facing=sw
            to_variable=elyssa_store
        [/unit]

        [unstore_unit]
            variable=elyssa_store
            find_vacant=no
        [/unstore_unit]

        [scroll_to_unit]
            id=Elyssa
        [/scroll_to_unit]

        [redraw][/redraw]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Of course, you are not <i>too</i> concerned about it."
        [/message]

        {VARIABLE current_goal trans1}

        {OBJECTIVES (
            side=1
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Proceed to the transport glyph")}

            {UNLIMITED_LEADER_MOVES_NOTE}
            {OBJECTIVE_NOTE {NO_GOLD_CARRYOVER_NOTE} }
        )}

        {UNLOCK_VIEW}

        {INT_UNLIT_BRAZIERS_ON_CHAMBER_EXIT}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Elyssa
            {INT_COM_TRIGGER_SLF}
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal trans1}
        [/filter_condition]

        [allow_undo][/allow_undo]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Your mission now is to slay the Gatekeeper, not to bother Uria again before you are done — that would be absurdly reckless."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=46,34
                radius=6
            [/filter_location]
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal trans1}
        [/filter_condition]

        [message]
            speaker=Sheelevrea
            message= _ "Hahahaha! Look, it is Uria’s little pet! Isn’t she adorable?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "You are obstructing the way. Get out."
        [/message]

        [message]
            speaker=Halbadrel
            message= _ "As you wish."
        [/message]

        {MOVE_UNIT id=Halbadrel 46 32}

        [message]
            speaker=Sheelevrea
            message= _ "Hee hee hee!" # wmllint: no spellcheck
        [/message]

        {MOVE_UNIT id=Elyssa 46 34}

        [sound]
            name=gate.ogg
        [/sound]

        [remove_terrain_overlays]
            x=45,46-47
            y=36,35
        [/remove_terrain_overlays]

        [redraw]
            side=1
        [/redraw]

        {MOVE_UNIT id=Elyssa 46 36}

        [redraw]
            side=1
        [/redraw]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Elyssa
            x,y=57,30
        [/filter]

        [allow_undo][/allow_undo]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "An old, rusted ring with no special powers whatsoever. It is absolutely useless to you."
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Elyssa
            x,y=58,39
        [/filter]

        [allow_undo][/allow_undo]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Just an old crate. There is nothing of value in it."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Elyssa
            x,y=66,34
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal trans1}
        [/filter_condition]

        # For later.

        [store_unit]
            [filter]
                id=Halbadrel
                [or]
                    id=Sheelevrea
                [/or]
                [or]
                    id=Kraador
                [/or]
            [/filter]
            variable=vermin_store
            kill=yes
        [/store_unit]

        {BUG_ON ({VARIABLE_NUMERICAL_NOT_EQUALS vermin_store.length 3}) ()}

        {SWITCH_FLOOR 2}

        #
        # The cutscene is played by the enter floor 2 event handler
        # invoked above. Once it is finished we return to floor 1
        # immediately.
        #

        {SWITCH_FLOOR 1}
    [/event]

    [event]
        name=leave floor 1

        [store_unit]
            [filter]
                id=Elyssa
            [/filter]
            variable=elyssa_store
            kill=yes
        [/store_unit]

        [store_unit]
            [filter]
                [filter_location][/filter_location]
            [/filter]
            variable=onmap_units_store
            kill=yes
        [/store_unit]

        {FADE_TO_BLACK}

        [fade_out_music][/fade_out_music]

        [store_shroud]
            side=1
            variable=floor1_shroudmap
        [/store_shroud]
    [/event]

    [event]
        name=setup floor 2

        [scroll_to]
            x,y=36,25
            {WARP}
        [/scroll_to]
    [/event]

    [event]
        name=enter floor 2

        [remove_shroud]
            side=1
            # x=0-1000
            # y=0-1000
        [/remove_shroud]

        {FADE_IN}

        [store_locations]
            terrain=Cud^Xo
            variable=spire_locs
        [/store_locations]

        {FOREACH spire_locs k}
            [unit]
                type=Verlissh Control Spire
                side=3
                x,y=$spire_locs[$k].x,$spire_locs[$k].y
                upkeep=free
                ai_special=guardian
                [modifications]
                    [object]
                        silent=yes
                        [effect]
                            apply_to=remove_attacks
                            name=noctum
                        [/effect]
                    [/object]
                [/modifications]
            [/unit]
        {NEXT k}

        {CLEAR_VARIABLE spire_locs}

        [store_starting_location]
            side=5
        [/store_starting_location]

        [unit]
            side=5
            canrecruit=yes
            type=Gatekeeper
            id=Ethealim
            name=" " # wmllint: ignore
            x,y=$location.x,$location.y
            facing=se
        [/unit]

        [hide_unit]
            side=5
        [/hide_unit]

        {CLEAR_VARIABLE location}

        {VARIABLE elyssa_store.facing nw}

        [unstore_unit]
            variable="elyssa_store"
            find_vacant=yes
            x,y=36,25
        [/unstore_unit]

        [redraw][/redraw]

        #
        # Do not clear elyssa_store, since it is used again
        # when returning to the first floor.
        #

        [fire_event]
            name=breach cutscene
        [/fire_event]
    [/event]

    [event]
        name=breach cutscene

        {MOVE_UNIT id=Elyssa 33 24}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "The unnatural air in this place makes you feel uneasy."
        [/message]

        [delay]
            time=750
        [/delay]

        {MOVE_UNIT id=Elyssa 31 23}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "On the other side of the breach, the Gatekeeper on Ethea awaits..."
        [/message]

        [store_starting_location]
            side=5
        [/store_starting_location]

        [remove_terrain_overlays]
            x,y=$location.x,$location.y
            radius=1
        [/remove_terrain_overlays]

        {CLEAR_VARIABLE location}

        [unhide_unit]
            side=5
        [/unhide_unit]

        [redraw][/redraw]

        [scroll_to_unit]
            id=Ethealim
        [/scroll_to_unit]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Elyssa
            scroll=no
            message= _ "... There is no going back now..."
        [/message]

        [scroll_to_unit]
            id=Elyssa
            {WARP}
        [/scroll_to_unit]

        {MOVE_UNIT id=Elyssa 25 20}

#define INT_AURA_F2_REMOVE
    [remove_item]
        x,y=25,20
    [/remove_item]
#enddef

        #
        # We cannot change a unit's halo in 1.10, so use [item]
        # instead.
        #

#define INT_AURA_F2 _OPACITY
    {INT_AURA_F2_REMOVE}

    [item]
        x,y=25,20
        image="misc/blank-hex.png"
        halo="halo/heart-aura.png~O("+{_OPACITY}+")"
    [/item]
#enddef
        {INT_AURA_F2 0.2}

        [delay]
            time=1250
        [/delay]

        {FLASH_RED ()}

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "...!"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image="misc/blank-hex.png"
            message= _ "<i>Have you forgotten who you are?</i>"
        [/message]

        [delay]
            time=750
        [/delay]

        {MODIFY_UNIT id=Ethealim name _"Ethealim"}

        [scroll_to_unit]
            id=Ethealim
        [/scroll_to_unit]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Ethealim
            message= _ "Are you deceiving yourself?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Who are you?"
        [/message]

        [message]
            speaker=Ethealim
            scroll=no
            message= _ "Who are you?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "I asked the question first. I was told Gatekeepers are not sentient creatures."
        [/message]

        [message]
            speaker=Ethealim
            scroll=no
            message= _ "You let yourself be deceived by appearances in spite of the aspect you control. Why is that?"
        [/message]

#define INT_ILLUSION_STEP _N
    {RED_SCREEN}

    [object]
        silent=yes
        [filter]
            id=Elyssa
        [/filter]
        [effect]
            apply_to=variation
            name="illusion"+{_N}
        [/effect]
    [/object]

    [redraw][/redraw]

    [delay]
        time=250
    [/delay]

    {RESET_SCREEN}
#enddef

        [sound]
            name=lightning.ogg
        [/sound]

        {INT_ILLUSION_STEP 1}

        {INT_AURA_F2_REMOVE}

        [redraw][/redraw]

        # Disable regular portrait.
        # FIXME: add a custom portrait?
        {MODIFY_UNIT id=Elyssa profile unit_image}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Ethealim
            scroll=no
            message= _ "As the child of Uria and heiress of Merthiaal you are, you harbor great potential."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "You are mistaken. I am neither thing."
        [/message]

        [message]
            speaker=Ethealim
            scroll=no
            message= _ "Are you not human? All humans everywhere are children of Uria."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "I am not human. Not anymore."
        [/message]

        {INCIDENTAL_MUSIC "overlive.ogg"}

        {INT_ILLUSION_STEP 2}

        [message]
            speaker=Ethealim
            scroll=no
            # po: 'designed' is used here in the sense of 'planned', 'intended', etc.
            # po: The sentence here is supposed to imply the existence of one or more deities
            # po: weaving every character's fate since before they were even born.
            message= _ "The heart of Merthiaal lies within you as designed, but that does not change your true being."
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "I was not destined by the Tree to inherit Darkness... but that’s irrelevant either way. I have transcended the definition of a ‘human’ and become something different."
        [/message]

        [message]
            speaker=Ethealim
            scroll=no
            message= _ "Have you? What does your heart tell you?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "My... heart..."
        [/message]

        [message]
            speaker=Ethealim
            scroll=no
            message= _ "The path of Darkness is a convoluted and deceptive one. Whereas your predecessor placed an excessive emphasis on her feelings to the detriment of rationality, you are doing the exact opposite. A true Guardian of Light or Darkness needs to establish a balance between both facets. And you..."
        [/message]

        [message]
            speaker=Ethealim
            scroll=no
            message= _ "... your very sense of identity has been <i>broken</i>..."
        [/message]

        {INT_ILLUSION_STEP 3}

        [message]
            speaker=Ethealim
            scroll=no
            message= _ "Uria’s corrupting influence is hampering your personal growth and tearing your essence of self apart, just as she wants."
        [/message]

        {INT_ILLUSION_STEP 4}

        {INT_AURA_F2 0.2}

        [message]
            speaker=Ethealim
            scroll=no
            message= _ "Tearing souls apart is what a corrupted Guardian of Life does best. But... can <i>you</i> escape her influence?"
        [/message]

        {INT_ILLUSION_STEP 5}

        {INT_AURA_F2 0.4}

        [message]
            speaker=Ethealim
            scroll=no
            message= _ "Can you escape her destructive grasp..."
        [/message]

        {INT_ILLUSION_STEP 6}

        {INT_AURA_F2 0.8}

        [message]
            speaker=Ethealim
            scroll=no
            message= _ "... before she utterly destroys your very self and seizes Darkness through your empty shell?"
        [/message]

        [delay]
            time=375
        [/delay]

        {INT_AURA_F2 1.0}

        [delay]
            time=375
        [/delay]

        [message]
            speaker=Elyssa
            image=$elyssa_store.profile
            message= _ "(<i>frantic</i>) Bind the soul to stone— turn the memories to dust— erase the spirit— shed the hollow SHELL!"
        [/message]

        # Remove the illusion.

        [unstore_unit]
            variable="elyssa_store"
            find_vacant=no
            x,y=25,20
        [/unstore_unit]

        [fade_out_music]
            duration=250
        [/fade_out_music]

        [scroll_to_unit]
            id=Ethealim
            {WARP}
        [/scroll_to_unit]

        #[message]
        #    speaker=narrator
        #    caption= _ "Argan"
        #    image=misc/blank-hex.png
        #    message= _ "<i>... Elyssa...</i>"
        #[/message]

        [delay]
            time=250
        [/delay]

        {RED_SCREEN}

        [hide_unit][/hide_unit]

        {INT_AURA_F2_REMOVE}

        [redraw][/redraw]

        [store_unit]
            [filter]
                id=Ethealim
            [/filter]
            kill=yes
            variable=gatekeeper_store
        [/store_unit]

        [sound]
            name=$gatekeeper_store.die_sound
        [/sound]

        [delay]
            time=1500
        [/delay]

        [sound]
            name="thunderstick.ogg"
        [/sound]

        [delay]
            time=500
        [/delay]

        [sound]
            name="thunderstick.ogg"
        [/sound]

        [delay]
            time=500
        [/delay]

        [terrain_mask]
            x,y=1,1
            {MASK 08A_Interim_02_1.mask}
            border=yes
        [/terrain_mask]

        [redraw][/redraw]

        {RESET_SCREEN}

        [unhide_unit][/unhide_unit]

        [sound]
            name="thunder3.wav"
        [/sound]

        {QUAKE ("explosion-big.ogg")}

        [delay]
            time=2000
        [/delay]

        [scroll_to_unit]
            id=Elyssa
        [/scroll_to_unit]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "..."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "Damn you, Zhangor. Damn you and your stinking lies."
        [/message]

        [delay]
            time=500
        [/delay]

        {MOVE_UNIT id=Elyssa 36 25}

#undef INT_AURA_F2
#undef INT_AURA_F2_REMOVE
    [/event]

    [event]
        name=leave floor 2

        [kill][/kill]

        {FADE_TO_BLACK}

        [place_shroud]
            side=1
            # everywhere
        [/place_shroud]
    [/event]

    [event]
        name=enter floor 1
        #
        # This event handler should only run on 1 -> 2 floor transitions.
        #
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal trans1}
        [/filter_condition]
        #[filter_condition]
        #    {VARIABLE_NUMERICAL_NOT_EQUALS elyssa_store.length 0}
        #    {VARIABLE_NUMERICAL_NOT_EQUALS onmap_units_store.length 0}
        #[/filter_condition]

        [scroll_to]
            x,y=$elyssa_store.x,$elyssa_store.y
            {WARP}
        [/scroll_to]

        [set_shroud]
            side=1
            shroud_data=$floor1_shroudmap
        [/set_shroud]

        [redraw]
            side=1
        [/redraw]

        {FADE_IN}

        {FOREACH onmap_units_store k}
            [unstore_unit]
                variable="onmap_units_store[$k]"
                find_vacant=yes
                check_passability=no
            [/unstore_unit]
        {NEXT k}

        {FOREACH vermin_store k}
            {VARIABLE vermin_store[$k].facing se}
            [if]
                {VARIABLE_LEXICAL_EQUALS vermin_store[$k].id Halbadrel}
                [then]
                    {VARIABLE vermin_store[$k].x 46}
                    {VARIABLE vermin_store[$k].y 36}
                [/then]
            [/if]
            [if]
                {VARIABLE_LEXICAL_EQUALS vermin_store[$k].id Sheelevrea}
                [then]
                    {VARIABLE vermin_store[$k].x 47}
                    {VARIABLE vermin_store[$k].y 36}
                [/then]
            [/if]
            [if]
                {VARIABLE_LEXICAL_EQUALS vermin_store[$k].id Kraador}
                [then]
                    {VARIABLE vermin_store[$k].x 45}
                    {VARIABLE vermin_store[$k].y 37}
                [/then]
            [/if]

            [unstore_unit]
                variable="vermin_store[$k]"
                find_vacant=yes
                check_passability=no
            [/unstore_unit]
        {NEXT k}

        #
        # Elyssa should be at the transporter glyph.
        #

        {VARIABLE elyssa_store.facing nw}

        [unstore_unit]
            variable="elyssa_store"
            find_vacant=yes
        [/unstore_unit]

        [redraw][/redraw]

        {CLEAR_VARIABLE elyssa_store,onmap_units_store,vermin_store}

        {REPLACE_SCENARIO_MUSIC "into_the_shadows.ogg"}

        [delay]
            time=1250
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Of course, she was not counting on the spell Uria taught you for the mission. Or was she?"
        [/message]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "You have not felt so stupid in a long time. Zhangor’s ruse was just too obvious to fall for it — Uria would not have asked you to destroy the Gatekeeper yourself if she did not fear her for some reason. Perhaps if she had such an introspective conversation with the Gatekeeper, things would have changed to some degree. Perhaps...

But no. You are well familiarized with the demoness and her childlike stubbornness. Whatever advice the Gatekeeper might have had for her would have gone unheeded. That is, assuming Uria would have given her a chance to speak in the first place."
        [/message]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Maybe you were too hasty in disposing of the creature, though. She seemed to be genuinely trying to help you for some reason. The illusion she cast on you seemed as real as it was intensely painful — not that you are are not accustomed to pain yourself, but... you admit that you were afraid for a moment."
        [/message]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Regardless of the intentions of Delethia’s offspring, she managed to stir up uncomfortable thoughts in your mind with her meddling. You decide to sweep them aside, if only for a brief interval while you go to report back to your oppressive overseer."
        [/message]

        {VARIABLE current_goal com2}

        {OBJECTIVES (
            side=1
            {OBJECTIVE_VICTORY ( _ "Report to Uria in the meeting chamber again")}

            {UNLIMITED_LEADER_MOVES_NOTE}
            {OBJECTIVE_NOTE {NO_GOLD_CARRYOVER_NOTE} }
        )}
    [/event]

    #
    # TODO: make sure this doesn't trigger right after exiting the cutscene
    #

    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Elyssa
            x,y=66,34
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_NOT_EQUALS current_goal trans1}
        [/filter_condition]

        [allow_undo][/allow_undo]

        #[message]
        #    speaker=narrator
        #    image=wesnoth-icon.png
        #    message= _ "You do not need to use the transporter again at this time."
        #[/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=46,36
                radius=6
            [/filter_location]
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal com2}
        [/filter_condition]

        [message]
            speaker=Sheelevrea
            message= _ "Ahahahaha! Hey, hey! Did you have fun down there? Hahahahaha!"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Not really. There was only one Gatekeeper and I wanted to perform many more bind soul spells tonight."
        [/message]

        [message]
            speaker=Halbadrel
            message= _ "That seems rather wasteful and improbable. Lord Zhangor said you needed Uria’s help to cast those."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Zhangor, you say?"
        [/message]

        [message]
            speaker=Sheelevrea
            message= _ "Hahahahaha!"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Ah, I see. Good to know he sent you here, but I fear you have been misinformed about the power I wield. Regardless, I have to wonder: why here, in my domain?"
        [/message]

        [message]
            speaker=Halbadrel
            message= _ "Lord Zhangor wanted us to keep you in check, naturally. There are various disturbing rumors running around surrounding your habits and plans, you see."
        [/message]

        [message]
            speaker=Sheelevrea
            message= _ "Some say you like inviting people to dine in your cell. They say... that you invite humans and demons... to eat their succulent flesh when you are... hungry! Hahahahaha!"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "(<i>monotone</i>) Ha, ha, ha. I can see why some of you might believe such a thing. But trust me, I am not the one who revels in chaos, destruction, and depravity. Perhaps you should be watching <i>him</i> instead. Nonetheless..."
        [/message]

        [if]
            [not]
                [have_unit]
                    id=Elyssa
                    [filter_adjacent]
                        id=Sheelevrea
                    [/filter_adjacent]
                [/have_unit]
            [/not]
            [then]
                {MOVE_UNIT id=Elyssa 47 37}

                [redraw]
                    side=1
                [/redraw]
            [/then]
            [else]
                [delay]
                    time=500
                [/delay]
            [/else]
        [/if]

        [message]
            speaker=Elyssa
            message= _ "(<i>frowning</i>) I absolutely <i>dislike</i> your obnoxious laugh, girl."
        [/message]

        [fade_out_music]
            duration=250
        [/fade_out_music]

        [item]
            [filter]
                id=Elyssa
            [/filter]
            image="misc/blank-hex.png"
            halo="halo/heart-aura.png~O(0.8)"
        [/item]

        [delay]
            time=250
        [/delay]

        {UNIT_SPELL_POPUP id=Elyssa _"bind soul"}

        [remove_item]
            [filter]
                id=Elyssa
            [/filter]
        [/remove_item]

        {RED_SCREEN}

        [kill]
            id=Sheelevrea
        [/kill]

        [hide_unit][/hide_unit]

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [unhide_unit][/unhide_unit]

        {RESET_SCREEN}

        [redraw][/redraw]

        [delay]
            time=1250
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            sound="break.ogg"
            message= _ "You grab the crystal orb containing the soul of your nameless victim and fling it against the wall, shattering it; the irregular shards are scattered over the floor.

... At least you <i>believe</i> she did not have a name."
        [/message]

        {REPLACE_SCENARIO_MUSIC "into_the_shadows.ogg"}

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Halbadrel
            message= _ "..."
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Their leader seems quite impressed by your little demonstration and orders his minion to pick up the shards. Hopefully he will choose to leave you alone, you think — that spell is quite physically and mentally taxing, and displaying weakness before Zhangor’s minions would not be a good idea."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Halbadrel
            message= _ "Lord Zhangor will hear of this."
        [/message]

        [message]
            speaker=Elyssa
            # po: 'however' is used here in the sense of "in whatever manner/fashion/form".
            message= _ "Oh, excellent, however should I express my gratitude! I was actually worried for a moment that I would have to send him the shards all by myself, wasting Uria’s invaluable time by making her wait much longer for my report."
        [/message]

        {MOVE_UNIT id=Halbadrel 48 37}

        [message]
            speaker=Elyssa
            message= _ "Please, <i>do</i> send him my regards."
        [/message]

        {MOVE_UNIT id=Halbadrel 52 38}

        [kill]
            id=Halbadrel
        [/kill]

        {MOVE_UNIT id=Kraador   51 39}

        [kill]
            id=Kraador
        [/kill]

        [redraw][/redraw]

        {MODIFY_UNIT id=Elyssa facing se}

        [redraw][/redraw]

        [delay]
            time=750
        [/delay]

        {MODIFY_UNIT id=Elyssa facing nw}

        [redraw][/redraw]

        [delay]
            time=250
        [/delay]

        {MOVE_UNIT id=Elyssa 47 36}

        [sound]
            name=gate.ogg
        [/sound]

        [remove_terrain_overlays]
            x=45,46-47
            y=36,35
        [/remove_terrain_overlays]

        [redraw]
            side=1
        [/redraw]

        {MOVE_UNIT id=Elyssa 46 33}
    [/event]

    [event]
        name=moveto
        [filter]
            id=Elyssa
            {INT_COM_CHAMBER_SLF}
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal com2}
        [/filter_condition]

        # Lit the entrance braziers

        {INT_LIT_BRAZIERS ({INT_SLF_BRAZIERS_ENTRANCE})}

        [redraw][/redraw]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Elyssa
            {INT_COM_TRIGGER_SLF}
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal com2}
        [/filter_condition]

        {LOCK_VIEW}

        {INT_CC_ACTIVATE_VISUALS}

        #
        # Make the sequence faster this time.
        #

        [terrain]
            x=56,58,58,54
            y=20,23,21,21
            layer=overlay
            terrain=^Ii
        [/terrain]

        [redraw][/redraw]

        {MOVE_UNIT id=Elyssa 56 21}

        {MODIFY_UNIT id=Elyssa facing nw}

        [delay]
            time=750
        [/delay]

        {INT_CC uria Uria _"Uria" 56 20} {FACING se}

        {REPLACE_SCENARIO_MUSIC "end.ogg"}

        [delay]
            time=750
        [/delay]

        #
        # Talk.
        #

        [message]
            speaker=Elyssa
            message= _ "The Gatekeeper on Ethea is no more, my lady. The breach from Urvatha is now clear for you to cross."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Uria
            message= _ "Hm, hm, I see. Well done, my Fire. Your success pleases me... greatly. Hm... I have a question for you."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Yes, my lady?"
        [/message]

        [message]
            speaker=Uria
            message= _ "Lord Zhangor informed me earlier of a... <i>revolt</i> organized by the stormkind witch. But from what he said I gather that the once-blessed faerie is directly involved in it. What do you know about this?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "The faerie abandoned her duty on the surface leading the Irdyan troops from the North. She made it to the ruined training chamber and confronted me."
        [/message]

        [message]
            speaker=Uria
            message= _ "Ah, hm, yes. Everyone has been looking forward to that confrontation ever since it was foretold by the Seer — it was an inevitability. Well, I assume you made her pay dearly for her meddling. Is she..."
        [/message]

        [message]
            speaker=Elyssa
            # wmllint: local spelling necrophages
            message= _ "I killed her just as you wished, my lady. (<i>smirking</i>) Hekuba’s necrophages took care of the rest for me. I would have loved to present you with her corpse, but it appears that our decrepit traitor still manages to interfere even after his soul ceased to exist. A pity too, since I really liked her hair."
        [/message]

        [message]
            speaker=Uria
            message= _ "No! I would not tolerate you wearing the scalp of that wretched creature anywhere near me; not to mention that some of your followers could get the wrong idea... Do you not think we have enough already with Ergea’s betrayal?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "My apologies, my lady."
        [/message]

        [message]
            speaker=Uria
            message= _ "Fair enough. Moving on, there is something you need to know."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Yes, my lady?"
        [/message]

        [message]
            speaker=Uria
            message= _ "I have transferred Irdya’s control to Lord Zhangor. You are relieved from your duty as my Fire."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "M— my lady?"
        [/message]

        [message]
            speaker=Uria
            message= _ "I refuse to acknowledge your reaction as one of surprise, Elyssa; the sole notion is utterly ridiculous. I did not ask you to lend him the bulk of the Triad’s troops without an ulterior reason. This is all part of a plan that is now mostly irrelevant for you. Your duty now is to serve him just as you have served me all these years."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "But you promised that Irdya would be under my control soon... Zhangor would assist you in Ethea!"
        [/message]

        [message]
            speaker=Uria
            message= _ "You ought to watch your tone, girl — do not forget that I can end your life and destroy your soul at any time I please. If you want the ball of dirt you call Irdya, you will have to strike a bargain with your new lord. Do you understand?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "I... understand, my lady."
        [/message]

        [message]
            speaker=Uria
            message= _ "Excellent then. Hm, hm, I am sure Zhangor will be as pleased as I am to count with your assistance to exterminate the vermin brought by the faerie before your very doors. And <i>perhaps</i> we will meet again in the future, ha, ha, ha, ha!"
        [/message]

        #
        # End talk.
        #

        [kill]
            animate=yes
            id=Uria
        [/kill]

        [remove_item]
            x,y=$x1,$y1
        [/remove_item]

        {FOREACH items k}
            # 1.10 and earlier always redraw after each [item] action.
#ifver WESNOTH_VERSION >= 1.11.0
            {VARIABLE lit_item.redraw no}
#endif

            [insert_tag]
                name=item
                variable="items[$k]"
            [/insert_tag]
        {NEXT k}

        {CLEAR_VARIABLE items}

        [remove_terrain_overlays]
            x=54,56,58,58
            y=21,20,21,23
        [/remove_terrain_overlays]

        {INT_UNLIT_BRAZIERS ({INT_SLF_BRAZIERS_CHAMBER})}

        [redraw]
            side=1
        [/redraw]

        [fade_out_music][/fade_out_music]

        [delay]
            time=250
        [/delay]

        {REPLACE_SCENARIO_MUSIC "everlasting_night.ogg"}
        {APPEND_MUSIC           "into_the_shadows.ogg"}

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "That damned shapeshifter scum should have stayed half-dead in that putrid pit. Stupid Uria and her irritating obsession with the bastard. You can only wonder what other machinations they have been brewing behind your back.

This unexpected development changes many things. Your plans need some urgent adjustments before those two perform their next move."
        [/message]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            # po: This line refers to Elynia as a 'piece', but it'd be nice to keep the gender
            # po: ambiguous whenever possible.
            message= _ "Time to check on your pivotal piece in the ruined laboratory. Maybe you should try to remember a few things along the way; open some of those rusty gates in your memory and look inside.

You just know you will need all the hints you can gather from this stronghold for your next course of action."
        [/message]

        {VARIABLE current_goal mem1}

        [remove_terrain_overlays]
            x=40,33
            y=38,29
        [/remove_terrain_overlays]

        {CLEAR_CAVE_SHROUD (
            x,y=33,29
            radius=1
        )}

        {CLEAR_CAVE_SHROUD (
            x,y=40,38
            radius=1
        )}

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=33,29
        [/scroll_to]

        {HIGHLIGHT_GOAL x,y=33,29}

        [scroll_to]
            x,y=40,38
        [/scroll_to]

        {HIGHLIGHT_GOAL x,y=40,38}

        [scroll_to_unit]
            id=Elyssa
        [/scroll_to_unit]

        {OBJECTIVES (
            side=1
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Enter the ruined laboratory")}

            {UNLIMITED_LEADER_MOVES_NOTE}
            {OBJECTIVE_NOTE {NO_GOLD_CARRYOVER_NOTE} }
        )}

        {UNLOCK_VIEW}

        {INT_UNLIT_BRAZIERS_ON_CHAMBER_EXIT}
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Elyssa
            {INT_COM_TRIGGER_SLF}
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal mem1}
            [or]
                {VARIABLE_LEXICAL_EQUALS current_goal mem2}
            [/or]
            [or]
                {VARIABLE_LEXICAL_EQUALS current_goal mem3}
            [/or]
            [or]
                {VARIABLE_LEXICAL_EQUALS current_goal mem4}
            [/or]
            [or]
                {VARIABLE_LEXICAL_EQUALS current_goal final}
            [/or]
        [/filter_condition]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "There is no use in attempting to activate the communicator at this time. Uria has probably left her fortress in Urvatha already, Zhangor is busy plotting in his lair, Nar-hamoth is missing in action, and the Seer does not really use these artifacts on account of her inability to move around unassisted. You do not have anything left to discuss with them for now either."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x,y=38,35
        [/filter]

        [remove_item]
            x,y=$x1,$y1
        [/remove_item]

        {QUAKE (cave-in.ogg)}

        [terrain]
            terrain=Urb
            x=37,36
            y=35,34
        [/terrain]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Touchplate triggered. A road rises from the depths."
        [/message]
    [/event]

#define INT_SIGIL _COL _ROW
    image="icons/original-ten-sigils.png~CROP($(60*"+{_COL}+"), $(60*"+{_ROW}+"), 60, 60)"
#enddef

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y=29,39
        [/filter]

        [allow_undo][/allow_undo]

        [item_choice_dialog]
            title= _ "The Original Ten"
            [option]
                {INT_SIGIL 0 0}
                title= _ "Life"
                text= _ "The force that governs the birth of all creatures in our reality. Incarnated by the Guardian of Life, also known as Uria, Guardian of the Legacy and the Void, Mistress of the Void, Goddess of Life."
            [/option]
            [option]
                {INT_SIGIL 1 0}
                title= _ "Water"
                text= _ "The element common to the origins of all life in our reality, as well as its sustainment and destruction. Incarnated by the Guardian of Water, also known as Valdir, Guardian of Water and Destruction, the Beast, God of War."
            [/option]
            [option]
                {INT_SIGIL 2 0}
                title= _ "Thunder"
                text= _ "The spark that keeps life in motion, the arbiter in a chaotic reality doomed to an ephemeral eternity of strife. Incarnated by the Guardian of Thunder, also known as Kaarul, Guardian of Thunder, Harbinger of Judgment, and God of Storms."
            [/option]
            [option]
                {INT_SIGIL 3 0}
                title= _ "Earth"
                text= _ "The shelter that harbors the promise of life, the energy that kindles the mystic in a dying reality. Incarnated by the Guardian of Earth, also known as Xia’el, Guardian of the Arcane Flame and Earth, Goddess of the Forests, Protector of Peace."
            [/option]
            [option]
                {INT_SIGIL 4 0}
                title= _ "Fire"
                text= _ "The aspect that fuels life through love, the flame that sustains the forge of knowledge in a reality where ignorance has ensnared its hopeless dwellers. Incarnated by the Guardian of Fire, also known as Shardia, Guardian of Fire and Knowledge, the Fire of Hope, Goddess of Love."
            [/option]
            [option]
                {INT_SIGIL 0 1}
                title= _ "Darkness"
                text= _ "The aspect of the free will necessary for life to progress, the precursor and successor of light in a reality devoid of ultimate intent. Incarnated by the Guardian of Darkness, also known as Merthiaal, Guardian of Darkness and Shadows, Eater of Souls, Goddess of Free Will."
            [/option]
            [option]
                {INT_SIGIL 1 1}
                title= _ "Light"
                text= _ "The aspect of the constancy from which life springs, the successor and precursor of darkness in a reality unprepared for its end. Incarnated by the Guardian of Light, also known as Luceith’el, Guardian of Light and Metal, Star of the Morning, Healer of Souls."
            [/option]
            [option]
                {INT_SIGIL 2 1}
                title= _ "Air"
                # wmllint: local spelling insufflates
                text= _ "The aspect of the kiss that insufflates life, the breath that preserves life in a decaying reality. Incarnated by the Guardian of Air, also known as Kazith, Guardian of Air and Breath, Lady of the Skies, Messenger of the Ether."
            [/option]
            [option]
                {INT_SIGIL 3 1}
                title= _ "Ice"
                text= _ "The aspect that is the cold touch that ends life, the substance that holds treasures for those daring to explore the confines of a shrinking reality. Incarnated by the Guardian of Ice, also known as Yukiria, Guardian of Ice and Mirrors, Queen of the White Expanse, Keeper of Death."
            [/option]
            [option]
                {INT_SIGIL 4 1}
                title= _ "Existence"
                text= _ "The aspect that binds all life together, the empty canvas from which a corrupted reality was created. Incarnated by the Guardian of Existence, also known as Delethia, Guardian of Secrets and Time, the Faceless Woman, Seer of the Tree."
            [/option]
        [/item_choice_dialog]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y=30,39
        [/filter]

        [allow_undo][/allow_undo]

        [message]
            speaker=narrator
            image= # wmllint: ignore
            {INT_SIGIL 0 0}
            caption= _ "Life"
            message= _ "The aspect of Life deals primarily with the creation and sustainment of life, as well as the very essence of being in all of its manifestations.

All the non-faerie human and human-like creatures were created in the image of the first Guardian of Life, who governed over Ethea during the First Cycle. This incarnation of Uria would prove to be essential for defeating the corrupted Protector of the Tree by orchestrating the demise of Yarae’s allies, at the cost of countless innocent lives everywhere.

Her next incarnation came into existence on a different world than Ethea due to unknown reasons."
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y=29,40
        [/filter]

        [allow_undo][/allow_undo]

        [message]
            speaker=narrator
            image= # wmllint: ignore
            {INT_SIGIL 3 0}
            caption= _ "Earth"
            message= _ "The aspect of Earth is one of four aspects that are directly connected to Life in a support role, paving the way for creation.

All faeriekind creatures were created in the image of the first Guardian of Earth, charged with the task of ruling over Irdya during the First Cycle.

Some sources claim that faeriekind beings were originally incorporeal and extremely rare until the ascension of the first incarnation of Xia’el, a woman said to have been created out of golden dust by Yarae himself, the Protector of the Tree. His influence might have brought her kind the boon of a more physical existence in greater numbers, albeit losing their immortality in the process. Various versions of the myth exist, some of them claiming that Xia’el’s form was a favor granted by Yarae after he fell in love with the creature.

Her next incarnation came into existence on a different world than Irdya due to unknown reasons."
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y=28,39
        [/filter]

        [allow_undo][/allow_undo]

        [message]
            speaker=narrator
            image= # wmllint: ignore
            {INT_SIGIL 0 1}
            caption= _ "Darkness"
            message= _ "Unlike the majority of the aspects constituting reality, Darkness and Light are derived from the nature of the First Gods themselves, stemming from Existence, and connected to Life in a structural role.

Just like Darkness precedes and succeeds Light from a physical standpoint, it also deals with the matter of the mind whereas Light deals with the soul of every being born under the Tree of Life. However, just as both aspects complement each other, they may also exchange places according to the circumstances.

Merthiaal, the Guardian of Darkness on Yrathid was the last guardian to be born during the First Cycle, and at the same time, she was the first guardian to perish. Although Yarae’s conflict had not yet begun, he did have an indirect role in causing Merthiaal’s downfall. The young guardian’s emotions clouded her reason; jealousy consumed her heart from inside as she watched her creator’s predilection for her sisters Uria and Xia’el.

In a desperate attempt to prove her worth to Yarae and even surpass his own power, the girl subverted her world’s seed and tried to absorb its energy for herself. Alas, even though their blood was always one and the same, the guardian and the Seed of Darkness were never meant to become one."
        [/message]

        [message]
            speaker=narrator
            image= # wmllint: ignore
            {INT_SIGIL 0 1}
            caption= _ "Darkness"
            # wmllint: local spelling Yrathidians
            message= _ "Not having learned her own song beforehand, Merthiaal could not assume full control of her new powers. Instead of becoming the true goddess she desired to be, the very aspect she controlled was destroyed — her mind succumbed to insanity as her horrifying new body absorbed the souls of each and every one of her fellow Yrathidians.

Uria put an end to Merthiaal’s rampage by ripping her heart out, destroying her body, and sealing her self in the hope that Yarae could do something to remedy the situation. However, Yarae was offended by the proposition; he refused to help with the resurrection and healing, choosing instead to preserve the lifeless world intact as a testament to his child’s hubris.

That incarnation of Uria would never be able to bring Merthiaal back to life, and the Guardian of Darkness would come to be known as the Eater of Souls, the antithesis of the Guardian of Light. Now lacking a distinct seed, Yrathid would not be restored at the end of the First Cycle, remaining instead as a graveyard world per Yarae’s wishes."
        [/message]
    [/event]

#undef INT_SIGIL

    #
    # Memory visions begin here.
    #

#define INT_MEMORY_CUTSCENE_PROLOGUE PLAYER_X PLAYER_Y FACING
    {LOCK_VIEW}

    {MOVE_UNIT id=Elyssa {PLAYER_X} {PLAYER_Y} }

    {MODIFY_UNIT id=Elyssa facing {FACING} }

    # Refresh shroud

    [redraw]
        side=1
    [/redraw]

    #
    # This extra scroll_to action is intended to recenter the screen if the
    # scrolling algorithm screwed up during the [move_unit] action above, or
    # for when no move could be performed (e.g. the unit is already at the
    # specified location).
    #
    # Of course, this is rather broken as of Wesnoth 1.11.0 and true centering
    # does not happen most of the time. Hopefully a future version will amend
    # that.
    #

    [scroll_to]
        x={PLAYER_X}
        y={PLAYER_Y}
    [/scroll_to]

    [delay]
        time=750
    [/delay]
#enddef

#define INT_MEMORY_CUTSCENE_EPILOGUE
    {UNLOCK_VIEW}
#enddef

    #
    # MEMORY 1 (mem1)
    #

    [event]
        name=moveto
        [filter]
            id=Elyssa
            x=26-32,33
            y=23-30,28
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal mem1}
        [/filter_condition]

        {INT_MEMORY_CUTSCENE_PROLOGUE 30 27 nw}

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "A particularly irksome disadvantage of living forever is that you very easily forget things that happened over a century ago if you do not take care of exercising your memory regularly. You are worried that this will become even harder over time, assuming you last long enough for that.

While you prepare your next move you decide to refresh your memory about some things. You make an effort to remember..."
        [/message]

        [delay]
            time=250
        [/delay]

#define INT_MC _VARIATION _ID _NAME _X _Y
    [unit]
        side=4
        type=Memory Controller

        variation={_VARIATION}

        id={_ID}
        name={_NAME}

        x={_X}
        y={_Y}

        animate=yes
    [/unit]

    [redraw][/redraw]
#enddef

        [scroll_to]
            x,y=28,26
        [/scroll_to]

        {INT_MC argan Argan _"Argan" 28 26} {FACING nw}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "It is him, the tortured man to whom you owe your life, even though you did not ask for it.

The scene feels familiar to you, but you are not completely sure yet how long ago it happened."
        [/message]

        [message]
            caption= _ "Elyssa"
            speaker=narrator
            image="misc/blank-hex.png"
            message= _ "<i>You have not visited me in a long time.</i>"
        [/message]

        [delay]
            time=500
        [/delay]

        {INT_MC elyssa "memory!Elyssa" _"Elyssa" 24 23} {FACING sw}

        [message]
            speaker=memory!Elyssa
            message= _ "What brings you here?"
        [/message]

        [message]
            speaker=Argan
            message= _ "Do I really need a reason? Uria is busy unearthing some ruins in Urvatha — she will not notice my absence. I just wanted to see you."
        [/message]

        # The explicit path is necessary to avoid her walking through a wall
        {MOVE_UNIT id=memory!Elyssa 23,23 24,25} {IGNORE_MOVEMENT_COSTS}

        [delay]
            time=250
        [/delay]

        {MOVE_UNIT id=memory!Elyssa 26 25} {IGNORE_MOVEMENT_COSTS}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Argan
            message= _ "I have to admit that I expected a warmer reception."
        [/message]

        [message]
            speaker=memory!Elyssa
            message= _ "I suppose... it’s hard to be enthusiastic about a visit from someone who has only spoken to me through crystal projections for over a century. It almost feels as though we are strangers... meeting for the first time..."
        [/message]

        [message]
            speaker=Argan
            message= _ "Does it now?"
        [/message]

        [delay]
            time=500
        [/delay]

        {MODIFY_UNIT id=memory!Elyssa facing nw}

        [redraw][/redraw]

        [delay]
            time=250
        [/delay]

        {MOVE_UNIT id=memory!Elyssa 27 26} {IGNORE_MOVEMENT_COSTS}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=memory!Elyssa
            message= _ "I missed you... I really, really did."
        [/message]

        [message]
            speaker=Argan
            message= _ "But..."
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Argan
            message= _ "I see..."
        [/message]

        [delay]
            time=250
        [/delay]

        {MODIFY_UNIT id=Argan facing se}

        [redraw][/redraw]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Argan
            message= _ "How have things been around here? Any progress?"
        [/message]

        # wmllint: local spellings Ghoram-Dul Grenmar

        [message]
            speaker=memory!Elyssa
            message= _ "With Nar-hamoth around I haven’t been able to continue with my search. But I went to Ghoram-Dul the other day and asked the Seer about her and—"
        [/message]

        [message]
            speaker=Argan
            message= _ "Not the faerie. The hive in the Grenmar region. I believe its construction should be nearly finished by now?"
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=memory!Elyssa
            message= _ "Did you come here just to ask me about such banal matters, or because you wanted to see me?"
        [/message]

        [message]
            speaker=Argan
            message= _ "Do I have to choose between those two options? I did not expect you to be so demanding from your superiors, girl."
        [/message]

        [message]
            speaker=memory!Elyssa
            message= _ "<i>Superiors</i>, you say?"
        [/message]

        [message]
            speaker=Argan
            message= _ "I do not have all the time of the world for your empty questions. Will you answer, or—"
        [/message]

        [message]
            speaker=memory!Elyssa
            message= _ "Uria sent you, didn’t she? She sent you to keep track of my activities, as if I needed another Shadow of hers around here."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=memory!Elyssa
            message= _ "Oh, but of course. ‘Shadow’ really suits you better than it does that brainless brute, except most of the scum in this place prefers to add ‘Master’ to it for some stupid reason."
        [/message]

        [message]
            speaker=Argan
            message= _ "You seem agitated—"
        [/message]

        [message]
            speaker=memory!Elyssa
            # po: 'Monster' here refers to Uria.
            message= _ "Dealing with your personality issues was exasperating enough back then; I will <b>not</b> bear talking to you now that you have become a puppet of that abusive monster. Get out."
        [/message]

        [message]
            speaker=Argan
            message= _ "El— Elyssa—"
        [/message]

        [message]
            speaker=memory!Elyssa
            message= _ "GET OUT!"
        [/message]

#define INT_END_MEMORY
    [kill]
        type=Memory Controller
        animate=yes
    [/kill]

    [redraw][/redraw]
#enddef

        {INT_END_MEMORY}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "For long you have tried to erase your memories revolving around Argan’s descent into insanity and the eventual fulfillment of his end of the bargain with Uria. Alas, Norsulan technology around the time you were resurrected was not advanced enough to do that kind of thing, and you are sort of stuck in the past in that regard.

Or maybe you just need more time to learn to do the mind tricks Merthiaal could do — on a mass scale, even."
        [/message]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "You decide to proceed further into the ruined laboratory and try to reminisce about better times."
        [/message]

        {VARIABLE current_goal mem2}

        {OBJECTIVES (
            side=1
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Proceed further into the ruined laboratory and try to reminisce about better times")}

            {UNLIMITED_LEADER_MOVES_NOTE}
            {OBJECTIVE_NOTE {NO_GOLD_CARRYOVER_NOTE} }
        )}

        {INT_MEMORY_CUTSCENE_EPILOGUE}
    [/event]

    #
    # MEMORY 2 (mem2)
    #

    [event]
        name=moveto
        [filter]
            id=Elyssa
            x=14-25
            y=17-23
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal mem2}
        [/filter_condition]

        {CLEAR_CAVE_SHROUD (
            x,y=20,20
            radius=5
        )}

        {INT_MEMORY_CUTSCENE_PROLOGUE 22 22 nw}

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Some of the hive creatures have adopted these ruins as their home. You do not really mind them since they are completely harmless around those they recognize as their own kind — at least as far as their biomechanical bodies’ identification signal mechanism goes. Unlike the Gatekeeper you just destroyed, you are absolutely certain that these artificial constructs have no souls of their own. Whether they have minds or not is a completely different matter, though."
        [/message]

        [delay]
            time=250
        [/delay]

        [scroll_to]
            x,y=18,20
        [/scroll_to]

        {INT_MC elyssa memory!Elyssa _"Elyssa" 18 20} {FACING nw}

        {INT_MC argan_unmasked Argan _"Argan" 19 21} {FACING nw}

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Argan
            message= _ "Elyssa... There is something I need to know."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=memory!Elyssa
            message= _ "I thought I told you to go away. I am not interested in helping you anymore."
        [/message]

        [message]
            speaker=Argan
            message= _ "I <i>need</i> your help. Please... You are the only one I could ever trust who can use the powers of darkness to block the Seer’s vision. I <i>need</i> to find my wife—"
        [/message]

        [message]
            speaker=memory!Elyssa
            message= _ "Why did you not try to find her before surrendering your free will to Uria? If you truly loved the Lady of Light, the first thing you should have done was—"
        [/message]

        [message]
            speaker=Argan
            message= _ "I already told you... I did not choose to be stranded in Urvatha for so long. Uria does not want me to find Elynia yet. I am worried that her plans could jeopardize your own safety. You must do something for me..."
        [/message]

        [message]
            speaker=Argan
            message= _ "If you find Elynia, you must kill her."
        [/message]

        [delay]
            time=250
        [/delay]

        {MODIFY_UNIT id=memory!Elyssa facing se}

        [redraw][/redraw]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=memory!Elyssa
            message= _ "... Why?"
        [/message]

        [message]
            speaker=Argan
            # po: The 'voice' Argan refers to is a female voice.
            message= _ "Because it is something you must do. That is what I was told by the voice..."
        [/message]

        [message]
            speaker=memory!Elyssa
            message= _ "You... You are in even worse shape than I thought. I simply cannot fathom what is going through Uria’s mind as of late. Why would she trust <i>you</i> with the command of the Empire like this?"
        [/message]

        [message]
            speaker=Argan
            message= _ "No. Listen. You can consult with the Seer later — I am sure she knows of the voice as well, but she has always refused to speak with me. I have a suspicion about that voice..."
        [/message]

        [message]
            speaker=memory!Elyssa
            message= _ "Does Uria need to know?"
        [/message]

        [message]
            speaker=Argan
            message= _ "No."
        [/message]

        [message]
            speaker=memory!Elyssa
            message= _ "Very well, then. I suppose the Seer will not inform Uria about this, though."
        [/message]

        [message]
            speaker=Argan
            message= _ "I do not think she has found out about your search yet, has she? You know the Seer is as much your ally as it is Uria’s — she does not take sides. She will not betray you, but not specifically because of your affiliation with Darkness. If that were all it takes to communicate with her, I would not need your help for that."
        [/message]

        {INT_END_MEMORY}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Many years later, Argan’s orders would take a turn for the worse, and you would happily comply with every single one. You do not really regret it in the least. Killing lesser creatures is amazingly comforting after all you have been through. If only you could do that with your own underlings more often. Wait, you mean Zhangor’s underlings now. You are quite sure he would not actually mind.

On the other hand, you were allowed to do as you pleased with your torturers back in the day. If only you had the control you have now over your artificially enhanced body, and Merthiaal’s heart. If only you could ravage people’s minds like the true Eater of Souls could. If only..."
        [/message]

        {VARIABLE current_goal mem3}

        [remove_terrain_overlays]
            x,y=22,17
        [/remove_terrain_overlays]

        {CLEAR_CAVE_SHROUD (
            x,y=22,17
            radius=1
        )}

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=22,17
        [/scroll_to]

        {HIGHLIGHT_GOAL x,y=22,17}

        [scroll_to_unit]
            id=Elyssa
        [/scroll_to_unit]

        {OBJECTIVES (
            side=1
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Proceed into the ruined room")}

            {UNLIMITED_LEADER_MOVES_NOTE}
            {OBJECTIVE_NOTE {NO_GOLD_CARRYOVER_NOTE} }
        )}

        {INT_MEMORY_CUTSCENE_EPILOGUE}
    [/event]

    [event]
        name=moveto
        [filter]
            id=Elyssa
            x=23-34,22
            y=11-18,17
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal mem3}
        [/filter_condition]

        {INT_MEMORY_CUTSCENE_PROLOGUE 24 16 ne}

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "This is where Argan brought you back to life — or what remains of the place, in any case. You really threw a tantrum that night, blinded by the great pain caused by the energy stemming from Merthiaal’s heart, and that unfathomable presence within it reaching into your soul.

You are not entirely sure whether the pain disappeared or you just became accustomed to it over the years, but you can still feel that presence on occasion — namely, whenever you feel tempted to fully unleash your frustration and anger."
        [/message]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "The costs and risks of being a predestined guardian have not been properly documented, but everyone agrees that it was the temptation of power what finally got the best of the goddess whose legacy Argan and Uria bestowed upon you. But your case is an unprecedented one, and you have had to cope with other difficulties along the way. The technology that binds your body and soul with Merthiaal’s heart was considered highly experimental on its world of origin, and every test subject was destroyed without exception.

Maybe it was because the heart they chose for their testing was that of an unborn goddess as opposed to a deceased one. Maybe it was because the Aspect of Fire itself did not choose them. Or maybe those individuals simply lacked the resolution Argan provided you, and the initial excruciating pain was too much for their feeble psyches.

Whatever the case is, you are certain that even though cheating the system devised by Yarae was a straining and arduous task, the Aspect of Darkness is yours to control now."
        [/message]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "If the once Lady of Light had not killed him, Argan would be proud to see you execute his plans like clockwork.

Proud. Nothing more than that, really.

If you were to use Golden Age literature as reference, you would say he always regarded you as a daughter. His increasing lack of empathy did not allow him to see that you had feelings of a different kind for him. While that truly bothered you in the beginning, you quickly learned about another of the costs of being a guardian. To put it into perspective, of all the guardians that have lived so far, only the second incarnation of the Guardian of Fire found true love — and then she died under mysterious circumstances nearly a couple of decades ago.

Those unrequited feelings you once had vanished long ago, but that does not change the fact that you owe your life to Argan and that you will do everything within your power for him, even now that he is gone for good."
        [/message]

        [delay]
            time=750
        [/delay]

        {VARIABLE current_goal mem4}

        [remove_terrain_overlays]
            x,y=13,30
        [/remove_terrain_overlays]

        {CLEAR_CAVE_SHROUD (
            x,y=13,30
            radius=1
        )}

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=13,30
        [/scroll_to]

        {HIGHLIGHT_GOAL x,y=13,30}

        [scroll_to_unit]
            id=Elyssa
        [/scroll_to_unit]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "It feels as though you have been wasting your time with this pointless introspective for months, even though it has obviously been just an hour. Damn the Gatekeeper and the Seer. Things would be much easier if you could just focus on commanding troops and killing opponents with complete disregard for ancient riddles and the absurd notion of fate."
        [/message]

        {OBJECTIVES (
            side=1
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Proceed into Elyssa’s cell")}

            {UNLIMITED_LEADER_MOVES_NOTE}
            {OBJECTIVE_NOTE {NO_GOLD_CARRYOVER_NOTE} }
        )}

        {INT_MEMORY_CUTSCENE_EPILOGUE}
    [/event]

    [event]
        name=moveto
        [filter]
            id=Elyssa
            x= 1-16
            y=30-42
        [/filter]
        [filter_condition]
            {VARIABLE_LEXICAL_EQUALS current_goal mem4}
        [/filter_condition]

        {INT_MEMORY_CUTSCENE_PROLOGUE 11 32 sw}

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Kendyare is still here as you left her.

The faerie destroyed her body near the entrance to the abandoned Iron Council chamber. If you were to give the necromancer a new chance you would have to give her a new body as well. She was rather entertaining to have around; but she was not particularly bright, and Nar-hamoth was abusing that to keep you under constant surveillance. You simply decided to act before Zhangor had a chance to take advantage of her as well."
        [/message]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "You have not really spent as much time in this cell as you would if you were an ordinary creature. Thankfully, your body allows you to spend an indefinite amount of time without rest. You have tried sleeping on occasion, but ever since you were captured by the human scum in the capital you have only had variations of the same recurring nightmares. You hoped your new life would allow you to have normal dreams again, but it has only been worse since then."
        [/message]

        [delay]
            time=250
        [/delay]

        {ITEM_TOUCHPLATE 14 12}

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "You think it is finally time to go and put those plans in motion."
        [/message]

        {MOVE_UNIT id=Elyssa 14 29}

        {VARIABLE current_goal final}

        {OBJECTIVES (
            side=1
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Find the touchplate leading to the secret room")}

            {UNLIMITED_LEADER_MOVES_NOTE}
            {OBJECTIVE_NOTE {NO_GOLD_CARRYOVER_NOTE} }
        )}

        {INT_MEMORY_CUTSCENE_EPILOGUE}
    [/event]

    [event]
        name=moveto
        first_time_only=yes
        [filter]
            id=Elyssa
            x,y=3,32
        [/filter]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "This is an old poetry book you found amongst some ruins unearthed from the Silver Lands. You used to dedicate your life to collecting every single piece of history you could salvage from the many remains of Golden Age civilizations, but after becoming a hybrid being your interests changed drastically. Things like poetry that do not contribute to your plans in any way whatsoever became pointless, and yet... this book is still here."
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Elyssa
            x,y=3,32
        [/filter]
        [filter_condition]
            {VARIABLE_BOOLEAN_NOT_EQUALS have_argans_missing_pages yes}
        [/filter_condition]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Do you want to pick the book up?"
            [option]
                message= _ "Yes."
                [command]
                    {VARIABLE have_argans_missing_pages yes}

                    [remove_item]
                        x,y=$x1,$y1
                    [/remove_item]

                    [message]
                        speaker=narrator
                        image=wesnoth-icon.png
                        message= _ "You take the book. A few loose pages slide onto the floor, and you pick them up."
                    [/message]

                    [delay]
                        time=750
                    [/delay]

                    [message]
                        speaker=narrator
                        image=wesnoth-icon.png
                        message= _ "Of course. These are the pages you took from Argan’s journal some time after he became irreversibly incoherent."
                    [/message]
                [/command]
            [/option]
            [option]
                message= _ "No."
                [command]
                    [allow_undo][/allow_undo]
                [/command]
            [/option]
        [/message]
    [/event]

    #
    # Final touchplate
    #

    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Elyssa
            x,y=14,12
        [/filter]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Once you go into that room, there will be no going back.

Are you sure you want to proceed now?"
            [option]
                message= _ "Yes."
                [command]
                    [fade_out_music][/fade_out_music]

                    [remove_item]
                        x,y=$x1,$y1
                    [/remove_item]

                    {PLACE_IMAGE items/altar-evil.png 14  5}

                    {QUAKE (cave-in.ogg)}

                    [terrain]
                        terrain=Urb^Es
                        x=13,14
                        y=12,11
                    [/terrain]

                    [message]
                        speaker=narrator
                        image=wesnoth-icon.png
                        message= _ "Touchplate triggered. A wall moves."
                    [/message]

                    {CLEAR_CAVE_SHROUD (
                        x,y=14,6
                        radius=6
                    )}

                    [redraw]
                        side=1
                    [/redraw]

                    [delay]
                        time=250
                    [/delay]

                    {MOVE_UNIT id=Elyssa 14 8}

                    {MOVE_UNIT id=Elyssa 14 6}

                    [delay]
                        time=750
                    [/delay]

                    [message]
                        speaker=Elyssa
                        message= _ "This is all your fault, Argan."
                    [/message]

                    [delay]
                        time=500
                    [/delay]

                    [message]
                        speaker=Elyssa
                        message= _ "I shouldn’t be the one to deal with this..."
                    [/message]

                    [delay]
                        time=500
                    [/delay]

                    [hide_unit][/hide_unit]

                    {FADE_TO_BLACK}

                    {ENDLEVEL_QUIET} {NO_REPLAY_SAVE}
                [/command]
            [/option]
            [option]
                message= _ "No."
                [command]
                    [allow_undo][/allow_undo]
                [/command]
            [/option]
        [/message]
    [/event]

    [event]
        name=victory

        {CLEAR_VARIABLE current_goal,reprimands}
    [/event]
[/scenario]

#undef INT_CC
#undef INT_CC_ACTIVATE_VISUALS
#undef INT_MC
#undef INT_MEMORY_CUTSCENE_EPILOGUE
#undef INT_MEMORY_CUTSCENE_PROLOGUE
#undef INT_END_MEMORY
#undef INT_LIT_BRAZIERS
#undef INT_UNLIT_BRAZIERS
#undef INT_UNLIT_BRAZIERS_ON_CHAMBER_EXIT
#undef INT_COM_CHAMBER_SLF
#undef INT_COM_TRIGGER_SLF
#undef INT_SLF_BRAZIERS_CHAMBER
#undef INT_SLF_BRAZIERS_ENTRANCE
#undef INT_ILLUSION_STEP
#undef INT_MAY_NOT_PASS

# kate: indent-mode normal; encoding utf-8; space-indent on;
