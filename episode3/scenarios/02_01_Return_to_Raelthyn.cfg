#textdomain wesnoth-After_the_Storm

[scenario]
    id=02_01_Return_to_Raelthyn
    name= _ "Return to Raelthyn"
    {MAP 02_01_Return_to_Raelthyn.map}
    next_scenario=02_02_Reckoning

    {F_DEATHS}

    {SCENARIO_MUSIC "heroes_rite.ogg"}

    {STORYTXT_RETURN_TO_RAELTHYN}

    # this scenario lasts one day plus most of the second day
    # until the short darkness begins, regardless of difficulty
    # level for story reasons
    turns=20
    {TWO_SUNS_DEFAULT_SCHEDULE}

    # Adavyan's keep location (SLF); this is used both by AI
    # code and event handlers.
#define R_ADAS_KEEP_SLF
    x=26,24-26,25,27
    y=18,19-20,21,21
#enddef

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        save_id=player
        team_name=good
        user_team_name= _ "team_name^Elynia"

        {GOLD 200 190 180}
        {INCOME 4 3 2}

        fog=yes

        # wmllint: recognize Elynia
        {CHARACTER_STATS_ELYNIA}
    [/side]

#define R_INITIAL_UNIT _TYPE _X _Y _ID _NAME _MORE_WML
    [unit]
        type={_TYPE}
        x={_X}
        y={_Y}

        id={_ID}
        name={_NAME}

        random_gender=no
        random_traits=no
        generate_name=no

        upkeep=loyal

        {_MORE_WML}
    [/unit]
#enddef

    [side]
        side=2
        controller=human
        persistent=no
        team_name=good
        user_team_name= _ "team_name^Raelthyn"
        {ARAGWAITH_FLAG}

        {GOLD 230 220 210}
        {INCOME 6 5 4}
        recruit=Aragwaith Archer,Aragwaith Spearman,Aragwaith Witch,Aragwaith Scout,Aragwaith Swordsman,Aragwaith Eagle Rider

        # wmllint: recognize Torancyn
        {CHARACTER_STATS_TORANCYN}
        [+modifications]
            {TEAM_COLOR_OVERRIDE () orange}
        [/modifications]
        canrecruit=yes
        facing=sw

        [unit]
            # wmllint: recognize Valen
            {CHARACTER_STATS_VALEN}
            upkeep=free
            {IS_HERO}
            [+modifications]
                {TEAM_COLOR_OVERRIDE () teal}
            [/modifications]
            facing=sw
            x,y=24,19
        [/unit]

        {R_INITIAL_UNIT (Aragwaith Longswordsman) 26 33 Boros   ( _ "Boros") (
            facing=sw
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_QUICK}
            [/modifications]
        )}
        {R_INITIAL_UNIT (Aragwaith Longswordsman) 34 28 Dereon  ( _ "Dereon") (
            facing=se
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_STRONG}
            [/modifications]
        )}
        {R_INITIAL_UNIT (Aragwaith Strongbow)     38 26 Valthyn ( _ "Valthyn") (
            facing=se
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_QUICK}
            [/modifications]
        )}
        {R_INITIAL_UNIT (Aragwaith Pikeman)       41 20 Pelarth ( _ "Pelarth") (
            facing=se
            [modifications]
                {TRAIT_QUICK}
                {TRAIT_INTELLIGENT}
            [/modifications]
        )}
        {R_INITIAL_UNIT (Aragwaith Strongbow)     18 18 Fraldar ( _ "Fraldar") (
            facing=sw
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_INTELLIGENT}
            [/modifications]
        )}
        {R_INITIAL_UNIT (Aragwaith Eagle Master)  35 10 Rilbur  ( _ "Rilbur") (
            facing=ne
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_INTELLIGENT}
            [/modifications]
        )}

        # These two are from IftU scenario 14
        {R_INITIAL_UNIT (Aragwaith Strongbow)     16 23 Blynyr  ( _ "Blynyr") (
            facing=sw
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_QUICK}
            [/modifications]
        )}
        {R_INITIAL_UNIT (Aragwaith Longswordsman) 16 30 Zednal  ( _ "Zednal") (
            facing=nw
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_QUICK}
            [/modifications]
        )}
    [/side]
    # wmllint: validate-on

#define R_DRILLER _X _Y
    [unit]
        type=Shaxthal Demolisher Drone
        x={_X}
        y={_Y}
        upkeep=loyal

        overlays="misc/payload-icon.png"

        random_gender=no
        random_traits=no
        generate_name=no

        [modifications]
            {TRAIT_BIOMECHANICAL}
        [/modifications]
    [/unit]
#enddef

    [side]
        side=3
        team_name=evil
        user_team_name= _ "team_name^Enemies"
        {CHAOS_FLAG}

        no_leader=yes

        gold=0
        village_gold=0
        {NO_INCOME}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            # Try to not attack enemy units unless there is no
            # other option.
            {AI_SIMPLE_ALWAYS_ASPECT aggression      -1000.00}
            {AI_SIMPLE_ALWAYS_ASPECT caution             0.00}
            {AI_SIMPLE_ALWAYS_ASPECT village_value       0.00}
            {AI_SIMPLE_ALWAYS_ASPECT grouping              no}

            #
            # Try to reach Advyan’s keep to deploy the payload.
            #

            [goal]
                name=target_location
                value=1000.0
                [criteria]
                    {R_ADAS_KEEP_SLF}
                [/criteria]
            [/goal]
        [/ai]

        {R_DRILLER  5 31} {FACING ne}
        {R_DRILLER 41 42} {FACING nw}
        {R_DRILLER 15  5} {FACING se}
#ifndef EASY
        {R_DRILLER 62  1} {FACING nw}
#endif
    [/side]

#undef R_DRILLER

    [side]
        side=4
        team_name=evil
        user_team_name= _ "team_name^Enemies"
        {CHAOS_FLAG}

        {GOLD 150 160 170}
        recruit=Chaos Gunner,Chaos Invoker,Chaos Invader,Chaos Raider

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "scout,mixed fighter,fighter,archer,fighter"}
        [/ai]

        canrecruit=yes
        type=Chaos Cataphract
        id=Daraes Pelnoth
        name= _ "Daraes Pelnoth"
        facing=nw
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]

        {R_INITIAL_UNIT ("Chaos Magus") 56 37 Golgathar ( _ "Golgathar") (
            facing=nw
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        )}
        {R_INITIAL_UNIT ("Dark Knight") 58 32 Merkal ( _ "Merkal") (
            facing=nw
            [modifications]
                {TRAIT_QUICK}
                {TRAIT_STRONG}
            [/modifications]
        )}
    [/side]

    [side]
        side=5
        team_name=evil
        user_team_name= _ "team_name^Enemies"
        {CHAOS_FLAG}

        {GOLD 155 160 165}
        recruit=Imp,Demon,Chaos Bowman,Chaos Headhunter

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "scout,mixed fighter,fighter,archer,fighter"}
        [/ai]

        canrecruit=yes
        type=Armageddon Imp
        id="Demon Lord Rhalgar'agael"
        name= _ "Demon Lord Rhalgar’agael"
        facing=se
        [modifications]
            {TRAIT_SLOW}
            {TRAIT_INTELLIGENT}
        [/modifications]

        {R_INITIAL_UNIT ("Demon Stormtide")  8  4 Kretassal ( _ "Kretassal") (
            facing=se
            gender=female
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_INTELLIGENT}
            [/modifications]
        )}
        {R_INITIAL_UNIT ("Demon Stormtide") 13  7 Kilagor ( _ "Kilagor") (
            facing=se
            [modifications]
                {TRAIT_QUICK}
                {TRAIT_STRONG}
            [/modifications]
        )}
        {R_INITIAL_UNIT ("Demon Zephyr") 18  3 Daenangor ( _ "Daenangor") (
            facing=se
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_DEXTROUS}
            [/modifications]
        )}
    [/side]

    [side]
        side=6
        team_name=evil
        user_team_name= _ "team_name^Enemies"
        {CHAOS_FLAG}

        {GOLD 160 170 180}
        recruit=Shaxthal Runner Drone,Chaos Invader,Chaos Bowman,Vampire Bat

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "fighter,mixed fighter,archer,scout,fighter"}
        [/ai]

        canrecruit=yes
        type=Ancient Lich
        id=Mal Sultaria
        name= _ "Mal Sultaria"
        facing=ne
        [modifications]
            {TRAIT_UNDEAD}
            {TRAIT_RESILIENT}
        [/modifications]

        {R_INITIAL_UNIT ("Blood Imp")  5 29 Thorkar ( _ "Thorkar") (
            facing=ne
            [modifications]
                {TRAIT_DIM}
                {TRAIT_STRONG}
            [/modifications]
        )}
        {R_INITIAL_UNIT ("Chaos Marauder") 3 18 Cergil ( _ "Cergil") (
            facing=se
            [modifications]
                {TRAIT_QUICK}
                {TRAIT_INTELLIGENT}
            [/modifications]
        )}
    [/side]

    [side]
        side=7
        team_name=evil
        user_team_name= _ "team_name^Enemies"
        {CHAOS_FLAG}

        {GOLD 150 160 170}
        recruit=Demon,Ghoul,Skeleton Archer,Ghost

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {AI_SIMPLE_ALWAYS_ASPECT recruitment_pattern "mixed fighter,archer,fighter,mixed fighter,scout,mixed fighter"}
        [/ai]

        canrecruit=yes
        type=Chaos Lorekeeper
        id=Morragor
        name= _ "Morragor"
        facing=nw
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_INTELLIGENT}
        [/modifications]

        {R_INITIAL_UNIT ("Demon Grunt") 60  9 Iralir  ( _ "Iralir") (
            facing=nw
            [modifications]
                {TRAIT_DEXTROUS}
                {TRAIT_QUICK}
            [/modifications]
        )}
        {R_INITIAL_UNIT ("Blood Imp") 55 15 Romoror ( _ "Romoror") (
            facing=nw
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_SLOW}
            [/modifications]
        )}
    [/side]

    [side]
        side=8
        team_name=good
        user_team_name= _ "team_name^Arphalad"
        {ARAGWAITH_FLAG}

        hidden=yes
        no_leader=yes

        controller=null

        {NO_INCOME}
        gold,village_gold=0,0
    [/side]

    [side]
        side=9
        team_name=good
        user_team_name= _ "team_name^Elves"
        {ELVISH_FLAG}

        hidden=yes
        no_leader=yes

        controller=null

        {NO_INCOME}
        gold,village_gold=0,0
    [/side]

#undef R_INITIAL_UNIT

    {STARTING_VILLAGES 4 9}
    {STARTING_VILLAGES 5 9}
    {STARTING_VILLAGES 6 9}
    {STARTING_VILLAGES 7 9}

    # NOTE: objects are shifted by x+12 and y+4 relative
    # to their locations in the standard Raelthyn map

    [label]
        x,y=45,8
        text= _ "Arphalad"
    [/label]

    [label]
        x,y=41,13
        text= _ "River Lorin"
    [/label]

    [label]
        x,y=29,30
        text= _ "Lake Wylven"
    [/label]

    [label]
        x,y=25,20
        text= _ "Adavyan’s Keep"
    [/label]

    [label]
        x,y=17,15
        text= _ "Danaerad"
    [/label]

    [label]
        x,y=35,10
        text= _ "Tower of Silence"
    [/label]

    {PLACE_IMAGE scenery/well-small.png 25 11}

    # {PLACE_IMAGE scenery/leanto.png 17 9}
    {PLACE_IMAGE scenery/temple1.png 22 11}
    # {PLACE_IMAGE scenery/oak-leaning.png 30 21}
    # {PLACE_IMAGE scenery/oak-leaning.png 30 12}
    # {PLACE_IMAGE scenery/oak-leaning.png 22 12}
    # {PLACE_IMAGE items/archery-target-right.png 15 14}
    # {PLACE_IMAGE items/archery-target-right.png 25 18}

    # {PLACE_IMAGE "scenery/temple1.png"   42  5}
    # {PLACE_IMAGE "items/straw-bale1.png" 49  8}
    # {PLACE_IMAGE "items/straw-bale2.png" 47 26}
    # {PLACE_IMAGE "items/grain-sheaf.png" 50 34}
    # {PLACE_IMAGE "items/straw-bale1.png" 43 38}
    # {PLACE_IMAGE "items/straw-bale1.png" 51 26}

#define R_RAELTHYN_DEFENSE _TYPE _X _Y _ID _NAME _TRAITS _FACING
    [unit]
        animate=yes
        side=2
        type={_TYPE}
        x={_X}
        y={_Y}
        unrenamable=yes

        id={_ID}
        name={_NAME}

        random_gender=no
        random_traits=no
        generate_name=no

        overlays="misc/loyal-icon.png"
        upkeep=loyal

        facing={_FACING}

        [modifications]
            {TRAIT_LOYAL}
            {_TRAITS}
        [/modifications]
    [/unit]
#enddef

#define R_ARPHALAD_MILITIA _TYPE _X _Y _ID _NAME _TRAITS _FACING
    [unit]
        animate=yes
        side=8
        type={_TYPE}
        x={_X}
        y={_Y}
        unrenamable=yes

        id={_ID}
        name={_NAME}

        random_gender=no
        random_traits=no
        generate_name=no

        overlays="misc/loyal-icon.png"
        upkeep=loyal

        facing={_FACING}

        [modifications]
            {TRAIT_LOYAL}
            {_TRAITS}
        [/modifications]
    [/unit]
#enddef

    [event]
        name=prestart

        {RECALL_ANYA}
        {RECALL_DURVAN}

        {MODIFY_UNIT (side=1) facing sw}

        # This is the amount of load-bearing drones the player
        # has to take down. The exact count will vary according
        # to difficulty (see above), but to make it easier for
        # future balancing we'll determine it at runtime instead
        # of hardcoding numbers.

        [count_units]
            type=Shaxthal Demolisher Drone
            variable=payload_count
        [/count_units]

        [hide_unit]
            side=2
        [/hide_unit]

        [capture_village]
            side=2
            x=13-45,23
            y= 8-32,37
            terrain=*^V*
        [/capture_village]
    [/event]

    #
    # The objectives in this scenario are rather unusually complicated, so
    # we update them in a single event that acts as a WML function of sorts
    # to make future code changes easier to accomplish.
    #

#define R_UPDATE_OBJECTIVES
    [fire_event]
        name=update player objectives
    [/fire_event]
#enddef

#define R_COMMON_OBJECTIVES
    {OBJECTIVE_VICTORY_END_OF_TURNS}
    {OBJECTIVE_OPTIONAL ( _ "Defeat all enemy leaders"+{EARLY_FINISH_BONUS_FOOTNOTE})}

    {OBJECTIVE_DEFEAT  ( _ "A Demolisher Drone explodes within range of Adavyan’s Keep")}
#enddef

#define R_OBJECTIVES_SIDE_1_DEATHS
    {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
    {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
    {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}
    {OBJECTIVE_DEFEAT  ( _ "Death of Irylean")}
#enddef

#define R_OBJECTIVES_SIDE_2_DEATHS
    {OBJECTIVE_DEFEAT  ( _ "Death of Torancyn")}
    {OBJECTIVE_DEFEAT  ( _ "Death of Valen")}
#enddef

#define R_OBJECTIVE_NOTES
    {OBJECTIVE_NOTE ( _ "Adavyan’s Keep comprises the initial keep and castle tiles where Torancyn stands")}
    {OBJECTIVE_NOTE ( _ "Keep in mind Demolisher Drones destroy and kill everything within a one-hex radius when slain; you will need to sacrifice units to achieve your goals")}
#enddef

#define R_OBJECTIVE_NON_PERSISTENT_TEAM_WARNING
    {OBJECTIVE_NOTE ( _ "Torancyn and his units (blue team) will <b>not</b> be carried over to the next scenario")}
#enddef

#define R_OBJECTIVE_DRONES
    [objective]
        description= _ "Destroy the Demolisher Drones before they reach Adavyan’s Keep at the center of the city"+" <small>"+_"($payload_count drones remaining)"+"</small>"
        condition=win
        [show_if]
            {VARIABLE_NUMERICAL_GREATER_THAN payload_count 1}
        [/show_if]
    [/objective]
    [objective]
        description= _"Destroy the Demolisher Drones before they reach Adavyan’s Keep at the center of the city"+" <small>"+_"(One drone remaining)"+"</small>"
        condition=win
        [show_if]
            {VARIABLE_NUMERICAL_EQUALS payload_count 1}
        [/show_if]
    [/objective]
#enddef

    [event]
        name=update player objectives
        first_time_only=no

        [if]
            {VARIABLE_NUMERICAL_GREATER_THAN payload_count 0}
            [then]
                {OBJECTIVES (
                    side=1
                    silent=yes
                    {R_OBJECTIVE_DRONES}
                    {R_COMMON_OBJECTIVES}
                    {R_OBJECTIVES_SIDE_1_DEATHS}
                    {R_OBJECTIVE_NOTES}
                    {OBJECTIVE_CARRYOVER}
                )}

                {OBJECTIVES (
                    side=2
                    silent=yes
                    {R_OBJECTIVE_DRONES}
                    {R_COMMON_OBJECTIVES}
                    {R_OBJECTIVES_SIDE_2_DEATHS}
                    {R_OBJECTIVE_NON_PERSISTENT_TEAM_WARNING}
                    {R_OBJECTIVE_NOTES}
                )}
            [/then]
            [else]
                {OBJECTIVES (
                    side=1
                    {R_COMMON_OBJECTIVES}
                    {R_OBJECTIVES_SIDE_1_DEATHS}
                    {OBJECTIVE_CARRYOVER}
                )}

                {OBJECTIVES (
                    side=2
                    {R_COMMON_OBJECTIVES}
                    {R_OBJECTIVES_SIDE_2_DEATHS}
                    {R_OBJECTIVE_NON_PERSISTENT_TEAM_WARNING}
                )}
            [/else]
        [/if]
    [/event]

#undef R_COMMON_OBJECTIVES
#undef R_OBJECTIVES_SIDE_1_DEATHS
#undef R_OBJECTIVES_SIDE_2_DEATHS
#undef R_OBJECTIVE_DRONES
#undef R_OBJECTIVE_NOTES
#undef R_OBJECTIVE_NON_PERSISTENT_TEAM_WARNING

    [event]
        name=start

        [message]
            speaker=Durvan
            message= _ "I can barely see through this fog and smoke, but, those are the city walls."
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=narrator
            image="misc/blank-hex.png"
            message= _ "<i>Dispel the fog.</i>"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Who said that?"
        [/message]

        [message]
            speaker=Durvan
            message= _ "Uh, I haven’t said anything..."
        [/message]

        [delay]
            time=750
        [/delay]

        [unit]
            animate=yes
            # wmllint: recognize Irylean
            {CHARACTER_STATS_IRYLEAN}
            side=8
            x,y=45,6
        [/unit]

        {LOYAL_UNDEAD_UNIT 8 (Skeleton Archer) 44 5} {FACING ne}
        [+unit]
            [+modifications]
                {TEAM_COLOR_OVERRIDE () white}
            [/modifications]
        [/unit]
        {LOYAL_UNDEAD_UNIT 8 (Skeleton Archer) 45 7} {FACING ne}
        [+unit]
            [+modifications]
                {TEAM_COLOR_OVERRIDE () white}
            [/modifications]
        [/unit]

        [message]
            speaker=Irylean
            message= _ "This has only just begun. Who are you and why have you come to this capital of destruction—"
        [/message]

        {MODIFY_UNIT (id=Elynia) facing se}

        [message]
            speaker=Elynia
            message=_ "I know you. Aren’t you—"
        [/message]

        [message]
            speaker=Irylean
            message= _ "The Lady of Light! We are saved! Hear, everyone, the gods have finally answered our prayers! She has returned!"
        [/message]

        {R_ARPHALAD_MILITIA (Aragwaith Swordsman) 47 8 Roeghar ( _ "Roeghar") ({TRAIT_RESILIENT})   (nw)}
        {R_ARPHALAD_MILITIA (Aragwaith Archer)    49 7 Avethan ( _ "Avethan") ({TRAIT_INTELLIGENT}) (nw)}

        [message]
            speaker=Avethan
            message= _ "All hail the Lady of Light!"
        [/message]

        [message]
            speaker=Anya
            message= _ "You appear to be quite popular here."
        [/message]

        [message]
            speaker=Elynia
            message= _ "This is rather unexpected given the circumstances of my previous return, but that was a long time ago, after all. If I’m not mistaken you are Irylean, one of Galas’ old advisors?"
        [/message]

        [message]
            speaker=Irylean
            message= _ "Indeed I was, my lady, but ever since Lord Galas stepped down I retired to this once prosperous land. The demons’ assault was completely  unexpected, but we are all doing our best to repel their forces. It’s said many members of the Grand Council were killed by the initial charges that destroyed the walls, but—"
        [/message]

        [modify_side]
            side=1
            fog=no
        [/modify_side]

        [redraw]
            side=1 # refresh minimap
        [/redraw]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Anya
            message= _ "The fog has lifted!"
        [/message]

        [message]
            speaker=Durvan
            message= _ "Lords of Light, what has happened to the capital?"
        [/message]

        [message]
            speaker=narrator
            image="misc/blank-hex.png"
            message= _ "<i>Look around.</i>"
        [/message]

#define R_BEHOLD_LOCATION _X _Y
    [scroll_to]
        x={_X}
        y={_Y}
    [/scroll_to]

    [delay]
        time=750
    [/delay]
#enddef

        {MODIFY_UNIT (id=Elynia) facing sw}

        [delay]
            time=750
        [/delay]

        {R_BEHOLD_LOCATION 35 10}

        {R_BEHOLD_LOCATION 16  7}

        {R_BEHOLD_LOCATION 16 26}

        {R_BEHOLD_LOCATION 30 39}

        {R_BEHOLD_LOCATION 58 34}

        {R_BEHOLD_LOCATION 25 20}

#undef R_BEHOLD_LOCATION

        [move_unit_fake]
            type=Aragwaith Lancer
            side=2
            x=35,36,37,38,39,40,41
            y= 8, 7, 7, 6, 6, 5, 5
        [/move_unit_fake]

        {R_RAELTHYN_DEFENSE (Aragwaith Lancer) 41 5 Vaenceth ( _ "Vaenceth") ({TRAIT_INTELLIGENT}) ne}
        [+unit]
            animate=no
        [/unit]

        [message]
            speaker=Vaenceth
            message= _ "Lady of Light, the Grand Council—or what remains of it anyway—sent me with a message for you, from our seer."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Valen? Is she—"
        [/message]

        [message]
            speaker=Vaenceth
            message= _ "She’s alive, but she needs your help— we all need your help. Our highest walls were struck down by the enemies through the use of strange self-destructing creatures. Our scouts have spotted more of them slowly coming towards the capital."
        [/message]

        [store_locations]
            [filter]
                type=Shaxthal Demolisher Drone
            [/filter]
            variable=payload_locs
        [/store_locations]

        {FOREACH payload_locs k}
            [scroll_to_unit]
                x,y=$payload_locs[$k].x,$payload_locs[$k].y
            [/scroll_to_unit]

            {HIGHLIGHT_GOAL (x,y=$payload_locs[$k].x,$payload_locs[$k].y)}
        {NEXT k}

        {CLEAR_VARIABLE payload_locs}

        [message]
            speaker=Vaenceth
            message= _ "If we are to defend Raelthyn, we must ensure they don’t reach and destroy the main keep where the remaining Grand Council members are. Should we lose the keep..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "That would be a huge blow against everyone’s morale, I know."
        [/message]

        [message]
            speaker=Irylean
            message= _ "I didn’t expect more of those to be heading towards here. I saw them in action... and stopping them might not have been my brightest plan either. They explode when defeated."
        [/message]

        [message]
            speaker=Vaenceth
            message= _ "Lord Torancyn said we should take them down no matter what the cost is."
        [/message]

        [message]
            speaker=Elynia
            message= _ "What a suicidal approach. Of course this is not a major problem when all the involved are undead, but we’ll never reach the other drones before they get to the keep. I assume his plan is to sacrifice his own people; he should hope there are desperate souls willing to give up their lives for the city amongst his troops. Irylean?"
        [/message]

        [message]
            speaker=Irylean
            message= _ "I’m at your service, my lady. And I presume the good people of Arphalad are as well."
        [/message]

        [message]
            speaker=Elynia
            message= _ "I suggest you reconsider your retirement. If we succeed here, I may require your help for a personal quest of mine. But for now, we need to take down those creatures and force their leaders to retreat or else, and you will help us."
        [/message]

        {MODIFY_UNIT (side=8) side 1}

        [message]
            speaker=Irylean
            message= _ "Of course, my lady."
        [/message]

        [message]
            speaker=Elynia
            message= _ "It’s time to get moving."
        [/message]

        [allow_recruit]
            side=1
            type=Vampire Bat,Ghost,Skeleton,Skeleton Archer,Walking Corpse
        [/allow_recruit]

        [transient_message]
            message= _ "You can once again recruit undead units.

Additionally, Irylean and the surviving militia men of Arphalad will follow you on your quest."
        [/transient_message]

        [unhide_unit]
            side=2
        [/unhide_unit]

        [capture_village]
            side=1
            x=37-47
            y= 1-10
            terrain=*^V*
        [/capture_village]

        {MOVE_UNIT (id=Elynia) 41 3}

        {R_UPDATE_OBJECTIVES}

        # HACK: We need this here since we always set the initial objectives silent=yes
        # above to keep the code simple, causing them to not be shown at the start of
        # turn 1 like usual.
        [show_objectives][/show_objectives]
    [/event]

    [event]
        name=side 2 turn 1

        {REPLACE_SCENARIO_MUSIC ("casualties_of_war.ogg")}
        {APPEND_MUSIC           ("siege_of_laurelmor.ogg")}
        {APPEND_MUSIC           ("battle.ogg")}

        [message]
            speaker=Torancyn
            message= _ "Here they come. Time to take them down."
        [/message]

        [message]
            speaker=Valen
            message= _ "Haven’t we lost enough soldiers and citizens defending the city yet? You should have called upon any necromancers there could be around instead."
        [/message]

        [message]
            speaker=Torancyn
            message= _ "The last one I trusted ended up betraying the Lady of Light, or that’s what you told us. What makes you think their kind can be trusted?"
        [/message]

        [message]
            speaker=Valen
            message= _ "The notion that not all of them are like-minded."
        [/message]

        # wmllint: local spelling Illana

        [message]
            speaker=Torancyn
            message= _ "I’m not taking my chances with those people again. Especially not now that Arnesius and Illana—"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Torancyn
            message= _ "Let’s just proceed with the plan and be done with it."
        [/message]
    [/event]

#undef R_RAELTHYN_DEFENSE
#undef R_ARPHALAD_MILITIA

    [event]
        # 'die' is used by the Demolition ability, and we're not guaranteed
        # our handler here will execute before that one, so we need to make
        # sure to block the ability's event handler first by triggering our
        # player defeat path!
        name=last breath
        [filter]
            type=Shaxthal Demolisher Drone
            [filter_location]
                [filter_adjacent_location]
                    {R_ADAS_KEEP_SLF}
                [/filter_adjacent_location]
            [/filter_location]
        [/filter]

        [fire_event]
            name=destroy adas keep
            [primary_unit]
                x,y=$x1,$y1
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=moveto
        [filter]
            type=Shaxthal Demolisher Drone
            {R_ADAS_KEEP_SLF}
        [/filter]

        [fire_event]
            name=destroy adas keep
            [primary_unit]
                x,y=$x1,$y1
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=destroy adas keep

        [kill]
            fire_event=no
            animate=yes
            x,y=$x1,$y1
        [/kill]

        {WHITE_SCREEN}

        # unceremoniously kill everyone in the keep without
        # giving them a chance to say their usual last words

        [kill]
            {R_ADAS_KEEP_SLF}
            animate=no
            fire_event=no
        [/kill]

        # TODO: also kill everyone adjacent

        # boom!

        [terrain]
            {R_ADAS_KEEP_SLF}
            terrain=Qxe
        [/terrain]

        {QUAKE "explosion-big.ogg"}

        [redraw][/redraw] # update terrain display

        {RESET_SCREEN}

        [delay]
            time=1000
        [/delay]

        [message]
            # try to locate a living hero unit
            id=Torancyn
            [or]
                id=Valen
            [/or]
            [or]
                id=Elynia
            [/or]
            [or]
                id=Anya
            [/or]
            [or]
                id=Durvan
            [/or]
            [or]
                id=Irylean
            [/or]
            # failing that, go for non-hero units
            [or]
                side=2
            [/or]
            [or]
                side=1
            [/or]
            message= _ "We have failed; Adavyan’s keep has been destroyed!"
        [/message]

        # signal defeat and get us out of whatever sequence led here
        # (i.e. so we don't get the Demolition ability's 'die' event handler
        # to run when the payload was activated near the keep)

        {ENDLEVEL_DEFEAT}
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            type=Shaxthal Demolisher Drone
            [not]
                [filter_location]
                    [filter_adjacent_location]
                        {R_ADAS_KEEP_SLF}
                    [/filter_adjacent_location]
                [/filter_location]
            [/not]
        [/filter]
        [filter_condition]
            {VARIABLE_NUMERICAL_GREATER_THAN payload_count 0}
        [/filter_condition]

        {VARIABLE_DEC payload_count}

        [fire_event]
            name=check payload status
        [/fire_event]
    [/event]

    [event]
        name=check payload status
        [filter_condition]
            {VARIABLE_NUMERICAL_EQUALS payload_count 0}
        [/filter_condition]

        [message]
            speaker=Torancyn
            message= _ "Very well, the last one of those bastards is down!"
        [/message]
    [/event]

    [event]
        name=check payload status
        first_time_only=no

        {R_UPDATE_OBJECTIVES}
    [/event]

    [event]
        name=last breath
        [filter]
            id=Valen
        [/filter]

        [message]
            speaker=Valen
            message= _ "Lord Torancyn, please tell the Lady of Light... the journal... I’m sorry..."
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            id=Valen
        [/filter]

        {ENDLEVEL_DEFEAT}
    [/event]

    [event]
        name=last breath
        [filter]
            id=Torancyn
        [/filter]

        [message]
            speaker=Torancyn
            message= _ "I never expected the heart of our country to be my last battlefield... Alas, Raelthyn will fall... without me..."
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            id=Torancyn
        [/filter]

        [message]
            speaker=Irylean
            message= _ "Lord Torancyn was slain in battle. This is hopeless."
        [/message]

        {ENDLEVEL_DEFEAT}
    [/event]

    [event]
        name=enemies defeated
        {ENDLEVEL_VICTORY yes}

        [message]
            speaker=Torancyn
            message= _ "Do the rest of you fiends want to come and taste our steel?"
        [/message]

        [message]
            speaker=Valen
            message= _ "They appear to be retreating."
        [/message]
    [/event]

    [event]
        name=time over
        {ENDLEVEL_VICTORY no}

        [message]
            speaker=Durvan
            message= _ "The fiends retreat; that’s rather odd."
        [/message]
    [/event]

    [event]
        name=victory

        [kill]
            canrecruit=yes
            [filter_side]
                [enemy_of]
                    side=1
                [/enemy_of]
            [/filter_side]
            animate=no
            fire_event=no
        [/kill]

        # wmllint: recognize Unarye
        [unit]
            {CHARACTER_STATS_UNARYE}
            canrecruit=yes
            side=9
            x,y=56,2
            facing=sw
        [/unit]

        {GENERIC_UNIT 9 (Elvish Sharpshooter) 56 1} {FACING sw}
        {GENERIC_UNIT 9 (Elvish Champion) 57 2} {FACING sw}

        {GENERIC_UNIT 9 (Elvish Enchantress) 60 16} {FACING nw}
        {GENERIC_UNIT 9 (Elvish Marshal) 60 17} {FACING nw}
        {GENERIC_UNIT 9 (Elvish Fighter) 61 14} {FACING nw}
        {GENERIC_UNIT 9 (Elvish Outrider) 53 3} {FACING nw}
        {GENERIC_UNIT 9 (Elvish Fighter) 54 16} {FACING nw}
        {GENERIC_UNIT 9 (Elvish Archer) 59 9} {FACING sw}
        {GENERIC_UNIT 9 (Elvish Prowler) 57 5} {FACING sw}
        {GENERIC_UNIT 9 (Elvish Captain) 60 5} {FACING sw}
        {GENERIC_UNIT 9 (Elvish Marksman) 53 13} {FACING se}
        {GENERIC_UNIT 9 (Elvish Shyde) 61 10} {FACING nw}
        {GENERIC_UNIT 9 (Elvish Ascetic) 59 3} {FACING sw}

        [message]
            speaker=Anya
            message= _ "Look to the northeast!"
        [/message]

        [scroll_to_unit]
            id=Unarye
        [/scroll_to_unit]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Irylean
            message= _ "Ha! It was about time!"
        [/message]
    [/event]

#undef R_ADAS_KEEP_SLF
#undef R_UPDATE_OBJECTIVES
[/scenario]

# kate: indent-mode normal; encoding utf-8; space-indent on;
