#textdomain wesnoth-After_the_Storm

[scenario]
    id=09_Dark_Depths
    name= _ "Dark Depths"
    {MAP 09_Dark_Depths_01.map}
    {TURNS 66 64 62}
    next_scenario=10_Blood
    victory_when_enemies_defeated=no
    disallow_recall=yes

    {DIVERGENCE_SIDE_PERSISTENCE_WORKAROUND_IMPLEMENTATION_ON_PRESTART 1 elynia_side_store}

    {I_DEATHS}

    {SCENARIO_MUSIC       "knalgan_theme.ogg"}
    {EXTRA_SCENARIO_MUSIC "suspense.ogg"}
    {EXTRA_SCENARIO_MUSIC "heroes_rite.ogg"}

    {STORYTXT_DARK_DEPTHS}

    {SPAWN_CONTROLLER}

    {INDOORS_HIVE} {SCHEDULE_LIGHTING -40 -80 -20}

    # TODO: boss units and helpers prefer attacking side 1's Fire Guardians
    #       instead of Elynia and Elyssa.

#define FINALE_B_SHARED_AI_PARAMS
    {AI_SIMPLE_ALWAYS_ASPECT aggression        1.00}
    {AI_SIMPLE_ALWAYS_ASPECT leader_aggression 1.00}
    {AI_SIMPLE_ALWAYS_ASPECT caution           0.00}
    {AI_SIMPLE_ALWAYS_ASPECT grouping            no}
#enddef

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        save_id=Elynia
        team_name=good
        user_team_name= _ "team_name^Elynia"
        {RAGGED_FLAG}

        fog=yes
        shroud=yes

        {NO_ECONOMY}

        share_maps=no
        share_view=no

        # wmllint: recognize Elynia
        {CHARACTER_STATS_ELYNIA}
        type=Guardian of Earth Elynia
        canrecruit=yes
    [/side]
    # wmllint: validate-on

    [side]
        # Midboss 2
        side=2
        team_name=evil
        user_team_name= _ "team_name^Zhangor"
        {CHAOS_FLAG}
        color=yellow

        hidden=yes
        no_leader=yes

        {NO_ECONOMY}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {FINALE_B_SHARED_AI_PARAMS}

            {AI_BOSS_TARGETING_ENGINE <<{"Elyssa","Elynia"}>>}

            [goal]
                [criteria]
                    id=Elyssa
                [/criteria]
                value=200
            [/goal]

            [goal]
                [criteria]
                    id=Elynia
                [/criteria]
                value=200 # Targets Elynia the same.
            [/goal]

            [goal]
                [criteria]
                    type=Fire Guardian
                [/criteria]
                value=1
            [/goal]
        [/ai]
    [/side]

    [side]
        # Midboss 1
        side=3
        team_name=evil
        user_team_name= _ "team_name^Engineer"
        {CHAOS_FLAG}
        color=yellow

        hidden=yes
        no_leader=yes

        {NO_ECONOMY}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {FINALE_B_SHARED_AI_PARAMS}

            {AI_BOSS_TARGETING_ENGINE <<{"Elyssa","Elynia"}>>}

            [goal]
                [criteria]
                    id=Elyssa
                [/criteria]
                value=200
            [/goal]

            [goal]
                [criteria]
                    id=Elynia
                [/criteria]
                value=100 # Prefers Elyssa.
            [/goal]

            [goal]
                [criteria]
                    type=Fire Guardian
                [/criteria]
                value=1
            [/goal]
        [/ai]
    [/side]

    [side]
        side=4
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        hidden=yes

        {NO_ECONOMY}

        canrecruit=yes
        type=Giant Spider

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {FINALE_B_SHARED_AI_PARAMS}
        [/ai]

        {GENERIC_UNIT () (Vampire Bat) 45 40} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Vampire Bat) 37 42} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING ne}
        {GENERIC_UNIT () (Vampire Bat) 55 38} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Vampire Bat) 51 44} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}

        {GENERIC_UNIT () (Dread Bat) 34 41} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}

        {GENERIC_UNIT () (Blood Bat) 42 37} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
    [/side]

    [side]
        side=5
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        hidden=yes

        {NO_ECONOMY}

        canrecruit=yes
        type=Giant Spider

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {FINALE_B_SHARED_AI_PARAMS}
        [/ai]

        {GENERIC_UNIT () (Giant Ant) 27 26} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
        {GENERIC_UNIT () (Giant Ant) 26 28} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING ne}

        {GENERIC_UNIT () (Fungoid) 58 37} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Fungoid) 49 41} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Fungoid) 57 44} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}

        {GENERIC_UNIT () (Abomination) 47 38} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}
    [/side]

    [side]
        side=6
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        hidden=yes

        {NO_ECONOMY}

        canrecruit=yes
        type=Psy Mindraider

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {FINALE_B_SHARED_AI_PARAMS}
        [/ai]

        {GENERIC_UNIT () (Psy Crawler) 50 30} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}
        {GENERIC_UNIT () (Psy Crawler) 47 36} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
        {GENERIC_UNIT () (Psy Crawler) 55 38} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Verlissh Matrix Flow System) 58 22} {NO_UPKEEP_NO_OVERLAY}

        {GENERIC_UNIT () (Verlissh Matrix Flow System) 50 13} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT () (Verlissh Matrix Flow System) 51 14} {NO_UPKEEP_NO_OVERLAY}

        {GENERIC_UNIT () (Verlissh Matrix Flow System) 36  9} {NO_UPKEEP_NO_OVERLAY}

        {GENERIC_UNIT () (Verlissh Matrix Flow System) 34 14} {NO_UPKEEP_NO_OVERLAY}

        {GENERIC_UNIT () (Verlissh Matrix Flow System) 22 20} {NO_UPKEEP_NO_OVERLAY}
    [/side]

    [side]
        # Shaxthal
        side=7
        team_name=evil
        user_team_name= _ "team_name^Dark Hive"
        {CHAOS_FLAG}

        hidden=yes
        no_leader=yes

        {NO_ECONOMY}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {FINALE_B_SHARED_AI_PARAMS}
        [/ai]

        {GENERIC_UNIT () (Shaxthal Stormblade) 41 30} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING n}
        {PALETTE shaxthal_drone_surface shaxthal_drone_purple}
        {GENERIC_UNIT () (Shaxthal Stormblade) 33 24} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
        {PALETTE shaxthal_drone_surface shaxthal_drone_purple}

        {GENERIC_UNIT () (Shaxthal Turret) 33 12} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT () (Shaxthal Turret) 52 21} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT () (Shaxthal Turret) 37 11} {NO_UPKEEP_NO_OVERLAY}
    [/side]

    [side]
        # Cutscene team used to emulate side 1 units
        side=8
        team_name=good
        user_team_name= _ "team_name^Elynia"
        {RAGGED_FLAG}
        color=red
        controller=null

        hidden=yes
        no_leader=yes

        share_maps=no
        share_view=no

        {NO_ECONOMY}
    [/side]

#define FINALE_B_DRONE_TINT_1
    [modifications]
        {UNIT_PALETTE_SWITCH () shaxthal_drone_base shaxthal_drone_purple}
    [/modifications]
#enddef
#define FINALE_B_DRONE_TINT_2
    [modifications]
        {UNIT_PALETTE_SWITCH () shaxthal_drone_surface shaxthal_drone_purple}
    [/modifications]
#enddef

    {TIMED_DRONE_SPAWNER 8 ({FINALE_B_DRONE_TINT_1} type,facing="Shaxthal Sentry Drone",se)    7 31 9}
    {TIMED_DRONE_SPAWNER 8 ({FINALE_B_DRONE_TINT_1} type,facing="Shaxthal Sentry Drone",se)    7 33 6}
    {TIMED_DRONE_SPAWNER 8 ({FINALE_B_DRONE_TINT_1} type,facing="Shaxthal Enforcer Drone",sw)  7 39 4}

    {TIMED_DRONE_SPAWNER 4 ({FINALE_B_DRONE_TINT_1} type="Shaxthal Drone")  7 35  5}
    {TIMED_DRONE_SPAWNER 4 ({FINALE_B_DRONE_TINT_1} type="Shaxthal Drone")  7 34  5}
    {TIMED_DRONE_SPAWNER 4 ({FINALE_B_DRONE_TINT_1} type="Shaxthal Drone")  7 54 22}

    {TIMED_DRONE_SPAWNER 8 ({FINALE_B_DRONE_TINT_1} type,facing="Shaxthal Sentry Drone",sw)  7 58 23}
    {TIMED_DRONE_SPAWNER 8 ({FINALE_B_DRONE_TINT_1} type,facing="Shaxthal Sentry Drone",se)  7 54 23}

    {TIMED_DRONE_SPAWNER 9 ({FINALE_B_DRONE_TINT_2} type,facing="Shaxthal Custodian Drone",ne)  7 20 20}

    {TIMED_DRONE_SPAWNER 3 ({FINALE_B_DRONE_TINT_1} type="Shaxthal Drone")  7 19 20}
    {TIMED_DRONE_SPAWNER 3 ({FINALE_B_DRONE_TINT_1} type="Shaxthal Drone")  7 20 21}

    {TIMED_DRONE_SPAWNER 6 ({FINALE_B_DRONE_TINT_1} type="Shaxthal Drone")  7 29 14}
    {TIMED_DRONE_SPAWNER 6 ({FINALE_B_DRONE_TINT_1} type="Shaxthal Drone")  7 27 15}
    {TIMED_DRONE_SPAWNER 6 ({FINALE_B_DRONE_TINT_1} type="Shaxthal Drone")  7 25 16}

    {TIMED_DRONE_SPAWNER 8 ({FINALE_B_DRONE_TINT_1} type="Shaxthal Worm")   7 22 19}
    {TIMED_DRONE_SPAWNER 8 ({FINALE_B_DRONE_TINT_1} type="Shaxthal Worm")   7 34  9}
    {TIMED_DRONE_SPAWNER 8 ({FINALE_B_DRONE_TINT_1} type="Shaxthal Worm")   7 54 25}

    {BIND_UNIT_TO_UNIT_MOVEMENT_RANGE id=Elyssa id=Elynia}

    {FIRE_GUARDIAN_SUMMONING}

    #
    # Code common to all bosses.
    #
    # FIXME: this code should really be common to all bosses and be
    #        part of the absorb_damage ability implementation.
    #

    [event]
        name=attacker hits
        first_time_only=no
        [filter_second]
            ability=absorb_damage
        [/filter_second]

        {BOSS_ABSORB_FULL_DAMAGE (x,y=$x2,$y2)}
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter]
            ability=absorb_damage
        [/filter]

        {BOSS_ABSORB_FULL_DAMAGE (x,y=$x1,$y1)}
    [/event]

    [event]
        name=prestart

        # This is our flag to know whether we are in the first
        # or second half of the scenario, for situations where
        # that cannot be inferred from context.
        {VARIABLE defeated_engineer no}

        {VARIABLE used_touchplate_1 no}
        {VARIABLE used_touchplate_2 no}

        # NOTE: this one is used in a later scenario
        {VARIABLE collected_crystal_shards 0}

        {VARIABLE part_2_map "{LE /maps/09_Dark_Depths_02.map}"}

        # wmllint: recognize Elyssa
        {RECALL_ELYSSA_AT_LOCATION 44 23}

        {MODIFY_UNIT id=Elyssa facing ne}
        {MODIFY_UNIT id=Elynia facing sw}

        [hide_unit][/hide_unit]

        {OBJECTIVES (
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Proceed further underground")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elyssa")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}

            {TURNS_RUN_OUT}

            {OBJECTIVE_NO_CARRYOVER}

            {LIMITED_CHARACTER_MOVES_NOTE}
            {FIRE_GUARDIAN_SUMMONING_NOTE}
        )}

        {BLACK_SCREEN}

        {LOCK_VIEW}
    [/event]

    [event]
        name=DEBUG1

        [teleport]
            [filter]
                id=Elyssa
            [/filter]
            x,y=37,43
        [/teleport]

        [teleport]
            [filter]
                id=Elynia
            [/filter]
            x,y=36,42
        [/teleport]
    [/event]

    [event]
        name=DEBUG2

        # Allow Elynia to move again.
        {DISABLE_BOUND_UNITS}

        [modify_turns]
            value=-1
        [/modify_turns]

        [modify_side]
            side=1
            fog=no
        [/modify_side]

        [fire_event]
            name=start part 2
        [/fire_event]
    [/event]

    #
    # NOTE: part 1 has some stock macro-controlled events for which it isn't
    # currently feasible to add these conditionals. The map for part 2 is
    # designed in such way those locations are inacessible during normal
    # gameplay. They are also marked with the Rough Overlay in the editor.
    #

#define FINALE_B_IN_PART_1
    {VARIABLE_BOOLEAN_EQUALS defeated_engineer no}
#enddef

#define FINALE_B_IN_PART_2
    {VARIABLE_BOOLEAN_EQUALS defeated_engineer yes}
#enddef

    [event]
        name=start

        {FADE_IN}

        {MOVE_UNIT id=Elyssa 44 17}

        [unhide_unit][/unhide_unit]

        [redraw]
            side=1
        [/redraw]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elynia
            message= _ "... We are not really trying to locate Zhangor, are we?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Of course we are. It is just taking us a while because he prefers to dwell in a very particular place... a place I also want you to see, before confronting him. I also want to give him a while to realize his mistake in interpreting the Seer’s prophecy."
        [/message]

        [message]
            speaker=Elynia
            message= _ "What mistake?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "The Seer said that on the Day of the Longest Night, the Angel of Blood would make a hasty attempt on the life of the New Guardian of Darkness, and fail. She also said that his actions would bring forth his own downfall."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Of course you don’t realize it because creatures like you lose track of time underground, but the Day of the Longest Night has been going on for <i>more than a day</i> already. And that is all because the New Guardian of Darkness the Seer mentioned cannot control her own powers, causing Irdya to be completely shrouded in darkness for longer than it should."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Zhangor decided to send his beasts after Ergea and your friend first, and then wait in his lair for me to go and challenge him — which would be a fairly predictable course of action for me. Or alternatively, he is awaiting for Naia to rise up again so he can attack me then. All his actions suggest he wanted to subvert the prophecy. But he already confronted the New Guardian of Darkness and failed to kill her — granted, through his minions."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "The New Guardian of Darkness the Seer referred to was not me. It was the girl. And the Longest Night will not end until she can put an end to the turmoil in her own heart, figuratively speaking."
        [/message]

        [message]
            speaker=Elynia
            message= _ "How do you know all this?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Ha, ha, ha! Don’t forget I am a Guardian of Darkness — not the <i>newest</i> one, but I certainly <i>am</i> Merthiaal’s heiress, Yarae’s design be damned. Not only I can read into the minds of the weak, but I can also understand people’s desires and motivations in general. It is possible to predict their actions in advance this way. Ah well, that is not part of the powers of a Guardian of Darkness, strictly speaking, but it does help a lot."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "And unfortunately, I also suspect Zhangor is already aware of our movements. Let’s not make him wait more time than strictly necessary, shall we?"
        [/message]

        {UNLOCK_VIEW}
    [/event]

    #
    # Events for the crystal shards during the first half of the scenario.
    #

    [event]
        name=collect crystal shard
        first_time_only=no

        {VARIABLE_INC collected_crystal_shards}

        [remove_item]
            x,y=$x1,$y1
        [/remove_item]

        [redraw]
            side=1
        [/redraw]

        [transient_message]
            image="icons/crystal-shard.png"
            transparent=yes
            message= _ "You pick up a curious crystal shard."
        [/transient_message]
    [/event]

#define FINALE_B_CRYSTAL_SHARD _X _Y
    {PLACE_IMAGE items/crystal-shard.png {_X} {_Y} }

    #
    # There are no events for other units attempting to
    # collect these. This is intentional.
    #

    [event]
        name=moveto
        [filter]
            x={_X}
            y={_Y}
            [and]
                id=Elyssa
                [or]
                    id=Elynia
                [/or]
            [/and]
        [/filter]
        [filter_condition]
            {FINALE_B_IN_PART_1}
        [/filter_condition]

        [fire_event]
            name=collect crystal shard
            [primary_unit]
                x,y=$x1,$y1
            [/primary_unit]
        [/fire_event]
    [/event]
#enddef

    {FINALE_B_CRYSTAL_SHARD 37 21}

    {FINALE_B_CRYSTAL_SHARD 31 33}

    {FINALE_B_CRYSTAL_SHARD 46 48}

    {FINALE_B_CRYSTAL_SHARD 61 29}

    #
    # Some dialogue follows the activation of this
    # glyph.
    #

    [event]
        name=moveto
        [filter]
            side=1
            x,y=38,3
        [/filter]

        {CLEAR_CAVE_SHROUD (
            x,y=25,25
            radius=2
        )}

        [redraw]
            side=1
        [/redraw]
    [/event]

    {GATE_GLYPH 38  3 25 25}

    [event]
        name=moveto
        [filter]
            side=1
            x,y=38,3
        [/filter]
        [filter_condition]
            {FINALE_B_IN_PART_1}
        [/filter_condition]

        {LOCK_VIEW}

        [terrain]
            terrain=^Br\
            x,y=25,25
            layer=overlay
        [/terrain]

        [redraw]
            side=1
        [/redraw]

        [message]
            speaker=Elynia
            message= _ "Where does that lead to?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "It’s an alternative path to an elevator shaft that will take us directly to the place I previously mentioned. While I don’t mind stabbing whoever stands in our way, a more discreet approach will get us there faster."
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]

        {UNLOCK_VIEW}
    [/event]

    [event]
        name=may not use touchplate dialog
        first_time_only=no

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Only a fully corporeal unit such as Elyssa or Elynia may activate this touchplate."
        [/message]
    [/event]

#define FINALE_B_IS_HERO
    id=Elynia
    [or]
        id=Elyssa
    [/or]
#enddef

#define FINALE_B_TOUCHPLATE _NUM _X _Y
    {ITEM_TOUCHPLATE {_X} {_Y} }

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            type=Fire Guardian
            x={_X}
            y={_Y}
        [/filter]
        [filter_condition]
            {VARIABLE_BOOLEAN_EQUALS ("used_touchplate_"+{_NUM}) no}
            {FINALE_B_IN_PART_1}
        [/filter_condition]

        [fire_event]
            name=may not use touchplate dialog
        [/fire_event]
    [/event]

    [event]
        name=moveto
        [filter]
            x={_X}
            y={_Y}
            [and]
                {FINALE_B_IS_HERO}
            [/and]
        [/filter]
        [filter_condition]
            {FINALE_B_IN_PART_1}
        [/filter_condition]

        [remove_item]
            x,y=$x1,$y1
        [/remove_item]

        {VARIABLE ("used_touchplate_"+{_NUM}) yes}
    [/event]
#enddef

    #
    # Affects the walls around (44, 31) via explosion.
    #

    {FINALE_B_TOUCHPLATE 1 42 30}

    [event]
        name=moveto
        [filter]
            x,y=42,30
            [and]
                {FINALE_B_IS_HERO}
            [/and]
        [/filter]
        [filter_condition]
            {FINALE_B_IN_PART_1}
        [/filter_condition]

        {LOCK_VIEW}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Nothing happens."
        [/message]

        [if]
            [have_unit]
                x,y=$x1,$y1
                id=Elyssa
            [/have_unit]
            [then]
                [message]
                    speaker=Elyssa
                    message= _ "These secret passages have gone unused for centuries — it’s no wonder that most of their mechanisms have rusted beyond use. But I know a method that never fails..."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Elyssa
                    message= _ "These secret passages have gone unused for centuries — it’s no wonder that most of their mechanisms have rusted beyond use. Just blast the wall down already."
                [/message]
            [/else]
        [/if]

        [delay]
            time=750
        [/delay]

        #
        # Very simplified version of the "blast event wall" event from
        # the previous scenario.
        #

        [hide_unit][/hide_unit]

        {RED_SCREEN}

        [terrain]
            x=42-45,44,43
            y=31   ,30,32
            terrain=Ur^Es
        [/terrain]

        {CLEAR_CAVE_SHROUD (
            x=42-45,44,43
            y=31   ,30,32
        )}

        [scroll_to]
            x,y=44,31
            {WARP}
        [/scroll_to]

        [redraw]
            side=1
        [/redraw]

        {RESET_SCREEN}

        [unhide_unit][/unhide_unit]

        {QUAKE ("explosion-big.ogg")}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "Perfect."
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]

        {UNLOCK_VIEW}
    [/event]

    #
    # This one is manually controlled further.
    # It affects both the walls around (44, 39), and the gate around 52 29.
    #
    {GATE_GLYPH 54 41 52 29}

    [event]
        name=moveto
        [filter]
            side=1
            x,y=54,41
        [/filter]
        [filter_condition]
            {FINALE_B_IN_PART_1}
        [/filter_condition]

        [message]
            speaker=Elyssa
            message= _ "That is not very useful—"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "Hm, there is a hot current of air coming from another direction now."
        [/message]

        [terrain]
            x,y=43,39-40
            terrain=Urb
        [/terrain]

        {CLEAR_CAVE_SHROUD (x,y,radius=44,39,1)}

        [redraw]
            side=1
        [/redraw]

        [delay]
            time=750
        [/delay]

        [scroll_to]
            x,y=44,39
        [/scroll_to]

        {HIGHLIGHT_GOAL x,y=44,39}

        [message]
            speaker=Elyssa
            message= _ "Ah. I remember now."
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]
    [/event]

    #
    # Lava shore.
    #

#define FINALE_B_LAVA_SHORE_X_Y
    x=43   ,44
    y=39-40,39
#enddef

#define FINALE_B_TRY_RELOCATE_HERO _ID _LOCS_X_Y
    [if]
        [not]
            [have_unit]
                id={_ID}
                {_LOCS_X_Y}
            [/have_unit]
        [/not]
        [then]
            [store_locations]
                {_LOCS_X_Y}
                [not]
                    [filter][/filter]
                [/not]
                variable=vacant_locs
            [/store_locations]

            [teleport]
                [filter]
                    id={_ID}
                [/filter]
                x,y=$vacant_locs[0].x,$vacant_locs[0].y
            [/teleport]

            {CLEAR_VARIABLE vacant_locs}
        [/then]
    [/if]
#enddef

    [event]
        name=moveto
        [filter]
            {FINALE_B_LAVA_SHORE_X_Y}
            [and]
                {FINALE_B_IS_HERO}
            [/and]
        [/filter]
        [filter_condition]
            {FINALE_B_IN_PART_1}
        [/filter_condition]

        {LOCK_VIEW}

        #
        # Make sure Elynia and Elyssa are together at this point.
        #

        {FORCE_MOBILIZE_BOUND_UNIT id=Elynia}

        [store_unit]
            [filter]
                {FINALE_B_LAVA_SHORE_X_Y}
                [not]
                    id=Elynia
                [/not]
                [not]
                    id=Elyssa
                [/not]
            [/filter]
            variable=other_store
            kill=yes
        [/store_unit]

        {FINALE_B_TRY_RELOCATE_HERO Elynia ({FINALE_B_LAVA_SHORE_X_Y})}
        {FINALE_B_TRY_RELOCATE_HERO Elyssa ({FINALE_B_LAVA_SHORE_X_Y})}

        {FOREACH other_store k}
            [unstore_unit]
                variable="other_store[$k]"
                find_vacant=yes
                check_passability=no
            [/unstore_unit]
        {NEXT k}

        {CLEAR_VARIABLE other_store}

        {CLEAR_CAVE_SHROUD (
            x,y=41,40
            radius=4
        )}

        [redraw]
            side=1
        [/redraw]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "We need to cross this inconvenient lava trench. Elynia, do your thing."
        [/message]

        [message]
            speaker=Elynia
            message= _ "My... thing?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "You are the Guardian of <i>Earth</i>, dear. You are supposed to do more complicated things than blasting walls and vermin."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Do you really expect me to know how this works all of a sudden? I did not ask to given this role, and all I know is that the pain has not ceased. I cannot think clearly like this."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "I <i>really</i> should just stab you in the chest and toss your useless bloody corpse into the lava."
        [/message]

        [hide_unit][/hide_unit]

        {RED_SCREEN}

        [terrain]
            x=42,41
            y=39,40
            terrain=Uh
        [/terrain]

        [redraw]
            side=1
        [/redraw]

        {RESET_SCREEN}

        [unhide_unit][/unhide_unit]

        {QUAKE ("explosion-big.ogg")}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "Keep moving."
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]

        {UNLOCK_VIEW}
    [/event]

#define FINALE_B_CHAMBER_WALL_X_Y
    x=33,34,35,36
    y=43,43,44,44
#enddef

    # Manually controlled.
    # Affects the walls around (34, 43) via old-fashioned wall-lifting.
    {FINALE_B_TOUCHPLATE 2 35 43}

    [event]
        name=moveto
        [filter]
            x,y=35,43
            [and]
                {FINALE_B_IS_HERO}
            [/and]
        [/filter]
        [filter_condition]
            {FINALE_B_IN_PART_1}
        [/filter_condition]

        {LOCK_VIEW}

        {VARIABLE spawner_controller_enabled no}

        {FORCE_MOBILIZE_BOUND_UNIT id=Elynia}

        [if]
            [have_unit]
                id=Elyssa
                x,y=$x1,$y1
            [/have_unit]
            [then]
                [message]
                    speaker=Elyssa
                    message= _ "Well, this wall is not going to move by itself—"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Elyssa
                    message= _ "Well, that wall is not going to move by itself—"
                [/message]
            [/else]
        [/if]

        {QUAKE ("rumble.ogg")}

        [terrain]
            {FINALE_B_CHAMBER_WALL_X_Y}
            terrain=Urb
        [/terrain]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message=_"Touchplate triggered. A wall moves."
        [/message]

        {CLEAR_CAVE_SHROUD (
            x,y=31,48
            radius=5
        )}

        [redraw]
            side=1
        [/redraw]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "I stand corrected. That was very convenient."
        [/message]

        {MOVE_UNIT id=Elyssa 32 46}
        {MOVE_UNIT id=Elynia 34 47}

        {RESET_UNIT_STATUSES (
            id=Elyssa
            [or]
                id=Elynia
            [/or]
        )}

        [kill]
            type=Fire Guardian
            side=1
        [/kill]

        [place_shroud]
            side=1
            [not]
                x,y=31,48
                radius=6
            [/not]
        [/place_shroud]

        [terrain]
            {FINALE_B_CHAMBER_WALL_X_Y}
            terrain=Xos
        [/terrain]

        [modify_side]
            side=1
            fog=no
        [/modify_side]

        [redraw]
            side=1
        [/redraw]

        {REPLACE_SCENARIO_MUSIC "overlive.ogg"}

        {QUAKE ("dragonstick.ogg")}

        [delay]
            time=500
        [/delay]

        {MODIFY_UNIT id=Elyssa facing ne}
        {MODIFY_UNIT id=Elynia facing nw}

        [redraw][/redraw]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "Of course. A cunning trap by Zhangor, I presume?"
        [/message]

        {MODIFY_UNIT id=Elyssa facing sw}
        {MODIFY_UNIT id=Elynia facing sw}

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        {MODIFY_UNIT id=Elyssa facing se}

        {CLEAR_CAVE_SHROUD (
            x,y=31,52
            radius=4
        )}

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=32,52
        [/scroll_to]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            scroll=no
            message= _ "The elevator..."
        [/message]

        [scroll_to_unit]
            id=Elyssa
        [/scroll_to_unit]

        [fire_event]
            name=boss 1 stage 1
        [/fire_event]
    [/event]

    [event]
        name=boss 1 stage 1

        {LOCK_VIEW}

        [store_starting_location]
            side=3
        [/store_starting_location]

        [unit]
            canrecruit=yes
            side=3
            id=Engineer Fendyrn
            name= _ "Engineer Fendyrn"
            type=Dwarvish Engineer
            x,y=$location.x,$location.y
            [modifications]
                {TRAIT_HEALTHY}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image=misc/blank-hex.png
            message= _ "<i>... heh, heh, heh, heh, heh, heh...</i>"
        [/message]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "Who is that?"
        [/message]

        {MODIFY_UNIT id=Elyssa facing sw}

        [redraw][/redraw]

        [message]
            speaker=Elyssa
            message= _ "Engineer?"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image=misc/blank-hex.png
            message= _ "<i>... hah, hah, hah, hah...</i>"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "You are not supposed to be around these levels, Engineer. Return to your workshop immediately."
        [/message]

        [message]
            speaker=Engineer Fendyrn
            message= _ "I do nae’ listen to order from yer anymore, witch. Yer time as the ‘Warlord’ ended with Lord Zhangor’s arrival."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "I believe I speak for Zhangor as well when I say that you are not supposed to be here. Return to your workshop immediately, or deal with the consequences."
        [/message]

        [message]
            speaker=Engineer Fendyrn
            message= _ "Will ye chop me remainin’ leg too, won’t ye? Ha, ha, ha, ha. Yer torture methods are as obsolete as the tech’ Argan used ta’ rebuild yer body." # wmllint: no spellcheck
        [/message]

        [message]
            speaker=Engineer Fendyrn
            # po: "Squirming insects" refers to the Shaxthal.
            # po: "The two of you" refers to Elyssa and Zhangor, not Elyssa and Elynia.
            message= _ "Zhangor released me a while ago, didn’t ye hear? “Yer free”, he said. “Ye can do anythin’ ye please”, said. And so’ere I am, ready to take on the two of you, and all yer squirmin’ insects." # wmllint: no spellcheck
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Is this insubordination I hear? This is your last chance."
        [/message]

        [message]
            speaker=Engineer Fendyrn
            message= _ "I believe ’tis yer last chance to <i>run</i>, girl." # wmllint: no spellcheck
        [/message]

        {REPLACE_SCENARIO_MUSIC "silence.ogg"}

        [hide_unit][/hide_unit]

        {WHITE_SCREEN}

        [sound]
            name="dragonstick.ogg"
        [/sound]

        [terrain]
            x=24
            y=47-53
            terrain=Ur^Es
        [/terrain]

        {CLEAR_CAVE_SHROUD (
            x,y=26,49
            radius=7
        )}

        [kill]
            id=Engineer Fendyrn
        [/kill]

        [hidden_unit]
            canrecruit=yes
            side=3
            id=Engineer Fendyrn
            name= _ "Engineer Fendyrn"
            type=Magnum Suit
            {IS_BOSS}
            x,y=$location.x,$location.y
            facing=ne
            [modifications]
                {TRAIT_MECHANICAL}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/hidden_unit]

        {CLEAR_VARIABLE location}

        [hidden_unit]
            side=3
            type=Iron Golem
            x,y=22,48
            facing=ne
            [modifications]
                {TRAIT_MECHANICAL}
            [/modifications]
        [/hidden_unit]

        [hidden_unit]
            side=3
            type=Iron Golem
            x,y=21,49
            facing=ne
            [modifications]
                {TRAIT_MECHANICAL}
            [/modifications]
        [/hidden_unit]

        [hidden_unit]
            side=3
            type=Iron Golem
            x,y=21,50
            facing=ne
            [modifications]
                {TRAIT_MECHANICAL}
            [/modifications]
        [/hidden_unit]

        {RESET_SCREEN}

        [unhide_unit][/unhide_unit]

        [redraw]
            side=1
        [/redraw]

        [scroll_to_unit]
            id=Engineer Fendyrn
            {WARP}
        [/scroll_to_unit]

        {BOSS_POPUP}

        [delay]
            time=1000
        [/delay]

        {REPLACE_SCENARIO_MUSIC "ambuscade-loop.ogg"}

        {INCIDENTAL_MUSIC       "moleman.ogg"}

        [message]
            speaker=Elynia
            message= _ "Oh gods... Is that..."
        [/message]

        [message]
            speaker=Engineer Fendyrn
            # po: The lich is Mal Hekuba.
            message= _ "Aye. The Soul Hammer is made’a the crystals commissioned by tha’ wretched lich. Lord Zhangor has put many a’them into good use, elf. But he do nae know ’tis hammer exists, or that it shall be the instrument of me revenge! Perhaps I should’a called her... the Destroyer o’ Gods!" # wmllint: no spellcheck
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Elynia, this is extremely dangerous. Stay away from this lunatic and his hammer! And you, fool... you have absolutely no idea with what kind of powers you are trifling."
        [/message]

        [message]
            speaker=Engineer Fendyrn
            message= _ "<b>HA, HA, HA, HA, HA, HA, HA, HA!!!</b>"
        [/message]

        [scroll_to_unit]
            id=Elyssa
        [/scroll_to_unit]

        [modify_turns]
            value=-1
        [/modify_turns]

        # Allow Elynia to move again.
        {DISABLE_BOUND_UNITS}

        {UNLOCK_VIEW}

        {OBJECTIVES (
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Stop the Engineer")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elyssa")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}

            {OBJECTIVE_NO_CARRYOVER}

            {OBJECTIVE_NOTE ( _ "The power of the Engineer’s hammer allows him to debilitate and destroy the Energy Heart of a Guardian")}
            {OBJECTIVE_NOTE ( _ "Elyssa and Elynia cannot damage the Engineer’s armor suit as it is powered by more replicas of Merthiaal’s heart; they must find another way to stop him")}
            {FIRE_GUARDIAN_SUMMONING_NOTE}
        )}

        [event]
            delayed_variable_substitution=no
            id=engineer_backstabbing_hint_handler # wmllint: ignore
            name="turn $($turn_number + 3)"

            [message]
                speaker=Elynia
                message= _ "I have an idea... Malin once mentioned something specific about Galas’ first encounter with your mechanical automatons."
            [/message]

            [message]
                speaker=Elyssa
                message= _ "And what would that be?"
            [/message]

            [message]
                speaker=Elynia
                message= _ "They are particularly vulnerable in the neck region. Maybe if we could distract him, you could stab him with your weapon—"
            [/message]

            [message]
                speaker=Elyssa
                message= _ "That was already my plan, stupid! Just try to do your part right for once!"
            [/message]

            {OBJECTIVES (
                victory_string= _ "Current Objective:"
                {OBJECTIVE_VICTORY ( _ "Backstab the Engineer using the Claw of Urvatha while he is facing Elynia")}

                {OBJECTIVE_DEFEAT  ( _ "Death of Elyssa")}
                {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}

                {OBJECTIVE_NO_CARRYOVER}

                {OBJECTIVE_NOTE ( _ "You can only backstab the Engineer during your own turns, on offense")}
                {OBJECTIVE_NOTE ( _ "The power of the Engineer’s hammer allows him to debilitate and destroy the Energy Heart of a Guardian")}
                {FIRE_GUARDIAN_SUMMONING_NOTE}
            )}
        [/event]
    [/event]

    #
    # Remember the Engineer's original facing before attacking him.
    #

    [event]
        id=engineer_facing_handler # wmllint: ignore
        name=attack
        first_time_only=no
        [filter]
            id=Elyssa
        [/filter]
        [filter_attack]
            name=claw of urvatha
        [/filter_attack]
        [filter_second]
            id=Engineer Fendyrn
        [/filter_second]
        [filter_condition]
            {VARIABLE_NUMERICAL_EQUALS side_number 1}
        [/filter_condition]

        {VARIABLE second_unit.variables.previous_facing $second_unit.facing}

        [unstore_unit]
            find_vacant=no
            variable=second_unit
        [/unstore_unit]
    [/event]

    #
    # Handle the Engineer being backstabbed using the Claw of Urvatha.
    #

    [event]
        id=engineer_backstabbing_handler # wmllint: ignore
        name=attacker hits
        first_time_only=no
        [filter]
            id=Elyssa
        [/filter]
        [filter_attack]
            name=claw of urvatha
        [/filter_attack]
        [filter_second]
            id=Engineer Fendyrn
        [/filter_second]
        [filter_condition]
            {VARIABLE_NUMERICAL_EQUALS side_number 1}
        [/filter_condition]

        [if]
            [have_unit]
                id=Elynia
                [filter_location]
                    [filter_adjacent_location]
                        x,y=$x2,$y2
                        adjacent="-$second_unit.variables.previous_facing"
                    [/filter_adjacent_location]
                [/filter_location]
            [/have_unit]
            [then]
                [fire_event]
                    name=boss 1 stage 2
                [/fire_event]
            [/then]
        [/if]
    [/event]

    [event]
        name=boss 1 stage 2

        #
        # Remove previous related event handlers.
        #

        [event]
            id=engineer_facing_handler # wmllint: ignore
            remove=yes
        [/event]

        [event]
            id=engineer_backstabbing_hint_handler # wmllint: ignore
            remove=yes
        [/event]

        [event]
            id=engineer_backstabbing_handler # wmllint: ignore
            remove=yes
        [/event]

        #
        # Allow the Engineer to be damaged from now on, but boost
        # his HP and attack strength in exchange.
        #

        [object]
            silent=yes
            [filter]
                id=Engineer Fendyrn
            [/filter]
            [effect]
                apply_to=remove_ability
                [abilities]
                    {ABILITY_ABSORB_DAMAGE}
                [/abilities]
            [/effect]
            [effect]
                apply_to=hitpoints
                increase_total=25%
                heal_full=yes
            [/effect]
            [effect]
                apply_to=attack
                name=soul hammer
                increase_damage=5 # 26-2
            [/effect]
            [effect]
                apply_to=attack
                name=flamethrower
                increase_damage=1 # 16-3
            [/effect]
        [/object]

        {REPLACE_SCENARIO_MUSIC "franticsketch.ogg"}

        #
        # Go red.
        #

        {DARKEN_RED_SCREEN -10}

        [message]
            speaker=Engineer Fendyrn
            message= _ "<b>ACK!</b> What ha’ ye done!!!"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Oops! It seems your armor suit and your fancy hammer are not perfect substitutes for the power of a true Guardian of Darkness!"
        [/message]

        {OBJECTIVES (
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Defeat the Engineer")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elyssa")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}

            {OBJECTIVE_NO_CARRYOVER}

            {OBJECTIVE_NOTE ( _ "The power of the Engineer’s hammer allows him to debilitate and destroy the Energy Heart of a Guardian")}
            {FIRE_GUARDIAN_SUMMONING_NOTE}
        )}

        [event]
            id=engineer_red_screening_handler # wmllint: ignore
            name=attacker hits
            first_time_only=no
            [filter_condition]
                [have_unit]
                    id=Engineer Fendyrn
                [/have_unit]
            [/filter_condition]

            [store_unit]
                [filter]
                    id=Engineer Fendyrn
                [/filter]
                kill=no
                variable=engineer_store
            [/store_unit]

            [if]
                {VARIABLE_NUMERICAL_LESS_THAN engineer_store.hitpoints "$($engineer_store.max_hitpoints * 0.20)"}
                [then]
                    {DARKEN_RED_SCREEN -50}
                [/then]
                [else]
                    [if]
                        {VARIABLE_NUMERICAL_LESS_THAN engineer_store.hitpoints "$($engineer_store.max_hitpoints * 0.40)"}
                        [then]
                            {DARKEN_RED_SCREEN -40}
                        [/then]
                        [else]
                            [if]
                                {VARIABLE_NUMERICAL_LESS_THAN engineer_store.hitpoints "$($engineer_store.max_hitpoints * 0.60)"}
                                [then]
                                    {DARKEN_RED_SCREEN -30}
                                [/then]
                                [else]
                                    [if]
                                        {VARIABLE_NUMERICAL_LESS_THAN engineer_store.hitpoints "$($engineer_store.max_hitpoints * 0.80)"}
                                        [then]
                                            {DARKEN_RED_SCREEN -20}
                                        [/then]
                                    [/if]
                                [/else]
                            [/if]
                        [/else]
                    [/if]
                [/else]
            [/if]

            {CLEAR_VARIABLE engineer_store}
        [/event]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Engineer Fendyrn
        [/filter]

        [fire_event]
            name=start part 2
        [/fire_event]
    [/event]

#define FINALE_B_ELYNIA_THOUGHTS _MESSAGE
    [message]
        speaker=narrator
        caption= _ "Elynia"
        image= # wmllint: ignore
        message="<i>"+{_MESSAGE}+"</i>" # wmllint: ignore
    [/message]
#enddef

    ############################################################################
    #                                                                          #
    #                               SECOND PART                                #
    #                                                                          #
    ############################################################################

    [event]
        name=start part 2

        {LOCK_VIEW}

        {DARKEN_RED_SCREEN -60}

        {REPLACE_SCENARIO_MUSIC "silence.ogg"}

        {DISABLE_FIRE_GUARDIAN_SUMMONING}

        [event]
            id=engineer_red_screening_handler # wmllint: ignore
            remove=yes
        [/event]

        {VARIABLE defeated_engineer yes}

        #
        # Prepare transition to part 2.
        #

        {QUAKE ("rumble.ogg")}

        [delay]
            time=500
        [/delay]

        {QUAKE ("explosion-big.ogg")}

        [delay]
            time=250
        [/delay]

        {QUAKE ("dragonstick.ogg")}

        [message]
            speaker=Elyssa
            message= _ "Elynia, grab my hand!"
        [/message]

        {QUAKE ("explosion-big.ogg")}

        [delay]
            time=500
        [/delay]

        {RESET_UNIT_STATUSES (
            id=Elynia
            [or]
                id=Elyssa
            [/or]
        )}

        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            variable=elynia_store
            kill=yes
        [/store_unit]

        [store_unit]
            [filter]
                id=Elyssa
            [/filter]
            variable=elyssa_store
            kill=yes
        [/store_unit]

        [kill]
            #
            # Kill everything else on the map.
            #
            [not]
                x,y=recall,recall
            [/not]
        [/kill]

        #
        # Deactivate all sides we will not use anymore.
        #

        [modify_side]
            [filter_side]
                [not]
                    side=1
                [/not]
                [not]
                    side=2
                [/not]
                [not]
                    side=8
                [/not]
            [/filter_side]
            hidden=yes
            controller=null
        [/modify_side]

        [store_map_dimensions][/store_map_dimensions]

        #
        # FIXME: is this really necessary? IIRC [remove_item]
        # was made to default to $x1,$y1 due to legacy code relying
        # on that assumption before it was converted to use SLFs,
        # but I am too lazy to check whether this is still the
        # case in 1.10.
        #

        [remove_item]
            x="0-$(1 + $map_size.width)"
            y="0-$(1 + $map_size.height)"
        [/remove_item]

        {CLEAR_VARIABLE map_size}

        {BLACK_SCREEN}

        [terrain]
            terrain=Xv
        [/terrain]

        [place_shroud]
            side=1
        [/place_shroud]

        [redraw]
            side=1
        [/redraw]

        [sound]
            name=rumble.ogg
        [/sound]

        #
        # Break.
        #

        [delay]
            time=4000
        [/delay]

        #
        # Setup the new map.
        #

        [replace_schedule]
            {UNDERGROUND}
        [/replace_schedule]

        [replace_map]
            map=$part_2_map
            expand,shrink=yes,yes
        [/replace_map]

        [redraw][/redraw]

        {VARIABLE elynia_store.x      50}
        {VARIABLE elynia_store.y      33}
        {VARIABLE elynia_store.facing se}

        {VARIABLE elyssa_store.x      50}
        {VARIABLE elyssa_store.y      31}
        {VARIABLE elyssa_store.facing se}

        # Reinstate fog.

        [modify_side]
            side=1
            fog=yes
        [/modify_side]

        {CLEAR_CAVE_SHROUD (
            x,y=50,31
            radius=4
        )}

        [hidden_unit]
            {CHARACTER_STATS_ELYNIA}
            type=Guardian of Earth Elynia
            canrecruit=no
            facing=$elynia_store.facing
            side=1
            x,y=$elynia_store.x,$elynia_store.y
            max_hitpoints=1
            variation=injured
        [/hidden_unit]

        [hidden_unit]
            {CHARACTER_STATS_ELYSSA}
            type=Guardian of Darkness Elyssa
            canrecruit=no
            facing=$elyssa_store.facing
            side=8
            x,y=$elyssa_store.x,$elyssa_store.y
            max_hitpoints=1
            variation=injured
        [/hidden_unit]

        {PLACE_IMAGE ("items/claw-of-urvatha.png~FL(horiz)") ("$($elyssa_store.x - 1)") $elyssa_store.y}

        {CLEAR_FOG 1 $elyssa_store.x "$($elyssa_store.y - 1)" $elyssa_store.max_moves}

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=$elynia_store.x,$elynia_store.y
            {WARP}
        [/scroll_to]

        {FADE_IN}

        [unhide_unit]
#ifver WESNOTH_VERSION < 1.11.0
            [not]
                type=Fog Clearer
            [/not]
#endif
        [/unhide_unit]

        [redraw]
            side=1
        [/redraw]

        [delay]
            time=2000
        [/delay]

        [message]
            speaker=Elynia
            image=misc/blank-hex.png
            message= _ "Unngh..." # wmllint: no spellcheck
        [/message]

        [delay]
            time=1000
        [/delay]

        [unstore_unit]
            find_vacant=no
            variable=elynia_store
        [/unstore_unit]

        [redraw][/redraw]

        [delay]
            time=1500
        [/delay]

        {FINALE_B_ELYNIA_THOUGHTS ( _ "I did not know where I was. The last thing I could recall was the chamber floor collapsing due to the energy released from the dwarf’s fractured hammer.")}

        {FINALE_B_ELYNIA_THOUGHTS ( _ "My neck felt cold and sticky... it was blood. I must have broken my head during the fall, and yet I was standing there as though my body had healed itself from the otherwise fatal injury.

I glanced at my surroundings...")}

        # FIXME: ah, if only!
        #{MODIFY_UNIT id=Elynia facing n}
        {MODIFY_UNIT id=Elynia facing nw}

        [redraw][/redraw]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elynia
            message= _ "Elyssa...?"
        [/message]

        {MOVE_UNIT id=Elynia ("$elyssa_store.x") ("$($elyssa_store.y + 1)")}

        [delay]
            time=1000
        [/delay]

        # po: Yes, Elynia is describing a literal BSOD (Blue Screen of Death).
        # po: See: http://en.wikipedia.org/wiki/Blue_Screen_of_Death
        # po: Looks like Norsulan technology isn't perfect either!
        {FINALE_B_ELYNIA_THOUGHTS ( _ "The demoness was lying on the humid cavern floor, inert as a rock. She did not seem injured, but neither did she draw breath. I did not know at first what to make of the situation.

I laid a hand on her forehead and attempted to peer into her mind to see whether she was still alive. All I could see through her frozen eyes was a series of incomprehensible white glyphs on a blue background, interspersed with an alien and yet somehow familiar language. Knowing she was a hybrid lifeform, the evidence I gathered was useless.")}

        {FINALE_B_ELYNIA_THOUGHTS ( _ "She could be alive... or she could be dead.

And not too far from her was the weapon she called the Claw of Urvatha. My master’s staff, first corrupted by the heart of a Gatekeeper that we used to call the Ruby of Fire, and now corrupted by the malignant touch of Merthiaal’s successor.")}

        [delay]
            time=750
        [/delay]

        {FINALE_B_ELYNIA_THOUGHTS ( _ "I felt compelled to grab the weapon and leave the demoness behind... but I had to ponder my possibilities first. She could come back to life the moment I laid my hands on it, and destroy me. Or she could stay as a dormant machine, and I would just abandon her and return to the surface, with Anya and Ergea.

A third alternative then occurred to me. I could grab the Claw, and destroy the creature in her sleep...")}

        [delay]
            time=1500
        [/delay]

        {FINALE_B_ELYNIA_THOUGHTS ( _ "... I spent some amount of time contemplating that alternative.

The thought of becoming a cold-blooded murderer suddenly horrified me.

No.

No, I would not give in to such terrifying urges. No. That was not me. That was not the elf who was raised by Niryone to protect the peoples of Irdya.

No.")}

        {MOVE_UNIT id=Elynia 48 30}

        {UNCLEAR_FOG}

        [redraw]
            side=1
        [/redraw]

        [delay]
            time=1000
        [/delay]

        {FINALE_B_ELYNIA_THOUGHTS ( _ "Between tears, I could catch a glimpse of light coming from around a corner.")}

        [delay]
            time=750
        [/delay]

        {MOVE_UNIT id=Elynia 46 29}
        {MODIFY_UNIT id=Elynia facing sw}

        [redraw]
            side=1
        [/redraw]

        [delay]
            time=750
        [/delay]

        {FINALE_B_ELYNIA_THOUGHTS ( _ "A conspicuous corridor, leading somewhere brightly illuminated. The walls were decorated with peculiar engravings.

I was compelled to follow. With my captor completely incapacitated to exert any kind of magic control over me, I could once again move with absolute freedom.")}

        {MOVE_UNIT id=Elynia 40 32}

        [terrain]
            x,y=43,31
            terrain=^Xo
            layer=overlay
        [/terrain]

        [modify_side]
            side=1
            fog=no
        [/modify_side]

        [place_shroud]
            side=1
            [not]
                x,y=40,32
                radius=3
            [/not]
        [/place_shroud]

        [redraw]
            side=1
        [/redraw]

        [kill]
            id=Elyssa
        [/kill]

        [remove_item]
            x,y="$($elyssa_store.x - 1)",$elyssa_store.y
        [/remove_item]

        [scroll_to_unit]
            id=Elynia
        [/scroll_to_unit]

        {OBJECTIVES (
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Explore the place")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}

            {OBJECTIVE_NO_CARRYOVER}

            {UNLIMITED_PLAYER_MOVES_NOTE}
        )}

        {CLEAR_VARIABLE elynia_store} # NOT elyssa_store, used later.

        [disallow_end_turn][/disallow_end_turn]

        {UNLIMITED_PLAYER_MOVES}

        {UNLOCK_VIEW}

        [event]
            name=moveto
            first_time_only=no
            [filter]
                id=Elynia
                x=41,42
                y=32,31
            [/filter]

            # Eeenope, not going back.

            {FINALE_B_ELYNIA_THOUGHTS ( _ "It was not my intention to go back where Elyssa’s inert body laid. I needed to keep exploring the corridor. My curiosity was just too great to resist.")}
        [/event]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Elynia
            # The sigil room event.
            x=18,17-19,14-22,12-24,12-26,14-25,23-24,25 # last two entries correspond to
            y=38,   39,   40,   41,42-47,48-51,   40,41 # the arch at the entrance
        [/filter]
        [filter_condition]
            {FINALE_B_IN_PART_2}
        [/filter_condition]

        [fire_event]
            name=cutscene 1
        [/fire_event]
    [/event]

#define FINALE_B_ARGAN_THOUGHTS _MESSAGE
    [message]
        speaker=narrator
        caption= _ "Argan"
        image= # wmllint: ignore
        message="<i>"+{_MESSAGE}+"</i>" # wmllint: ignore
    [/message]
#enddef

    [event]
        name=cutscene 1

        {BUG_ON ({FINALE_B_IN_PART_1}) ()}

        {LOCK_VIEW}

        {CLEAR_CAVE_SHROUD (
            x,y=19,43
            radius=8
        )}

        {MOVE_UNIT id=Elynia 19 43}

        [place_shroud]
            side=1
            [not]
                x,y=19,43
                radius=8
            [/not]
        [/place_shroud]

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=19,45
        [/scroll_to]

        [scroll_to_unit]
            id=Elynia
        [/scroll_to_unit]

        [delay]
            time=1000
        [/delay]

        {FINALE_B_ELYNIA_THOUGHTS ( _ "The ceiling lights formed a familiar shape on the floor: the sigil of the First Guardian of Earth, Xia’el. Or at least, as it was depicted in Argan’s journal.

An odd sense of comfort suddenly came to me. I felt for once as though I was, finally, at home.")}

        [delay]
            time=750
        [/delay]

        {MOVE_UNIT id=Elynia 19 45}

        {MODIFY_UNIT id=Elynia facing ne}

        [delay]
            time=750
        [/delay]

        {REPLACE_SCENARIO_MUSIC "snowfall.ogg"}

        {FINALE_B_ELYNIA_THOUGHTS ( _ "If Elyssa spoke the truth, this was my destiny all along. I was meant to be the Guardian of Earth on Irdya, and I was meant to keep my world and my people from harm; from Elyssa, from Argan, from Zhangor, from Uria...

... From myself.

... And I had failed. I had failed them all. I grew up ignorant of my true purpose, focusing only on mundane problems, remaining centered on my own needs and desires for the most part. I allowed Irdya’s terrible fate to come to pass: the destruction of many civilizations; the deaths of millions.

Weren’t Guardians created to <i>protect</i> their worlds?")}

        [delay]
            time=750
        [/delay]

        [hide_unit][/hide_unit]

        {FADE_TO_BLACK}

        [delay]
            time=1000
        [/delay]

        #
        # Dear gods, why am I doing this to myself? Next campaign I write
        # will be all about happiness and sunshine.
        #

        {FINALE_B_ELYNIA_THOUGHTS ( _ "I let myself collapse on the floor... and cried.

I needed to cry after Galas’ death. I needed to cry after losing Malin. But I resisted the emotion for so long because I did not want anyone to know I was weak on the inside.

But then, I was at home at last... alone. Nobody would know. So I cried.

I wished Anya could be with me. But she did not know where I was, and I did not even know whether she was still alive. And even if she was... it would only be a matter of time until Zhangor solved the Seer’s riddle and killed the girl.")}

        [delay]
            time=750
        [/delay]

        {FINALE_B_ELYNIA_THOUGHTS ( _ "Home...")}

        [delay]
            time=5000
        [/delay]

        {FINALE_B_ARGAN_THOUGHTS ( _ "There, there.")}

        [delay]
            time=750
        [/delay]

        {FINALE_B_ARGAN_THOUGHTS ( _ "You have not failed yet, my love. There are still things left to do.")}

        [delay]
            time=2000
        [/delay]

        {FINALE_B_ELYNIA_THOUGHTS ( _ "... A— Argan?")}

        [delay]
            time=250
        [/delay]

        {FINALE_B_ELYNIA_THOUGHTS ( _ "... Oh, I must have really lost it now.")}

        [delay]
            time=250
        [/delay]

        {FINALE_B_ARGAN_THOUGHTS ( _ "I am here. Don’t you feel me?")}

        [delay]
            time=250
        [/delay]

        {FINALE_B_ELYNIA_THOUGHTS ( _ "... Is this a dream?")}

        [delay]
            time=250
        [/delay]

        {FINALE_B_ARGAN_THOUGHTS ( _ "... Is it?")}

        [delay]
            time=250
        [/delay]

        {FINALE_B_ELYNIA_THOUGHTS ( _ "... I feel you. I feel your warm touch again. But... how?")}

        {FINALE_B_ARGAN_THOUGHTS ( _ "Because you wished for my return. All these years...")}

        {FINALE_B_ELYNIA_THOUGHTS ( _ "... I did.")}

        {FINALE_B_ARGAN_THOUGHTS ( _ "I missed you, Elynia.")}

        {FINALE_B_ELYNIA_THOUGHTS ( _ "... I— I—

... I did too.

Oh, Argan...")}

        [delay]
            time=5000
        [/delay]

        {FINALE_B_ARGAN_THOUGHTS ( _ "We don’t have much time left, my love. Irdya is in ruins now, and Zhangor could find us any moment now. You need to get up.")}

        {FINALE_B_ELYNIA_THOUGHTS ( _ "Yes...")}

        [delay]
            time=1000
        [/delay]

        {FADE_IN}

        [unhide_unit][/unhide_unit]

        [unit]
            side=1
            type=Master of Darkness
            canrecruit=yes
            id=Argan
            name= _ "Argan"
            x,y=19,44
            facing=sw
            [modifications]
                {TRAIT_STRONG}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        {RESET_UNIT_STATUSES id=Elynia}

        [delay]
            time=1000
        [/delay]

        #
        # Hello, censors.
        #
        # Please don't mess with the plot or you will pay dearly.
        #
        # -- shadowmaster
        #

        {FINALE_B_ELYNIA_THOUGHTS ( _ "I let my lips approach his own as we embraced like we had not for an eternity. He felt so delightfully real, I was willing to give in to our carnal urges—

But...")}

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Argan
            message= _ "Is there something wrong, my love?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "I... feel... strange."
        [/message]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Elynia
            message= _ "My heart... it hurts..."
        [/message]

        [message]
            speaker=Argan
            message= _ "That must be because you have spent too much time scurrying around. Just let yourself relax for a moment. We can reminisce about better times together..."
        [/message]

        [fade_out_music][/fade_out_music]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Elynia
            # po: Yes, the question mark may seem misplaced, but it's actually intentional
            # po: as it denotes a different sentence inflection. She is supposed to sound
            # po: confused.
            message= _ "You don’t sound like yourself? My head... I—"
        [/message]

        [message]
            speaker=Elynia
            message= _ "My memories have become so hazy... but... I... remember that sword... Elyssa has your sword..."
        [/message]

        [message]
            speaker=Argan
            message= _ "Elynia, please, just..."
        [/message]

        [delay]
            time=1000
        [/delay]

        {VARIABLE elyssa_store.x      19}
        {VARIABLE elyssa_store.y      43}
        {VARIABLE elyssa_store.facing se}

        [message]
            speaker=narrator
            caption= _ "Elyssa"
            image=$elyssa_store.profile
            message= _ "Hello..."
        [/message]

        [unit]
            # We only want the recruit animation, screw stats.
            animate=yes
            side=1
            canrecruit=yes
            id=Elyssa
            type=$elyssa_store.type
            x,y=$elyssa_store.x,$elyssa_store.y
            facing=$elyssa_store.facing
        [/unit]

        [unstore_unit]
            # clobbered!
            variable=elyssa_store
            find_vacant=no
        [/unstore_unit]

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [animate_attack]
            [filter]
                id=Argan
            [/filter]
            [filter_second]
                id=Elyssa
            [/filter_second]
            [filter_attack]
                name=$elyssa_store.attack[0].name
            [/filter_attack]
            kill=no
            animate=yes
            fire_event=no
            amount=$elyssa_store.attack[0].damage
            damage_type=$elyssa_store.attack[0].type
            alignment=neutral
            #experience=no
        [/animate_attack]

        {CLEAR_VARIABLE elyssa_store}

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "... Zhangor."
        [/message]

        {REPLACE_SCENARIO_MUSIC "gathering_storm.ogg"}

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Argan
            message= _ "How..."
        [/message]

        [message]
            speaker=Elyssa
            # po: I guess I'm already pushing the censors' limits a lot here?
            # po: It'd be advisable to keep it subtle in translations too.
            message= _ "Your act seems pretty cheap in retrospect. I cannot say I am completely disappointed, though; it was <i>absolutely</i> amusing to watch you attempt to—ahem—handle the poor, broken elf. But did you truly think it would work out? Ha ha ha!"
        [/message]

        [message]
            speaker=Argan
            message= _ "<i>(metallic voice) I am not precisely myself, though.</i>"
        [/message]

        [hide_unit][/hide_unit]

        {RED_SCREEN}

        [teleport]
            [filter]
                id=Elyssa
            [/filter]
            x,y=19,42
        [/teleport]

        [teleport]
            [filter]
                id=Elynia
            [/filter]
            x,y=19,46
        [/teleport]

        [kill]
            id=Argan
        [/kill]

        [sound]
            name=lightning.ogg
        [/sound]

        [delay]
            time=50
        [/delay]

        [sound]
            name=magic-dark.ogg
        [/sound]

        {RESET_SCREEN}

        [unhide_unit][/unhide_unit]

        [unit]
            canrecruit=yes
            side=2
            id=Deathbringer
            name= _ "Deathbringer"
            type=Shaxthal Deathbringer Alpha
            {IS_BOSS}
            x,y=19,44
            facing=sw
            [modifications]
                {TRAIT_BIOMECHANICAL}
                {TRAIT_DEXTROUS}
            [/modifications]
        [/unit]

        {PALETTE shaxthal_drone_surface shaxthal_drone_purple}

        [redraw]
            side=1
        [/redraw]

        [scroll_to_unit]
            id=Deathbringer
        [/scroll_to_unit]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Deathbringer
            message= _ "But your guess was close enough. Congratulations, Guardian of Darkness."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "So the rumors are true, after all — you go around possessing other creatures’ bodies now."
        [/message]

        [message]
            speaker=Elynia
            message= _ "(<i>enraged</i>) You were going to possess me..."
        [/message]

        [message]
            speaker=Deathbringer
            # po: "Aspect" here refers to the Aspect of Earth, not Elynia's physical appearance.
            message= _ "Or steal your aspect through your currently vulnerable energy heart. Either outcome would have been advantageous for me, but no — it would seem you will both have to die instead."
        [/message]

        [terrain]
            terrain=Xu
            x=23-24,25
            y=40   ,41
        [/terrain]

        [place_shroud]
            side=1
            x=23-27,25-27
            y=38-39,   40
        [/place_shroud]

        [redraw]
            side=1
        [/redraw]

        {QUAKE ("dragonstick.ogg")}

        [message]
            speaker=Elynia
            message= _ "(<i>enraged</i>) Not if I can kill <b>you</b> first."
        [/message]

#define FINALE_B_BOSS_DRONE _TYPE _X _Y
    [unit]
        side=2
        type={_TYPE}
        x={_X}
        y={_Y}
        random_gender=yes
        random_traits=yes
        generate_name=yes
        animate=yes
    [/unit]

    {PALETTE shaxthal_drone_surface shaxthal_drone_purple}
#enddef

        {FINALE_B_BOSS_DRONE ("Shaxthal Assault Drone")   18 43}
        {FINALE_B_BOSS_DRONE ("Shaxthal Protector Drone") 19 43}
        {FINALE_B_BOSS_DRONE ("Shaxthal Assault Drone")   20 43}
        {FINALE_B_BOSS_DRONE ("Shaxthal Assault Drone")   20 44}
        {FINALE_B_BOSS_DRONE ("Shaxthal Protector Drone") 19 45}
        {FINALE_B_BOSS_DRONE ("Shaxthal Assault Drone")   18 44}

        {OBJECTIVES (
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Defeat Zhangor’s Deathbringer")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elyssa")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}

            {OBJECTIVE_NO_CARRYOVER}

            {OBJECTIVE_NOTE ( _ "The Deathbringer’s spear allows it to destroy the Energy Heart of a Guardian")}

            {FIRE_GUARDIAN_SUMMONING_NOTE}
        )}

        [allow_end_turn][/allow_end_turn]

        {DISABLE_UNLIMITED_PLAYER_MOVES}

        {ENABLE_FIRE_GUARDIAN_SUMMONING}

        {UNLOCK_VIEW}
    [/event]

    [event]
        name=die
        [filter]
            id=Deathbringer
        [/filter]

        [fire_event]
            name=cutscene 2
        [/fire_event]
    [/event]

#define FINALE_B_FLASH_RED
    {RED_SCREEN}

    [delay]
        time=100
    [/delay]

    {RESET_SCREEN}
#enddef

    [event]
        name=cutscene 2

        {LOCK_VIEW}

        [kill]
            [not]
                id=Elynia
            [/not]
            [not]
                id=Elyssa
            [/not]
            animate=no
            fire_event=no
        [/kill]

        {BLACK_SCREEN}

        # Nope, not hiding any units this time.

        {QUAKE ("dragonstick.ogg")}

        [fade_out_music][/fade_out_music]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=narrator
            caption= _ "Zhangor"
            image=misc/blank-hex.png
            sound=laugh.ogg
            message= _ "Ha ha ha ha ha ha ha ha ha ha ha!"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "What is this, another of your illusions?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "I cannot see anything."
        [/message]

        [delay]
            time=750
        [/delay]

        [modify_side]
            side=1
            fog=no
            shroud=no
        [/modify_side]

        [terrain]
            # EVERYWHERE
            terrain=Xv^Gov
        [/terrain]

        [redraw]
            side=1
        [/redraw]

        {RESET_SCREEN}

        [delay]
            time=750
        [/delay]

        {MOVE_UNIT id=Elynia 18 40}
        {MODIFY_UNIT id=Elynia facing nw}
        [redraw][/redraw]

        {MOVE_UNIT id=Elyssa 26 43}
        {MODIFY_UNIT id=Elyssa facing se}
        [redraw][/redraw]

        {FINALE_B_ELYNIA_THOUGHTS ( _ "I felt disorientated. Fear suddenly overwhelmed me. I figured it was another of Zhangor’s tricks.")}

        [message]
            speaker=Elynia
            message= _ "We need to dispel this darkness somehow, Elyssa. Do you think you could..."
        [/message]

        [delay]
            time=250
        [/delay]

        {FINALE_B_FLASH_RED}

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "Argan— No..."
        [/message]

        {MODIFY_UNIT id=Elynia facing se}

        [redraw][/redraw]

        {FINALE_B_FLASH_RED}

        [delay]
            time=250
        [/delay]

        {REPLACE_SCENARIO_MUSIC "suspense.ogg"}

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "Elyssa?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "YOU KILLED HIM!"
        [/message]

        {MOVE_UNIT id=Elyssa 20 41}
        {MODIFY_UNIT id=Elyssa facing nw}
        [redraw][/redraw]

        [message]
            speaker=Elynia
            message= _ "Elyssa, I..."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Why— Why do you have to show this to me again? WHY?"
        [/message]

        {MOVE_UNIT id=Elyssa 19 41}

        [store_unit]
            [filter]
                id=Elyssa
            [/filter]
            variable=elyssa_store
        [/store_unit]

        {VARIABLE elyssa_store.facing nw}

        [unstore_unit]
            variable=elyssa_store
            find_vacant=no
        [/unstore_unit]

#define FINALE_B_ELYSSA_STRIKES_ELYNIA
    [animate_attack]
        [filter]
            id=Elynia
        [/filter]
        [filter_second]
            id=Elyssa
        [/filter_second]
        [filter_attack]
            name=$elyssa_store.attack[0].name
        [/filter_attack]
        kill=no
        animate=yes
        fire_event=no
        amount=$elyssa_store.attack[0].damage
        damage_type=$elyssa_store.attack[0].type
        alignment=neutral
        #experience=no
    [/animate_attack]
#enddef

        [message]
            speaker=Elyssa
            message= _ "Why couldn’t you <b>save</b> him instead?!"
        [/message]

        {FINALE_B_ELYSSA_STRIKES_ELYNIA}

        [message]
            speaker=Elyssa
            sound=laugh.ogg
            message= _ "Why?!"
        [/message]

        {FINALE_B_ELYSSA_STRIKES_ELYNIA}

        {FINALE_B_ELYSSA_STRIKES_ELYNIA}

        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            variable=elynia_store
            kill=no
        [/store_unit]

        [kill]
            id=Elynia
            animate=yes
            fire_event=no
        [/kill]

        [unstore_unit]
            variable=elynia_store
        [/unstore_unit]

        {APPLY_INJURED_VARIATION id=Elynia ne}

        {MODIFY_UNIT id=Elynia profile misc/blank-hex.png}

        [message]
            speaker=Elyssa
            message= _ "<i>(metallic voice) You are disgrace to your sad excuse of a civilization!</i>"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Stop it... please... Zhangor is attempting to control you..."
        [/message]

        {FINALE_B_ELYSSA_STRIKES_ELYNIA}

        [message]
            speaker=Elyssa
            message= _ "<i>(metallic voice) Nobody can control me!</i>"
        [/message]

        {FINALE_B_ELYSSA_STRIKES_ELYNIA}

        [message]
            speaker=Elynia
            message= _ "... please..."
        [/message]

        {FINALE_B_ELYSSA_STRIKES_ELYNIA}

        [message]
            speaker=Elynia
            message= _ "... I know you—"
        [/message]

        {FINALE_B_ELYSSA_STRIKES_ELYNIA}

        [message]
            speaker=Elynia
            message= _ "... I know you loved Argan too."
        [/message]

        [delay]
            time=2000
        [/delay]

        [message]
            speaker=Elynia
            message= _ "<i>(metallic voice) ... He wanted you to find me... and guide me... didn’t he...</i>"
        [/message]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "... You... you are not me. Why am I crying?"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "... Are these... my own tears?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "<i>(metallic voice) ... Try to remember... that you...</i>"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "<i>... that I was once...</i>"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "<i>(metallic voice) ... human—</i>"
        [/message]

        {FINALE_B_FLASH_RED}

        [message]
            speaker=Elyssa
            message= _ "No... no..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "<i>(metallic voice) Uria required me to kill them! It was... it was never my intention... please!</i>"
        [/message]

        {FINALE_B_FLASH_RED}

        [delay]
            time=250
        [/delay]

        {FINALE_B_FLASH_RED}

        [message]
            speaker=Elyssa
            message= _ "Zhangor is trying to make us lose control of our powers..."
        [/message]

        [message]
            speaker=Elynia
            # po: This is part of one of Elyssa's lines from IftU scenario 22C.
            message= _ "<i>(metallic voice) I have fallen, and failed my Master...</i>"
        [/message]

        {FINALE_B_FLASH_RED}

        [message]
            speaker=Elyssa
            message= _ "... He is trying to take us both at once... using the powers of the Gatekeeper of Urvatha..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "<i>(metallic voice) Why... why did you bring me back to life... WHY?!</i>"
        [/message]

        [message]
            speaker=narrator
            caption= _ "Ethealim"
            image=misc/blank-hex.png
            # po: Callback to AtS E3S8A "Interim".
            message= _ "<i>... your very sense of identity has been broken...</i>"
        [/message]

        [message]
            speaker=narrator
            caption= _ "Mal Keshar"
            image=misc/blank-hex.png
            # po: Callback to AtS E1S12 "The Queen".
            message= _ "<i>... a greater cause, one that transcends the fate of Irdya...</i>"
        [/message]

        [message]
            speaker=narrator
            caption= _ "Niryone"
            image=misc/blank-hex.png
            message= _ "<i>... take the Sceptre of Fire... and wield it... against our enemies...</i>"
        [/message]

        {FINALE_B_FLASH_RED}

        [message]
            speaker=Elyssa
            message= _ "... He is using the powers of the Gatekeeper of Urvatha to tear into our minds... I should have seen that he would try to use it for this..."
        [/message]

        {FINALE_B_FLASH_RED}

        [delay]
            time=250
        [/delay]

        {FINALE_B_FLASH_RED}

        [message]
            speaker=Elyssa
            message= _ "<i>(metallic voice) Elynia, grab my hand!</i>"
        [/message]

        {FINALE_B_FLASH_RED}

        [kill]
            id=Elynia
            [or]
                id=Elyssa
            [/or]
        [/kill]

        {FADE_TO_BLACK}

        [fade_out_music]
            duration=4000
        [/fade_out_music]

        [delay]
            time=1000
        [/delay]

        {INCIDENTAL_MUSIC "heroes_rite.ogg"}

        {FINALE_B_ELYNIA_THOUGHTS ( _ "For a moment, I could not tell our memories and emotions apart. For a moment, I saw the fear in the demoness’ subconscious; I saw her fear of Uria; her fear of the many creatures she had tortured and slain, both under Uria’s command and of her own volition.

I felt her suffering at the hands of Argan’s men before he rescued her from their cruelty. I saw her wandering the sands before being captured by those monsters. I saw through the invisible mask she had worn all this time to protect her fragile self from the corruption rooted deep within the energy hearts of our kind.

I saw that, despite her claims to the contrary, she was human. And despite living for longer than any elf on Irdya, she was still just a girl, forced by Argan and Uria to live a life she did not want. A life she could not end on her own, for fear of ceasing to exist forever.")}

        {FINALE_B_ELYNIA_THOUGHTS ( _ "I saw one of her nightmares, one in which she is alone wandering an endless void with nothing in sight other than a tree above; a broken tree, in flames.

But it was not a tree like any I have ever seen in my life.")}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image=misc/blank-hex.png
            message= _ "<i>Don’t you see? We aren’t that different after all.</i>"
        [/message]

        [modify_side]
            side=1
            shroud=yes
        [/modify_side]

        [replace_map]
            map=$part_2_map
            expand,shrink=yes,yes
        [/replace_map]

        [redraw][/redraw]

        [delay]
            time=2000
        [/delay]

        {FADE_IN}

        [unstore_unit]
            find_vacant=yes
            variable=elynia_store
        [/unstore_unit]

        [unstore_unit]
            find_vacant=yes
            variable=elyssa_store
        [/unstore_unit]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Elynia
            # po: Callback to AtS E3S8C "Breakdown".
            message= _ "Why... did you not kill me?"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "(<i>crying</i>) Because Argan asked me to help you."
        [/message]

        [delay]
            time=1000
        [/delay]

        {FINALE_B_ELYNIA_THOUGHTS ( _ "I could not restrain myself anymore. With tears in my eyes I laughed maniacally like I never had before.")}

        {FINALE_B_ELYNIA_THOUGHTS ( _ "Was that my own emotion, or Elyssa’s? Did it actually matter?")}

        {FINALE_B_ELYNIA_THOUGHTS ( _ "There was only one thing I knew for sure.

Galas, Anlindë, and Mal Keshar woke me up to save Irdya from Uria’s corrupting influence. The lives of the three of them were cut short not by Elyssa, but by the broken creature into which Uria turned her.")}

        {FINALE_B_ELYNIA_THOUGHTS ( _ "I gave Ergea a chance because that is what my friends would have done, and she led me to Elyssa.

If fate decided for us to join forces despite our mutual hatred, then so be it.

No-one in Irdya will ever see peace again for as long as Zhangor and Uria exist.")}

        {FINALE_B_ELYNIA_THOUGHTS ( _ "No matter the consequences... no matter who is on my side, I will confront those two.

Uria has to be stopped.")}

        [delay]
            time=250
        [/delay]

        {UNLOCK_VIEW}

        {ENDLEVEL_QUIET}
    [/event]

    [event]
        name=victory

        {CLEAR_VARIABLE defeated_engineer,used_touchplate_1,used_touchplate_2,part_2_map}
    [/event]
[/scenario]

#undef FINALE_B_SHARED_AI_PARAMS
#undef FINALE_B_DRONE_TINT_1
#undef FINALE_B_DRONE_TINT_2
#undef FINALE_B_CRYSTAL_SHARD
#undef FINALE_B_TOUCHPLATE
#undef FINALE_B_LAVA_SHORE_X_Y
#undef FINALE_B_TRY_RELOCATE_HERO
#undef FINALE_B_ELYNIA_THOUGHTS
#undef FINALE_B_IN_PART_1
#undef FINALE_B_IN_PART_2
#undef FINALE_B_BOSS_DRONE
#undef FINALE_B_FLASH_RED
#undef FINALE_B_ELYSSA_STRIKES_ELYNIA
#undef FINALE_B_IS_HERO
#undef FINALE_B_CHAMBER_WALL_X_Y
#undef FINALE_B_ARGAN_THOUGHTS

# kate: indent-mode normal; encoding utf-8; space-indent on;
