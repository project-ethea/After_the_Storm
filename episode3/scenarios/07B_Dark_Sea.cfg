#textdomain wesnoth-After_the_Storm

[scenario]
    id=07B_Dark_Sea
    name= _ "Dark Sea"
    {MAP 07B_Dark_Sea.map}
    {TURNS 22 20 20}
    next_scenario=08A_Interim
    victory_when_enemies_defeated=no

    {H_DEATHS}

    {SCENARIO_MUSIC "revelation.ogg"}

    {STORYTXT_DARK_SEA}

    {LONGDARK3}
    {LONGDARK3}
    {LONGDARK3}
    {LONGDARK3}
    {LONGDARK4}
    {LONGDARK4}
    {LONGDARK4}
    {LONGDARK4}
    {ENDLESS_NIGHT}

    {SHAXTHAL_SET_SURFACE_VARIATIONS_FLAG}

    [event]
        name=turn 9
        # The night! Will last! FOREVER!
        [replace_schedule]
            {ENDLESS_NIGHT}
        [/replace_schedule]
    [/event]

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        save_id=Anya
        team_name=good
        user_team_name= _ "team_name^Anya"

        shroud=yes

        {GOLD 250 240 230}

        # wmllint: recognize Anya
        {CHARACTER_STATS_ANYA}
        canrecruit=yes
        # Start with an L3, teleportation is rather important here.
        type=Nightshade Fire
        overlays="" # clobber IS_HERO from the stats macro
    [/side]
    # wmllint: validate-on

    {STARTING_VILLAGES 1 6}

    [side]
        side=2
        controller=human
        save_id=Durvan
        team_name=good
        user_team_name= _ "team_name^Durvan"
        {ALLIANCE_FLAG}

        # wmllint: recognize Durvan

        {NO_ECONOMY}
        no_leader=yes
        hidden=yes
    [/side]

    [side]
        side=3
        team_name=evil
        user_team_name= _ "team_name^Kalari"
        {CHAOS_FLAG}

        {GOLD 130 140 150}
        recruit=Chaos Raider,Chaos Invoker,Chaos Invader

        canrecruit=yes
        type=Chaos Razerman
        id=Mereldyan
        name= _ "Mereldyan"
        facing=sw
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]

        [village]
            x,y=46,22
        [/village]

        [village]
            x,y=44,23
        [/village]

        [village]
            x,y=50,27
        [/village]

        [village]
            x,y=51,29
        [/village]

        [village]
            x,y=44,21
        [/village]

#ifndef EASY
        {GENERIC_UNIT () (Hell Guardian)     54 23} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}
        {GENERIC_UNIT () (Serpent Messenger) 51 22} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
#endif
    [/side]

    [side]
        side=4
        team_name=evil
        user_team_name= _ "team_name^Kalari"
        {CHAOS_FLAG}

        {GOLD 130 140 150}
        recruit=Chaos Invader,Chaos Bowman,Demon

        canrecruit=yes
        type=Demon Warrior
        id=Jarayavel
        name= _ "Jarayavel"
        gender=male
        facing=ne
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_DEXTROUS}
        [/modifications]

        [village]
            x,y=54,18
        [/village]

        [village]
            x,y=57,18
        [/village]

        [village]
            x,y=60,20
        [/village]

        [village]
            x,y=60,25
        [/village]

        {GENERIC_UNIT () (Chaos Invader) 56 19} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING ne}
        {GENERIC_UNIT () (Chaos Invader) 58 21} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING ne}
        {GENERIC_UNIT () (Chaos Invader) 46 24} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
        {GENERIC_UNIT () (Chaos Invader) 48 26} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
    [/side]

    [side]
        side=5
        team_name=evil
        user_team_name= _ "team_name^Uria"
        {CHAOS_FLAG}

        {GOLD 125 130 135}
        recruit=Chaos Invoker,Imp,Chaos Headhunter

        canrecruit=yes
        type=Chaos Magus
        id=Zaraphor
        name= _ "Zaraphor"
        facing=nw
        [modifications]
            {TRAIT_RESILIENT}
            {TRAIT_INTELLIGENT}
        [/modifications]

        [village]
            x,y=70,26
        [/village]
    [/side]

    {STARTING_VILLAGES 5 4}

    [side]
        side=6
        team_name=evil
        user_team_name= _ "team_name^Uria"
        {CHAOS_FLAG}

        {GOLD 140 145 150}
        recruit=Demon,Chaos Hound,Psy Crawler

        canrecruit=yes
        type=Demon Spelldancer
        id=Elesmeera
        name= _ "Elesmeera"
        facing=ne
        [modifications]
            {TRAIT_STRONG}
            {TRAIT_RESILIENT}
        [/modifications]

        [village]
            x,y=42,31
        [/village]

        [village]
            x,y=46,35
        [/village]

        [village]
            x,y=49,33
        [/village]

        [village]
            x,y=48,28
        [/village]
    [/side]

    #
    # Delayed enemy sides.
    # These are configured by a later event.
    # The no_leader=yes spec is left out so wmllint stops complaining
    # about shit it doesn't understand.
    #

#define FINALE_A_DELAYED_SIDE
    hidden=yes
    controller=null
#enddef

    [side]
        side=7
        team_name=evil
        user_team_name= _ "team_name^Shaxthals"
        {CHAOS_FLAG}

        no_leader=yes
        {FINALE_A_DELAYED_SIDE}
        {NO_ECONOMY}
    [/side]

    [side]
        side=8
        team_name=evil
        user_team_name= _ "team_name^Shaxthals"
        {CHAOS_FLAG}

        no_leader=yes
        {FINALE_A_DELAYED_SIDE}
        {NO_ECONOMY}
    [/side]

    [side]
        side=9
        team_name=evil
        user_team_name= _ "team_name^Shaxthals"
        {CHAOS_FLAG}

        no_leader=yes
        {FINALE_A_DELAYED_SIDE}
        {NO_ECONOMY}
    [/side]

    [side]
        side=10
        team_name=evil
        user_team_name= _ "team_name^Uria"
        {CHAOS_FLAG}
        color=pink

        no_leader=yes
        {FINALE_A_DELAYED_SIDE}
        {NO_ECONOMY}
    [/side]

    [side]
        side=11
        team_name=evil
        user_team_name= _ "team_name^Uria"
        {CHAOS_FLAG}
        color=yellow

        no_leader=yes
        {FINALE_A_DELAYED_SIDE}
        {NO_ECONOMY}
    [/side]

    [side]
        side=12
        team_name=evil
        user_team_name= _ "team_name^Uria"
        {CHAOS_FLAG}
        color=yellow

        no_leader=yes
        {FINALE_A_DELAYED_SIDE}
        {NO_ECONOMY}
    [/side]

    [side]
        side=13
        team_name=evil
        user_team_name= _ "team_name^Uria"
        {CHAOS_FLAG}
        color=yellow

        no_leader=yes
        {FINALE_A_DELAYED_SIDE}
        {NO_ECONOMY}
    [/side]

#undef FINALE_A_DELAYED_SIDE

    [label]
        x,y=53,23
        text= _ "Ivæthea’s Bridge" # wmllint: no spellcheck
    [/label]

    [label]
        x,y=55,22
        text= _ "North Keep"
    [/label]

    [label]
        x,y=50,24
        text= _ "South Keep"
    [/label]

    {PLACE_IMAGE ("items/scarecrow.png")   42 22}
    {PLACE_IMAGE ("items/straw-bale2.png") 43 23}
    {PLACE_IMAGE ("items/straw-bale1.png") 58 15}
    #{PLACE_IMAGE ("items/grain-sheaf.png") 56 16}
    {PLACE_IMAGE ("items/scarecrow.png")   74 26}
    {PLACE_IMAGE ("items/straw-bale2.png") 74 25}
    {PLACE_IMAGE ("items/straw-bale1.png") 73 27}

    {PLACE_IMAGE ("scenery/rock2.png") 30 12}
    {PLACE_IMAGE ("scenery/rock1.png")  7 12}

    {PLACE_IMAGE ("items/burial.png") 36 48}
    {PLACE_IMAGE ("items/burial.png") 27 61}
    {PLACE_IMAGE ("items/burial.png") 60 50}
    {PLACE_IMAGE ("items/burial.png") 75 54}

    {PLACE_IMAGE ("items/bonestack.png") 67 62}
    {PLACE_IMAGE ("items/bonestack.png") 62 55}
    {PLACE_IMAGE ("items/bonestack.png") 34 54}

    {PLACE_IMAGE ("scenery/mine-abandoned.png") 45 54}
    {PLACE_IMAGE ("scenery/mine-abandoned.png") 47 55}
    {PLACE_IMAGE ("scenery/mine-abandoned.png") 30 30}

    {PLACE_IMAGE ("items/altar-evil.png") 68 57}

    {PLACE_IMAGE ("items/bones.png~FL(horiz)") 64 38}
    {PLACE_IMAGE ("scenery/rock3.png")         11 37}

    {PLACE_IMAGE ("scenery/shipwreck-1.png")            7 37}
    {PLACE_IMAGE ("scenery/shipwreck-1.png")           14 62}
    {PLACE_IMAGE ("scenery/shipwreck-1.png")            4 56}

    {PLACE_IMAGE ("scenery/village-human-burned1.png") 18 29}

    {PLACE_IMAGE ("scenery/signpost.png") 58 18}

    [event]
        name=moveto
        [filter]
            side=1,2
            x,y=58,18
        [/filter]

        [allow_undo][/allow_undo]

        [message]
            speaker=narrator
            image=scenery/signpost.png
            message= _ "North Kelenvar" # wmllint: no spellcheck
        [/message]
    [/event]

    {PLACE_IMAGE ("scenery/signpost.png") 44 27}

    [event]
        name=moveto
        [filter]
            side=1,2
            x,y=44,27
        [/filter]

        [allow_undo][/allow_undo]

        [message]
            speaker=narrator
            image=scenery/signpost.png
            message= _ "South Kelenvar" # wmllint: no spellcheck
        [/message]
    [/event]

    {PLACE_IMAGE ("scenery/signpost.png") 57 51}

    [event]
        name=moveto
        [filter]
            side=1,2
            x,y=57,51
        [/filter]

        [allow_undo][/allow_undo]

        [message]
            speaker=narrator
            image=scenery/signpost.png
            message= _ "<s>Moon Guard Post</s>"
        [/message]
    [/event]

    [event]
        name=prestart

        # BEGIN: finale sequence configuration

        # wmlindent: start ignoring
        {BUG_ON ({VARIABLE_NUMERICAL_NOT_EQUALS finale_status.length 1})
                ("E3S7B must be started from a finale scenario")}
        # wmlindent: stop ignoring

        #
        # Restore Elynia's side status from E3S6 (E3S7A.1 prestart)
        #

        {FOREACH finale_status.side_1_units k}
            {VARIABLE location.x recall}
            {VARIABLE location.y recall}

            [if]
                {VARIABLE_LEXICAL_EQUALS finale_status.side_1_units[$k].id Anya}
                {VARIABLE_LEXICAL_EQUALS finale_status.side_1_units[$k].type ("Nightshade Fire")}
                #
                # We want the stored Anya to replace the one we get by default here if
                # she's already an L3 (very likely).
                #
                [then]
                    [store_starting_location]
                        side=1
                    [/store_starting_location]

                    {VARIABLE finale_status.side_1_units[$k].canrecruit yes}
                    {CLEAR_VARIABLE finale_status.side_1_units[$k].overlays}
                [/then]
            [/if]

            [unstore_unit]
                variable="finale_status.side_1_units[$k]"
                x,y=$location.x,$location.y
                find_vacant=no
            [/unstore_unit]
        {NEXT k}

        {CLEAR_VARIABLE location}

        #
        # Restore the carryover gold from E3S6 (E3S7A.1 prestart)
        #

        [gold]
            side=1
            amount=$finale_status.side_1_gold
        [/gold]

        #
        # TODO: carry the recruit list over from E3S6 instead of specifying
        #       it by hand here.
        #

        [allow_recruit]
            side=1
            type=Faerie Sprite,Skeleton,Skeleton Archer,Ghost,Vampire Bat,Walking Corpse,Footpad,Poacher,Thug,Ruffian
        [/allow_recruit]

        [allow_recruit]
            side=1
            type=Dark Adept,Troll Whelp,Demon,Saurian Augur,Saurian Skirmisher
        [/allow_recruit]

        #
        # Recall units and create Ergea for the first time
        #

        # wmllint: recognize Irylean
        {RECALL_IRYLEAN_AT_LOCATION 56  5}
        # wmllint: recognize Ergea
        {RECALL_ERGEA_AT_LOCATION   54  5}
        # wmllint: recognize Cron
        {RECALL_CRON_AT_LOCATION    54  4}

        {MODIFY_UNIT side=1 facing s}

        [remove_shroud]
            side=1
            x=30-76
            y= 0-36
        [/remove_shroud]

        #
        # Side 2 is not enabled until a few turns later
        #

        [modify_side]
            side=2
            controller=null
            hidden=yes
        [/modify_side]

        {OBJECTIVES (
            side=1
            victory_string= _ "Current Objectives:"
            {OBJECTIVE_VICTORY ( _ "Capture Zaraphor’s keep and castle before turn 10")}

            {OBJECTIVE_DEFEAT  ( _ "Any number of enemy leaders standing on Zaraphor’s keep and castle by the start of turn 10")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Irylean")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Ergea")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Cron")}

            {OBJECTIVE_CARRYOVER}
        )}

        {CLEAR_VARIABLE finale_status}
    [/event]

    [event]
        name=start

        {LOCK_VIEW}

        [message]
            speaker=Ergea
            message= _ "My scouts have just informed me that the bulk of the region’s defenses are already in motion and heading for our present location. They shall be here in just a few hours. It is possible that someone betrayed us, or..."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Anya
            message= _ "... She is not coming back, is she?"
        [/message]

        [message]
            speaker=Irylean
            message= _ "She must have had a good reason for leaving us like this, Anya. Well... I hope so, anyway. My lady, what about those reinforcements?"
        [/message]

        [scroll_to]
            x,y=66,23
        [/scroll_to]

        {HIGHLIGHT_GOAL x,y=66,23}

        [message]
            speaker=Ergea
            scroll=no
            message= _ "The old fort near the river city guards a second portal leading to the northern lands whence you came. I had arranged for your allies to arrive through it at dawn, but... this unexpected development jeopardizes the success of the entire operation."
        [/message]

        [message]
            speaker=Ergea
            scroll=no
            message= _ "We must secure that fort as swiftly as we may. It is only a few hours before dawn breaks. If we manage to distract our enemies for long enough, Elynia might have an opportunity to succeed in her own mission."
        [/message]

        [scroll_to]
            x,y=53,23
        [/scroll_to]

        [message]
            speaker=Ergea
            scroll=no
            message= _ "The inhabitants of these lands are not too satisfied with the Iron Triad’s management. I advise that we try to gain their support and stir up a revolution — their numbers and resources may prove essential for what has yet to come."
        [/message]

        [message]
            speaker=Irylean
            message= _ "Let us get moving then. Anya shall lead the way!"
        [/message]

        [message]
            speaker=Anya
            message= _ "I... shall?"
        [/message]

        [message]
            speaker=Irylean
            message= _ "That’s what Elynia said in that note, did not she? But you don’t need to worry about the management aspect — we can help you with that. Your darkness powers and teleportation should be advantageous in the front line, but it’s more important that these men are led by someone with whom they are already well familiarized besides Elynia herself — another <i>someone</i> they can relate to, if you catch my drift."
        [/message]

        [message]
            speaker=Anya
            message= _ "... Wait... you mean..."
        [/message]

        [message]
            speaker=Irylean
            message= _ "Yes!"
        [/message]

        [message]
            speaker=Anya
            message= _ "(<i>annoyed</i>) Your rationale seems rather perverse, and it’s slightly offensive considering I have never... unlike... Ack! How about... we just... move on?!"
        [/message]

        [message]
            speaker=Ergea
            message= _ "I support the motion. This is no time for such frivolous chatter."
        [/message]

        {VARIABLE sep "• "}

        [transient_message]
            message= _ "You can now recruit the following unit types:"+"

$sep|"+{TSTR_UNIT_TYPE_DARK_ADEPT}+"
$sep|"+_"Demon"+"
$sep|"+{TSTR_UNIT_TYPE_SAURIAN_AUGUR}+"
$sep|"+{TSTR_UNIT_TYPE_SAURIAN_SKIRMISHER}+"
$sep|"+{TSTR_UNIT_TYPE_TROLL_WHELP}
        [/transient_message]

        {CLEAR_VARIABLE sep}

        {REPLACE_SCENARIO_MUSIC "loyalists.ogg"}
        {APPEND_MUSIC           "breaking_the_chains.ogg"}

        {UNLOCK_VIEW}
    [/event]

    [event]
        name=last breath
        [filter]
            id=Jarayavel
        [/filter]

        [message]
            speaker=Jarayavel
            message= _ "So bold— argh..."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Mereldyan
        [/filter]

        [message]
            speaker=Mereldyan
            message= _ "The Fist shall not tolerate your intrusion..."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Zaraphor
        [/filter]

        [message]
            speaker=Zaraphor
            # po: The 'Fist' is a yet unseen male demon.
            message= _ "The Fist knows... He knows everything... Flee while you can..."
        [/message]
    [/event]

    [event]
        name=last breath
        [filter]
            id=Elesmeera
        [/filter]

        [message]
            speaker=Elesmeera
            message= _ "No, n— please no! My fair lady of the Storms, I— I did not have a choice! The Fist— I— I—"
        [/message]

        [message]
            speaker=Ergea
            message= _ "You betrayed me and my people. There is only one possible punishment for such a grave misdeed under my rule and you are well aware what it is."
        [/message]

        [message]
            speaker=Elesmeera
            message= _ "No! I beg you—"
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            canrecruit=yes
            side=4,3
        [/filter]
        [filter_condition]
            [not]
                [have_unit]
                    canrecruit=yes
                    side=4,3
                    [not]
                        x,y=$x1,$y1
                    [/not]
                [/have_unit]
            [/not]
        [/filter_condition]

        [unit]
            animate=yes
            side=1
            id=Theneryr
            name= _ "Theneryr"
            type=Bowman
            x,y=49,21
            {IS_LOYAL}
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [unit]
            animate=yes
            side=1
            id=Maergon
            name= _ "Maergon"
            type=Bowman
            x,y=52,20
            {IS_LOYAL}
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]

        [unit]
            animate=yes
            side=1
            id=Sergalyr
            name= _ "Sergalyr"
            type=Spearman
            x,y=51,26
            {IS_LOYAL}
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]

        [unit]
            animate=yes
            side=1
            id=Muthel
            name= _ "Muthel"
            type=Thief
            gender=male
            x,y=58,24
            {IS_LOYAL}
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_INTELLIGENT}
            [/modifications]
        [/unit]

        [unit]
            animate=yes
            facing=nw
            side=1
            id=Cyrelean
            name= _ "Cyrelean"
            type=Thief
            gender=female
            x,y=54,23
            {IS_LOYAL}
            [modifications]
                {TRAIT_LOYAL}
                {TRAIT_RESILIENT}
            [/modifications]
        [/unit]

        [message]
            speaker=Cyrelean
            message= _ "The old order is coming to an end at last, and in time, freedom will be ours!"
        [/message]

        [message]
            speaker=Sergalyr
            message= _ "Let us purge the foul worshipers of Uria and reclaim our ancestors’ lands!"
        [/message]
    [/event]

    # NOTE: this should really only be used with even numbers
#define FINALE_A_LOOT_EVENT _SIDE _AMOUNT
    [event]
        name=die
        [filter]
            canrecruit=yes
            side={_SIDE}
        [/filter]

        [if]
            [have_unit]
                id=Durvan
            [/have_unit]
            [then]
                [sound]
                    name=gold.ogg
                [/sound]

                {VARIABLE temp_gold_retrieval_amount ("$("+{_AMOUNT}+" / 2)")}

                [message]
                    speaker=narrator
                    image="items/gold-coins-medium.png"
                    message= _ "Both playing teams retrieve $temp_gold_retrieval_amount pieces of gold."
                [/message]

                [gold]
                    side=1,2
                    amount=$temp_gold_retrieval_amount
                [/gold]

                {CLEAR_VARIABLE temp_gold_retrieval_amount}
            [/then]
            [else]
                {RETRIEVE_GOLD {_AMOUNT} }
            [/else]
        [/if]
    [/event]
#enddef

    {FINALE_A_LOOT_EVENT 3 160}

    {FINALE_A_LOOT_EVENT 4 154}

    {FINALE_A_LOOT_EVENT 5 90}

    {FINALE_A_LOOT_EVENT 6 86}

    ############################################################################
    #                                                                          #
    #                                   STAGE 2                                #
    #                                                                          #
    ############################################################################

    [event]
        name=turn 10

        [message]
            speaker=Anya
            message= _ "I don’t understand... It should be dawn already!"
        [/message]

        [message]
            speaker=Ergea
            message= _ "The... day of the Longest Night... This does not bode well."
        [/message]
    [/event]

    [event]
        name=turn 10
        [if]
            [have_unit]
                canrecruit=yes
                [filter_side]
                    [enemy_of]
                        side=1
                    [/enemy_of]
                [/filter_side]
                [filter_location]
                    x,y=66,23
                    radius=1
                [/filter_location]
            [/have_unit]
            [then]
                [message]
                    speaker=Irylean
                    message= _ "We failed to secure that portal in time! Without those reinforcements we will never make it! Retreat!"
                [/message]

                {ENDLEVEL_DEFEAT}
            [/then]
            [else]
                [fire_event]
                    name=stage 2
                [/fire_event]
            [/else]
        [/if]
    [/event]

#define FINALE_A_SETUP_SIDE _SIDE_NUMBER _LEADER_X _LEADER_Y _SIDE_WML _LEADER_WML
    #
    # Enemy leaders start facing wherever Anya is.
    #
    [store_direction]
        from_x={_LEADER_X}
        from_y={_LEADER_Y}
        [to]
            [filter]
                id=Anya
            [/filter]
        [/to]
    [/store_direction]

    [modify_side]
        side={_SIDE_NUMBER}
        controller=ai
        hidden=no

        # Base stats when not overridden by the _SIDE_WML
        # argument contents.

        gold=100
        {DEFAULT_ECONOMY}

        {_SIDE_WML}
    [/modify_side]

    [unit]
        canrecruit=yes
        side={_SIDE_NUMBER}
        x={_LEADER_X}
        y={_LEADER_Y}
        facing=$direction
        {_LEADER_WML}
    [/unit]

    {CLEAR_VARIABLE direction}
#enddef

#define FINALE_A_SETUP_MAP_STARTLOC_SIDE _SIDE_NUMBER _SIDE_WML _LEADER_WML
    [store_starting_location]
        side={_SIDE_NUMBER}
    [/store_starting_location]

    {FINALE_A_SETUP_SIDE {_SIDE_NUMBER} $location.x $location.y ({_SIDE_WML}) ({_LEADER_WML})}

    {CLEAR_VARIABLE location}
#enddef

#define FINALE_A_CAPTURE_INITIAL_VILLAGES _SIDE_NUMBER _RADIUS
    [store_locations]
        [filter]
            canrecruit=yes
            side={_SIDE_NUMBER}
        [/filter]
        variable=location
    [/store_locations]

    {CAPTURE_VILLAGES {_SIDE_NUMBER} $location.x $location.y {_RADIUS} }

    {CLEAR_VARIABLE location}
#enddef

#define FINALE_A_NO_DEMOLITION_ABILITY
    [object]
        silent=yes
        [effect]
            apply_to=remove_ability
            [abilities]
                {ABILITY_DEMOLITION_TEXT_ONLY}
            [/abilities]
        [/effect]
    [/object]
#enddef

    [event]
        name=stage 2

        {LOCK_VIEW}

        #
        # Start enemies setup.
        #

        [remove_terrain_overlays]
            terrain=*^Xo
        [/remove_terrain_overlays]

        # Side 7

        {FINALE_A_SETUP_MAP_STARTLOC_SIDE 7 (
            {GOLD 150 165 180}
            recruit=Shaxthal Drone,Shaxthal Razorbird
        ) (
            canrecruit=yes
            type=Shaxthal War Drone
            [modifications]
                {TRAIT_BIOMECHANICAL}
                {TRAIT_STRONG}
            [/modifications]
        )}

        {GENERIC_UNIT 7 (Shaxthal Drone)  6 39} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION surface}
        {GENERIC_UNIT 7 (Shaxthal Drone)  4 42} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION surface}
        {GENERIC_UNIT 7 (Shaxthal Drone)  3 43} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION surface}

#ifndef EASY
        {GENERIC_UNIT 7 (Shaxthal Thunderbird)  2 41} {NO_UPKEEP_NO_OVERLAY} {FACING ne}
        {GENERIC_UNIT 7 (Shaxthal Thunderbird)  7 38} {NO_UPKEEP_NO_OVERLAY} {FACING ne}
#endif

        {GENERIC_UNIT 7 (Shaxthal Protector Drone) 60 58} {NO_UPKEEP_NO_OVERLAY} {FACING nw} {GUARDIAN}
        {GENERIC_UNIT 7 (Shaxthal Protector Drone) 66 52} {NO_UPKEEP_NO_OVERLAY} {FACING nw} {GUARDIAN}
        {GENERIC_UNIT 7 (Shaxthal Stormblade)      63 57} {NO_UPKEEP_NO_OVERLAY} {FACING nw} {GUARDIAN}
        {GENERIC_UNIT 7 (Shaxthal Rayblade)        64 55} {NO_UPKEEP_NO_OVERLAY} {FACING nw} {GUARDIAN}

        {GENERIC_UNIT 7 (Shaxthal Rayblade)      66 47} {NO_UPKEEP_NO_OVERLAY} {FACING ne} {GUARDIAN}
        {GENERIC_UNIT 7 (Shaxthal Assault Drone) 73 43} {NO_UPKEEP_NO_OVERLAY} {FACING nw} {GUARDIAN}

#ifndef EASY
        {GENERIC_UNIT 7 (Shaxthal Demolisher Drone) 59 51} {NO_UPKEEP_NO_OVERLAY} {FACING n}
        [+unit]
            [+modifications]
                {FINALE_A_NO_DEMOLITION_ABILITY}
            [/modifications]
        [/unit]
#endif

        {GENERIC_UNIT 7 (Shaxthal Demolisher Drone)  1 48} {NO_UPKEEP_NO_OVERLAY} {FACING ne}
        [+unit]
            [+modifications]
                {FINALE_A_NO_DEMOLITION_ABILITY}
            [/modifications]
        [/unit]

        {GENERIC_UNIT 7 (Shaxthal Runner Drone) 58 45} {NO_UPKEEP_NO_OVERLAY} {FACING ne}
        {GENERIC_UNIT 7 (Shaxthal Runner Drone) 58 46} {NO_UPKEEP_NO_OVERLAY} {FACING nw}

#ifndef EASY
        {GENERIC_UNIT 7 (Shaxthal Stormblade) 24 42} {NO_UPKEEP_NO_OVERLAY} {FACING ne}
#endif

        {FINALE_A_CAPTURE_INITIAL_VILLAGES 7 8}

        # Side 8

        {FINALE_A_SETUP_MAP_STARTLOC_SIDE 8 (
            {GOLD 150 165 180}
            recruit=Shaxthal Drone,Shaxthal Razorbird
        ) (
            canrecruit=yes
            type=Shaxthal Enforcer Drone
            variation=surface
            [modifications]
                {TRAIT_BIOMECHANICAL}
                {TRAIT_QUICK}
            [/modifications]
        )}

#ifndef EASY
        {GENERIC_UNIT 8 (Shaxthal Assault Drone)  4 18} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
#endif
        {GENERIC_UNIT 8 (Shaxthal Assault Drone)  8 13} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}

        {FINALE_A_CAPTURE_INITIAL_VILLAGES 8 8}

        # Side 9

        {FINALE_A_SETUP_MAP_STARTLOC_SIDE 9 (
            {GOLD 150 165 180}
            recruit=Shaxthal Drone,Shaxthal Razorbird,Shaxthal Rayblade
        ) (
            canrecruit=yes
            type=Shaxthal Demolisher Drone
            [modifications]
                {TRAIT_BIOMECHANICAL}
                {TRAIT_RESILIENT}
                {FINALE_A_NO_DEMOLITION_ABILITY}
            [/modifications]
        )}

        {GENERIC_UNIT 9 (Shaxthal Sentry Drone)  6 47} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION surface}
#ifndef EASY
        {GENERIC_UNIT 9 (Shaxthal Sentry Drone)  3 54} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION surface}
#endif

        {GENERIC_UNIT 9 (Shaxthal Drone)  3 52} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION surface}
        {GENERIC_UNIT 9 (Shaxthal Drone)  4 50} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION surface}

        {FINALE_A_CAPTURE_INITIAL_VILLAGES 9 8}

        # Side 10

        {FINALE_A_SETUP_SIDE 10 (20) (41) (
            {GOLD 150 165 180}
            recruit=Chaos Raider,Chaos Invader,Chaos Bowman,Chaos Gunner
        ) (
            canrecruit=yes
            type=Chaos Cataphract
            id=Celwyngyr
            name= _ "Celwyngyr"
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_INTELLIGENT}
            [/modifications]
        )}

        {FINALE_A_CAPTURE_INITIAL_VILLAGES 10 4}

        # Side 11

        {FINALE_A_SETUP_SIDE 11 (31) (55) (
            {GOLD 150 165 180}
            recruit=Chaos Headhunter,Chaos Invoker,Chaos Hound
        ) (
            canrecruit=yes
            type=Chaos Soulhunter
            id=Morol
            name= _ "Morol"
            [modifications]
                {TRAIT_INTELLIGENT}
                {TRAIT_STRONG}
            [/modifications]
        )}

        {FINALE_A_CAPTURE_INITIAL_VILLAGES 11 5}

        # Side 12

        {FINALE_A_SETUP_SIDE 12 (69) (45) (
            {GOLD 180 195 210}
            recruit=Skeleton,Skeleton Archer,Ghost,Ghoul,Walking Corpse
        ) (
            canrecruit=yes
            type=Lich
            id=Mal Fyrgwynn
            name= _ "Mal Fyrgwynn"
            [modifications]
                {TRAIT_UNDEAD}
                {TRAIT_RESILIENT}
            [/modifications]
        )}

        {GENERIC_UNIT 12 (Necrophage) 67 43} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}
        {GENERIC_UNIT 12 (Necrophage) 68 47} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}

        {GENERIC_UNIT 12 (Spectre) 20 38} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING ne}

        {GENERIC_UNIT 12 (Wraith) 34 51} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING ne}

        {GENERIC_UNIT 12 (Wraith)  6 19} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING ne}

#ifndef EASY
        {GENERIC_UNIT 12 (Death Knight) 34 55} {NO_UPKEEP_NO_OVERLAY} {FACING ne}
        {GENERIC_UNIT 12 (Deathblade)   35 55} {NO_UPKEEP_NO_OVERLAY} {FACING ne}
        {GENERIC_UNIT 12 (Bone Shooter) 34 54} {NO_UPKEEP_NO_OVERLAY} {FACING ne}
        {GENERIC_UNIT 12 (Revenant)     33 55} {NO_UPKEEP_NO_OVERLAY} {FACING ne}
#endif

        {FINALE_A_CAPTURE_INITIAL_VILLAGES 12 4}

        # Side 13

        {FINALE_A_SETUP_SIDE 13 (65) (57) (
            {GOLD 150 165 180}
            recruit=Chaos Gunner,Chaos Invoker,Automaton,Chaos Raider
        ) (
            canrecruit=yes
            type=Demon Warrior
            gender=male
            id=Demon Lord Alavys
            name= _ "Demon Lord Alavys"
            [modifications]
                {TRAIT_RESILIENT}
                {TRAIT_DEXTROUS}
            [/modifications]
        )}

        {GENERIC_UNIT 13 (Goliath) 65 44} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}
        {GENERIC_UNIT 13 (Goliath) 22 39} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING ne}
        {GENERIC_UNIT 13 (Goliath) 64 58} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}

#ifndef EASY
        {GENERIC_UNIT 13 (Hell Guardian) 62 52} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}
#else
        {GENERIC_UNIT 13 (Doom Guard)    62 52} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}
#endif
        {GENERIC_UNIT 13 (Doom Guard)    59 54} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING ne}
        {GENERIC_UNIT 13 (Doom Guard)    68 51} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}
        {GENERIC_UNIT 13 (Doom Guard)    70 55} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}

        {GENERIC_UNIT 13 (Chaos Marksman) 62 55} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING n}

        {GENERIC_UNIT 13 (Dark Knight) 62 60} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}
        {GENERIC_UNIT 13 (Dark Knight) 68 59} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING nw}

        {FINALE_A_CAPTURE_INITIAL_VILLAGES 13 6}

        #
        # End enemies setup.
        #

        [modify_side]
            side=1
            shroud=no
        [/modify_side]

        [redraw]
            side=1
        [/redraw]

        [modify_side]
            side=2
            controller=human
            hidden=no
            {GOLD 290 280 270}
            {DEFAULT_ECONOMY}
            recruit=Footpad,Thug,Poacher,Ruffian,Orcish Grunt,Orcish Archer,Wolf Rider,Orcish Assassin
        [/modify_side]

        [if]
            {VARIABLE_BOOLEAN_EQUALS waited_for_bardyl yes}
            [then]
                # wmlindent: start ignoring
                {BUG_ON ({VARIABLE_NUMERICAL_NOT_EQUALS bardyl_side_state.length 1})
                        ("side 2 status from E3S4.2 is corrupted")}
                # wmlindent: stop ignoring
                [gold]
                    side=2
                    amount=$bardyl_side_state.gold
                [/gold]

                [allow_recruit]
                    side=2
                    type=$bardyl_side_state.recruit
                [/allow_recruit]

                {FOREACH bardyl_side_units k}
                    [unstore_unit]
                        variable="bardyl_side_units[$k]"
                        x,y=recall,recall
                    [/unstore_unit]
                {NEXT k}
            [/then]
        [/if]

        [if]
            {VARIABLE_NUMERICAL_EQUALS durvan_store.length 1}
            [then]
                #
                # If we have Durvan, we want to place him on his recall
                # list first.
                #
                {VARIABLE durvan_store.side 2}
                {VARIABLE durvan_store.canrecruit yes}
                {CLEAR_VARIABLE durvan_store.overlays}

                [unstore_unit]
                    variable=durvan_store
                    x,y=recall,recall
                [/unstore_unit]
            [/then]
        [/if]

        [scroll_to]
            x,y=66,23
        [/scroll_to]

        [store_direction]
            from_x,from_y=66,23
            [to]
                [filter]
                    id=Anya
                [/filter]
            [/to]
        [/store_direction]

        # Recall or create Durvan as necessary.
        [unit]
            {CHARACTER_STATS_DURVAN}
            x,y=66,23
            side=2
            canrecruit=yes
            overlays="" # clobber IS_HERO from the stats macro
            animate=yes
            facing=$direction
        [/unit]

        {CLEAR_VARIABLE direction}

        #
        # First try to recall any loyals that might be in the
        # side 2 recall list (when it exists at all).
        #

        {RECALL_SIDE_LOYALS 2 ()}

        #
        # Generate one or two extra loyals if there aren't
        # enough loyals.
        #

        [while]
            [have_unit]
                side=2
                count=1-2
            [/have_unit]
            [do]
                [unit]
                    type=Aragwaith Spearman
                    side=2
                    placement=leader
                    animate=yes
                    upkeep=loyal
                    {IS_LOYAL}
                    generate_name=yes
                    random_traits=yes
                    random_gender=yes
                    [modifications]
                        {TRAIT_LOYAL}
                    [/modifications]
                [/unit]
            [/do]
        [/while]

        [redraw][/redraw]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Durvan
            message= _ "Uh... It seems we arrived just in time."
        [/message]

        [store_locations]
            x= 5, 6,20,31,65,69
            y=17,41,41,55,57,45
            variable=scroll_locations
        [/store_locations]

        {FOREACH scroll_locations k}
            [scroll_to]
                x,y=$scroll_locations[$k].x,$scroll_locations[$k].y
            [/scroll_to]

            [delay]
                time=500
            [/delay]
        {NEXT k}

        {CLEAR_VARIABLE scroll_locations}

        [message]
            speaker=Anya
            message= _ "Durvan! I thought you would be on your way back home by now!"
        [/message]

        [message]
            speaker=Durvan
            message= _ "I changed my mind, I guess? I can’t shake off the feeling that I’ll regret this later, though. Where is Elynia?"
        [/message]

        [message]
            speaker=Irylean
            message= _ "We don’t know. She might be dead, or worse..."
        [/message]

        [if]
            {VARIABLE_BOOLEAN_EQUALS waited_for_bardyl yes}
            [then]
                [message]
                    speaker=Ergea
                    message= _ "You may discuss that at a later time. For now, it is of utmost importance that we distract or take down Kalari’s military. I am confident that the Alliance troops Sir Durvan has amassed shall serve us well for this mission."
                [/message]

                [message]
                    speaker=Durvan
                    message= _ "It’s really General Bardyl and Elynia who should get the credit, not me. I merely asked him to lend us a hand, and he gladly acceded, most likely in return for Elynia’s support during the siege of Aran-Balgur. And incidentally, I’m no Sir."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Ergea
                    message= _ "You may discuss that at a later time. For now, it is of utmost importance that we distract or take down Kalari’s military. However, I expected Sir Durvan to provide us with more numerous troops than this."
                [/message]

                [message]
                    speaker=Durvan
                    message= _ "That General Bardyl wouldn’t accede to spending more lives on a pointless mission after Elynia decided to part ways with him before they could properly reclaim Aran-Balgur. So, I had to make do with low-ranking militiamen and some orcish mercenaries. And incidentally, I’m no Sir."
                [/message]
            [/else]
        [/if]

        [message]
            speaker=Anya
            message= _ "Time is of the essence, Durvan. We need to get moving while the darkness can provide us with an advantage."
        [/message]

        [message]
            speaker=Durvan
            message= _ "Sure, these men and women thirst for the blood of these fiends. Lead the way!"
        [/message]

        [scroll_to_unit]
            id=Anya
        [/scroll_to_unit]

        # [objectives] in 1.10 can't do multiple sides.

        {FOR k 1 2}
            {OBJECTIVES (
                side=$k
                {OBJECTIVE_VICTORY_END_OF_TURNS}
                {OBJECTIVE_OPTIONAL ( _ "Defeat all enemy leaders"+{EARLY_FINISH_BONUS_FOOTNOTE})}

                {OBJECTIVE_DEFEAT  ( _ "Death of Anya")}
                {OBJECTIVE_DEFEAT  ( _ "Death of Durvan")}
                {OBJECTIVE_DEFEAT  ( _ "Death of Irylean")}
                {OBJECTIVE_DEFEAT  ( _ "Death of Ergea")}
                {OBJECTIVE_DEFEAT  ( _ "Death of Cron")}

                {OBJECTIVE_CARRYOVER}
            )}
        {NEXT k}

        {REPLACE_SCENARIO_MUSIC "casualties_of_war.ogg"}
        {APPEND_MUSIC           "legends_of_the_north.ogg"}

        {CLEAR_VARIABLE durvan_store,waited_for_bardyl,bardyl_side_state,bardyl_side_units}

        {UNLOCK_VIEW}
    [/event]

    [event]
        name=side 1 turn 11

        [message]
            speaker=Durvan
            message= _ "So, Elynia went on a mission to infiltrate the Iron Council’s citadel? What kind of nonsense is that?"
        [/message]

        [message]
            speaker=Anya
            message= _ "According to Ergea she went to locate some kind of weapon buried beneath Kalari. I am really worried for her. She just left during the night without telling anyone about her plans. What are we supposed to do now? I mean, other than perpetuating this bloodshed. Ergea says it’s important and that it might be her only chance to succeed. But who knows what kind of abominations await in that place."
        [/message]
    [/event]

    [event]
        name=side 2 turn 11

        [message]
            speaker=Anya
            message= _ "And then there is this inexplicable unending darkness. It <i>is</i> our element, yet I can’t help but find all this dreadfully unnatural and foreboding."
        [/message]

        [message]
            speaker=Durvan
            message= _ "Yes... yes, it is. Maybe I shouldn’t have allowed Ergea to convince me to come here."
        [/message]

        [message]
            speaker=Anya
            message= _ "Ah, so you came back with us because she asked you to?"
        [/message]

        [message]
            speaker=Durvan
            # wmllint: local spelling Er
            # po: The first 'you' is singular; the second 'you' is plural.
            message= _ "Er... well, I admit that before she asked me I already wanted to see whether you were all right... I mean, you people."
        [/message]

        [message]
            speaker=Anya
            message= _ "Hm. I see."
        [/message]
    [/event]

    [event]
        name=die
        [filter]
            type=Skeleton,Skeleton Archer
        [/filter]
        [filter_second]
            id=Cron
        [/filter_second]

        [message]
            speaker=Cron
            message= _ "Cron likes the sound of bones breaking under his hammer."
        [/message]
    [/event]

    [event]
        name=attack
        [filter]
            id=Cron
        [/filter]
        [filter_second]
            type=Imp
        [/filter_second]

        [message]
            speaker=Cron
            message= _ "Cron enjoys crushing insolent vermin to death."
        [/message]

        [message]
            speaker=second_unit
            message= _ "Get away from me, you beast!"
        [/message]
    [/event]

    {FINALE_A_LOOT_EVENT 7 192}

    {FINALE_A_LOOT_EVENT 8 4}

    {FINALE_A_LOOT_EVENT 9 14}

    {FINALE_A_LOOT_EVENT 10 80}

    {FINALE_A_LOOT_EVENT 11 166}

    {FINALE_A_LOOT_EVENT 12 98}

    {FINALE_A_LOOT_EVENT 13 278}

    [event]
        name=enemies defeated

        [message]
            speaker=Ergea
            message= _ "Taking their river settlements, vanquishing their leaders, and leaving their troops in utter disarray ought to be enough to keep the Iron Council distracted for a short interval. It is time to take the fight to the citadel itself."
        [/message]

        {ENDLEVEL_VICTORY yes}
    [/event]

    [event]
        name=time over

        [message]
            speaker=Ergea
            message= _ "The situation is not as favorable as I wished. We ought to take the fight closer to the Iron Council’s citadel if we want to keep their attention away from Elynia."
        [/message]

        {ENDLEVEL_VICTORY no}
    [/event]

    {DIVERGENCE_SIDE_PERSISTENCE_WORKAROUND_IMPLEMENTATION_ON_VICTORY  1 anya_side_store}

    {DIVERGENCE_SIDE_PERSISTENCE_WORKAROUND_IMPLEMENTATION_ON_VICTORY  2 durvan_side_store}
[/scenario]

#undef FINALE_A_LOOT_EVENT
#undef FINALE_A_NO_DEMOLITION_ABILITY
#undef FINALE_A_CAPTURE_INITIAL_VILLAGES
#undef FINALE_A_SETUP_MAP_STARTLOC_SIDE
#undef FINALE_A_SETUP_SIDE

# kate: indent-mode normal; encoding utf-8; space-indent on;
