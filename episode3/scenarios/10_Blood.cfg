#textdomain wesnoth-After_the_Storm

[scenario]
    id=10_Blood
    name= _ "Blood"
    {MAP 10_Blood.map}
    turns=-1
    next_scenario=11_After_the_Storm
    victory_when_enemies_defeated=no
    disallow_recall=yes
    # We do not need this because the player 'Elynia' is never used again
    # after this point.
    #{DO_NOT_REMOVE_FROM_CARRYOVER_ON_DEFEAT}

    {K_DEATHS}

    {SCENARIO_MUSIC       "nunc_dimittis.ogg"}
    {EXTRA_SCENARIO_MUSIC "heroes_rite.ogg"}
    {EXTRA_SCENARIO_MUSIC "weight_of_revenge.ogg"}

    {STORYTXT_BLOOD}

    {SPAWN_CONTROLLER}

    {UNDERGROUND} {SCHEDULE_LIGHTING 20 -20 -20}

    {SHAXTHAL_SET_SURFACE_VARIATIONS_FLAG}

#define FINALE_B_SHARED_AI_PARAMS
    {AI_SIMPLE_ALWAYS_ASPECT aggression        9.00}
    {AI_SIMPLE_ALWAYS_ASPECT leader_aggression 9.00}
    {AI_SIMPLE_ALWAYS_ASPECT caution           0.00}
    {AI_SIMPLE_ALWAYS_ASPECT grouping            no}
#enddef

    # wmllint: validate-off
    [side]
        side=1
        controller=human
        save_id=Elynia
        team_name=good
        user_team_name= _ "team_name^Elynia"
        {RAGGED_FLAG}

        fog=yes
        shroud=yes

        {NO_ECONOMY}

        share_maps=no
        share_view=no

        # wmllint: recognize Elynia
        {CHARACTER_STATS_ELYNIA}
        type=Guardian of Earth Elynia
        canrecruit=yes
    [/side]
    # wmllint: validate-on

    [side]
        side=2
        team_name=evil
        user_team_name= _ "team_name^Zhangor"
        {CHAOS_FLAG}
        color=yellow

        hidden=yes
        no_leader=yes

        {NO_ECONOMY}

        {ai/aliases/stable_singleplayer.cfg}
        [ai]
            {FINALE_B_SHARED_AI_PARAMS}

            {AI_BOSS_TARGETING_ENGINE 2 <<{"Elyssa","Elynia"}>>}

            [goal]
                [criteria]
                    id=Elyssa
                [/criteria]
                value=200
            [/goal]

            [goal]
                [criteria]
                    id=Elynia
                [/criteria]
                value=200
            [/goal]

            [goal]
                [criteria]
                    type=Fire Guardian
                [/criteria]
                value=1
            [/goal]
        [/ai]
    [/side]

    [side]
        # Demons
        side=3
        team_name=evil
        user_team_name= _ "team_name^Zhangor"
        {CHAOS_FLAG}

        hidden=yes
        no_leader=yes

        {NO_ECONOMY}

        [ai]
            {FINALE_B_SHARED_AI_PARAMS}
        [/ai]

        {GENERIC_UNIT () (Psy Mindraider) 33 30} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Psy Crawler) 32 29} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
        {GENERIC_UNIT () (Psy Crawler) 32 30} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
        {GENERIC_UNIT () (Psy Crawler) 33 31} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Psy Crawler) 23 32} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Psy Crawler) 30 25} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Psy Crawler) 24 52} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Psy Crawler) 33 56} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
    [/side]

    [side]
        # Shaxthal
        side=4
        team_name=evil
        user_team_name= _ "team_name^Zhangor"
        {CHAOS_FLAG}

        hidden=yes
        no_leader=yes

        {NO_ECONOMY}

        [ai]
            {FINALE_B_SHARED_AI_PARAMS}
        [/ai]

#ifdef HARD
        {GENERIC_UNIT () (Shaxthal Custodian Drone) 25 36} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
#endif
        {GENERIC_UNIT () (Shaxthal Custodian Drone) 32 37} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
#ifndef EASY
        {GENERIC_UNIT () (Shaxthal Custodian Drone) 27 26} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
#endif
    [/side]

    [side]
        # Undead
        side=5
        team_name=evil
        user_team_name= _ "team_name^Zhangor"
        {CHAOS_FLAG}

        hidden=yes
        no_leader=yes

        {NO_ECONOMY}

        [ai]
            {FINALE_B_SHARED_AI_PARAMS}
        [/ai]

        {GENERIC_UNIT () (Fallen Faerie) 15 51} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
        {GENERIC_UNIT () (Fallen Faerie) 28 48} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
        {GENERIC_UNIT () (Fallen Faerie) 33 50} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
        {GENERIC_UNIT () (Fallen Faerie) 43 49} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Fallen Faerie) 29 43} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
        {GENERIC_UNIT () (Fallen Faerie) 32 42} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Revenant) 26 58} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
        {GENERIC_UNIT () (Revenant) 32 45} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Death Knight) 36 57} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Soulless) 32 58} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 34 61} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 26 61} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 24 57} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 22 55} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 21 61} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 36 55} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 40 52} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 41 55} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 45 54} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 30 46} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 33 48} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 18 49} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION swimmer}

        {GENERIC_UNIT () (Soulless) 26 54} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 41 51} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 33 53} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 12 54} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 18 61} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 39 61} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 46 49} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}

        {GENERIC_UNIT () (Soulless) 30 32} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 23 26} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 11 25} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 13 41} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 39 39} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 49 27} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 49 21} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}

        {GENERIC_UNIT () (Soulless) 23 50} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 38 51} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 31 28} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}
        {GENERIC_UNIT () (Soulless) 23 33} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {VARIATION wose}

        {GENERIC_UNIT () (Spectre) 40 30} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Spectre) 27 31} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Spectre) 17 29} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}

        {GENERIC_UNIT () (Spectre) 28 17} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}

        {GENERIC_UNIT () (Ghost) 16 14} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Ghost)  8 26} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Ghost) 47 53} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Ghost) 39 62} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}

        {GENERIC_UNIT () (Draug) 25 22} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
        {GENERIC_UNIT () (Draug) 31 22} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}

        {GENERIC_UNIT () (Spectre) 28 46} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}
        {GENERIC_UNIT () (Spectre) 35 50} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING sw}
        {GENERIC_UNIT () (Spectre) 27 52} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN} {FACING se}

#ifndef EASY
        {GENERIC_UNIT () (Shadow) 21 52} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}
        {GENERIC_UNIT () (Shadow) 43 51} {NO_UPKEEP_NO_OVERLAY} {GUARDIAN}

        # These aren't guardians. This is intentional.
        {GENERIC_UNIT () (Shadow)     31 40} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT () (Shadow)     26 33} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT () (Nightgaunt) 28 22} {NO_UPKEEP_NO_OVERLAY}
#endif
    [/side]

    {TIMED_DRONE_SPAWNER 6 (type,variation="Shaxthal Enforcer Drone",surface)  4 26 38}
    {TIMED_DRONE_SPAWNER 6 (type,variation="Shaxthal Enforcer Drone",surface)  4 34 45}

    {TIMED_DRONE_SPAWNER 3 (type,variation="Shaxthal Sentry Drone",surface)  4 10 38}
    {TIMED_DRONE_SPAWNER 3 (type,variation="Shaxthal Sentry Drone",surface)  4 11 40}
    {TIMED_DRONE_SPAWNER 3 (type,variation="Shaxthal Sentry Drone",surface)  4 14 43}
    {TIMED_DRONE_SPAWNER 3 (type,variation="Shaxthal Sentry Drone",surface)  4  2 36}
    {TIMED_DRONE_SPAWNER 3 (type,variation="Shaxthal Sentry Drone",surface)  4  1 31}
    {TIMED_DRONE_SPAWNER 3 (type,variation="Shaxthal Sentry Drone",surface)  4  8 23}
    {TIMED_DRONE_SPAWNER 3 (type,variation="Shaxthal Sentry Drone",surface)  4 45 32}
    {TIMED_DRONE_SPAWNER 3 (type,variation="Shaxthal Sentry Drone",surface)  4 46 35}
    {TIMED_DRONE_SPAWNER 3 (type,variation="Shaxthal Sentry Drone",surface)  4 42 38}
    {TIMED_DRONE_SPAWNER 3 (type,variation="Shaxthal Sentry Drone",surface)  4 49 35}
    {TIMED_DRONE_SPAWNER 3 (type,variation="Shaxthal Sentry Drone",surface)  4 54 34}

#ifndef EASY
    {TIMED_DRONE_SPAWNER 6 (type,variation="Shaxthal Sentry Drone",surface)  4 19 25}
    {TIMED_DRONE_SPAWNER 6 (type,variation="Shaxthal Sentry Drone",surface)  4 21 19}
    {TIMED_DRONE_SPAWNER 6 (type,variation="Shaxthal Sentry Drone",surface)  4 35 17}
    {TIMED_DRONE_SPAWNER 6 (type,variation="Shaxthal Sentry Drone",surface)  4 35 24}
#endif

    {FIRE_GUARDIAN_SUMMONING}

    [event]
        name=DEBUG1

        [kill]
            [filter_location]
                x,y=28,20
                radius=10
            [/filter_location]
        [/kill]

        [teleport]
            [filter]
                id=Elyssa
            [/filter]
            x,y=25,23
        [/teleport]

        [teleport]
            [filter]
                id=Elynia
            [/filter]
            x,y=26,23
        [/teleport]

        [fire_event]
            name=reveal keep
        [/fire_event]
    [/event]

#define FINALE_B_SIGIL_TILE_FRAGMENT _REL_X _REL_Y
    [tile]
        x={_REL_X}
        y={_REL_Y}
        type=!,W* # needed to void this rule on boss stage 4
    [/tile]
#enddef

    [terrain_graphics]
        x,y=27,19
        {FINALE_B_SIGIL_TILE_FRAGMENT 0 0}
        {FINALE_B_SIGIL_TILE_FRAGMENT 1 0}
        {FINALE_B_SIGIL_TILE_FRAGMENT 2 0}
        {FINALE_B_SIGIL_TILE_FRAGMENT 0 1}
        {FINALE_B_SIGIL_TILE_FRAGMENT 1 1} # keep at 28,20
        {FINALE_B_SIGIL_TILE_FRAGMENT 2 1}
        {FINALE_B_SIGIL_TILE_FRAGMENT 0 2}
        {FINALE_B_SIGIL_TILE_FRAGMENT 1 2}
        {FINALE_B_SIGIL_TILE_FRAGMENT 2 2}
        probability=100
        [image]
            center=94,144
            layer=0
            name="../scenery/sigil-4.png"
        [/image]
    [/terrain_graphics]

#undef FINALE_B_SIGIL_TILE_FRAGMENT

    {CAVE_NOISE_SOUND_SOURCE}
    [+sound_source]
        id=cave_noise
    [/sound_source]

    [event]
        name=prestart

        {VARIABLE boss_stage      0}
        {VARIABLE boss_start_turn 0}

        # Aspect combos shit is too complicated to setup here,
        # so it's done later on.

        # wmllint: recognize Elyssa
        {RECALL_ELYSSA_AT_LOCATION 29 65}

        {FACE_DIRECTION id=Elyssa se}
        {FACE_DIRECTION id=Elynia nw}

        {OBJECTIVES (
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Locate Zhangor")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elyssa")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}

            {OBJECTIVE_NO_CARRYOVER}

            {FIRE_GUARDIAN_SUMMONING_NOTE}
        )}

        [set_menu_item]
            # NOTE: the z prefix is intended to force this item
            # to go below the Fire Guardian summoning command.
            id=wmi_z_combo_attacks_info
            description= _ "Attack Combinations"
            image="icons/menu-book.png"
            [command]
                [combo_info_dialog][/combo_info_dialog]
            [/command]
        [/set_menu_item]
    [/event]

    [event]
        name=start

        [message]
            speaker=Elynia
            message= _ "Blood?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Yes, more blood. You might want to get used to it — there is a lot of it in the place we are headed towards."
        [/message]
    [/event]

    [event]
        name=turn 2

        [message]
            speaker=Elyssa
            message= _ "If we want to have any chance of killing that bastard for good, we must stick together and try to combine our powers and attacks in different ways. Your aspect is undeniably affiliated to the path of Light; mine is Darkness. Perhaps, even without the Union, we may be able to achieve something in some form."
        [/message]

        [message]
            speaker=Elynia
            message= _ "That is why you wanted me by your side, right?"
        [/message]

        [message]
            speaker=Elyssa
            # po: "Us" = Argan and Elyssa.
            message= _ "Yes. It is my hope that you... will not let us down."
        [/message]

        [transient_message]
            message= _ "Right click on the map and choose “Attack Combinations” for information on the possible attack combinations you can use and their effects."
        [/transient_message]
    [/event]

    {OBJ_HEALING_GLYPH 20 16}

    {OBJ_HEALING_GLYPH 33 15}

#ifndef HARD
    {OBJ_HEALING_GLYPH 25 27}
#else
    [event]
        name=prestart
        [remove_terrain_overlays]
            x,y=25,27
        [/remove_terrain_overlays]
    [/event]
#endif

    ############################################################################
    #                                                                          #
    #                               ASPECT COMBOS                              #
    #                                                                          #
    ############################################################################

#define COMBO_DBG _MSG
    {LOG_ATS_DBG ("COMBO: "+{_MSG})}
#enddef

#define COMBO_SIGIL _COL _ROW
    "icons/original-ten-sigils.png~CROP($(60*"+{_COL}+"), $(60*"+{_ROW}+"), 60, 60)"
#enddef

#define COMBO_SIGIL_EARTH
    {COMBO_SIGIL 3 0}
#enddef

#define COMBO_SIGIL_DARKNESS
    {COMBO_SIGIL 0 1}
#enddef

    [event]
        name=reset combo status
        first_time_only=no

        [set_variables]
            name=combo_status
            mode=replace
            [value]
                [side_a]
                    attacker,attack=$null,$null
                    [target]
                        x,y=0,0
                    [/target]
                [/side_a]
                [side_b]
                    attacker,attack=$null,$null
                    [target]
                        x,y=0,0
                    [/target]
                [/side_b]
            [/value]
        [/set_variables]
    [/event]

    [event]
        name=prestart

        {COMBO_DBG "initializing"}

        [fire_event]
            name=reset combo status
        [/fire_event]

        [set_variables]
            name=combo_attacks
            mode=replace
            [literal]
                side_a="claw of urvatha"
                side_b="ensnare"
                symmetric=no
                name= _ "inferno grasp"
                [effect]
                    apply_to=damage
                    multiply=3.0
                [/effect]
                [ui]
                    encountered=no
                    [side_a]
                        attack_name= _"claw of urvatha" # wmllint: ignore
                        attack_icon=attacks/staff-elven-star.png # FIXME: placeholder
                        aspect_icon={COMBO_SIGIL_DARKNESS}
                    [/side_a]
                    [side_b]
                        attack_name= _"ensnare" # wmllint: ignore
                        attack_icon=attacks/entangle.png
                        aspect_icon={COMBO_SIGIL_EARTH}
                    [/side_b]
                [/ui]
            [/literal]
            [literal]
                side_a="claw of urvatha"
                side_b="faerie touch"
                symmetric=no
                name= _ "primal nightmare"
                [effect]
                    apply_to=damage
                    multiply=4.0
                [/effect]
                [ui]
                    encountered=no
                    [side_a]
                        attack_name= _"claw of urvatha" # wmllint: ignore
                        attack_icon=attacks/staff-elven-star.png # FIXME: placeholder
                        aspect_icon={COMBO_SIGIL_DARKNESS}
                    [/side_a]
                    [side_b]
                        attack_name= _"faerie touch" # wmllint: ignore
                        attack_icon=attacks/touch-faerie.png
                        aspect_icon={COMBO_SIGIL_EARTH}
                    [/side_b]
                [/ui]
            [/literal]
            [literal]
                side_a="pyranoctum"
                side_b="arcane rage"
                symmetric=yes
                name= _ "flames of xia’el"
                [effect]
                    apply_to=damage
                    multiply=2.0
                [/effect]
                [ui]
                    encountered=no
                    [side_a]
                        attack_name= _"pyranoctum" # wmllint: ignore
                        attack_icon=attacks/fireball.png
                        aspect_icon={COMBO_SIGIL_DARKNESS}
                    [/side_a]
                    [side_b]
                        attack_name= _"arcane rage" # wmllint: ignore
                        attack_icon=attacks/arcane-rage.png
                        aspect_icon={COMBO_SIGIL_EARTH}
                    [/side_b]
                [/ui]
            [/literal]
            [literal]
                side_a="noctum"
                side_b="arcane rage"
                symmetric=yes
                name= _ "foreshadowing moon"
                [effect]
                    apply_to=damage
                    multiply=4.0
                [/effect]
                [ui]
                    encountered=no
                    [side_a]
                        attack_name= _"noctum" # wmllint: ignore
                        attack_icon=attacks/noctum.png
                        aspect_icon={COMBO_SIGIL_DARKNESS}
                    [/side_a]
                    [side_b]
                        attack_name= _"arcane rage" # wmllint: ignore
                        attack_icon=attacks/arcane-rage.png
                        aspect_icon={COMBO_SIGIL_EARTH}
                    [/side_b]
                [/ui]
            [/literal]
        [/set_variables]

        {COMBO_DBG "$combo_attacks.length combos"}
    [/event]

    [event]
        name=victory

        {CLEAR_VARIABLE combo_attacks,combo_status}
    [/event]

    #
    # NOTE: Only during offense.
    #

    [event]
        name=attack
        first_time_only=no
        [filter]
            id=Elynia
            [or]
                id=Elyssa
            [/or]
        [/filter]
        [filter_condition]
            {VARIABLE_NUMERICAL_EQUALS side_number 1}
        [/filter_condition]

        {VARIABLE combo_side $null}

        [if]
            {VARIABLE_LEXICAL_EQUALS combo_status.side_a.attacker $null}
            [then]
                {VARIABLE combo_side a}
            [/then]
            [else]
                {VARIABLE combo_side b}
            [/else]
        [/if]

        {VARIABLE state_ref combo_status.side_$combo_side}

        {BUG_ON ({VARIABLE_LEXICAL_EQUALS state_ref "combo_status.side_"}) ("No combo side set!")}

        [set_variables]
            name=$state_ref
            mode=replace
            [value]
                attacker=$unit.id
                attack=$weapon.name
                [target]
                    x,y=$x2,$y2
                [/target]
            [/value]
        [/set_variables]

        {COMBO_DBG "side $combo_side status set (attacker=$unit.id attack=$weapon.name target=$x2,$y2)"}

        [if]
            {VARIABLE_LEXICAL_EQUALS combo_side b}

            {VARIABLE_NUMERICAL_EQUALS combo_status.side_a.target.x $combo_status.side_b.target.x}
            {VARIABLE_NUMERICAL_EQUALS combo_status.side_a.target.y $combo_status.side_b.target.y}

            [then]
                {COMBO_DBG "side a and side b match, running controller"}

                [fire_event]
                    name=combo controller
                    [primary_unit]
                        x,y=$x1,$y1
                    [/primary_unit]
                    [secondary_unit]
                        x,y=$x2,$y2
                    [/secondary_unit]
                [/fire_event]
            [/then]
        [/if]

        {CLEAR_VARIABLE combo_side,state_ref}
    [/event]

    [event]
        name=combo controller
        first_time_only=no

        # Pseudo-references to keep code tidy.

        {VARIABLE rs_a combo_status.side_a}
        {VARIABLE rs_b combo_status.side_b}

        {BUG_ON (
            [not]
                {VARIABLE_NUMERICAL_EQUALS $rs_a|.target.x $x2}
                {VARIABLE_NUMERICAL_EQUALS $rs_a|.target.y $y2}
                {VARIABLE_NUMERICAL_EQUALS $rs_b|.target.x $x2}
                {VARIABLE_NUMERICAL_EQUALS $rs_b|.target.y $y2}
            [/not]
        ) ("Combo controller invoked with bad target")}

        {FOREACH combo_attacks n}
            # More pseudo-references
            {VARIABLE rc_combo combo_attacks[$n]}

            {BUG_ON ({VARIABLE_NUMERICAL_NOT_EQUALS $rc_combo|.effect.length 1}) ("Combo effect count in config is not 1 ($$rc_combo|.effect.length)")}

            {VARIABLE rc_effect $rc_combo|.effect}

            [if]
                {FALSE}

                # Condition 1: symmetric combos
                [or]
                    {VARIABLE_BOOLEAN_EQUALS $rc_combo|.symmetric yes}
                    [and] # A is A or B
                        {VARIABLE_LEXICAL_EQUALS $rc_combo|.side_a $$rs_a|.attack}
                        [or]
                            {VARIABLE_LEXICAL_EQUALS $rc_combo|.side_a $$rs_b|.attack}
                        [/or]
                    [/and]
                    [and] # B is A or B
                        {VARIABLE_LEXICAL_EQUALS $rc_combo|.side_b $$rs_a|.attack}
                        [or]
                            {VARIABLE_LEXICAL_EQUALS $rc_combo|.side_b $$rs_b|.attack}
                        [/or]
                    [/and]
                [/or]

                # Condition 2: asymmetric combos
                [or]
                    {VARIABLE_BOOLEAN_EQUALS $rc_combo|.symmetric no}
                    # A = A
                    {VARIABLE_LEXICAL_EQUALS $rc_combo|.side_a $$rs_a|.attack}
                    # B = B
                    {VARIABLE_LEXICAL_EQUALS $rc_combo|.side_b $$rs_b|.attack}
                [/or]

                [then]
                    {COMBO_DBG "selected combo [$n]; side a = $$rs_a|.attack; side b = $$rs_b|.attack"}

                    # Apply the combo to the selected attack, then break the loop
                    {FOREACH unit.attack m}
                        [if]
                            {VARIABLE_LEXICAL_EQUALS unit.attack[$m].name $$rs_b|.attack}
                            [then]
                                {COMBO_DBG "applying combo effects to attack [$m] '$$rs_b|.attack' on $unit.id"}

                                [if]
                                    {VARIABLE_LEXICAL_EQUALS $rc_effect|.apply_to damage}
                                    [then]
                                        {VARIABLE ra_damage_ary "unit.attack[$m].specials.damage"}
                                        {VARIABLE ra_damage     "$ra_damage_ary|[$$ra_damage_ary|.length]"}

                                        [set_variables]
                                            name=$ra_damage
                                            mode=insert
                                            [insert_tag]
                                                name=value
                                                variable=$rc_effect
                                            [/insert_tag]
                                        [/set_variables]

                                        [set_variables]
                                            name=$ra_damage
                                            mode=merge
                                            [value]
                                                id=combo_damage_effect # wmllint: ignore
                                                apply_to=self
                                                active_on=offense
                                            [/value]
                                        [/set_variables]

                                        #{COMBO_DBG "$ra_damage|.id = $$ra_damage|.id"}
                                        #{COMBO_DBG "$ra_damage|.multiply = $$ra_damage|.multiply"}
                                        #{COMBO_DBG "$ra_damage|.apply_to = $$ra_damage|.apply_to"}
                                        #{COMBO_DBG "$ra_damage|.active_on = $$ra_damage|.active_on"}

                                        [unstore_unit]
                                            variable=unit
                                            find_vacant=no
                                        [/unstore_unit]

                                        [event]
                                            id=combo_hits_handler # wmllint: ignore
                                            name=attacker hits
                                            delayed_variable_substitution=no
                                            first_time_only=yes

                                            {UNIT_SPELL_POPUP x,y=$|x1,$|y1 $$rc_combo|.name}
                                        [/event]

                                        [event]
                                            name=attack end
                                            delayed_variable_substitution=no
                                            first_time_only=yes

                                            {COMBO_DBG "removing combo effects"}

                                            {CLEAR_VARIABLE $ra_damage}

                                            [unstore_unit]
                                                variable=unit
                                                find_vacant=no
                                            [/unstore_unit]

                                            [fire_event]
                                                name=reset combo status
                                            [/fire_event]

                                            [event]
                                                id=combo_hits_handler # wmllint: ignore
                                                remove=yes
                                            [/event]
                                        [/event]

                                        {CLEAR_VARIABLE ra_damage,ra_damage_ary}

                                        {BREAK m}
                                    [/then]
                                    [else]
                                        {BUG ("Combo effect not implemented yet: '$$rc_effect|.apply_to'")}
                                    [/else]
                                [/if]
                            [/then]
                        [/if]
                    {NEXT m}

                    {BREAK n}
                [/then]
            [/if]

            {CLEAR_VARIABLE rc_combo,rc_effect}
        {NEXT n}

        {CLEAR_VARIABLE rs_a,rs_b}
    [/event]

    [event]
        name=side 1 turn end
        first_time_only=no

        {COMBO_DBG "resetting state on side 1 turn end"}

        [fire_event]
            name=reset combo status
        [/fire_event]
    [/event]

#undef COMBO_SIGIL_EARTH
#undef COMBO_SIGIL_DARKNESS
#undef COMBO_SIGIL
#undef COMBO_DBG

    ############################################################################
    #                                                                          #
    #                            REACHING BOSS AREA                            #
    #                                                                          #
    ############################################################################

    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=28,20
                radius=6
            [/filter_location]
        [/filter]

        [fire_event]
            name=reveal keep
        [/fire_event]
    [/event]

#define FINALE_B_ZHANGORS_KEEP_SLF
    x,y=28,20
    radius=1
#enddef

    [event]
        name=reveal keep

        {LOCK_VIEW}

        [remove_shroud]
            side=1
            x,y=28,20
            radius=7
        [/remove_shroud]

        [remove_terrain_overlays]
            x,y=28,20
            radius=1
            [and]
                terrain=C*^*
            [/and]
        [/remove_terrain_overlays]

        [terrain]
            x,y=28,20
            terrain=^Kov
            layer=overlay
        [/terrain]

        {CLEAR_FOG 1 28 20 8}

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=28,20
        [/scroll_to]

        {HIGHLIGHT_GOAL (x,y=28,20)}

        {UNCLEAR_FOG}

        [message]
            speaker=Elyssa
            message= _ "Hm. He is not here as I expected. I suppose his intention is to make some kind of dramatic entrance later."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Elynia, there is something here you should see."
        [/message]

        {OBJECTIVES (
            victory_string= _ "Current Objective:"
            {OBJECTIVE_VICTORY ( _ "Move Elynia and Elyssa to (28, 20) and the immediately adjacent locations")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elyssa")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}

            {OBJECTIVE_NO_CARRYOVER}

            {FIRE_GUARDIAN_SUMMONING_NOTE}
        )}

        {UNLOCK_VIEW}

        [event]
            id=ee_moveto_handler # wmllint: ignore
            name=moveto
            first_time_only=no
            [filter]
                [filter_location]
                    {FINALE_B_ZHANGORS_KEEP_SLF}
                [/filter_location]
                [and]
                    id=Elynia
                    [or]
                        id=Elyssa
                    [/or]
                [/and]
            [/filter]

            [if]
                {VARIABLE_LEXICAL_EQUALS unit.id Elynia}
                [have_unit]
                    id=Elyssa
                    [filter_location]
                        {FINALE_B_ZHANGORS_KEEP_SLF}
                    [/filter_location]
                [/have_unit]
                [or]
                    {VARIABLE_LEXICAL_EQUALS unit.id Elyssa}
                    [have_unit]
                        id=Elynia
                        [filter_location]
                            {FINALE_B_ZHANGORS_KEEP_SLF}
                        [/filter_location]
                    [/have_unit]
                [/or]

                [then]
                    [fire_event]
                        name=boss stage 1
                    [/fire_event]
                [/then]
            [/if]
        [/event]
    [/event]

    ############################################################################
    #                                                                          #
    #                               BOSS STAGE 1                               #
    #                                                                          #
    ############################################################################

    [event]
        name=boss stage 1

        [event]
            id=ee_moveto_handler # wmllint: ignore
            remove=yes
        [/event]

        {BUG_ON (
            [not]
                [have_unit]
                    id=Elynia
                    [filter_location]
                        {FINALE_B_ZHANGORS_KEEP_SLF}
                    [/filter_location]
                [/have_unit]
                [have_unit]
                    id=Elyssa
                    [filter_location]
                        {FINALE_B_ZHANGORS_KEEP_SLF}
                    [/filter_location]
                [/have_unit]
            [/not]
        ) ("stage 1 fired early")}

        {LOCK_VIEW}

        {RESET_UNIT_STATUSES (
            id=Elyssa
            [or]
                id=Elynia
            [/or]
        )}

        [kill]
            [filter_location]
                x,y=28,20
                radius=7
            [/filter_location]
            [not]
                id=Elynia
                [or]
                    id=Elyssa
                [/or]
            [/not]
        [/kill]

        [modify_side]
            side=1
            fog=no
        [/modify_side]

        [remove_shroud]
            side=1
            x=0-55
            y=0-39
        [/remove_shroud]

        [place_shroud]
            side=1
            x= 0-55
            y=40-69
        [/place_shroud]

        [redraw]
            side=1
        [/redraw]

        [fade_out_music][/fade_out_music]

        [fade_out_sound_effects][/fade_out_sound_effects]

        {REMOVE_SOUND_SOURCE cave_noise}

        [reset_sound_effects][/reset_sound_effects]

        {REPLACE_SCENARIO_MUSIC "transience.ogg"}

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Elynia
            message= _ "What is that in the middle of the blood lake?"
        [/message]

        [scroll_to]
            x,y=28,4
        [/scroll_to]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            scroll=no
            message= _ "The Seed of Earth, the place from which all life on Irdya originally sprang."
        [/message]

        [message]
            speaker=Elyssa
            scroll=no
            message= _ "It is currently sealed in its chamber. There is not much that can be done with it by anyone other than the Guardian of Earth. Generally speaking, nobody is supposed to see or tamper with the thing that lays within; not even the controlling Guardian herself. That is to say, not even you."
        [/message]

        [message]
            speaker=Elyssa
            scroll=no
            message= _ "... Unless, of course, you wanted to reset life on Irdya back to the beginning. That is how the Second Cycle was started. But if you did that, then every living or non-living creature currently standing on this world would be erased from existence — even you."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Doing that would destroy Zhangor for sure, but Uria is not on Irdya, and the loss would be insignificant to her. But if you feel particularly selfish about your pitiful existence, this is an option."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elynia
            message= _ "That would be a coward’s choice, don’t you think?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Possibly. But if the guardian in question feared the absolute end of their own existence, then one could say that making the choice would take some degree of courage."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "What is your choice?"
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "Do not worry, it is not a binding decision, yet."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Is that the only possible use for the power stored in this place? To destroy all life in our world so it can start anew?"
        [/message]

        [message]
            speaker=Elyssa
            message= _ "If Merthiaal’s cautionary story is any indication, yes. But Uria believes otherwise. She believes that the seeds can be used for other things if the aspect you control is either Life or Existence, based on the efforts of her predecessor — or the very unreliable information we have about them, anyway. But her attempts to find the seed on Urvatha have proven fruitless so far, and her patience is wearing thin. As ludicrous as it sounds, she no longer wants to find <i>just</i> the Body of the Union on Ethea."
        [/message]

        [message]
            speaker=Elynia
            message= _ "I see. Then, there is no point in doing anything with ours."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "I suppose. There is so much we still don’t know about our own creation..."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Come to think of it, we should be thankful that Delethia’s actions ensured we would not get a proper Guardian of Existence for this cycle who could turn out to be an even more powerful deranged psychopath than Uria. Well, probably. That girl, Anya... her sole existence raises many questions we thought we had already answered."
        [/message]

        [message]
            speaker=Elyssa
            sound=laugh.ogg
            message= _ "...!"
        [/message]

        [fade_out_music]
            duration=500
        [/fade_out_music]

        {REPLACE_SCENARIO_MUSIC "siege_of_laurelmor.ogg"}

        [mute_sound_effects][/mute_sound_effects]

        {CAVE_NOISE_SOUND_SOURCE}
        [+sound_source]
            id=cave_noise
        [/sound_source]

        [fade_in_sound_effects]
            duration=750
        [/fade_in_sound_effects]

        [message]
            speaker=Elyssa
            message= _ "... But of course. The bastard’s plans aren’t as aligned with Uria’s own as I originally thought."
        [/message]

        [store_unit]
            [filter]
                id=Elyssa
            [/filter]
            variable=elyssa_store
            kill=yes
        [/store_unit]

        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            variable=elynia_store
            kill=yes
        [/store_unit]

        [sound]
            name=magic-dark.ogg
        [/sound]

        [hide_unit][/hide_unit]

        {RED_SCREEN}

        {VARIABLE_ADD elyssa_store.x  4}
        {VARIABLE elyssa_store.facing se}
        {VARIABLE_MIN elynia_store.x  4}
        {VARIABLE elynia_store.facing sw}

        [hidden_unit]
            {CHARACTER_STATS_ELYNIA}
            type=Guardian of Earth Elynia
            canrecruit=no
            facing=$elynia_store.facing
            side=1
            x,y=$elynia_store.x,$elynia_store.y
            max_hitpoints=1
            variation=injured
            upkeep=free
        [/hidden_unit]

        [hidden_unit]
            {CHARACTER_STATS_ELYSSA}
            type=Guardian of Darkness Elyssa
            canrecruit=no
            facing=$elyssa_store.facing
            side=1
            x,y=$elyssa_store.x,$elyssa_store.y
            max_hitpoints=1
            variation=injured
            upkeep=free
        [/hidden_unit]

        [sound]
            name=lightning.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        {RESET_SCREEN}

        [unhide_unit][/unhide_unit]

        [redraw]
            side=1
        [/redraw]

        [delay]
            time=100
        [/delay]

        [kill]
            x,y=28,20
            [not]
                side=1
            [/not]
        [/kill]

        [unit]
            canrecruit=yes
            animate=yes
            side=2
            id=Zhangor
            name= _ "Zhangor"
            type=Angel of Blood
            {IS_BOSS}
            x,y=28,20
            facing=se
            [modifications]
                {TRAIT_BIOMECHANICAL}
                {TRAIT_DEXTROUS}
            [/modifications]
        [/unit]

        [scroll_to_unit]
            id=Zhangor
        [/scroll_to_unit]

        {BOSS_POPUP}

        #{REPLACE_SCENARIO_MUSIC "the_dangerous_symphony.ogg"}

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Zhangor
            message= _ "What a glorious day for Irdya! So, at long last, Argan’s little girl solved the puzzle!"
        [/message]

        [kill]
            id=Elyssa
        [/kill]

        [unstore_unit]
            variable=elyssa_store
            find_vacant=yes
            check_passability=no
        [/unstore_unit]

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        {FACE_DIRECTION id=Elyssa nw}

        [redraw][/redraw]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elyssa
            message= _ "You are a disgusting liar and a traitor, Zhangor."
        [/message]

        [kill]
            id=Elynia
        [/kill]

        [unstore_unit]
            variable=elynia_store
            find_vacant=yes
            check_passability=no
        [/unstore_unit]

        [redraw][/redraw]

        [delay]
            time=750
        [/delay]

        {FACE_DIRECTION id=Elynia ne}

        [redraw][/redraw]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Zhangor
            message= _ "Excellent. That makes us equals in the eyes of the Lady of Light. Or should I call her the Guardian of Earth now?"
        [/message]

        {FACE_DIRECTION id=Zhangor sw}

        [redraw][/redraw]

        [message]
            speaker=Zhangor
            message= _ "Ah yes, Elynia... I have not forgotten what you and Argan did to me. Do you have any idea what it feels like to live for hundreds of years in agonizing pain with your limbs scattered across the land and buried deep in the ground? Do you?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "You’ve got nothing to fear; this time I shall make sure <i>nothing</i> remains of your wretched body for Uria to bring back."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "And I shall make sure your soul is destroyed forever as well."
        [/message]

        [message]
            speaker=Zhangor
            message= _ "Without the Union? Go ahead, try your best!"
        [/message]

        {REPLACE_SCENARIO_MUSIC "gathering_storm.ogg"}

        [sound]
            name="dragonstick.ogg"
        [/sound]

        [kill]
            x=29-33
            y=43-45
        [/kill]

        [terrain]
            x=29-33
            y=43-45
            terrain=Xos
        [/terrain]

        [sound]
            name="dragonstick.ogg"
        [/sound]

        [terrain_mask]
            x,y=1,1
            {MASK 10_Blood_1.mask}
            border=yes
        [/terrain_mask]

        [redraw][/redraw]

        {QUAKE (explosion-big.ogg)}

        [delay]
            time=250
        [/delay]

        {VARIABLE boss_stage 1}

        {VARIABLE boss_start_turn $turn_number}

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Vanquish Demon Lord Zhangor")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elyssa")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}

            {OBJECTIVE_NO_CARRYOVER}

            {OBJECTIVE_NOTE ( _ "Zhangor’s Gatekeeper powers allow him to debilitate and destroy the Energy Heart of a Guardian")}
            {FIRE_GUARDIAN_SUMMONING_NOTE}
        )}

        {UNLOCK_VIEW}
    [/event]

    ############################################################################
    #                                                                          #
    #                       SHARED CODE FOR ALL BOSS STAGES                    #
    #                                                                          #
    ############################################################################

    [event]
        name=side 2 turn
        first_time_only=no
        [filter_condition]
            {VARIABLE_NUMERICAL_NOT_EQUALS boss_stage 0}
        [/filter_condition]

        {BUG_ON ({VARIABLE_NUMERICAL_LESS_THAN boss_start_turn 1}) ("boss_start_turn < 1")}

        #
        # Let him recruit a castleful of units every n turns,
        # depending on the current difficulty setting.
        #

        {VARIABLE boss_recruitment_rate {DIFF 4 3 2} }

        # First see if we just started the first boss turn.
        {VARIABLE boss_recruitment_factor "$($turn_number - $boss_start_turn)"}

        [if]
            {VARIABLE_NUMERICAL_NOT_EQUALS boss_recruitment_factor 0}
            [then]
                {VARIABLE_MOD boss_recruitment_factor $boss_recruitment_rate}
            [/then]
        [/if]

        [if]
            {VARIABLE_NUMERICAL_EQUALS boss_recruitment_factor 0}
            [then]
                [fire_event]
                    name=boss recruitment controller
                [/fire_event]
            [/then]
        [/if]

        {CLEAR_VARIABLE boss_recruitment_rate,boss_recruitment_factor}
    [/event]

    [event]
        name=boss recruitment controller
        first_time_only=no

        {BUG_ON ({VARIABLE_NUMERICAL_NOT_EQUALS side_number 2}) ("boss recruitment controller called when side_number != 2")}

        [if]
            {VARIABLE_NUMERICAL_LESS_THAN boss_stage 3}
            [then]
                {VARIABLE side_2_recruits "Psy Crawler,Shaxthal Drone"}
            [/then]
            [else]
                {VARIABLE side_2_recruits "Psy Crawler,Shaxthal Drone,Shaxthal Rayblade,Ghost"}
            [/else]
        [/if]

        [modify_side]
            side=2
            recruit=$side_2_recruits
            gold={DIFF 60 70 80}
        [/modify_side]

        [event]
            name=side 2 turn end
            delayed_variable_substitution=no

            [modify_side]
                side=2
                gold=0
            [/modify_side]

            {DISALLOW_RECRUIT 2 $side_2_recruits}
        [/event]

        {CLEAR_VARIABLE side_2_recruits}
    [/event]

    ############################################################################
    #                                                                          #
    #                               BOSS STAGE 2                               #
    #                                                                          #
    ############################################################################

    [event]
        name=last breath
        [filter]
            id=Zhangor
        [/filter]
        [filter_condition]
            {VARIABLE_NUMERICAL_EQUALS boss_stage 1}
        [/filter_condition]

        [fire_event]
            name=boss stage 2
            [primary_unit]
                id=Zhangor
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=boss stage 2

        {VARIABLE boss_stage 2}

        {VARIABLE ofacing $unit.facing}
        {VARIABLE ox      $x1}
        {VARIABLE oy      $y1}

        {LOCK_VIEW}

        {RESET_UNIT_STATUSES (
            id=Elyssa
            [or]
                id=Elynia
            [/or]
        )}

        [scroll_to_unit]
            id=Zhangor
        [/scroll_to_unit]

        [fade_out_music]
            duration=500
        [/fade_out_music]

        [sound]
            name=laugh.ogg
        [/sound]

        {PLAY_LEVELOUT_ANIM id=Zhangor}

        [kill]
            id=Zhangor
        [/kill]

        [hide_unit][/hide_unit]

        {RED_SCREEN}

        #
        # Try to get any outstanding actions out of the queue now to mitigate
        # [delay] timing issues below.
        #

        [redraw]
            side=1
        [/redraw]

        [hidden_unit]
            canrecruit=yes
            side=2
            id=Zhangor
            name= _ "Zhangor"
            type=Angel of Blood
            {IS_BOSS}
            variation=nightmare1
            x,y=$ox,$oy
            facing=$ofacing
            [modifications]
                {TRAIT_UNDEAD}
                {TRAIT_DEXTROUS}
            [/modifications]
        [/hidden_unit]

        {CLEAR_VARIABLE ox,oy,ofacing}

        [sound]
            name=gun-activate-2.ogg
        [/sound]

        [delay]
            # Approx. the length of gun-activate-2.ogg (actually around 920 ms,
            # but [delay] is too inaccurate due to the calls to the display drawing
            # code involved.
            time=900
        [/delay]

        {RESET_SCREEN}

        [sound]
            name=lightning.ogg
        [/sound]

        {REPLACE_SCENARIO_MUSIC "ambuscade-loop.ogg"}
        {APPEND_MUSIC           "vengeful.ogg"}
        {INCIDENTAL_MUSIC       "moleman.ogg"}

        [unhide_unit][/unhide_unit]

        {PLAY_LEVELIN_ANIM id=Zhangor}

        [redraw]
            side=1
        [/redraw]

        [if]
            [not]
                [have_unit]
                    id=Zhangor
                    x,y=28,20
                [/have_unit]
            [/not]
            [then]
                #
                # Attempt to teleport any units on Zhangor's
                # keep away.
                #
                # FIXME: This may actually fail; in that case
                #        Zhangor's location may end up being
                #        somewhere else and we may need to pay
                #        attention to that later on.
                #

                [if]
                    [have_unit]
                        x,y=28,20
                    [/have_unit]
                    [then]
                        [teleport]
                            [filter]
                                x,y=28,20
                            [/filter]
                            x,y=30,19
                        [/teleport]
                    [/then]
                [/if]

                {MOVE_UNIT id=Zhangor 28 20} {IGNORE_MOVEMENT_COSTS}

                [redraw]
                    side=1
                [/redraw]
            [/then]
        [/if]

        [store_locations]
            terrain=Xos
            [and]
                x,y=28,20
                radius=7
            [/and]
            #
            # NOTE: this variable persists until the end of the
            # boss battle!
            #
            variable=core_locs
        [/store_locations]

        {QUAKE ("cave-in.ogg")}

        {QUAKE ("cave-in.ogg")}

        {FOREACH core_locs k}
            [store_direction]
                from_x,from_y=$core_locs[$k].x,$core_locs[$k].y
                to_x,to_y=28,20
            [/store_direction]

            [terrain]
                # TODO: maybe some special terrain for this?
                terrain=Cud^Xo
                x,y=$core_locs[$k].x,$core_locs[$k].y
            [/terrain]

            [hidden_unit]
                side=2
                type=Blood Core
                x,y=$core_locs[$k].x,$core_locs[$k].y
                facing=$direction
            [/hidden_unit]

            {CLEAR_VARIABLE direction}
        {NEXT k}

        [sound]
            name="explosion-big.ogg"
        [/sound]

        [unhide_unit][/unhide_unit]

        [redraw][/redraw]

        {QUAKE ()}

        [message]
            speaker=Elynia
            message= _ "What are you trying to do now?"
        [/message]

        [store_locations]
            terrain=*^Fet*
            [and]
                x,y=28,20
                radius=7
            [/and]
            #
            # NOTE: this variable persists until the end of the
            # boss battle!
            #
            variable=banshee_locs
        [/store_locations]

        {FOREACH banshee_locs k}
            [store_direction]
                from_x,from_y=$banshee_locs[$k].x,$banshee_locs[$k].y
                to_x,to_y=28,20
            [/store_direction]

            [remove_terrain_overlays]
                x,y=$banshee_locs[$k].x,$banshee_locs[$k].y
            [/remove_terrain_overlays]

            [hidden_unit]
                side=2
                type=Fallen Faerie
                random_gender=yes
                random_traits=yes
                generate_name=yes
                x,y=$banshee_locs[$k].x,$banshee_locs[$k].y
                facing=$direction
            [/hidden_unit]

            {CLEAR_VARIABLE direction}
        {NEXT k}

        [sound]
            name={SOUND_LIST:LICH_HIT}
        [/sound]

        [unhide_unit][/unhide_unit]

        [redraw][/redraw]

        [delay]
            time=750
        [/delay]

        {UNLOCK_VIEW}

        #
        # Once all Blood Cores are destroyed, every attack from the guardians
        # has 100% chance to hit Zhangor.
        #

        {FORCE_CHANCE_TO_HIT (
            id=Elynia
            [or]
                id=Elyssa
            [/or]
        ) (id=Zhangor) 100 (
            [not]
                [have_unit]
                    type=Blood Core
                [/have_unit]
            [/not]
        )}
    [/event]

    [event]
        name=attacker hits
        first_time_only=no
        [filter]
            side=1
        [/filter]
        [filter_second]
            type=Blood Core
        [/filter_second]

        [fire_event]
            name=player hits blood core
            [primary_unit]
                x,y=$x1,$y1 # side 1
            [/primary_unit]
            [secondary_unit]
                x,y=$x2,$y2 # side 2
            [/secondary_unit]
        [/fire_event]
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter_second]
            side=1
        [/filter_second]
        [filter]
            type=Blood Core
        [/filter]

        [fire_event]
            name=player hits blood core
            [primary_unit]
                x,y=$x2,$y2 # side 1
            [/primary_unit]
            [secondary_unit]
                x,y=$x1,$y1 # side 2
            [/secondary_unit]
        [/fire_event]
    [/event]

    [event]
        name=player hits blood core
        first_time_only=yes

        [message]
            # Try speaking as the primary unit if she's Elynia or Elyssa, or Elyssa
            # otherwise.
            x,y=$x1,$y1
            [and]
                id=Elynia
                [or]
                    id=Elyssa
                [/or]
            [/and]
            [or]
                id=Elyssa
            [/or]
            message= _ "What the—"
        [/message]
    [/event]

    [event]
        name=player hits blood core
        first_time_only=no

        #
        # PRECONDITIONS (unchecked):
        # * primary unit is side = 1
        # * secondary unit is side = 2
        #

        {BUG_ON ({VARIABLE_NUMERICAL_LESS_THAN boss_stage 2}) ("Blood Core handler running before boss stage 2 ($boss_stage|)")}

        #
        # Shuffle Blood Cores' HP bars around whenever possible.
        #

        [store_unit]
            [filter]
                type=Blood Core
                [filter_location]
                    find_in=core_locs
                [/filter_location]
            [/filter]
            variable=shuffle_stack
        [/store_unit]

        #
        # This shuffling algorithm should work in every case regardless of the amount
        # of units stored. If there's a single unit stored, it is unstored back with
        # minimal overhead later (*). If there are no units stored, the loop never
        # runs, and the bugcheck path is not hit.
        #

        {REVERSE_FOREACH shuffle_stack k}
            # k is the position of the primary unit to swap, set by the foreach cycle.
            # r is the position of teh secondary unit to swap, determined by the RNG.
            {VARIABLE r -1}

            [if]
                {VARIABLE_NUMERICAL_GREATER_THAN k 0}
                [then]
                    {VARIABLE_RANDOM r "0..$($k - 1)"}

                    {LOG_ATS_DBG ("SWAP: $k <-> $r <$shuffle_stack.length>")}

                    {VARIABLE swap.hitpoints     $shuffle_stack[$r].hitpoints}
                    {VARIABLE swap.max_hitpoints $shuffle_stack[$r].max_hitpoints}

                    {VARIABLE shuffle_stack[$r].hitpoints     $shuffle_stack[$k].hitpoints}
                    {VARIABLE shuffle_stack[$r].max_hitpoints $shuffle_stack[$k].max_hitpoints}

                    {VARIABLE shuffle_stack[$k].hitpoints     $swap.hitpoints}
                    {VARIABLE shuffle_stack[$k].max_hitpoints $swap.max_hitpoints}

                    [unstore_unit]
                        variable="shuffle_stack[$r]"
                        find_vacant=no
                        check_passability=no
                    [/unstore_unit]

                    {CLEAR_VARIABLE swap}
                [/then]
            [/if]

            # (*)

            [unstore_unit]
                variable="shuffle_stack[$k]"
                find_vacant=no
                check_passability=no
            [/unstore_unit]

            [if]
                {VARIABLE_NUMERICAL_GREATER_THAN r -1}
                [then]
                    [floating_text]
                        x=$shuffle_stack[$k].x,$shuffle_stack[$r].x
                        y=$shuffle_stack[$k].y,$shuffle_stack[$r].y
                        text="<span color='#FF7F00'>!</span>" # wmllint: ignore
                    [/floating_text]

                    {CLEAR_VARIABLE shuffle_stack[$r]}

                    {VARIABLE_DEC k}
                [/then]
            [/if]

            {CLEAR_VARIABLE r,shuffle_stack[$k]}
        {REVERSE_NEXT k}

        # We shouldn't hit this unless the shuffling algorithm is broken.
        {BUG_ON ({VARIABLE_NUMERICAL_GREATER_THAN shuffle_stack.length 0}) ("Unit stats shuffling algorithm postcondition broken")}

        # FIXME: because I don't want to see what happens if we fire death events in the
        #        middle of the sequence above, we need to check now what Blood Cores are
        #        left with 0 HP or less. The game does not automatically kill them when
        #        this happens unless it's the actual target unit.

        [store_unit]
            [filter]
                type=Blood Core
                [filter_location]
                    find_in=core_locs
                [/filter_location]
            [/filter]
            variable=shuffle_stack
            kill=no
        [/store_unit]

        {FOREACH shuffle_stack k}
            [if]
                {VARIABLE_NUMERICAL_LESS_THAN shuffle_stack[$k].hitpoints 1}
                [not]
                    {VARIABLE_NUMERICAL_EQUALS x2 $shuffle_stack[$k].x}
                    {VARIABLE_NUMERICAL_EQUALS y2 $shuffle_stack[$k].y}
                [/not]
                [then]
                    [kill]
                        x,y=$shuffle_stack[$k].x,$shuffle_stack[$k].y
                        fire_event=yes
                        animate=yes
                    [/kill]
                [/then]
            [/if]
        {NEXT k}

        {CLEAR_VARIABLE shuffle_stack}
    [/event]

    [event]
        name=player hits blood core
        first_time_only=yes

        [message]
            speaker=Elyssa
            message= _ "Oh, is that what we are doing now, Zhangor? I expected you to be more creative than this in a real fight."
        [/message]
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            type=Blood Core
        [/filter]

        #
        # Boost ALL guardians HP. This includes Zhangor unless he's
        # already on his last variation stage.
        #

        {VARIABLE guardian_player_hp_boost {DIFF 40 30 20} }
        {VARIABLE guardian_enemy_hp_boost  {DIFF 20 30 40} }

        [store_unit]
            [filter]
                id=Elyssa
                [or]
                    id=Elynia
                [/or]
            [/filter]
            variable=guardians_store
        [/store_unit]

        [sound]
            name="heal.wav"
        [/sound]

        {FOREACH guardians_store k}
            {VARIABLE_ADD guardians_store[$k].max_hitpoints $guardian_player_hp_boost}
            {VARIABLE_ADD guardians_store[$k].hitpoints     $guardian_player_hp_boost}

            [unstore_unit]
                variable="guardians_store[$k]"
                find_vacant=no
                {COLOR_HEAL}
                text="+$guardian_player_hp_boost" # wmllint: ignore
            [/unstore_unit]
        {NEXT k}

        {CLEAR_VARIABLE guardians_store}

        [if]
            {VARIABLE_NUMERICAL_NOT_EQUALS boss_stage 3}
            [then]
                [store_unit]
                    [filter]
                        id=Zhangor
                    [/filter]
                    variable=zhangor_store
                [/store_unit]

                {VARIABLE_ADD zhangor_store.max_hitpoints $guardian_enemy_hp_boost}
                {VARIABLE_ADD zhangor_store.hitpoints     $guardian_enemy_hp_boost}

                [unstore_unit]
                    variable=zhangor_store
                    find_vacant=no
                    {COLOR_HEAL}
                    text="+$guardian_enemy_hp_boost" # wmllint: ignore
                [/unstore_unit]

                {CLEAR_VARIABLE zhangor_store}
            [/then]
        [/if]

        {CLEAR_VARIABLE guardian_player_hp_boost,guardian_enemy_hp_boost}
    [/event]

    [event]
        name=die
        [filter]
            type=Blood Core
        [/filter]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Elynia
            message= _ "I feel... as though destroying these things is increasing my power somehow..."
        [/message]

        [message]
            speaker=Elyssa
            message= _ "Yes, I feel the same — but Zhangor’s life force appears to be increasing as well."
        [/message]
    [/event]

    ############################################################################
    #                                                                          #
    #                               BOSS STAGE 3                               #
    #                                                                          #
    ############################################################################

    [event]
        name=last breath
        [filter]
            id=Zhangor
        [/filter]
        [filter_condition]
            {VARIABLE_NUMERICAL_EQUALS boss_stage 2}
        [/filter_condition]

        [fire_event]
            name=boss stage 3
            [primary_unit]
                id=Zhangor
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=boss stage 3

        {VARIABLE boss_stage 3}

        {VARIABLE ofacing $unit.facing}
        {VARIABLE ox      $x1}
        {VARIABLE oy      $y1}

        {BUG_ON ({VARIABLE_NUMERICAL_EQUALS banshee_locs.length 0}) ("banshee_locs.length == 0")}

        {LOCK_VIEW}

        {RESET_UNIT_STATUSES (
            id=Elyssa
            [or]
                id=Elynia
            [/or]
            [or]
                id=Zhangor
            [/or]
        )}

        [scroll_to_unit]
            id=Zhangor
        [/scroll_to_unit]

        [delay]
            time=250
        [/delay]

        {FLASH_RED (
            [sound]
                name="dragonstick.ogg"
            [/sound]

            [kill]
                id=Zhangor
            [/kill]

            [unit]
                canrecruit=yes
                side=2
                id=Zhangor
                name= _ "Zhangor"
                type=Angel of Blood
                {IS_BOSS}
                variation=nightmare2
                x,y=$ox,$oy
                facing=$ofacing
                [modifications]
                    {TRAIT_UNDEAD}
                    {TRAIT_DEXTROUS}
                [/modifications]
            [/unit]
        )}

        {CLEAR_VARIABLE ox,oy,ofacing}

        [redraw][/redraw]

        [delay]
            time=500
        [/delay]

        [sound]
            name="laugh.ogg"
        [/sound]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Elynia
            message= _ "Oh dear gods, will this ever stop?"
        [/message]

        {FOREACH banshee_locs k}
            {VARIABLE shapeshifter_type "Demon Shapeshifter"}
            {VARIABLE shapeshifter_id   $null}

            [set_variables]
                name=shapeshifter_mods
                mode=replace
                [literal]
                    [object]
                        silent=yes
                        [effect]
                            apply_to=image_mod
                            add="CS(16,0,16)" # Add a little purpleish tint.
                        [/effect]
                    [/object]
                [/literal]
            [/set_variables]

            [switch]
                variable=k
                [case]
                    value=0
                    {VARIABLE shapeshifter_type "Master of Darkness"}
                    {VARIABLE shapeshifter_id   "fakeArgan"}
                [/case]
                [case]
                    value=2
                    {VARIABLE shapeshifter_type "Nightshade Fire"}
                    {VARIABLE shapeshifter_id   "fakeAnya"}

                    [set_variables]
                        name=shapeshifter_mods
                        mode=insert
                        [literal]
                            [object]
                                silent=yes
                                [effect]
                                    apply_to=image_mod
                                    add="PAL(magenta_to_red_tc>magenta_to_yellow_tc)"
                                [/effect]
                            [/object]
                        [/literal]
                    [/set_variables]
                [/case]
                [case]
                    value=4
                    {VARIABLE shapeshifter_type "Elvish Wayfarer"}
                    {VARIABLE shapeshifter_id   "fakeGalas"}
                [/case]
                [else]
                    {CLEAR_VARIABLE shapeshifter_mods}
                [/else]
            [/switch]

            [store_direction]
                from_x,from_y=$banshee_locs[$k].x,$banshee_locs[$k].y
                to_x,to_y=28,20
            [/store_direction]

            [scroll_to]
                x,y=$banshee_locs[$k].x,$banshee_locs[$k].y
            [/scroll_to]

            [unit]
                side=2
                animate=yes
                type=$shapeshifter_type
                facing=$direction
                x,y=$banshee_locs[$k].x,$banshee_locs[$k].y
                id=$shapeshifter_id
                name=""
                generate_name=no
                random_traits=no
                random_gender=yes
                [insert_tag]
                    name=modifications
                    variable=shapeshifter_mods
                [/insert_tag]
            [/unit]

            {CLEAR_VARIABLE shapeshifter_id,shapeshifter_type,shapeshifter_mods,direction}
        {NEXT k}

        [message]
            speaker=Zhangor
            message= _ "What is the matter, Guardians? Do you fear killing those of your own kin now? Have you not become accustomed to it over the course of your lives?"
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]

        {UNLOCK_VIEW}
    [/event]

#define FINALE_B_SHAPESHIFTER_CONFRONT_EH _ID _SECOND_ID _WML
    [event]
        name=attack
        [filter]
            id="fake"+{_ID} # wmllint: ignore
        [/filter]
        [filter_second]
            id={_SECOND_ID}
        [/filter_second]

        [fire_event]
            name="shapeshifter "+{_ID}+" confront "+{_SECOND_ID}
            [primary_unit]
                x,y=$x1,$y1
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=attack
        [filter_second]
            id="fake"+{_ID} # wmllint: ignore
        [/filter_second]
        [filter]
            id={_SECOND_ID}
        [/filter]

        [fire_event]
            name="shapeshifter "+{_ID}+" confront "+{_SECOND_ID}
            [primary_unit]
                x,y=$x2,$y2
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name="shapeshifter "+{_ID}+" confront "+{_SECOND_ID}

        {_WML}
    [/event]
#enddef

#define FINALE_B_SHAPESHIFTER_KILL_EH _ID _SECOND_ID _WML
    [event]
        name=die
        [filter]
            id="fake"+{_ID} # wmllint: ignore
        [/filter]
        [filter_second]
            id={_SECOND_ID}
        [/filter_second]

        {_WML}
    [/event]
#enddef

    [event]
        name=die
        [filter]
            type=Demon Shapeshifter
        [/filter]

        [if]
            [have_unit]
                id=Elynia
                x,y=$x2,$y2
            [/have_unit]
            [then]
                [message]
                    speaker=Elynia
                    message= _ "These are manifestations of Zhangor’s will — not even real shapeshifters!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Elynia
                    message= _ "They are manifestations of Zhangor’s will — not even real shapeshifters!"
                [/message]
            [/else]
        [/if]
    [/event]

    # Nothing for Elyssa<->Anya.
    #{FINALE_B_SHAPESHIFTER_CONFRONT_EH Anya Elyssa ()}

    {FINALE_B_SHAPESHIFTER_KILL_EH Anya Elyssa (
        [message]
            speaker=Elyssa
            # po: This sentence could be interpreted in two different ways; either Elyssa
            # po: is stating that she wouldn't want to kill the real Anya, or that she
            # po: does not necessarily consider the real Anya to be the real Guardian of
            # po: Darkness, and hence she might not hesitate in killing her. This
            # po: ambiguity is intentional.
            message= _ "I would hate to have to kill you... if you were the real Guardian of Darkness."
        [/message]
    )}

    {FINALE_B_SHAPESHIFTER_CONFRONT_EH Anya Elynia (
        [message]
            speaker=unit
            caption= _ "Anya"
            message= _ "You abandoned me..."
        [/message]
    )}

    {FINALE_B_SHAPESHIFTER_KILL_EH Anya Elynia (
        [message]
            speaker=Elynia
            # po: ‘Demon’ here refers to Zhangor.
            message= _ "Posing as my dearest friend will not save you from my wrath, demon!"
        [/message]
    )}

    {FINALE_B_SHAPESHIFTER_CONFRONT_EH Argan Elyssa (
        [message]
            speaker=unit
            caption= _ "Argan"
            message= _ "You left me to die..."
        [/message]
    )}

    {FINALE_B_SHAPESHIFTER_KILL_EH Argan Elyssa (
        [message]
            speaker=Elyssa
            message= _ "Your imitation of Argan is once again absolutely pathetic."
        [/message]
    )}

    {FINALE_B_SHAPESHIFTER_CONFRONT_EH Argan Elynia (
        [message]
            speaker=unit
            caption= _ "Argan"
            message= _ "You betrayed me..."
        [/message]
    )}

    {FINALE_B_SHAPESHIFTER_KILL_EH Argan Elynia (
        [message]
            speaker=Elynia
            message= _ "This cheap trick will not break me down this time."
        [/message]
    )}

    {FINALE_B_SHAPESHIFTER_CONFRONT_EH Galas Elyssa (
        [message]
            speaker=unit
            caption= _ "Galas"
            message= _ "You killed me..."
        [/message]
    )}

    {FINALE_B_SHAPESHIFTER_KILL_EH Galas Elyssa (
        [message]
            speaker=Elyssa
            message= _ "I could slaughter a whole host of these stupid elves a thousand times, Zhangor. Is this all you’ve got?"
        [/message]
    )}

    {FINALE_B_SHAPESHIFTER_CONFRONT_EH Galas Elynia (
        [message]
            speaker=unit
            caption= _ "Galas"
            message= _ "You failed to protect me..."
        [/message]
    )}

    {FINALE_B_SHAPESHIFTER_KILL_EH Galas Elynia (
        [message]
            speaker=Elynia
            message= _ "I no longer care for any of this, Zhangor. I no longer care."
        [/message]
    )}

    ############################################################################
    #                                                                          #
    #                                 FINAL STAGE                              #
    #                                                                          #
    ############################################################################

    [event]
        name=last breath
        [filter]
            id=Zhangor
        [/filter]
        [filter_condition]
            {VARIABLE_NUMERICAL_EQUALS boss_stage 3}
        [/filter_condition]

        [fire_event]
            name=boss stage 4
            [primary_unit]
                id=Zhangor
            [/primary_unit]
        [/fire_event]
    [/event]

#define FINALE_B_RED_AURA _ID
    [item]
        [filter]
            id={_ID}
        [/filter]
        halo="halo/heart-aura.png"
        image="misc/blank-hex.png"
    [/item]
#enddef

#define FINALE_B_GREEN_AURA _ID
    [item]
        [filter]
            id={_ID}
        [/filter]
        halo="halo/heart-aura.png~CS(-255,128,16)"
        image="misc/blank-hex.png"
    [/item]
#enddef

#define FINALE_B_FADE_STEP NUMBER DELAY_TIME
    {FADE_STEP_RGB {NUMBER} -500 -500 {DELAY_TIME}}
#enddef

    [event]
        name=boss stage 4

        {LOCK_VIEW}

        {REPLACE_SCENARIO_MUSIC "silence.ogg"          }
        {INCIDENTAL_MUSIC       "one_thousand_suns.ogg"}

        [message]
            speaker=Zhangor
            message= _ "(<i>fluctuating voice</i>) You... cannot destroy me..."
        [/message]

        {RESET_UNIT_STATUSES (
            id=Elyssa
            [or]
                id=Elynia
            [/or]
            [or]
                id=Zhangor
            [/or]
        )}

        [scroll_to_unit]
            id=Zhangor
        [/scroll_to_unit]

        [delay]
            time=250
        [/delay]

        [sound]
            name="dragonstick.ogg"
        [/sound]

        [object]
            silent=yes
            [filter]
                id=Zhangor
            [/filter]
            [effect]
                apply_to="variation"
                name="nightmare3"
            [/effect]
        [/object]

        [redraw][/redraw]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Zhangor
            message= _ "(<i>feminine voice</i>) ... I am... the Angel of Blood..."
        [/message]

        #
        # The Flat Overlay is used so Elynia and Elyssa do not sink
        # into the blood terrain.
        #

        [terrain]
            x,y=28,20
            radius=6
            terrain=Wwb^Gov
        [/terrain]

        # Remove healing glyphs
        [remove_item][/remove_item]

        [redraw][/redraw]

        {QUAKE ("explosion-big.ogg")}

        [message]
            speaker=Elyssa
            message= _ "You are nothing but a sad memory of who you once were. It seems Uria did not do such a good job in bringing you back from your grave. Perhaps she was aware that you would eventually betray her. Or perhaps she did not have the same infatuation she had with Argan."
        [/message]

        [terrain]
            x,y=28,20
            radius=8
            terrain=Wwb^Gov
        [/terrain]

        [redraw][/redraw]

        {QUAKE ("explosion-big.ogg")}

        [message]
            speaker=Elyssa
            message= _ "What I do know for sure..."
        [/message]

        [kill]
            [filter_location]
                x,y=28,20
                radius=8
            [/filter_location]
            [not]
                id=Zhangor
                [or]
                    id=Elynia
                [/or]
                [or]
                    id=Elyssa
                [/or]
            [/not]
            animate=yes
            fire_event=no
        [/kill]

        [message]
            speaker=Elyssa
            message= _ "... is that you are done. Elynia!"
        [/message]

        [store_unit]
            [filter]
                id=Zhangor
            [/filter]
            kill=no
            variable=zhangor_store
        [/store_unit]

        {VARIABLE zhangor_store.name (_"unit_name^???")}

        [unstore_unit]
            variable=zhangor_store
            find_vacant=no
            check_passability=no
        [/unstore_unit]

        {MOVE_UNIT id=Elyssa "$($zhangor_store.x - 2)" $zhangor_store.y}
        {FACE_DIRECTION id=Elyssa se}

        [redraw][/redraw]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Zhangor
            # po: 'He' is intended to be used in the sense of a deity here.
            message= _ "(<i>feminine voice</i>) ... He will come for you... at the end..."
        [/message]

        {MOVE_UNIT id=Elynia "$($zhangor_store.x + 2)" $zhangor_store.y}
        {FACE_DIRECTION id=Elynia sw}

        {CLEAR_VARIABLE zhangor_store}

        [redraw][/redraw]

        [message]
            speaker=Zhangor
            # po: 'Him' also as a deity here.
            message= _ "(<i>feminine voice</i>) ... the Four will not suffice to defeat Him..."
        [/message]

        {FINALE_B_RED_AURA Elyssa}

        [message]
            speaker=Elyssa
            message= _ "Pierce into the heart of stone..."
        [/message]

        {COLOR_ADJUST 30 0 0}

        {QUAKE ({SOUND_LIST:LICH_HIT})}

        {FINALE_B_GREEN_AURA Elynia}

        [message]
            speaker=Elynia
            message= _ "... release the soul back to the void..."
        [/message]

        {COLOR_ADJUST 60 0 0}

        {QUAKE ({SOUND_LIST:LICH_HIT})}

        {MODIFY_UNIT id=Elyssa level 7}

        [redraw][/redraw]

        [message]
            speaker=Elyssa
            message= _ "... break the curse of Yarae..."
        [/message]

        {COLOR_ADJUST 90 0 0}

        {QUAKE ({SOUND_LIST:LICH_HIT})}

        {MODIFY_UNIT id=Elynia level 7}

        [redraw][/redraw]

        {REMOVE_SOUND_SOURCE cave_noise}

        [fade_out_music]
            duration=500
        [/fade_out_music]

        [message]
            speaker=Elynia
            message= _ "... dispel the spirit from this world."
        [/message]

        {COLOR_ADJUST 120 0 0}

        {QUAKE ({SOUND_LIST:LICH_HIT})}

        {COLOR_ADJUST 150 0 0}

        {QUAKE ("explosion-big.ogg")}

        {COLOR_ADJUST 180 0 0}

        #
        # We need these two stored for the next scenario since we will be
        # working with Anya and Durvan's side information instead.
        #

        [store_unit]
            [filter]
                id=Elyssa
            [/filter]
            variable=elyssa_store
            kill=yes
        [/store_unit]

        [store_unit]
            [filter]
                id=Elynia
            [/filter]
            variable=elynia_store
            kill=yes
        [/store_unit]

        {VARIABLE coming_from_e3s10 yes}

        [kill]
            {NOT_ON_RECALL_LIST}
            animate=no
            fire_event=no
        [/kill]

        {QUAKE ("dragonstick.ogg")}

        {COLOR_ADJUST 210 0 0}

        [remove_item][/remove_item]

        {QUAKE ("explosion-big.ogg")}

        {RED_SCREEN}

        [delay]
            time=1900
        [/delay]

        #
        # Cross-fade from red screen to black screen.
        #

        {FINALE_B_FADE_STEP  224 5}
        {FINALE_B_FADE_STEP  192 5}
        {FINALE_B_FADE_STEP  160 5}
        {FINALE_B_FADE_STEP  128 5}
        {FINALE_B_FADE_STEP   96 5}
        {FINALE_B_FADE_STEP   64 5}
        {FINALE_B_FADE_STEP   32 5}
        {FINALE_B_FADE_STEP    0 5}
        {FINALE_B_FADE_STEP  -32 5}
        {FINALE_B_FADE_STEP  -64 5}
        {FINALE_B_FADE_STEP  -96 5}
        {FINALE_B_FADE_STEP -128 5}
        {FINALE_B_FADE_STEP -160 5}
        {FINALE_B_FADE_STEP -192 5}
        {FINALE_B_FADE_STEP -224 5}

        {BLACK_SCREEN}

        [place_shroud]
            side=1
            # EVERYWHERE
        [/place_shroud]

        [delay]
            time=10000
        [/delay]

        {REPLACE_SCENARIO_MUSIC "journeys_end.ogg"}

        [delay]
            time=4000
        [/delay]

        [message]
            speaker=narrator
            caption= _ "Aradellys"
            image="misc/blank-hex.png"
            message= _ "<i>It is all well, children of Irdya. You may rest now.</i>"
        [/message]

        [delay]
            time=4000
        [/delay]

        [fade_out_music]
            duration=2000
        [/fade_out_music]

        {UNLOCK_VIEW}

        {ENDLEVEL_QUIET}
    [/event]

    [event]
        name=victory

        {REMOVE_MENU_ITEM wmi_z_combo_attacks_info}

        {CLEAR_VARIABLE boss_stage,boss_start_turn,core_locs,banshee_locs}
    [/event]
[/scenario]

#undef FINALE_B_SHARED_AI_PARAMS
#undef FINALE_B_FADE_STEP
#undef FINALE_B_RED_AURA
#undef FINALE_B_GREEN_AURA
#undef FINALE_B_ZHANGORS_KEEP_SLF
#undef FINALE_B_SHAPESHIFTER_KILL_EH
#undef FINALE_B_SHAPESHIFTER_CONFRONT_EH

# kate: indent-mode normal; encoding utf-8; space-indent on;
