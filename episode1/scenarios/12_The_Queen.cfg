#textdomain wesnoth-After_the_Storm

[scenario]
    id=12_The_Queen
    name= _ "The Queen"
    {MAP 11_Return_to_Wesmere_part_2.map}
    turns=-1
    next_scenario="13_Death_and_Rebirth"
    victory_when_enemies_defeated=no

    {B_DEATHS}

    {SCENARIO_MUSIC       "weight_of_revenge.ogg"}
    {EXTRA_SCENARIO_MUSIC "northerners.ogg"}
    {EXTRA_SCENARIO_MUSIC "siege_of_laurelmor.ogg"}
    {EXTRA_SCENARIO_MUSIC "heroes_rite.ogg"}

    {INDOORS_HIVE} {SCHEDULE_LIGHTING -10 -50 10}

#define RTW_SHARED_AI_ASPECTS
    {AI_SIMPLE_ALWAYS_ASPECT aggression 200.00}
    {AI_SIMPLE_ALWAYS_ASPECT caution      0.00}
    {AI_SIMPLE_ALWAYS_ASPECT grouping       no}
#enddef

    [time_area]
        id=surface
        x=0-24,0-23,0-21,0-19,0-17,0-15
        y=0-10,  11,  12,  13,  14,  15
        {SHORTDARK} {SCHEDULE_LIGHTING -10 -50 10}
    [/time_area]

    {SPAWN_CONTROLLER}

    # wmllint: validate-off
    [side]
        save_id=player

        gold,village_gold=0,0
        {NO_INCOME}

        fog,shroud=yes,yes

        controller=human
        side=1
        team_name=player
        user_team_name= _ "team_name^Elynia"

        # wmllint: recognize Elynia
        {CHARACTER_STATS_ELYNIA_AS_LEADER}
    [/side]
    # wmllint: validate-on

#define RTW_MATRIX_PART_1 X Y
    {GENERIC_UNIT () (Verlissh Matrix Flow System) ({X}) ({Y})} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
#enddef

    [side]
        side=2
        team_name=hive
        user_team_name= _ "team_name^Wesmere Hive"
        {CHAOS_FLAG}
        hidden=yes
        color=orange

        no_leader=yes
        {NO_ECONOMY}

        [ai]
            {RTW_SHARED_AI_ASPECTS}
        [/ai]

        {RTW_MATRIX_PART_1 57 19}
        {RTW_MATRIX_PART_1 44 18}

        {RTW_MATRIX_PART_1 62 24}
        {RTW_MATRIX_PART_1 63 24}

        {RTW_MATRIX_PART_1 68 22}
        {RTW_MATRIX_PART_1 69 24}

        {RTW_MATRIX_PART_1 72 13}
        {RTW_MATRIX_PART_1 69 14}
        {RTW_MATRIX_PART_1 74 12}
        {RTW_MATRIX_PART_1 66 15}
        {RTW_MATRIX_PART_1 71  2}

        {GENERIC_UNIT () (Psy Crawler) 67 24} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT () (Psy Crawler) 71 22} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT () (Psy Crawler) 71 15} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}

        {GENERIC_UNIT () (Psy Crawler) 52  3} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT () (Psy Crawler) 49  7} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT () (Psy Crawler) 55 11} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT () (Psy Crawler) 60 10} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
    [/side]

#undef RTW_MATRIX_PART_1

    [side]
        side=3
        team_name=hive
        user_team_name= _ "team_name^Wesmere Hive"
        {CHAOS_FLAG}
        hidden=no
        color=brown

        no_leader=yes
        {NO_ECONOMY}

        [ai]
            {RTW_SHARED_AI_ASPECTS}
        [/ai]
    [/side]

    [side]
        side=4
        team_name=hive
        user_team_name= _ "team_name^Wesmere Hive"
        {CHAOS_FLAG}
        hidden=yes
        color=black

        no_leader=yes
        {NO_ECONOMY}

        [ai]
            {RTW_SHARED_AI_ASPECTS}
        [/ai]

        {GENERIC_UNIT () (Soulless) 66 19} {NO_UPKEEP_NO_OVERLAY} {FACING se} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 70 18} {NO_UPKEEP_NO_OVERLAY} {FACING s } {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 74 20} {NO_UPKEEP_NO_OVERLAY} {FACING sw} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 68 12} {NO_UPKEEP_NO_OVERLAY} {FACING sw} {GUARDIAN} {VARIATION swimmer}
        {GENERIC_UNIT () (Soulless) 72 10} {NO_UPKEEP_NO_OVERLAY} {FACING nw} {GUARDIAN} {VARIATION swimmer}
    [/side]

    [side]
        # Gates controller side
        side=5
        team_name=hive
        user_team_name= _ "team_name^Wesmere Hive"
        {CHAOS_FLAG}
        hidden=yes
        color=black
        controller=null

        no_leader=yes
        {NO_ECONOMY}
    [/side]

    [side]
        side=6
        team_name=hive
        user_team_name= _ "team_name^Wesmere Hive"
        color=white
        {CHAOS_FLAG}
        hidden=yes

        no_leader=yes
        {NO_ECONOMY}
    [/side]

    [side]
        side=7
        team_name=hive
        user_team_name= _ "team_name^Wesmere Hive"
        color=yellow
        {CHAOS_FLAG}
        hidden=yes

        recruit=Shaxthal Worm

        no_leader=yes
        {NO_ECONOMY}
    [/side]

    [side]
        side=8
        team_name=player
        user_team_name= _ "team_name^Elynia"
        hidden=yes
        color=red
        controller=null
        share_maps,share_view=no,no

        no_leader=yes
        {NO_ECONOMY}
    [/side]

#undef RTW_SHARED_AI_ASPECTS

    [event]
        name=prerecruit
        first_time_only=no
        [filter]
            type=Shaxthal Worm
        [/filter]

        [object]
            silent=yes
            [filter]
                x,y=$x1,$y1
            [/filter]
            [effect]
                apply_to=variation
                name=b
            [/effect]
        [/object]
    [/event]

#define TQ_LIVING_NONHERO_UNIT
    side=1
    race=orc
    [or]
        race=goblin
    [/or]
    [or]
        race=faerie
    [/or]
    [or]
        race=human
    [/or]
    [or]
        race=elf
    [/or]
    [not]
        id=Elynia
    [/not]
#enddef

    #
    # Glyphs
    #

    {OBJ_HEALING_GLYPH 72 17}
    {OBJ_HEALING_GLYPH 74  1}

    #
    # Enemy spawners
    #

#define RTW_EASY_SPAWNS
    type="Shaxthal Drone"
#enddef

#define RTW_MEDIUM_SPAWNS
    {QUANTITY type
    ("Shaxthal Drone")
    ("Shaxthal Drone,Shaxthal Drone,Shaxthal Sentry Drone,Shaxthal Drone,Shaxthal Drone,Shaxthal Drone,Shaxthal Assault Drone")
    ("Shaxthal Drone,Shaxthal Drone,Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Sentry Drone")
    }
#enddef

#define RTW_HARD_SPAWNS
    {QUANTITY type
    ("Shaxthal Drone,Shaxthal Drone,Shaxthal Sentry Drone,Shaxthal Drone,Shaxthal Drone")
    ("Shaxthal Drone,Shaxthal Drone,Shaxthal Sentry Drone,Shaxthal Drone,Shaxthal Drone,Shaxthal Drone,Shaxthal Assault Drone")
    ("Shaxthal Drone,Shaxthal Drone,Shaxthal Sentry Drone,Shaxthal Assault Drone,Shaxthal Sentry Drone,Shaxthal Sentry Drone")
    }
#enddef

    # D

    {TIMED_DRONE_SPAWNER 20 ({RTW_HARD_SPAWNS})   2 43 20}
    {TIMED_DRONE_SPAWNER  7 ({RTW_EASY_SPAWNS})   2 47 22}
    {TIMED_DRONE_SPAWNER  9 ({RTW_EASY_SPAWNS})   2 46 20}

    {TIMED_DRONE_SPAWNER 20 ({RTW_HARD_SPAWNS})   2 57 20}
    {TIMED_DRONE_SPAWNER  8 ({RTW_MEDIUM_SPAWNS}) 2 62 26}
    {TIMED_DRONE_SPAWNER  4 ({RTW_EASY_SPAWNS})   2 60 24}
    {TIMED_DRONE_SPAWNER  4 ({RTW_EASY_SPAWNS})   2 63 22}

    {TIMED_DRONE_SPAWNER  8 ({RTW_EASY_SPAWNS})   2 70 17}
    {TIMED_DRONE_SPAWNER 20 ({RTW_MEDIUM_SPAWNS}) 2 73 17}
    {TIMED_DRONE_SPAWNER  5 ({RTW_EASY_SPAWNS})   2 74 14}
    {TIMED_DRONE_SPAWNER  6 ({RTW_EASY_SPAWNS})   2 66 13}

    {TIMED_DRONE_SPAWNER 20 ({RTW_HARD_SPAWNS})   2 68  9}
    {TIMED_DRONE_SPAWNER  4 ({RTW_EASY_SPAWNS})   2 69  9}

    # E

    {ONETIME_DRONE_SPAWNER  ({RTW_HARD_SPAWNS})   6 74  3}
    {ONETIME_DRONE_SPAWNER  ({RTW_MEDIUM_SPAWNS}) 6 75  8}

#undef RTW_EASY_SPAWNS
#undef RTW_MEDIUM_SPAWNS
#undef RTW_HARD_SPAWNS

#define TQ_ENABLE_CAVE_WATER_SOUND_SOURCES
    {CAVE_WATER_SOUND_SOURCE 72 19}

    {CAVE_WATER_SOUND_SOURCE 74  4}

    {CAVE_WATER_SOUND_SOURCE 59  3}

    {CAVE_WATER_SOUND_SOURCE 40  5}
#enddef

    #
    # FIXME: Yes, the names are hardcoded because sound sources haven't
    #        received enough love from the developers and there isn't a lot
    #        that can be done with them in Lua/WML.
    #
#define TQ_DISABLE_CAVE_WATER_SOUND_SOURCES
    {REMOVE_SOUND_SOURCE __ss_cave_water_72_19}

    {REMOVE_SOUND_SOURCE __ss_cave_water_74_4}

    {REMOVE_SOUND_SOURCE __ss_cave_water_59_3}

    {REMOVE_SOUND_SOURCE __ss_cave_water_40_5}
#enddef

    {TQ_ENABLE_CAVE_WATER_SOUND_SOURCES}

    #
    # This sound source is not part of the macros because it is handled
    # specially.
    #

    {HIVE_NOISE_2_SOUND_SOURCE}
    [+sound_source]
        id=cave_sound_source
    [/sound_source]

    [event]
        name=prestart

        {VARIABLE energy_supply_hidden no}

        # wmllint: recognize Mal Keshar

        [if]
            {VARIABLE_BOOLEAN_EQUALS rtw_gameplay_path yes}

            #
            # Came here from Return to Wesmere pt. 2
            #
            [then]
                [kill]
                    id=Elynia
                [/kill]

                {FOREACH rtw_end_gamestate.player_onmap_units k}
                    [unstore_unit]
                        variable="rtw_end_gamestate.player_onmap_units[$k]"
                        find_vacant=no
                    [/unstore_unit]
                {NEXT k}

                {FOREACH rtw_end_gamestate.ai_onmap_units k}
                    [unstore_unit]
                        variable="rtw_end_gamestate.ai_onmap_units[$k]"
                        find_vacant=no
                    [/unstore_unit]
                {NEXT k}

                [modify_turns]
                    current=$rtw_end_gamestate.turn_number
                [/modify_turns]

                [modify_side]
                    side=1
                    gold=$rtw_end_gamestate.player_stats.gold
                [/modify_side]

                [set_shroud]
                    side=1
                    shroud_data=$rtw_end_gamestate.shroudmap
                [/set_shroud]
            [/then]

            #
            # Came here via :cl debug command
            #
            [else]
                [store_starting_location]
                    side=2
                [/store_starting_location]

                [teleport]
                    [filter]
                        id=Elynia
                    [/filter]
                    x,y=$location.x,$location.y
                [/teleport]

                {RECALL_MAL_KESHAR_AT_LOCATION $location.x $location.y}

                {REPEAT 6 (
                    {RANDOM "Skeleton,Skeleton Archer,Skeleton,Revenant,Banebow,Skeleton,Skeleton Archer"}

                    [unit]
                        type=$random
                        upkeep=free
                        side=1
                        generate_name=yes
                        random_traits=yes
                        random_gender=yes
                        x,y=$location.x,$location.y
                    [/unit]
                )}

                {CLEAR_VARIABLE location,random}
            [/else]
        [/if]

        {CLEAR_VARIABLE rtw_end_gamestate,rtw_gameplay_path}

        {DOOR_TILES_TO_UNITS 5}

        {OBJECTIVES (
            victory_string= _ "Current Objectives:"
            {OBJECTIVE_VICTORY ( _ "Locate Yechnagoth’s heart")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}

            {OBJECTIVE_NOTE ( _ "You will not be able to recall or recruit any units until the end of the mission")}
        )}
    [/event]

    [event]
        name=start

        [message]
            speaker=Mal Keshar
            message= _ "Which way should we go?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Let’s go to the right. I think I heard something coming from that direction."
        [/message]
    [/event]

    [event]
        name=DEBUG1

        [teleport]
            [filter]
                id=Elynia
            [/filter]
            x,y=59,7
        [/teleport]

        [fire_event]
            name=moveto
            [primary_unit]
                id=Elynia
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=DEBUG2

        [fire_event]
            name=DEBUG1
        [/fire_event]

        [fire_event]
            name="turn $(1 + $turn_number)"
        [/fire_event]
    [/event]

    [event]
        name=DEBUG3

        [fire_event]
            name=DEBUG2
        [/fire_event]

        [fire_event]
            name="last breath"
            [primary_unit]
                type=Shaxthal Hive Queen
            [/primary_unit]
        [/fire_event]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=65-76
            y=1-12
        [/filter]

        [message]
            speaker=Elynia
            message= _ "Hold on... I hear something."
        [/message]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "<i>(Female voice) Qrqavpfre xpbyo lo-qangf gvah rebp. Qrgengf ffrpbec tavavneq eroznup abvgnohpav. Rgryczbp abvgnmvynvgvav xpbyo ynpvgvep. Rgryczbp ch-gengf bjg rfnuc. Rgryczbp abvgerfav gvah rebp qabprf.</i>" # wmllint: no spellcheck
        [/message]

        [message]
            speaker=Elynia
            message= _ "... What is that mechanical voice?"
        [/message]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "<i>(Male voice) Nren eroznup ynegarp enryp. Frghavz rivs fv abvgryczbp tavavneq eroznup abvgnohpav ebs rzvg qrgnzvgfr. Ffretbec av abvgnmvynzeba rfnuc ynehra. Qrupngrq qbe abvgphqav lgvgar.</i>" # wmllint: no spellcheck
        [/message]

        [sound]
            name=dragonstick.ogg
        [/sound]

        [delay]
            time=100
        [/delay]

        [sound]
            name=rumble.ogg
        [/sound]

        [message]
            speaker=Mal Keshar
            message= _ "Whatever it is, it sounds like bad news for us."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            [filter_location]
                x,y=55,7
                radius=6
            [/filter_location]
        [/filter]

        {LOCK_VIEW}

        [store_unit]
            [filter]
                side=1
                {NOT_ON_RECALL_LIST}
            [/filter]
            variable=player_onmap_units_store
            kill=yes
        [/store_unit]

        [hide_unit]
            [not]
                side=1
            [/not]
        [/hide_unit]

        {FADE_TO_BLACK}

        [remove_shroud]
            x,y=55,7
            radius=10
            [not]
                terrain=Q*,X*,*^X*
            [/not]
            side=1
        [/remove_shroud]

        [remove_shroud]
            x,y=55,7
            radius=1
            side=1
        [/remove_shroud]

        [scroll_to]
            x,y=55,7
            {WARP}
        [/scroll_to]

        [fade_out_sound_effects]
            duration=500
        [/fade_out_sound_effects]

        #
        # Add new sound source while sound is silenced to make
        # the effect seem seamless.
        #

        {HIVE_NOISE_1_SOUND_SOURCE}
        [+sound_source]
            id=hive_sound_source
        [/sound_source]

        #
        # Continue with music disabled until the boss appears.
        #

        [fade_out_music]
            duration=500
        [/fade_out_music]

        [fade_in_sound_effects]
            duration=500
        [/fade_in_sound_effects]

        {FADE_IN}

        {FOREACH player_onmap_units_store k}
            [set_variables]
                mode=merge
                name="player_onmap_units_store[$k]"
                [value]
                    x,y=60,6
                    hitpoints=$player_onmap_units_store[$k].max_hitpoints
                    moves=$player_onmap_units_store[$k].max_moves
                    attacks_left=$player_onmap_units_store[$k].max_attacks
                    [status]
                        poisoned=no
                        slowed=no
                    [/status]
                [/value]
            [/set_variables]

            [unstore_unit]
                variable="player_onmap_units_store[$k]"
                find_vacant=yes
            [/unstore_unit]
        {NEXT k}

        {CLEAR_VARIABLE player_onmap_units_store}

        [unhide_unit]
            [not]
                side=1
            [/not]
        [/unhide_unit]

        [redraw][/redraw]

        [message]
            speaker=Mal Keshar
            message= _ "It’s a very large, suspiciously vacant chamber. He he, what do you think, Elynia?"
        [/message]

        {QUAKE (cave-in.ogg)}

        [scroll_to]
            x,y=71,2
        [/scroll_to]

        #
        # Remove all items everywhere, especially glyphs.
        # Their haloes glitch through shroud.
        #
        [remove_item][/remove_item]

        [redraw][/redraw]

        [kill]
            x=71,67,68
            y= 2, 5, 6
            [not]
                side=1
            [/not]
            animate,fire_event=no,no
        [/kill]

        [terrain]
            terrain=Xos
            x=71,67,68
            y= 2, 5, 6
        [/terrain]

        [place_shroud]
            side=1
            x=72-77,68-71,66-67,64-65
            y=0-40 , 5-40, 9-40,15-40
        [/place_shroud]

        [redraw]
            side=1
        [/redraw]

        {QUAKE (thunderstick.ogg)}

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Mal Keshar
            message= _ "... And, now we’re trapped. How predictable."
        [/message]

        [message]
            speaker=Elynia
            message= _ "I know. Let us be on guard for whatever those voices were talking about."
        [/message]

        {UNLOCK_VIEW}

        [event]
            delayed_variable_substitution=no
            name="turn $($turn_number + 1)"
            [fire_event]
                name=activate boss
            [/fire_event]
        [/event]

        [event]
            delayed_variable_substitution=no
            name="turn $($turn_number + 2)"
            [fire_event]
                name=reveal energy supply
            [/fire_event]
        [/event]
    [/event]

    [event]
        name=activate boss

        {LOCK_VIEW}

        [set_variables]
            name=location
            mode=replace
            [literal]
                x,y=55,7
            [/literal]
        [/set_variables]

        [scroll_to]
            x,y=$location.x,$location.y
            {WARP}
        [/scroll_to]

        [fade_out_music]
            duration=500
        [/fade_out_music]

        [terrain]
            x,y=$location.x,$location.y
            radius=1
            terrain=Yhl^Kov
        [/terrain]

        [modify_side]
            side=7
            gold=0
            {INCOME 6 8 10}
        [/modify_side]

        [modify_side]
            side=1
            fog=no
        [/modify_side]

        [place_shroud]
            side=1
            x=0-40,41-76
            y=0-40,18-40
        [/place_shroud]

        #
        # Refresh shroud.
        #

        [redraw]
            side=1
        [/redraw]

        [item]
            x,y=$location.x,$location.y
            image=misc/blank-hex.png
            halo=halo/lighthouse-aura.png
        [/item]

        [delay]
            time=500
        [/delay]

        #
        # Make a first living unit under the player's control face towards the
        # Queen's spawn location.
        #

        [store_unit]
            [filter]
                {TQ_LIVING_NONHERO_UNIT}
                {NOT_ON_RECALL_LIST}
            [/filter]
            kill=no
            variable=living_nonhero_units
        [/store_unit]

        [if]
            {VARIABLE_NUMERICAL_GREATER_THAN living_nonhero_units.length 0}
            [then]
                {VARIABLE_RANDOM n "0..$($living_nonhero_units.length - 1)"}

                [store_direction]
                    from_x,from_y=$living_nonhero_units[$n].x,$living_nonhero_units[$n].y
                    to_x,to_y=$location.x,$location.y
                    variable="living_nonhero_units[$n].facing"
                [/store_direction]

                [unstore_unit]
                    find_vacant=no
                    variable="living_nonhero_units[$n]"
                [/unstore_unit]

                [redraw][/redraw]

                #
                # Yes, the unit will not be shown changing facing unless the
                # screen is wide enough.
                #

                [message]
                    scroll=no
                    x,y=$living_nonhero_units[$n].x,$living_nonhero_units[$n].y
                    message= _ "What is that?"
                [/message]

                {CLEAR_VARIABLE n}
            [/then]
        [/if]

        {CLEAR_VARIABLE living_nonhero_units}

        #
        # Make all other side 1 units face towards the spawn location.
        #

        [store_unit]
            [filter]
                side=1
                {NOT_ON_RECALL_LIST}
            [/filter]
            variable=player_units
        [/store_unit]

        {FOREACH player_units k}
            [store_direction]
                from_x,from_y=$player_units[$k].x,$player_units[$k].y
                to_x,to_y=$location.x,$location.y
                variable="player_units[$k].facing"
            [/store_direction]

            [unstore_unit]
                find_vacant=no
                variable="player_units[$k]"
            [/unstore_unit]
        {NEXT k}

        {CLEAR_VARIABLE player_units}

        [redraw][/redraw]

        [delay]
            time=250
        [/delay]

        #
        # Enter the Queen.
        #

        [hide_unit][/hide_unit]

        {WHITE_SCREEN}

        [redraw][/redraw]

        [sound]
            name=ambient/shaxthal-roam-1.ogg
        [/sound]

        [sound]
            name=melee-fire.ogg
        [/sound]

        [delay]
            time=500
        [/delay]

        [store_direction]
            from_x,from_y=$location.x,$location.y
            [to]
                [filter]
                    id=Elynia
                [/filter]
            [/to]
        [/store_direction]

        #
        # Spawn the Queen's assistants.
        #

        [hidden_unit]
            side=7
            x,y=56,6
            type=Shaxthal Drone
            upkeep=free
            random_traits=yes
            facing=$direction
        [/hidden_unit]

        [hidden_unit]
            side=7
            x,y=54,7
            type=Shaxthal Drone
            upkeep=free
            random_traits=yes
            facing=$direction
        [/hidden_unit]

        [hidden_unit]
            side=7
            x,y=56,7
            type=Shaxthal Drone
            upkeep=free
            random_traits=yes
            facing=$direction
        [/hidden_unit]

        [hidden_unit]
            side=7
            x,y=54,6
            type=Shaxthal Drone
            upkeep=free
            random_traits=yes
            facing=$direction
        [/hidden_unit]

        #
        # The Queen.
        #

        [hidden_unit]
            # wmllint: recognize Shaxthal Hive Queen
            id=Shaxthal Hive Queen
            generate_name=no
            type=Shaxthal Hive Queen
            canrecruit=yes
            {IS_BOSS}
            side=7
            x,y=$location.x,$location.y
            facing=$direction
            [modifications]
                {TRAIT_BIOMECHANICAL}
                {TRAIT_RESILIENT}
            [/modifications]
        [/hidden_unit]

        {CLEAR_VARIABLE direction}

        [remove_item]
            x,y=$location.x,$location.y
        [/remove_item]

        #
        # Restore screen.
        #

        {RESET_SCREEN}

        [unhide_unit][/unhide_unit]

        {BOSS_AMBIENTANCE}

        [message]
            speaker=Elynia
            message= _ "—Uria be damned!"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Hey, that conspicuous glowing orb embedded in its torso seems important!"
        [/message]

        [scroll_to]
            x,y=$location.x,$location.y
        [/scroll_to]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Elynia
            message= _ "Yes. It must be the very thing we have been searching for. Our timing couldn’t be any worse... Destroy it! Destroy it at all costs!"
        [/message]

        {CLEAR_VARIABLE location}

        {VARIABLE energy_supply_hidden yes}

        {UNLOCK_VIEW}

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Destroy the Queen")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}

            {OBJECTIVE_NOTE ( _ "You will not be able to recall or recruit any units until the end of the mission")}
        )}
    [/event]

    [event]
        name=reveal energy supply

        {VARIABLE energy_supply_hidden no}

        [store_locations]
            x=56,58,56,59
            y= 2, 3, 4, 5
            variable=supply_locs
        [/store_locations]

        {QUAKE "cave-in.ogg"}

        {FOREACH supply_locs k}
            [terrain]
                x,y=$supply_locs[$k].x,$supply_locs[$k].y
                terrain=Yhl
            [/terrain]

            [unit]
                side=7
                canrecruit=no
                upkeep=free
                {IS_BOSS}
                type=Verlissh Matrix Core
                x,y=$supply_locs[$k].x,$supply_locs[$k].y
            [/unit]
        {NEXT k}

        {CLEAR_VARIABLE supply_locs}

        [redraw][/redraw]

        [scroll_to]
            x,y=58,3
        [/scroll_to]

        [delay]
            time=1000
        [/delay]

        [message]
            scroll=no
            speaker=Elynia
            message= _ "We have found those things before, in the old capital! They must have something to do with the hive, and possibly this creature as well — perhaps some kind of power source? Try destroying them!"
        [/message]
    [/event]

#define TQ_ENERGY_SUPPLY_INTACT_CONDITION
    [have_unit]
        type=Verlissh Matrix Core
        side=7
    [/have_unit]
    [or]
        {VARIABLE_BOOLEAN_EQUALS energy_supply_hidden yes}
    [/or]
#enddef

    [event]
        name=attacker hits
        first_time_only=no
        [filter]
            side=1
        [/filter]
        [filter_second]
            id=Shaxthal Hive Queen
        [/filter_second]
        [filter_condition]
            {TQ_ENERGY_SUPPLY_INTACT_CONDITION}
        [/filter_condition]

        {BOSS_ABSORB_FULL_DAMAGE (id=Shaxthal Hive Queen)}
    [/event]

    [event]
        name=defender hits
        first_time_only=no
        [filter_second]
            side=1
        [/filter_second]
        [filter]
            id=Shaxthal Hive Queen
        [/filter]
        [filter_condition]
            {TQ_ENERGY_SUPPLY_INTACT_CONDITION}
        [/filter_condition]

        {BOSS_ABSORB_FULL_DAMAGE (id=Shaxthal Hive Queen)}
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            type=Verlissh Matrix Core
            side=7
        [/filter]

        [harm_unit]
            [filter]
                id=Shaxthal Hive Queen
            [/filter]
            amount=16
            kill=no
            fire_event=no
            animate=yes
        [/harm_unit]
    [/event]

    [event]
        name=die
        [filter]
            type=Verlissh Matrix Core
            side=7
        [/filter]

        [message]
            speaker=Elynia
            message= _ "This appears to be causing some damage to the beast!"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Very well — let’s do some more!"
        [/message]

        {OBJECTIVES (
            {OBJECTIVE_VICTORY ( _ "Destroy the energy supply units in the Queen’s chamber")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}

            {OBJECTIVE_NOTE ( _ "You will not be able to recall or recruit any units until the end of the mission")}
        )}
    [/event]

    [event]
        name=die
        first_time_only=no
        [filter]
            type=Verlissh Matrix Core
            side=7
        [/filter]

        [kill]
            x,y=$x1,$y1
            fire_event,animate=no,no
        [/kill]

        [if]
            [not]
                [have_unit]
                    type=Verlissh Matrix Core
                    side=7
                [/have_unit]
            [/not]
            [then]
                [object]
                    silent=yes
                    [filter]
                        id=Shaxthal Hive Queen
                    [/filter]
                    [effect]
                        apply_to=remove_ability
                        [abilities]
                            {ABILITY_ABSORB_DAMAGE}
                        [/abilities]
                    [/effect]
                [/object]

                [delay]
                    time=1000
                [/delay]

                [message]
                    speaker=Elynia
                    message= _ "It’s working! Strike it down now!"
                [/message]

                {OBJECTIVES (
                    {OBJECTIVE_VICTORY ( _ "Destroy the Queen")}

                    {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
                    {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}

                    {OBJECTIVE_NOTE ( _ "You will not be able to recall or recruit any units until the end of the mission")}
                )}
            [/then]
        [/if]
    [/event]

    #
    # Verlissh Crawlers respawn logic
    #

    [event]
        name=side 7 turn refresh
        first_time_only=no
        [filter_condition]
            [have_unit]
                type=Verlissh Matrix Core
                side=7
            [/have_unit]
        [/filter_condition]

        [store_unit]
            [filter]
                type=Psy Crawler
                side=7
            [/filter]
            variable=crawlers_store
            kill=no
        [/store_unit]

        [if]
            {VARIABLE_NUMERICAL_LESS_THAN crawlers_store.length {DIFF 2 3 4} }
            [then]
                [store_locations]
                    [filter]
                        type=Verlissh Matrix Core
                        side=7
                    [/filter]
                    variable=respawn_locs
                [/store_locations]

                {VARIABLE_RANDOM respawn_count {DIFF 1..2 1..3 2..4} }

                {REPEAT $respawn_count (
                    {VARIABLE_RANDOM respawn_loc_index "0..$($respawn_locs.length - 1)"}

                    {GENERIC_UNIT (7) (Psy Crawler) $respawn_locs[$respawn_loc_index].x $respawn_locs[$respawn_loc_index].y}
                    {NO_UPKEEP_NO_OVERLAY}
                    [+unit]
                        animate=yes
                    [/unit]

                    {CLEAR_VARIABLE respawn_loc_index}
                )}

                {CLEAR_VARIABLE respawn_locs,respawn_count}
            [/then]
        [/if]

        {CLEAR_VARIABLE crawlers_store}
    [/event]

    #
    # Mal Keshar deterioration logic
    #

    [event]
        name=new turn
        first_time_only=no
        [filter_condition]
            [have_unit]
                id=Shaxthal Hive Queen
            [/have_unit]
        [/filter_condition]

        {RANDOM 1,2}

        [harm_unit]
            [filter]
                id=Mal Keshar
            [/filter]
            amount=$random
            unhealable=yes
            kill=no
            animate=yes
        [/harm_unit]

        {CLEAR_VARIABLE random}
    [/event]

    [event]
        name=new turn
        [filter_condition]
            [have_unit]
                id=Shaxthal Hive Queen
            [/have_unit]
        [/filter_condition]

        [message]
            speaker=Mal Keshar
            sound={SOUND_LIST:LICH_HIT}
            message= _ "*Uurgh*" # wmllint: ignore no spellcheck
        [/message]

        [message]
            speaker=Elynia
            message= _ "—Malin? Are you all right?"
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Mal Keshar
            message= _ "This... this place is not doing me any good... There is a greater force at work in here, pulling our souls into it..."
        [/message]

        [message]
            speaker=Elynia
            message= _ "I should be able to heal you, just—"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "I don’t think that will help for long. I’m going to lend you a hand while I can..."
        [/message]

        {VARIABLE_RANDOM random_spawn_count {DIFF 4..6 3..5 2..5} }

        [store_locations]
            x,y=55,7
            radius=4
            [not]
                terrain=Q*,X*,*^X*
            [/not]
            [not]
                [filter]
                [/filter]
            [/not]
            variable=spawn_locs
        [/store_locations]

        [if]
            {VARIABLE_NUMERICAL_EQUALS spawn_locs.length 0}
            [then]
                [set_variables]
                    mode=replace
                    name=spawn_locs
                    [literal]
                        x,y=55,7
                    [/literal]
                [/set_variables]
            [/then]
        [/if]

        {REPEAT $random_spawn_count (
            {VARIABLE_RANDOM random_type (Skeleton,Skeleton,Skeleton,Skeleton,Skeleton Archer,Revenant,Deathblade,Banebow,Soulless,Walking Corpse,Walking Corpse)}
            {VARIABLE_RANDOM random_loc "0..$($spawn_locs.length - 1)"}

            #
            # This animation only works after scenario 9.2
            #
            [animate_unit]
                [filter]
                    id=Mal Keshar
                [/filter]
                flag=void_recruiting
            [/animate_unit]

            {GENERIC_UNIT 1 $random_type $spawn_locs[$random_loc].x $spawn_locs[$random_loc].y} {NO_UPKEEP_NO_OVERLAY}
            [+unit]
                animate=yes
            [/unit]
        )}

        {CLEAR_VARIABLE random_spawn_count,random_type,random_loc,spawn_locs}
    [/event]

    [event]
        name=last breath
        [filter]
            id=Shaxthal Hive Queen
        [/filter]

        {LOCK_VIEW}

        [message]
            speaker=narrator
            message= _ "The unsightly behemoth let out a terrifying loud screech with its dying breath. As the creature collapsed, the alien core in its chest shattered, and burst, releasing a great amount of energy that enveloped all in ghostly red tendrils..."
            image=wesnoth-icon.png
        [/message]

        {FLASH_RED (
            [kill]
                fire_event=no
                x,y=$x1,$y1
                animate=yes
            [/kill]
        )}

        [kill]
            fire_event=no
            type=Psy Crawler
            [or]
                type=Shaxthal Drone
            [/or]
            animate=yes
        [/kill]

        [fire_event]
            name=begin final cutscene
        [/fire_event]

        {UNLOCK_VIEW}
    [/event]

#define TQ_PETRIFY_STORED_UNIT _UNIT_STORE_NAME
    [set_variables]
        mode=merge
        name={_UNIT_STORE_NAME}
        [value]
            side=8
            experience=0
            hitpoints=1
            max_hitpoints=1
            moves=1
            max_moves=1
            ellipse=none # wmllint: no ellipsecheck
            [status]
                petrified=yes
                unhealable=yes
                slowed=no
                poisoned=no
                uncovered=yes
            [/status]
        [/value]
    [/set_variables]
#enddef

#define TQ_PETRIFY_ONE_RANDOM_UNDEAD
    [if]
        [have_unit]
            side=1
            race=undead
            [not]
                id=Mal Keshar
            [/not]
            {NOT_ON_RECALL_LIST}
        [/have_unit]
        [then]
            [store_unit]
                [filter]
                    side=1
                    race=undead
                    [not]
                        id=Mal Keshar
                    [/not]
                [/filter]
                variable=undead_fossil_store
            [/store_unit]

            {VARIABLE_RANDOM fossil_index "0..$($undead_fossil_store.length - 1)"}

            {TQ_PETRIFY_STORED_UNIT undead_fossil_store[$fossil_index]}

            [sound]
                name=petrified.ogg
            [/sound]

            [unstore_unit]
                find_vacant=no
                variable="undead_fossil_store[$fossil_index]"
            [/unstore_unit]

            [scroll_to]
                x,y=$undead_fossil_store[$fossil_index].x,$undead_fossil_store[$fossil_index].y
            [/scroll_to]

            {CLEAR_VARIABLE undead_fossil_store,fossil_index} #,petrified_label}
        [/then]
    [/if]
#enddef

#define TQ_PETRIFY_ALL_REMAINING_UNDEAD
    [store_unit]
        [filter]
            side=1
            race=undead
            {NOT_ON_RECALL_LIST}
        [/filter]
        variable=undead_fossil_store
    [/store_unit]

    {FOREACH undead_fossil_store k}
        {TQ_PETRIFY_STORED_UNIT undead_fossil_store[$k]}

        [sound]
            name=petrified.ogg
        [/sound]

        [unstore_unit]
            find_vacant=no
            variable="undead_fossil_store[$k]"
        [/unstore_unit]

        [scroll_to]
            x,y=$undead_fossil_store[$k].x,$undead_fossil_store[$k].y
        [/scroll_to]
    {NEXT k}

    {CLEAR_VARIABLE undead_fossil_store}
#enddef

    [event]
        name=begin final cutscene

        {LOCK_VIEW}

        {TQ_DISABLE_CAVE_WATER_SOUND_SOURCES}

        {REPLACE_SCENARIO_MUSIC "silence.ogg"}

        {QUAKE "rumble.ogg,cave-in.ogg"}

        [if]
            [have_unit]
                {TQ_LIVING_NONHERO_UNIT}
            [/have_unit]
            [then]
                [message]
                    {TQ_LIVING_NONHERO_UNIT}
                    message= _ "The energy is filling the place!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Elynia
                    message= _ "The energy is filling the place!"
                [/message]
            [/else]
        [/if]

        {QUAKE "rumble.ogg,cave-in.ogg"}

        [message]
            speaker=narrator
            message= _ "... an energy of a kind unknown to either Elynia or the lich."
            image=wesnoth-icon.png
        [/message]

        {FLASH_RED (
            {QUAKE "rumble.ogg,cave-in.ogg"}
        )}

        [harm_unit]
            [filter]
                race=undead
            [/filter]
            amount=8
            unhealable=yes
            kill=no
            animate=yes
        [/harm_unit]

        [fade_out_sound_effects]
            duration=500
        [/fade_out_sound_effects]

        #
        # Disable background sound sources permanently, just for artsy effect.
        # The water sound sources are disabled only temporarily.
        #

        {REMOVE_SOUND_SOURCE cave_sound_source,hive_sound_source}

        {TQ_DISABLE_CAVE_WATER_SOUND_SOURCES}

        #
        # Give UI a chance to run to update sound sources and stuff.
        #

        [delay]
            time=1000
        [/delay]

        # wmllint: local spellings plural_you singular_you

        [if]
            [have_unit]
                {TQ_LIVING_NONHERO_UNIT}
            [/have_unit]
            [then]
                [message]
                    speaker=Mal Keshar
                    # po: Condenser/capacitor.
                    message= _ "plural_you^... It’s clear now that those power condensers were essential for running something else here. All of you, make haste and return to the surface before the hive collapses."
                [/message]

                [message]
                    speaker=Elynia
                    message= _ "<i>We</i>? What about <i>you</i>?!"
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Mal Keshar
                    # po: Condenser/capacitor.
                    message= _ "singular_you^... It’s clear now that those power condensers were essential for running something else here. You must make haste and return to the surface before the hive collapses."
                [/message]

                [message]
                    speaker=Elynia
                    message= _ "<i>I</i>? What about <i>you</i>?!"
                [/message]
            [/else]
        [/if]

        #
        # Reset SFX volume.
        #

        [reset_sound_effects][/reset_sound_effects]

        {QUAKE "rumble.ogg,cave-in.ogg"}

        [message]
            speaker=Mal Keshar
            message= _ "Surely you realize that I am well past my time to roam this earth — I am as old as a fossil, and our little fight with Elyssa and Argan in the frontier between Inferno and Irdya has truly had a long-lasting effect on my powers... The power that’s consuming this place now is tearing into my very soul... It hurts."
        [/message]

        [message]
            speaker=Elynia
            message= _ "But—"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "You and I... we have many followers from diverse backgrounds. I am sure that, should you need a new necromancer to help you, many will be willing to take up my position. Just make sure to not get yourself killed and don’t forget that you are here fighting for a greater cause, one that transcends the fate of Irdya."
        [/message]

        {TQ_PETRIFY_ONE_RANDOM_UNDEAD}

        [message]
            speaker=Elynia
            message= _ "(<i>in tears</i>) Argan’s journal... Where is it?"
        [/message]

        {TQ_PETRIFY_ONE_RANDOM_UNDEAD}
        {TQ_PETRIFY_ONE_RANDOM_UNDEAD}

        [message]
            speaker=Mal Keshar
            message= _ "Kyara—"
        [/message]

        {TQ_PETRIFY_ALL_REMAINING_UNDEAD}

        {REPLACE_SCENARIO_MUSIC "the_king_is_dead.ogg"}
        {APPEND_MUSIC           "transience.ogg"}

        {INCIDENTAL_MUSIC       "sad.ogg"}

        [message]
            speaker=Elynia
            message= _ "Malin..."
        [/message]

        [redraw][/redraw]

        [delay]
            time=2000
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "<i>(Tears.)</i>"
        [/message]

        [delay]
            time=2000
        [/delay]

        [message]
            speaker=Elynia
            message= _ "How could I let this happen? NO!"
        [/message]

        {QUAKE "rumble.ogg,cave-in.ogg"}

        [if]
            [have_unit]
                {TQ_LIVING_NONHERO_UNIT}
            [/have_unit]
            [then]
                [message]
                    {TQ_LIVING_NONHERO_UNIT}
                    message= _ "My lady, we cannot spend any more time here!"
                [/message]

                [sound]
                    name={SOUND_LIST:COLLAPSING_FACILITY}
                [/sound]

                [delay]
                    time=1000
                [/delay]

                [message]
                    speaker=Elynia
                    message= _ "..."
                [/message]

                [delay]
                    time=1000
                [/delay]

                [message]
                    {TQ_LIVING_NONHERO_UNIT}
                    message= _ "Lady!"
                [/message]
            [/then]
        [/if]

        [delay]
            time=1000
        [/delay]

        [sound]
            name={SOUND_LIST:COLLAPSING_FACILITY}
        [/sound]

        [message]
            speaker=narrator
            image= # wmllint: ignore
            message= _ "<i>... Don’t forget that you are here fighting for a greater cause, one that transcends the fate of Irdya.</i>"
        [/message]

        [delay]
            time=1000
        [/delay]

        [if]
            [have_unit]
                {TQ_LIVING_NONHERO_UNIT}
            [/have_unit]
            [then]
                [message]
                    speaker=Elynia
                    message= _ "We must get out of here."
                [/message]
            [/then]
            [else]
                [message]
                    speaker=Elynia
                    message= _ "I must get out of here."
                [/message]
            [/else]
        [/if]

        [store_locations]
            [filter]
                id=Elynia
            [/filter]
            variable=elynia_loc
        [/store_locations]

        [if]
            {VARIABLE_NUMERICAL_GREATER_THAN elynia_loc.x 50}
            [then]
                {MOVE_UNIT (id=Elynia) 50 6}
            [/then]
        [/if]

        [time_area]
            id=surface
            remove=yes
        [/time_area]

        [terrain_mask]
            x,y=1,1
            border=yes
            {MASK 12_The_Queen_1.mask}
        [/terrain_mask]

        [kill]
            x=1-34,35-76
            y=1-39,17-39
            animate=no
            fire_event=no
        [/kill]

        [remove_shroud]
            side=1
            x=37-52,41-58
            y=  0-9,10-14
            #[not]
            #    terrain=Q*,X*,*^X*
            #[/not]
        [/remove_shroud]

        [redraw][/redraw]

        {HIGHLIGHT_IMAGE 39 6 "items/gohere.png" ()}

        [remove_item]
            x,y=39,6
        [/remove_item]

        [message]
            speaker=Elynia
            message= _ "That way..."
        [/message]

        {OBJECTIVES (
            victory_string= _ "Current Objectives:"
            {OBJECTIVE_VICTORY ( _ "Find an alternate exit to the surface")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}

            {OBJECTIVE_NOTE ( _ "You will not be able to recall or recruit any units until the end of the mission")}
        )}

        #
        # Re-enable regular sound sources (not background ambience).
        #

        {TQ_ENABLE_CAVE_WATER_SOUND_SOURCES}

        {VARIABLE end_of_scenario_turn_number "$($turn_number + 3)"}

        {CLEAR_VARIABLE elynia_loc}

        {UNLOCK_VIEW}

        #
        # Make sure Elynia can't be hit, we don't want her dying at this point.
        #

        {FORCE_CHANCE_TO_HIT () (id=Elynia) 0 ()}

        #
        # Elynia deterioration logic
        #

        [event]
            name=new turn
            first_time_only=no
            [filter_condition]
                {VARIABLE_NUMERICAL_LESS_THAN turn_number $end_of_scenario_turn_number}
            [/filter_condition]

            {RANDOM 8..18}

            [harm_unit]
                [filter]
                    id=Elynia
                [/filter]
                amount=$random
                kill=no
                animate=yes
            [/harm_unit]

            {CLEAR_VARIABLE random}
        [/event]

        #
        # Critters deterioration logic
        #

        [event]
            name=new turn
            first_time_only=no

            {RANDOM 8..16}

            # Visible units are animated and may get less damage,
            # but they may also die.

            [harm_unit]
                [filter]
                    [filter_vision]
                        visible=yes
                        side=1
                    [/filter_vision]
                    [not]
                        side=1
                    [/not]
                    [not]
                        side=8
                    [/not]
                [/filter]
                amount=$random
                kill=yes
                animate=yes
            [/harm_unit]

            {RANDOM 12..60}

            # Units out of the player's reach are not animated but
            # may get more damage. However, they may *not* die.

            [harm_unit]
                [filter]
                    [filter_vision]
                        visible=no
                        side=1
                    [/filter_vision]
                    [not]
                        side=1
                    [/not]
                    [not]
                        side=8
                    [/not]
                [/filter]
                amount=$random
                kill=no
                animate=no
            [/harm_unit]

            {CLEAR_VARIABLE random}
        [/event]

        [event]
            name=moveto
            first_time_only=no

            {RANDOM 0..16}

            [if]
                {VARIABLE_NUMERICAL_GREATER_THAN random 6}
                [then]
                    {QUAKE {SOUND_LIST:COLLAPSING_FACILITY} }
                [/then]
            [/if]

            {CLEAR_VARIABLE random}
        [/event]

        [event]
            delayed_variable_substitution=no
            name="turn $($turn_number + 1)"

            [message]
                speaker=narrator
                image= # wmllint: ignore
                message= _ "<i>... I have always been alone...</i>"
            [/message]

            {QUAKE {SOUND_LIST:COLLAPSING_FACILITY} }

            [kill]
                animate=yes
                fire_event=no
                side=7
                [filter_vision]
                    visible=yes
                    side=1
                [/filter_vision]
            [/kill]

            [kill]
                animate=no
                fire_event=no
                side=7
            [/kill]

            [terrain]
                x=61,58,52,58,62
                y= 7,10, 8, 4, 6
                terrain=Xu
            [/terrain]

            [redraw][/redraw]

            {QUAKE {SOUND_LIST:COLLAPSING_FACILITY} }
        [/event]

        [event]
            delayed_variable_substitution=no
            name="turn $($turn_number + 2)"

            [message]
                speaker=narrator
                image= # wmllint: ignore
                message= _ "<i>... I’ll be alone again...</i>"
            [/message]

            {QUAKE {SOUND_LIST:COLLAPSING_FACILITY} }

            [kill]
                animate=yes
                fire_event=no
                side=1
                {NOT_ON_RECALL_LIST}
                [not]
                    id=Elynia
                [/not]
            [/kill]

            {QUAKE {SOUND_LIST:COLLAPSING_FACILITY} }
        [/event]

        [event]
            delayed_variable_substitution=no
            name="turn $end_of_scenario_turn_number"

            [fire_event]
                name=the end
            [/fire_event]
        [/event]
    [/event]

    [event]
        name=new turn
        first_time_only=no
        [filter_condition]
            [have_unit]
                side=8
                [not]
                    id=Mal Keshar
                [/not]
            [/have_unit]
        [/filter_condition]

        [store_unit]
            [filter]
                side=8
                [not]
                    id=Mal Keshar
                [/not]
            [/filter]
            kill=no
            variable=side8_store
        [/store_unit]

        [kill]
            animate,fire_event=yes,no
            x,y=$side8_store[0].x,$side8_store[0].y
        [/kill]

        {CLEAR_VARIABLE side8_store}
    [/event]

#define TQ_ELYNIA_FADE_STEP _RGB_SHIFT _ALPHA _MAX_HP_CHANGE
    [object]
        silent=yes
        [filter]
            id=Elynia
        [/filter]
        [effect]
            apply_to=image_mod
            replace="CS("+{_RGB_SHIFT}+","+{_RGB_SHIFT}+","+{_RGB_SHIFT}+")~O("+{_ALPHA}+")"
        [/effect]
        [effect]
            apply_to=zoc
            value=no
        [/effect]
        [effect]
            apply_to=hitpoints
            increase_total={_MAX_HP_CHANGE}
        [/effect]
        [effect]
            apply_to=max_experience
            increase={_MAX_HP_CHANGE}
        [/effect]
    [/object]

    [redraw][/redraw]
#enddef

    [event]
        name=the end

        {LOCK_VIEW}

        # These sound sources are only running when this event is thrown out
        # of sequence (debug mode)...

        {REMOVE_SOUND_SOURCE cave_sound_source,hive_sound_source}

        {TQ_DISABLE_CAVE_WATER_SOUND_SOURCES}

        [message]
            speaker=Elynia
            message= _ "The spell... I must use the spell..."
        [/message]

        [delay]
            time=500
        [/delay]

        {QUAKE {SOUND_LIST:COLLAPSING_FACILITY} }

        [delay]
            time=500
        [/delay]

        [message]
            speaker=narrator
            image= # wmllint: ignore
            message= _ "<i>... I lost </i>much<i> more than that long ago...</i>"
        [/message]

        {QUAKE {SOUND_LIST:COLLAPSING_FACILITY} }

        {QUAKE {SOUND_LIST:COLLAPSING_FACILITY} }

        [message]
            speaker=narrator
            image= # wmllint: ignore
            message= _ "<i>... We aren’t that different after all...</i>"
        [/message]

        {QUAKE {SOUND_LIST:COLLAPSING_FACILITY} }

        [delay]
            time=500
        [/delay]

        [message]
            speaker=narrator
            image= # wmllint: ignore
            message= _ "<i>... a greater cause, one that transcends the fate of Irdya...</i>"
        [/message]

        [delay]
            time=500
        [/delay]

        {QUAKE {SOUND_LIST:COLLAPSING_FACILITY} }

        [message]
            speaker=Elynia
            message= _ "I..."
        [/message]

        [harm_unit]
            [filter]
                id=Elynia
            [/filter]
            amount="$($this_unit.hitpoints - 1)"
            kill=no
            animate=yes
        [/harm_unit]

        [fade_out_music]
            duration=500
        [/fade_out_music]

        [message]
            speaker=narrator
            caption= _ "Uria"
            message= _ "<i>Do you truly think you can fight me?</i>"
            image=wesnoth-icon.png
        [/message]

        {FADE_STEP 8 250}

        {TQ_ELYNIA_FADE_STEP -8 0.98 -5%}

        {FADE_STEP 16 250}

        {TQ_ELYNIA_FADE_STEP -16 0.94 -5%}

        {FADE_STEP 24 250}

        {TQ_ELYNIA_FADE_STEP -24 0.90 -10%}

        {QUAKE {SOUND_LIST:COLLAPSING_FACILITY} }

        [message]
            speaker=narrator
            caption= _ "Uria"
            message= _ "<i>You don’t have the power of the Union to help you anymore. Your friends are gone. Our power is unlimited. You cannot win.</i>"
            image=wesnoth-icon.png
        [/message]

        {TQ_ELYNIA_FADE_STEP -32 0.86 -10%}

        {FADE_STEP 32 250}

        {TQ_ELYNIA_FADE_STEP -64 0.82 -20%}

        {FADE_STEP 64 250}

        [sound]
            name={SOUND_LIST:COLLAPSING_FACILITY}
        [/sound]

        {TQ_ELYNIA_FADE_STEP -96 0.76 -20%}

        {FADE_STEP 96 250}

        {TQ_ELYNIA_FADE_STEP -128 0.72 -40%}

        {FADE_STEP 128 250}

        [message]
            speaker=Elynia
            message= _ "... must..."
        [/message]

        {TQ_ELYNIA_FADE_STEP -196 0.65 -60%}

        [sound]
            name=rumble.ogg
        [/sound]

        [remove_item][/remove_item]

        {FADE_STEP 160 250}

        {TQ_ELYNIA_FADE_STEP -196 0.50 -80%}

        [sound]
            name={SOUND_LIST:COLLAPSING_FACILITY}
        [/sound]

        {FADE_STEP 192 250}

        #
        # NOTE: This kills Elynia too. We don't need her anymore past this
        #       point.
        #

        [kill]
            animate=no
            fire_event=no
        [/kill]

        [sound]
            name={SOUND_LIST:COLLAPSING_FACILITY}
        [/sound]

        {FADE_STEP 224 250}

        [replace_schedule]
            {NEUTRAL_TOD} {SCHEDULE_LIGHTING 0 -20 -20}
        [/replace_schedule]

        {FADE_STEP 500 250}

        [terrain]
            # Everywhere.
            terrain=Xv
        [/terrain]

        [redraw][/redraw]

        [modify_side]
            side=1
            fog,shroud=no,no
        [/modify_side]

        [delay]
            time=6000
        [/delay]

        [terrain]
            # Everywhere.
            terrain=Gll^Fp
        [/terrain]

        {FADE_STEP 224 250}
        {FADE_STEP 208 250}
        {FADE_STEP 192 250}
        {FADE_STEP 176 250}
        {FADE_STEP 160 250}
        {FADE_STEP 144 250}
        {FADE_STEP 128 250}
        {FADE_STEP 112 250}
        {FADE_STEP 96  250}
        {FADE_STEP 80  250}
        {FADE_STEP 64  250}
        {FADE_STEP 48  250}
        {FADE_STEP 32  250}
        {FADE_STEP 16  250}
        {FADE_STEP 0   250}

        [delay]
            time=6000
        [/delay]

        [message]
            speaker=narrator
            image= # wmllint: ignore
            message= _ "<i>... Where am I?</i>"
        [/message]

        [delay]
            time=2000
        [/delay]

        {FADE_TO_BLACK}

        {ENDLEVEL_QUIET}
    [/event]

    [event]
        name=victory

        {CLEAR_VARIABLE energy_supply_hidden,end_of_scenario_turn_number}
    [/event]

#undef TQ_ELYNIA_FADE_STEP

#undef TQ_ENERGY_SUPPLY_INTACT_CONDITION
#undef TQ_LIVING_NONHERO_UNIT

#undef TQ_PETRIFY_STORED_UNIT
#undef TQ_PETRIFY_ONE_RANDOM_UNDEAD
#undef TQ_PETRIFY_ALL_REMAINING_UNDEAD

#undef TQ_ENABLE_CAVE_WATER_SOUND_SOURCES
#undef TQ_DISABLE_CAVE_WATER_SOUND_SOURCES
[/scenario]

# kate: indent-mode normal; encoding utf-8; space-indent on;
