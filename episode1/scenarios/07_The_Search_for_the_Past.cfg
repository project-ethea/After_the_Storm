#textdomain wesnoth-After_the_Storm

[scenario]
    id=07_The_Search_for_the_Past
    name= _ "The Search for the Past"
    {MAP 07_The_Search_for_the_Past.map}
    {TURNS 70 68 65}
    next_scenario="07x_Resolutions"
    victory_when_enemies_defeated=no

    {A_DEATHS}

    {SCENARIO_MUSIC       "underground.ogg"} {CONTINUE_PLAYING_STORY_MUSIC_FIRST}
    {EXTRA_SCENARIO_MUSIC "the_deep_path.ogg"}
    {EXTRA_SCENARIO_MUSIC "into_the_shadows.ogg"}

    {STORYTXT_THE_SEARCH_FOR_THE_PAST}

    {UNDERGROUND}

    # wmllint: validate-off
    [side]
        save_id=player

        controller=human
        side=1
        team_name=player
        user_team_name= _ "team_name^Galas"

        {GOLD 300 280 260}
        {INCOME 3 2 2}
        shroud=yes

        # wmllint: recognize Galas
        {CHARACTER_STATS_GALAS}
    [/side]
    # wmllint: validate-on

    [side]
        side=2
        team_name=critters
        user_team_name= _ "team_name^Cave Creatures"
        hidden=yes
        no_leader=yes

        [ai]
            {AI_NO_SCOUTS}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 10.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution     0.0}
        [/ai]
    [/side]

    [side]
        side=3
        team_name=critters
        user_team_name= _ "team_name^Cave Creatures"

        type=Lesser Giant Spider
        canrecruit=yes
        hidden=yes
        gold=0
        income=-2
        village_gold=0

        [ai]
            {AI_NO_SCOUTS}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 10.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution     0.0}
        [/ai]
    [/side]

    [side]
        side=4
        team_name=critters
        user_team_name= _ "team_name^Undead"
        {FLAG_VARIANT undead}
        no_leader=yes
        hidden=yes

        [ai]
            {AI_NO_SCOUTS}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 10.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution     0.0}
        [/ai]
    [/side]

    [side]
        side=5
        team_name=critters
        user_team_name= _ "team_name^Yechnagoth’s Guards"
        {CHAOS_FLAG}
        no_leader=yes
        hidden=yes

        [ai]
            {AI_NO_SCOUTS}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 10.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution     0.0}
        [/ai]
    [/side]

    [side]
        side=6
        team_name=critters
        user_team_name= _ "team_name^Chaos Guards"
        {CHAOS_FLAG}
        no_leader=yes
        hidden=yes

        [ai]
            {AI_NO_SCOUTS}
            {AI_SIMPLE_ALWAYS_ASPECT aggression 10.0}
            {AI_SIMPLE_ALWAYS_ASPECT caution     0.0}
        [/ai]
    [/side]

    {STARTING_VILLAGES 1 5}

    {PLACE_IMAGE (scenery/trash.png)           29 45}
    {PLACE_IMAGE (scenery/trash.png)           10 44}
    {PLACE_IMAGE (scenery/trash.png)           12 48}
    {PLACE_IMAGE (scenery/rubble.png)          25 45}
    {PLACE_IMAGE (scenery/rubble.png)          25 47}
    {PLACE_IMAGE (items/brazier.png)           19 39}
    {PLACE_IMAGE (items/brazier.png)           17 40}
    {PLACE_IMAGE (items/brazier.png)           19 42}
    {PLACE_IMAGE (items/brazier.png)           21 41}
    {PLACE_IMAGE (items/brazier.png)           28 35}
    {PLACE_IMAGE (items/burial.png)            17 24}
    {PLACE_IMAGE (items/burial.png)            25 24}
    {PLACE_IMAGE (items/bonestack.png)         30 17}

    {PLACE_IMAGE ("items/bones.png")           27 45}
    {PLACE_IMAGE ("items/bones.png~FL(horiz)") 23 41}

    {PLACE_IMAGE (scenery/monolith1.png)       18 29}
    {PLACE_IMAGE (scenery/monolith3.png)       32 10}

    {CAVE_WATER_SOUND_SOURCE 26 22}

    {CAVE_WATER_SOUND_SOURCE 18 50}

    {CAVE_NOISE_SOUND_SOURCE}

    [event]
        name=prestart
        {DOOR_TILES_TO_UNITS 2}

        # wmllint: recognize Elynia
        {RECALL_ELYNIA}
        # wmllint: recognize Mal Keshar
        {RECALL_MAL_KESHAR}
        # wmllint: recognize Horo
        {RECALL_HORO}
        # wmllint: recognize Kyara
        {RECALL_KYARA}

        {FACE_DIRECTION (side=1) ne}

        {OBJECTIVES (
            victory_string= _ "Current Objectives:"
            {OBJECTIVE_VICTORY ( _ "Follow the path and explore underground")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Galas")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Horo")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Kyara")}
            {TURNS_RUN_OUT}

            {OBJECTIVE_CARRYOVER}
        )}

        {GENERIC_UNIT 2 (Vampire Bat) 37 12} {GUARDIAN}
        {GENERIC_UNIT 2 (Vampire Bat) 30 10} {GUARDIAN}
        {GENERIC_UNIT 2 (Vampire Bat) 27 9 } {GUARDIAN}
        {GENERIC_UNIT 2 (Vampire Bat) 28 8 } {GUARDIAN}
        {GENERIC_UNIT 2 (Vampire Bat) 27 7 } {GUARDIAN}

        {GENERIC_UNIT 2 {DIFF (Vampire Bat) (Blood Bat) (Dread Bat)} 20 8 } {GUARDIAN}

        {GENERIC_UNIT 2 (Vampire Bat) 5  11} {GUARDIAN}
        {GENERIC_UNIT 2 (Vampire Bat) 16 10} {GUARDIAN}
        {GENERIC_UNIT 2 (Vampire Bat) 16 10} {GUARDIAN}

        {GENERIC_UNIT 2 (Giant Ant) 10  5} {FACING sw} {GUARDIAN}
        {GENERIC_UNIT 2 (Giant Ant)  7  8} {FACING se} {GUARDIAN}
        {GENERIC_UNIT 2 (Giant Ant)  8  3} {FACING s } {GUARDIAN}

        {GENERIC_UNIT 2 (Giant Ant) 34 14} {FACING n } {GUARDIAN}
        {GENERIC_UNIT 2 (Giant Ant) 38 14} {FACING nw} {GUARDIAN}
        {GENERIC_UNIT 2 (Giant Ant) 34 14} {FACING n } {GUARDIAN}

        {GENERIC_UNIT 2 (Leech) 13 7 }
        {GENERIC_UNIT 2 (Leech) 23 4 }
        {GENERIC_UNIT 2 (Leech) 33 5 }

        {GENERIC_UNIT 2 (Leech) 11 12}
        {GENERIC_UNIT 2 (Leech) 13 12}
        {GENERIC_UNIT 2 (Leech) 9  13}

        {GENERIC_UNIT 2 (Giant Mushroom) 39 18}

        {GENERIC_UNIT 2 (Leech) 30 15}

        {GENERIC_UNIT 2 (Fungoid) 36 22} {GUARDIAN}
        {GENERIC_UNIT 2 (Fungoid) 40 23} {GUARDIAN}
        {GENERIC_UNIT 2 (Fungoid) 38 25} {GUARDIAN}

        {GENERIC_UNIT 4 (Walking Corpse) 18 50} {VARIATION bat} {FACING ne} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}

        {GENERIC_UNIT 2 (Dread Bat) 13  1} {VARIATION bat} {FACING ne} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}

        {GENERIC_UNIT 4 (Necrophage)  9 46} {FACING ne} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}

        {GENERIC_UNIT 4 (Ghoul)  7 36} {FACING se} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT 4 (Ghoul) 22 40} {FACING sw} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT 4 (Ghoul) 33 48} {FACING sw} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT 4 (Ghoul) 29 49} {FACING nw} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT 4 (Ghoul) 16 39} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT 4 (Ghoul) 16 42} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT 4 (Ghoul) 21 42} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
#ifndef EASY
        {GENERIC_UNIT 4 (Necrophage) 19 41} {FACING ne} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT 4 (Soulless) 22 32} {VARIATION swimmer} {FACING n} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
#endif
        {GENERIC_UNIT 4 (Walking Corpse) 20 31} {VARIATION swimmer} {FACING ne} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT 4 (Walking Corpse) 24 29} {VARIATION swimmer} {FACING sw} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}

        {GENERIC_UNIT 4 (Soulless) 17 28} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}
        {GENERIC_UNIT 4 (Walking Corpse) 17 28} {VARIATION saurian} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}

        {GENERIC_UNIT 4 (Soulless) 24 23} {VARIATION saurian} {FACING ne} {GUARDIAN} {NO_UPKEEP_NO_OVERLAY}

        {GENERIC_UNIT 5 (Psy Crawler) 27 33} {FACING nw} {GUARDIAN}
        {GENERIC_UNIT 5 (Psy Crawler) 26 34} {FACING se} {GUARDIAN}
        {GENERIC_UNIT 5 (Psy Crawler) 22 20} {FACING s } {GUARDIAN}

        {GENERIC_UNIT 6 (Demonic Hound) 26 32} {FACING nw} {GUARDIAN}

        {GENERIC_UNIT 5 (Tentacle of the Deep) 3  33} {GUARDIAN}
        {GENERIC_UNIT 5 (Tentacle of the Deep) 11 31} {GUARDIAN}
        {GENERIC_UNIT 5 (Tentacle of the Deep) 20 32} {GUARDIAN}
        {GENERIC_UNIT 5 (Tentacle of the Deep) 26 29} {GUARDIAN}
        {GENERIC_UNIT 5 (Tentacle of the Deep) 34 22} {GUARDIAN}

        {GENERIC_UNIT 5 (Water Serpent) 25 20} {FACING se} {GUARDIAN}
        {GENERIC_UNIT 5 (Water Serpent) 30 23} {FACING nw} {GUARDIAN}

        {VARIABLE sighted_bats           0}
        {VARIABLE touchplate_38_18_used no}

        {VARIABLE  glyph_7_37_used      no}
        {VARIABLE  glyph_9_36_used      no}
        {VARIABLE  glyph_4_45_used      no}
        #{VARIABLE  glyph_6_46_used      no}
        #{VARIABLE  glyph_8_47_used      no}
        {VARIABLE glyph_10_48_used      no}
        {VARIABLE glyph_31_48_used      no}
    [/event]

    [event]
        name=victory
        {CLEAR_VARIABLE sighted_bats,touchplate_38_18_used}

        {CLEAR_VARIABLE glyph_7_37_used}
        {CLEAR_VARIABLE glyph_9_36_used}
        {CLEAR_VARIABLE glyph_4_45_used}
        #{CLEAR_VARIABLE glyph_6_46_used}
        #{CLEAR_VARIABLE glyph_8_47_used}
        {CLEAR_VARIABLE glyph_10_48_used}
        {CLEAR_VARIABLE glyph_31_48_used}
    [/event]

    [event]
        name=start
        [message]
            speaker=Horo
            message= _ "I don’t like this place. It feels as if something is waiting to ambush us in the darkness."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Heh, darkness. These elves aren’t very smart after all. Why would they think that sending one of their sun-loving youths would be of any help to us?"
        [/message]

        [message]
            speaker=Kyara
            message= _ "Keep your mouth shut, decrepit lich! We are being <i>far</i> more lenient than anyone would be with those who deal with your unnatural minions and these filthy apes."
        [/message]

        [message]
            speaker=Horo
            message= _ "Who are you calling “filthy apes”, you..."
        [/message]

        [message]
            speaker=Galas
            message= _ "Calm down, everyone! If we are to explore these caverns, we’ll need to stay together."
        [/message]

        [message]
            speaker=Kyara
            message= _ "What are you looking for? Some kind of artifact? Rocks? Spiders?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "We believe these caves beneath the dark citadel may have once been used by our enemies. If that is the case, they may have left behind scrolls, artifacts, or anything else that could provide us with hints."
        [/message]

        [message]
            speaker=Galas
            message= _ "This is no time to fight amongst ourselves. Just stay alert and let us see what we can find."
        [/message]

        [message]
            speaker=Horo
            message= _ "We will help you as best we can, elf."
        [/message]
    [/event]

    {FIRE_EVENT_ON_STUMBLE_UPON giant_spider (
        canrecruit=yes
        side=3
    )}

    [event]
        name=giant_spider
        [store_starting_location]
            side=4
        [/store_starting_location]

        [unit]
            x,y=$location.x,$location.y
            side=4
            canrecruit=yes
            type=Death Knight
            id=Firden
            name= _ "Firden"
            [modifications]
                {TRAIT_UNDEAD}
            [/modifications]
        [/unit]

        [modify_side]
            side=4
            recruit=Skeleton,Walking Corpse,Ghost
            {GOLD 100 125 150}
            {INCOME 2 3 4}
        [/modify_side]

#ifdef HAVE_SAVE_GOLD_ASPECT_BY_DEFAULT
        #
        # Don't let gold saving kick in on the first AI turn.
        #
        {MODIFY_AI_ADD_ASPECT 4 recruitment_save_gold (
            [facet]
                [value]
                    active="$($turn_number + 1)"
                [/value]
            [/facet]
        )}
#endif

        {CAPTURE_VILLAGES 4 $location.x $location.y 8}

        [capture_village]
            side=4
            x,y=31,17
        [/capture_village]

        [message]
            side,canrecruit=3,yes
            message= _ "<i>Hissssssss</i>" # wmllint: no spellcheck
        [/message]

        [message]
            speaker=Horo
            message= _ "A giant spider. Just a bothersome giant spider."
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]

        {CLEAR_VARIABLE location}
    [/event]

    {FIRE_EVENT_ON_STUMBLE_UPON undead_enemies (
        side=4
    )}

    [event]
        name=undead_enemies

        [message]
            speaker=Galas
            message= _ "Look out, there are undead sentinels standing in our way!"
        [/message]

        [message]
            speaker=Kyara
            message= _ "This is impossible! Our druids purged any evil creatures left on this island after Kalehssar’s victory!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Above the surface, they might have been unable to detect these slumbering minions. Yes, it appears our presence is what has awakened them after so long."
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]
    [/event]

    [event]
        name=die
        [filter]
            id=Firden
        [/filter]

        [message]
            speaker=Mal Keshar
            message= _ "There was very little strength left in this guardian. I wonder who was the master of these minions before the place was abandoned?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "Argan, of course. There’s no doubt about it."
        [/message]

        [scroll_to]
            x,y=$x2,$y2
        [/scroll_to]
    [/event]

    [event]
        name=die
        [filter]
            level=2
            [or]
                level=3
            [/or]
        [/filter]
        [filter_second]
            id=Kyara
        [/filter_second]

        [message]
            speaker=Mal Keshar
            message= _ "Not bad for a sun-loving little girl."
        [/message]

        [message]
            speaker=Kyara
            message= _ "Shut up, necromancer."
        [/message]

        [scroll_to]
            x,y=$x2,$y2
        [/scroll_to]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=29-35
            y=15-19
        [/filter]
        [filter_condition]
            {VARIABLE_BOOLEAN_NOT_EQUALS touchplate_38_18_used yes}
        [/filter_condition]

        {CLEAR_CAVE_SHROUD (
            x,y=31,17
            radius=3
        )}

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=31,18
        [/scroll_to]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Kyara
            message= _ "Now what?"
        [/message]

        [message]
            speaker=Galas
            message= _ "If our past experiences with this sort of fortress are anything to go by, this is most likely not the dead end it appears to be. Let us check the cave to the east."
        [/message]
    [/event]

    {ITEM_TOUCHPLATE 38 18}

    [event]
        name=moveto
        [filter]
            side=1
            x,y=38,18
        [/filter]

        {VARIABLE touchplate_38_18_used yes}

        [remove_item]
            x,y=$x1,$y1
        [/remove_item]

        [terrain]
            x,y=38,19
            terrain=Uu
        [/terrain]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Touchplate triggered. A wall moves."
        [/message]

        [redraw]
            side=1
        [/redraw]
    [/event]

    {ITEM_CRYSTAL_GLYPH_GATE 38 23}

    [event]
        name=moveto
        [filter]
            side=1
            x,y=38,23
        [/filter]

        [terrain]
            x,y=30,19
            terrain=Uu
        [/terrain]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Crystal glyph activated. A wall moves."
        [/message]

        [remove_shroud]
            x,y=30,19
            radius=1
            [or]
                x,y=28,21
                radius=1
            [/or]
            side=1
        [/remove_shroud]

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=29,21
        [/scroll_to]

        {HIGHLIGHT_GOAL (x,y=29,21)}

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]
    [/event]

    [event]
        name=moveto
        [filter]
            id=Elynia
            x,y=38-40,28
        [/filter]

        [message]
            speaker=Elynia
            message= _ "Hm... I don’t know what I was thinking; there is no point in following this stream."
        [/message]
    [/event]

    {FIRE_EVENT_ON_STUMBLE_UPON sighted_bats (
        race=bats
    )}
    {FIRE_EVENT_ON_STUMBLE_UPON sighted_water_serpent (
        type=Water Serpent
    )}
    {FIRE_EVENT_ON_STUMBLE_UPON sighted_verlissh (
        race=verlissh
    )}

    [event]
        name=sighted_bats
        first_time_only=no

        {VARIABLE_INC sighted_bats}

        [if]
            {VARIABLE_NUMERICAL_GREATER_THAN sighted_bats 2}
            [then]
                [message]
                    speaker=Kyara
                    message= _ "These accursed bats are everywhere!"
                [/message]

                [message]
                    speaker=Mal Keshar
                    message= _ "It’s a cave, what did you expect? Rabbits?"
                [/message]

                [scroll_to]
                    x,y=$x1,$y1
                [/scroll_to]
            [/then]
        [/if]
    [/event]

    [event]
        name=sighted_water_serpent

        [message]
            speaker=Galas
            scroll=no
            message= _ "Those water creatures don’t look friendly at all."
        [/message]
    [/event]

    [event]
        name=sighted_verlissh

        [message]
            speaker=Kyara
            scroll=no
            # wmllint: local spelling Yec
            message= _ "These abominations look much like Yechnagoth’s true form did according to our druids..."
        [/message]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x=10-18
            y=25-30
        [/filter]

        {CLEAR_CAVE_SHROUD (
            x,y=12,25
            radius=2
            [or]
                x,y=16,25
                radius=2
            [/or]
        )}

        [redraw]
            side=1
        [/redraw]

        [scroll_to]
            x,y=15,27
        [/scroll_to]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elynia
            scroll=no
            message= _ "It seems there was a cave-in here long ago. This blocked passage might have led to the citadel — let’s see what lies down the path."
        [/message]
    [/event]

    [event]
        name=DEBUG1

        [teleport]
            [filter]
                id=Galas
            [/filter]
            x,y=23,37
        [/teleport]

        [teleport]
            [filter]
                id=Elynia
            [/filter]
            x,y=24,37
        [/teleport]

        [teleport]
            [filter]
                id=Mal Keshar
            [/filter]
            x,y=24,36
        [/teleport]
    [/event]

    [event]
        name=die
        [filter]
            type=Door
            [and]
                x,y=22,37
                [or]
                    x,y=23,38
                [/or]
            [/and]
        [/filter]

        [remove_shroud]
            side=1
            x=16-23,15
            y=38-43,39-43
        [/remove_shroud]

        [redraw][/redraw]

        [scroll_to]
            x,y=19,40
        [/scroll_to]

        [fade_out_music]
            duration=500
        [/fade_out_music]

        {REPLACE_SCENARIO_MUSIC "wanderer.ogg"}

        [message]
            speaker=Galas
            message= _ "Ghouls. I guess this is Argan’s old lair."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Yes, it seems to be... Let’s get rid of its current residents and inspect those chambers."
        [/message]

        {OBJECTIVES (
            victory_string= _ "Current Objectives:"
            {OBJECTIVE_VICTORY ( _ "Gather all information you can from Argan’s lair")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Galas")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Horo")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Kyara")}

            {TURNS_RUN_OUT}

            {OBJECTIVE_CARRYOVER}
        )}

        [event]
            name=check_glyphs
            first_time_only=no
            [if]
                {VARIABLE_BOOLEAN_EQUALS  glyph_7_37_used yes}
                {VARIABLE_BOOLEAN_EQUALS  glyph_9_36_used yes}
                {VARIABLE_BOOLEAN_EQUALS  glyph_4_45_used yes}
                #{VARIABLE_BOOLEAN_EQUALS  glyph_6_46_used yes}
                #{VARIABLE_BOOLEAN_EQUALS  glyph_8_47_used yes}
                {VARIABLE_BOOLEAN_EQUALS glyph_10_48_used yes}
                {VARIABLE_BOOLEAN_EQUALS glyph_31_48_used yes}
                [then]
                    {ENDLEVEL_VICTORY yes}
                [/then]
            [/if]
        [/event]
    [/event]

    [event]
        name=moveto
        [filter]
            side=1
            x,y=27,45
        [/filter]

        [message]
            speaker=Horo
            scroll=no
            message= _ "The skeleton of a human, it seems. Who knows how this poor bastard ended up thrown into this chamber."
        [/message]
    [/event]

#define __MSG_POWER_UP_GLYPH _MSG
    [message]
        speaker=narrator
        image=items/crystal-glyph-powerup.png
        caption= _ "Crystal Glyph"
        message={_MSG} # wmllint: ignore
    [/message]
#enddef

#define __LIBRARY_GLYPH_BASE _X _Y _WML
    {ITEM_CRYSTAL_GLYPH_MESSAGE {_X} {_Y} }
    {ITEM_GOAL                  {_X} {_Y} }

    # Step 1: remove goal marker

    [event]
        name=moveto
        [filter]
            x={_X}
            y={_Y}
            side=1
        [/filter]

        {ITEM_REMOVE_GOAL {_X} {_Y} }
    [/event]

    # Step 2: show associated messages (may be triggered again if the player wishes so)

    [event]
        name=moveto
        first_time_only=no
        [filter]
            x={_X}
            y={_Y}
            side=1
        [/filter]

        [allow_undo][/allow_undo]

        {_WML}
    [/event]

    # Step 3: commit status

    [event]
        name=moveto
        [filter]
            x={_X}
            y={_Y}
            side=1
        [/filter]

        {VARIABLE "glyph_$x1|_$y1|_used" yes}

        [fire_event]
            name=check_glyphs
        [/fire_event]
    [/event]
#enddef

#define __LIBRARY_GLYPH _X _Y _MSG
    {__LIBRARY_GLYPH_BASE ({_X}) ({_Y}) ({MSG_GLYPH ({_MSG})})}
#enddef

    {__LIBRARY_GLYPH 7 37 ( _ "The Verlissh are a group of very basic lifeforms first brought to Irdya by Rythénian warriors. Under given conditions, these creatures can combine to form larger and more complex units, and even integrate foreign organisms, adapting to and enhancing their functions.")}

    {__LIBRARY_GLYPH 9 36 ( _ "Uria has learned that the Argazar civilization used the Verlissh to enhance the abilities and strength of their so-called ‘biomechanical’ warriors. There are ruins scattered across Irdya from which we could obtain samples to, in time, raise a whole army to put an end to the current Dark Age.")}

    {__LIBRARY_GLYPH 4 45 ( _ "The advanced Norsulan technology stolen by Uria’s agents from those working for the one who is rumored to be the reincarnation of Valdir has been very helpful for our ends; understanding the most interesting creations of the Argazar people would have proved nearly impossible without a better-documented modern reference.")}

    # wmlindent: start ignoring
    {__LIBRARY_GLYPH_BASE 10 48 (
        # po: Note: Urvatha = Inferno. Uria is considered the mother of Inferno
        # po: in a strictly figurative sense.
        {MSG_GLYPH ( _ "According to some ancient legends of disputable origin, the First created a beautiful maiden out of fine dust, and bestowed her control over the awesome power that flows through the veins of every one of her faerie descendants, including the elves of Irdya.

Those legends also tell of one of her siblings: Merthiaal the ashen one, who owing to her bold actions would come to be known as the Eater of Souls. Even after a cycle has passed, the oldest races of Irdya and other worlds continue to remember her, and avoid using her true name in conversation. If they must, they will speak of her as ‘Yechnagoth’.

Now, Merthiaal fervently desired the First’s favor. Alas, no matter how much she tried, she could not manage to tame the Aspect of Darkness, and this would remain the case until her confused heart could be healed; for the First only had eyes for the wielder of the Arcane Flame, and Uria, the Guardian who would come to be regarded as the mother of Urvatha.")}

        {MSG_GLYPH ( _ "Envy rooted deep within Merthiaal’s mind. In an attempt to prove her worth, she committed an unspeakable sin against the order of the Universe. Her control over Darkness was lost as a result. Her own world was destroyed, along with every soul on it. Any further damage was only narrowly averted thanks to Uria’s timely intervention.

Merthiaal’s heart, soul, and memories were preserved through eons, but her body was not.

Now we have the means to build a new body that may allow her power to flow unimpeded once again. If she can be convinced to accept Uria’s offer, then she shall have a new opportunity to destroy the descendants of her rival and allow us to reign over this decadent world.")}
    )}
    # wmlindent: stop ignoring

    {OBJ_HEALING_GLYPH  6 46}

    {OBJ_HEALING_GLYPH  8 47}

    {OBJ_HEALING_GLYPH 20 47}

    {ITEM_CRYSTAL_GLYPH_POWERUP 31 48}
    {ITEM_GOAL                  31 48}

    {CONTINUOUS_SOUND_SOURCE power_up_glyph_sound_source 31 48 ("glyph-powerup.ogg")}

    [event]
        name=moveto
        [filter]
            x=31
            y=48
            side=1
        [/filter]

        [allow_undo][/allow_undo]

        [redraw][/redraw]

        {__MSG_POWER_UP_GLYPH ( _ "This glyph may not be used by anyone but the true descendants of She who wields the Arcane Flame that protects Irdya.")}

        [if]
            [have_unit]
                id=Elynia
                x=$x1
                y=$y1
            [/have_unit]
            [else]
                [message]
                    speaker=Galas
                    message= _ "Elynia, you should check this crystal; it may have information we need."
                [/message]

                {OBJECTIVES (
                    victory_string= _ "Current Objectives:"
                    {OBJECTIVE_VICTORY ( _ "Move Elynia to the sealed crystal glyph")}
                    {OBJECTIVE_VICTORY ( _ "Gather all information you can from Argan’s lair")}

                    {OBJECTIVE_DEFEAT  ( _ "Death of Galas")}
                    {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
                    {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}
                    {OBJECTIVE_DEFEAT  ( _ "Death of Horo")}
                    {OBJECTIVE_DEFEAT  ( _ "Death of Kyara")}

                    {TURNS_RUN_OUT}

                    {OBJECTIVE_CARRYOVER}
                )}
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        [filter]
            x=31
            y=48
            id=Elynia
        [/filter]

        {VARIABLE "glyph_$x1|_$y1|_used" yes}

        {__MSG_POWER_UP_GLYPH ( _ "Within this glyph is encoded a Teleport spell which will allow you to cross great distances if you can move your soul without your body, gaze beyond without your eyes, and touch the world beyond your reach. Given sufficient focus, you shall be able to travel to any place from your memories and find anybody as long as you can sense their heart.

Beware, for not everything is written, and those who stray from their reality might not find anything on the other side of the mirror.")}

        [message]
            speaker=Mal Keshar
            message= _ "That’s strange. Why would Argan keep something he obviously couldn’t use in his lair?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "It could be... that he foresaw these events and wanted to help us, even if he couldn’t break free from Uria’s control."
        [/message]

        [message]
            speaker=Galas
            message= _ "It’s more likely that he wanted to set a trap for us or anyone else who would manage to find this place."
        [/message]

        [message]
            speaker=Elynia
            message= _ "I don’t believe he truly intended to cause me any harm with his actions... I’ll take the spell, it could be of use later."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Elynia, don’t—"
        [/message]

        [scroll_to]
            x,y=$x1,$y1
        [/scroll_to]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "As Elynia approached the crystal’s surface with her hand, the glyph disintegrated into fine golden dust, covering her for a few moments..."
        [/message]

        [animate_unit]
            [filter]
                x,y=$x1,$y1
            [/filter]
            flag=shine_golden
            with_bars=no
        [/animate_unit]

        [remove_item]
            x,y=$x1,$y1
        [/remove_item]

        [terrain]
            terrain=Uu
            x,y=$x1,$y1
        [/terrain]

        {REMOVE_SOUND_SOURCE (power_up_glyph_sound_source)}

        [redraw][/redraw]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "... And then it vanished into thin air."
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Elynia
            message= _ "I don’t feel any different, but... I guess I need to figure out exactly how this power works, now."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "Hmph. In my times, you didn’t acquire magic abilities from a rock. Well, be careful if you ever attempt to use that spell; knowing who might have put it there, I don’t think it’s safe. And more generally, while it is known that powerful mages can learn to travel great distances like that, many of them also disappear on occasion and are never heard of again."
        [/message]

        {OBJECTIVES (
            victory_string= _ "Current Objectives:"
            {OBJECTIVE_VICTORY ( _ "Gather all information you can from Argan’s lair")}

            {OBJECTIVE_DEFEAT  ( _ "Death of Galas")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Elynia")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Mal Keshar")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Horo")}
            {OBJECTIVE_DEFEAT  ( _ "Death of Kyara")}

            {TURNS_RUN_OUT}

            {OBJECTIVE_CARRYOVER}
        )}

        [fire_event]
            name=check_glyphs
        [/fire_event]
    [/event]

    [event]
        name=victory

        #
        # Just to keep the cutscene zone clear.
        #
        {RESET_AND_SEND_TO_RECALL_LIST (
            side=1
            [not]
                id=Galas
                [or]
                    id=Elynia
                [/or]
                [or]
                    id=Mal Keshar
                [/or]
                [or]
                    id=Horo
                [/or]
                [or]
                    id=Kyara
                [/or]
            [/not]
            [not]
                x,y=recall,recall
            [/not]
        )}

        [kill]
            [not]
                side=1
            [/not]
            animate=no
            fire_event=no
        [/kill]

        {RESET_UNIT_STATUSES (
            side=1
            [not]
                x,y=recall,recall
            [/not]
        )}

        [hide_unit][/hide_unit]

        {FADE_TO_BLACK}

        [fade_out_music][/fade_out_music]

        [scroll_to]
            x,y=19,41
            {WARP}
        [/scroll_to]

        [redraw][/redraw]

        {FADE_IN}

        # FIXME: This sequence actually unhides the units before we reach the
        # [unhide_unit] action.
        [teleport]
            [filter]
                id=Galas
            [/filter]
            x,y=16,39
        [/teleport]
        {FACE_DIRECTION (id=Galas) se}
        [teleport]
            [filter]
                id=Elynia
            [/filter]
            x,y=21,39
        [/teleport]
        {FACE_DIRECTION (id=Elynia) sw}
        [teleport]
            [filter]
                id=Mal Keshar
            [/filter]
            x,y=17,42
        [/teleport]
        {FACE_DIRECTION (id=Mal Keshar) ne}
        [teleport]
            [filter]
                id=Horo
            [/filter]
            x,y=22,41
        [/teleport]
        {FACE_DIRECTION (id=Horo) nw}
        [teleport]
            [filter]
                id=Kyara
            [/filter]
            x,y=20,42
        [/teleport]
        {FACE_DIRECTION (id=Kyara) nw}

        [unhide_unit][/unhide_unit]

        {REPLACE_SCENARIO_MUSIC "nunc_dimittis.ogg"}

        [redraw][/redraw]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Galas
            message= _ "There doesn’t seem to be much more to see here. That’s unfortunate."
        [/message]

        [message]
            speaker=Kyara
            # po: "Our priestesses won’t accept this truth." or something similarly terrifying.
            message= _ "What we have found here is... frightening. We always thought that there was only one world, the one in which we live. Our priestesses won’t... What do we do with this?"
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "This reminds me that the ‘First’ is also described in the ruins of a hidden city beneath the Heart Mountains. It is said that he created ten powerful demons, the Original Ten. All this would imply that all elves and other faerie creatures are descended, or at least created in the image of this mysterious wielder of the Arcane Flame, sister of Uria and Yechnagoth, and one of the Original Ten."
        [/message]

        [message]
            speaker=Elynia
            message= _ "Eloh. That’s her name — a name that was seldom heard in my times, for nearly nothing was known for certain about her and the myths neglected explaining the origin of every other race on Irdya. I suppose that Zhangor’s influence upon Wesmere may have resulted in the reintroduction of that name to our kin’s lore. Regardless, even though linguistics are not my specialty, I suspect that’s still not her true name, much like the case of Yechnagoth."
        [/message]

        [message]
            speaker=Elynia
            message= _ "What you have learned here about all this... it would probably be best to keep it as a secret from the rest of the world for now, especially the allusions to additional worlds. In these times when demons roam and spoil Irdya at will, realizing that they might be more closely related to us than we suspected, and that there might be more awaiting out there... it could be devastating to our cultures, to say the least. Perhaps after all this is over..."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "<i>(snicker)</i> And you say that Argan never intended to cause you any harm? All that we have found proves that he really wanted to destroy your kind after all! Using the powers of an ancient demon, no less!"
        [/message]

        [message]
            speaker=Elynia
            message= _ "I don’t believe that any of this was done out of his own volition. He was... under Uria’s control."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "So, have you forgotten what he said? “I chose my fate — I guess this is what I deserved from the beginning.” I know, his last words were very vague, but it certainly sounded like he was well aware of what he was doing the whole time. Perhaps it was not his intention to cause harm to <i>you</i> in particular, but the damage he caused throughout the continent, in the name of Uria, to the things you protect... did it not affect you? Furthermore, it seemed like Uria felt his loss. If he was a mere puppet of hers, would she have resented his death so much?"
        [/message]

        [delay]
            time=750
        [/delay]

        {MOVE_UNIT id=Elynia 20 40}

        [delay]
            time=250
        [/delay]

        {MOVE_UNIT id=Elynia 19 41}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "Elynia slowly approached Mal Keshar with a grim expression in her eyes — neither the lich nor Galas had seen that much rage reflected in her before."
        [/message]

        [delay]
            time=250
        [/delay]

        {MOVE_UNIT id=Elynia 18 41}

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elynia
            message= _ "You know nothing."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "I saw enough. I heard enough."
        [/message]

        [message]
            speaker=Horo
            message= _ "<i>(nervously)</i> We should return to the surface before we run out of provisions."
        [/message]

        [message]
            speaker=Galas
            message= _ "Elynia... if I’m not mistaken, we found a journal in the Heart, and you have kept it all this time with you, correct?"
        [/message]

        [message]
            speaker=Elynia
            message= _ "<i>(hesitates for a second)</i> I... the elf who suggested that we take the journal, he was under Uria’s control, wasn’t he? It might not truly be Argan’s."
        [/message]

        [message]
            speaker=Galas
            message= _ "I am sure it is. I knew Lédinor well enough, and I’m sure that was him speaking, not Uria. It was later that his face and demeanor changed completely. No matter what Uria said, I’m certain that Lédinor was struggling to overcome her control all that time, resisting it long enough to help us, even though he knew she would succeed in the end. If he had told us about it, he would have collapsed much earlier."
        [/message]

        [delay]
            time=250
        [/delay]

        [message]
            speaker=Galas
            message= _ "We are descendants of Eloh, and as the Quenoth elves know, not even Yechnagoth’s mind control can work on us that easily."
        [/message]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Galas
            message= _ "I know you are probably hesitant about reading Argan’s journal because you fear to learn more about how much of a monster he became..."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elynia
            message= _ "I..."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Mal Keshar
            message= _ "If you prefer, I could read it for you, and keep any details besides what is relevant to our quest from reaching anyone."
        [/message]

        [delay]
            time=750
        [/delay]

        [message]
            speaker=Elynia
            message= _ "<i>(with a calmer expression)</i> Very well."
        [/message]

        [message]
            speaker=Mal Keshar
            message= _ "In the meantime, perhaps you could socialize with the locals or something. Perhaps try to have fun and smile? It really helps when you’ve lived for so long — I should be one to know. While you do that, I’ll be <i>killing</i> myself reading a damn book; I haven’t found any good reading material since the Fall, you know? It seems like everyone suddenly forgot how to read and write after the Wesnothians singlehandedly ended the world!"
        [/message]

        [message]
            speaker=Kyara
            message= _ "... You are already dead."
        [/message]
    [/event]

    [event]
        name=time over

        #
        # I could not think of any good reason for the defeat on end-of-turns; the
        # baddies aren't going to invade Quenoth any time soon, but I can't let the
        # player milk income forever.
        #

        [message]
            speaker=Horo
            message= _ "We have spent too much time in these caverns, and many of my men are starving."
        [/message]

        [message]
            speaker=Elynia
            message= _ "<i>(sighs, staring at the ceiling)</i> Why do we always have a time limit of some sort for everything we do?"
        [/message]
    [/event]

#undef __MSG_POWER_UP_GLYPH
#undef __LIBRARY_GLYPH
#undef __LIBRARY_GLYPH_BASE
[/scenario]

# kate: indent-mode normal; encoding utf-8; space-indent on;
